<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>CockroachDBäº‹åŠ¡æ¨¡å‹</title>
    <url>/2021/12/21/CockroachDB%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B/</url>
    <content><![CDATA[<p>å‰é¢æˆ‘ä»¬çœ‹ä¸‹Tidbçš„äº‹åŠ¡æ¨¡å‹ï¼ŒåŸºäºPercolatorå®ç°ï¼Œæ¥ç€æˆ‘ä»¬çœ‹ä¸‹CockroachDBçš„å®ç°æ–¹æ¡ˆï¼ŒåŸºäºSpannerå®ç°ï¼Œå¯¹æ¯”äºŒè€…çš„åŒºåˆ«ã€‚æˆ‘ä»¬è¿˜æ˜¯ä»ä¸‹é¢ä¸‰ä¸ªæ–¹é¢</p>
<h4 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h4><h5 id="åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹è¦åšä»€ä¹ˆï¼Ÿ"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹è¦åšä»€ä¹ˆï¼Ÿ" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹è¦åšä»€ä¹ˆï¼Ÿ"></a>åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹è¦åšä»€ä¹ˆï¼Ÿ</h5><h5 id="éœ€è¦æ€è€ƒçš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ"><a href="#éœ€è¦æ€è€ƒçš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="éœ€è¦æ€è€ƒçš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ"></a>éœ€è¦æ€è€ƒçš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ</h5><h5 id="åŸºäºSpannerçš„è§£å†³æ–¹æ¡ˆï¼Ÿ"><a href="#åŸºäºSpannerçš„è§£å†³æ–¹æ¡ˆï¼Ÿ" class="headerlink" title="åŸºäºSpannerçš„è§£å†³æ–¹æ¡ˆï¼Ÿ"></a>åŸºäºSpannerçš„è§£å†³æ–¹æ¡ˆï¼Ÿ</h5><h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><h4 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h4><h4 id="Tidb-VS-CockroachDB"><a href="#Tidb-VS-CockroachDB" class="headerlink" title="Tidb VS CockroachDB"></a>Tidb VS CockroachDB</h4><p><strong>å‚è€ƒæ–‡æ¡£</strong></p>
<p><a href="https://www.cockroachlabs.com/docs/stable/architecture/transaction-layer.html">https://www.cockroachlabs.com/docs/stable/architecture/transaction-layer.html</a></p>
<p><a href="https://nan01ab.github.io/2021/06/Distributed-Txn(5).html">https://nan01ab.github.io/2021/06/Distributed-Txn(5).html</a></p>
]]></content>
      <tags>
        <tag>CockroachDB</tag>
        <tag>åˆ†å¸ƒå¼äº‹åŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title>tidbäº‹åŠ¡æ¨¡å‹</title>
    <url>/2021/12/21/tidb%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B/</url>
    <content><![CDATA[<p>ä¹‹å‰çš„çœ‹raftæºç åˆ†æçš„æ—¶å€™ï¼Œå»çœ‹äº†çœ‹<code>atomic.Value</code>çš„å®ç°ï¼Œä¹‹åå°±ä¸€ç›´æƒ³ç€Tidbçš„äº‹åŠ¡çš„å®ç°ï¼Œå› ä¸ºå®ç°çš„æ€è·¯æ¯”è¾ƒç±»ä¼¼çš„ã€‚Tidbçš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹æ˜¯åŸºäºGoogleçš„Percolatorå®ç°çš„ã€‚æ¥ç€æˆ‘ä»¬ä»åŸç†ã€ä»£ç å®ç°ã€ä»¥åŠä¼˜åŒ–ä¸‰å¤§å—æ¥è¯¦ç»†çœ‹çœ‹ã€‚</p>
<h4 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h4><h5 id="åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹è¦åšä»€ä¹ˆï¼Ÿ"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹è¦åšä»€ä¹ˆï¼Ÿ" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹è¦åšä»€ä¹ˆï¼Ÿ"></a>åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹è¦åšä»€ä¹ˆï¼Ÿ</h5><p><a href="https://imgtu.com/i/T8tPBj"><img src="https://s4.ax1x.com/2021/12/23/T8tPBj.md.png" alt="T8tPBj.md.png"></a></p>
<p>å›¾ç‰‡æ¥æºï¼š<a href="https://www.jianshu.com/p/bca8a678fafc">blogåœ°å€</a>  [å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»åˆ é™¤]ã€‚3ä¸ªäº‹åŠ¡å¹¶å‘å†™å…¥ï¼ŒT1/T2æ›´æ–°åŒä¸€ä¸ªåˆ†ç‰‡çš„ç›¸åŒè¡Œ(b)ã€‚T1/T3ä»¥ä¸åŒçš„é¡ºåºæ›´æ–°ç›¸åŒçš„è¡Œã€‚</p>
<h5 id="éœ€è¦æ€è€ƒçš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ"><a href="#éœ€è¦æ€è€ƒçš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="éœ€è¦æ€è€ƒçš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ"></a>éœ€è¦æ€è€ƒçš„é—®é¢˜æœ‰å“ªäº›ï¼Ÿ</h5><p>æˆ‘ä»¬ä»äº‹åŠ¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ¥è¯¦ç»†è€ƒè™‘è¿™ä¸ªäº‹æƒ…ã€‚</p>
<p><strong>å•äº‹åŠ¡</strong></p>
<p>1ã€T1äº‹åŠ¡æ›´æ–°(a,b)ä¸¤æ¡è®°å½•ï¼Œæ€ä¹ˆçŸ¥é“è®°å½•åœ¨å“ªäº›åˆ†ç‰‡ä¸Šï¼Ÿ</p>
<p>2ã€T1äº‹åŠ¡åŒæ—¶æ›´æ–°äº†2ä¸ªåˆ†ç‰‡ï¼Œæ€ä¹ˆä¿è¯åŸå­æ€§ï¼ŒåŒæ—¶æˆåŠŸorå¤±è´¥ï¼Ÿ</p>
<p>3ã€æ¯ä¸€æ¡è®°å½•åˆæœ‰3ä¸ªå‰¯æœ¬ï¼Œæ€ä¹ˆä¿è¯å¤šå‰¯æœ¬çš„åŒæ­¥ï¼Ÿ</p>
<p><strong>å¹¶å‘äº‹åŠ¡</strong></p>
<p>ã€T1/T2åŒæ—¶æ›´æ–°åˆ†ç‰‡2ï¼Œä¼šä¸ä¼šæœ‰å†²çªï¼Ÿå†²çªæ£€æµ‹æ€ä¹ˆåšï¼Ÿå¦‚æœæœ‰å†²çªæ€ä¹ˆåŠï¼Ÿ  â€“ ä¹è§‚äº‹åŠ¡ or  æ‚²è§‚äº‹åŠ¡</p>
<p>5ã€T1/T3ç”¨ä¸åŒçš„é¡ºåºæ›´æ–°ç›¸åŒçš„æ•°æ®ï¼Œä¼šä¸ä¼šæ­»é”ï¼Ÿ â€“ æ­»é”æ£€æµ‹</p>
<p>6ã€ä¸åŒçš„éš”ç¦»çº§åˆ«æ€ä¹ˆå®ç°ï¼Ÿ â€“ MVCC</p>
<h5 id="åŸºäºPercolatorçš„è§£å†³æ–¹æ¡ˆï¼Ÿ"><a href="#åŸºäºPercolatorçš„è§£å†³æ–¹æ¡ˆï¼Ÿ" class="headerlink" title="åŸºäºPercolatorçš„è§£å†³æ–¹æ¡ˆï¼Ÿ"></a>åŸºäºPercolatorçš„è§£å†³æ–¹æ¡ˆï¼Ÿ</h5><p>å…ˆç”¨<a href="http://notes.stephenholiday.com/Percolator.pdf">è®ºæ–‡</a>ä¸­çš„ä¾‹å­æ¥ç®€å•è¯´æ˜ä¸‹æ•´ä¸ªæµç¨‹ï¼šBob-&gt;Joeè½¬è´¦$7çš„æ•´ä¸ªè¿‡ç¨‹ã€‚balè¡¨ç¤ºçš„æ˜¯åˆ—ã€‚</p>
<p>1ã€åˆå§‹çŠ¶æ€ï¼ŒBobåœ¨æ—¶åˆ»5æœ‰$10ï¼ŒJoeåœ¨æ—¶åˆ»5æœ‰$2ã€‚æ—¶åˆ»5-&gt;æ—¶åˆ»6æ²¡æœ‰ä»»ä½•æ“ä½œï¼Œæ‰€æœ‰6çš„æ—¶å€™è¿˜æ˜¯data@5çš„æ•°æ®ï¼Œå¦‚æœ€åä¸€åˆ—ã€‚</p>
<p><a href="https://imgtu.com/i/TKxBkj"><img src="https://s4.ax1x.com/2021/12/21/TKxBkj.png" alt="TKxBkj.png"></a></p>
<p>2ã€è½¬è´¦å¼€å§‹ï¼ŒBobè´¦å·å‘ç”Ÿä¸¤ä¸ªå˜åŒ–ï¼Œæ—¶åˆ»7å…ˆå°†Bobè´¦æˆ·çš„lockå­—æ®µ(ç¬¬3åˆ—)è®¾ç½®ä¸ºprimaryï¼Œç„¶åå°†data(ç¬¬äºŒåˆ—)è¿›è¡Œæ›´æ–°ï¼Œä½™é¢ä¸º$3ã€‚</p>
<p><a href="https://imgtu.com/i/TKzZNj"><img src="https://s4.ax1x.com/2021/12/21/TKzZNj.png" alt="TKzZNj.png"></a></p>
<p>3ã€Bobè´¦æˆ·æ›´æ–°å®Œæˆï¼Œå¼€å§‹æ›´æ–°Joeè´¦æˆ·ï¼ŒJoeè´¦æˆ·æ“ä½œåŒBob(æ³¨æ„è¿˜æ˜¯æ—¶åˆ»7ï¼Œå¼€å§‹æ—¶é—´)ï¼Œå´åˆ«æ˜¯è·å–çš„lockä¸æ˜¯primaryäº†ï¼Œè€Œæ˜¯ref to primary(ç¬¬ä¸‰åˆ—)ã€‚ä¾‹å­ä¸­secondaryè¡Œåªæœ‰ä¸€è¡Œï¼Œå®é™…å¯èƒ½æ˜¯å¤šè¡Œï¼Œrow by rowçš„åšè·å–é”&amp;æ›´æ–°æ•°æ®çš„æ“ä½œã€‚</p>
<p><a href="https://imgtu.com/i/TMSiGR"><img src="https://s4.ax1x.com/2021/12/21/TMSiGR.png" alt="TMSiGR.png"></a></p>
<p>4ã€æ¥ä¸‹æ¥æ•°æ®æ›´æ–°å¥½äº†ï¼Œè¿›å…¥åˆ°æäº¤é˜¶æ®µã€‚æ–°çš„æ—¶åˆ»8ï¼Œå°†primaryçš„é”ä¿¡æ¯åˆ é™¤ï¼Œå¹¶å°†æ•°æ®å†™å…¥åˆ°bal:writeåˆ—(ç¬¬4åˆ—)ï¼Œåˆ°è¿™é‡Œäº‹åŠ¡å°±ç®—æ˜¯æäº¤äº†ã€‚secondaryè¡Œçš„æäº¤æ˜¯å¼‚æ­¥çš„ã€‚è¿™ä¸ªæ—¶å€™è¯»Bobçš„è´¦æˆ·çœ‹åˆ°çš„å€¼å°±æ˜¯$3ã€‚</p>
<p><a href="https://imgtu.com/i/TMpNX6"><img src="https://s4.ax1x.com/2021/12/21/TMpNX6.png" alt="TMpNX6.png"></a></p>
<p>5ã€æœ€åæ›´æ–°Bobè´¦æˆ·ä¿¡æ¯ï¼Œæ“ä½œåŒæ­¥4ï¼Œåˆ é™¤é”&amp;æ·»åŠ æ—¶åˆ»8çš„ä¿¡æ¯ã€‚å¦‚æœæ˜¯å¤šè¡Œéœ€è¦æ›´æ–°ï¼Œä¹Ÿæ˜¯row by rowçš„å»æ›´æ–°ã€‚</p>
<p><a href="https://imgtu.com/i/TMC9Ig"><img src="https://s4.ax1x.com/2021/12/21/TMC9Ig.png" alt="TMC9Ig.png"></a></p>
<p>çœ‹ä¸‹äº‹åŠ¡ç›¸å…³çš„3åˆ—ï¼š</p>
<p>c:lock : é”ä¿¡æ¯ï¼Œæ´»è·ƒäº‹åŠ¡ã€‚</p>
<p>c:write ï¼šæäº¤äº‹åŠ¡ã€‚å¦‚æœprimaryå·²ç»commitäº†ï¼Œä¸ç®¡secondaryæœ‰æ²¡æœ‰åº”ç”¨å®Œï¼Œéƒ½æ˜¯æäº¤äº‹åŠ¡ã€‚</p>
<p>c:data ï¼š å­˜å‚¨çš„å°±æ˜¯å„ä¸ªæ—¶åˆ»çš„æ•°æ®ã€‚</p>
<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹ä¹‹å‰æå‡ºçš„é—®é¢˜æ€ä¹ˆä½¿ç”¨ä¸Šé¢çš„æ¨¡å‹ä¸€ä¸ªä¸ªçš„è§£å†³æ‰ã€‚</p>
<p>1ã€T1äº‹åŠ¡æ›´æ–°(a,b)ä¸¤æ¡è®°å½•ï¼Œæ€ä¹ˆçŸ¥é“è®°å½•åœ¨å“ªäº›åˆ†ç‰‡ä¸Šï¼Ÿ</p>
<p>â€‹     ä»PDé‡Œé¢è·å–ï¼Œè¿™ä¸ªä¸æ˜¯äº‹åŠ¡æäº¤çš„é‡ç‚¹ï¼Œåé¢å¯ä»¥ç ”ç©¶ä¸‹æ•°æ®åˆ†å¸ƒçš„ç­–ç•¥ã€‚</p>
<p>2ã€T1äº‹åŠ¡åŒæ—¶æ›´æ–°äº†2ä¸ªåˆ†ç‰‡ï¼Œæ€ä¹ˆä¿è¯åŸå­æ€§ï¼ŒåŒæ—¶æˆåŠŸorå¤±è´¥ï¼Ÿ</p>
<p>â€‹     2é˜¶æ®µæäº¤ï¼Œå…ˆprewriteï¼Œå†commitï¼Œä»¥primary:writeä½œä¸ºäº‹åŠ¡æäº¤çš„æ ‡å‡†ã€‚</p>
<blockquote>
<p>ğŸ¤”: ä¸ºå•¥ä¸ç›´æ¥å…¨éƒ¨åŠ é”ï¼Œè¦è¿™æ ·éº»çƒ¦çš„ä½¿ç”¨2é˜¶æ®µï¼Ÿ</p>
<p>â€‹      å¦‚æœç›´æ¥åŠ é”ï¼Œé‚£åœ¨æ•´ä¸ªæäº¤è¿‡ç¨‹ä¸­éƒ½ä¸å¯ç”¨ã€‚row by rowçš„æäº¤&amp;é‡Šæ”¾èƒ½éƒ¨åˆ†ä¼˜åŒ–æ€§èƒ½ã€‚</p>
</blockquote>
<blockquote>
<p>ğŸ¤”: ä¸ºå•¥è¦åœ¨prewriteé˜¶æ®µå†™æ•°æ®ï¼Œä¸åœ¨commité˜¶æ®µå†™å‘¢ï¼Ÿ</p>
<p>â€‹       ä»¥ä¸Šé¢çš„æƒ…å†µä¸ºä¾‹ï¼ŒJoeè´¦æˆ·åœ¨å¼‚æ­¥åº”ç”¨ä¹‹å‰ï¼Œç‰ˆæœ¬7åªæœ‰lockï¼Œæ²¡æœ‰dataï¼Œå¿…é¡»å¾—ç­‰åˆ°æ‰€æœ‰çš„è¡Œéƒ½å¼‚æ­¥çš„åº”ç”¨å®Œäº†æ•°æ®ï¼Œæ‰èƒ½ç»™å®¢æˆ·ç«¯è¿”å›ï¼Œéå¸¸å®¹æ˜“è¶…æ—¶ã€‚</p>
</blockquote>
<blockquote>
<p>ğŸ¤”: æ—¢ç„¶æœ‰2é˜¶æ®µï¼Œæ˜¯ä¸æ˜¯é©¬ä¸Šæƒ³åˆ°äº†åè°ƒå™¨ï¼Ÿ</p>
<p>â€‹      å®é™…ä¸Špercolatoræ¨¡å‹ä½¿ç”¨writeåˆ—æ¥å¼±åŒ–äº†è¿™ä¸€ç‚¹ï¼Œåœ¨commité˜¶æ®µå¹¶ä¸éœ€è¦é€šçŸ¥æ‰€æœ‰rowå»commitï¼Œåªéœ€è¦å®Œæˆprimary rowçš„æ›´æ–°å³å¯ã€‚åé¢ç”±å¼‚æ­¥çš„ä»»åŠ¡å»å®ç°ã€‚åœ¨prewriteé˜¶æ®µç¡®å®éœ€è¦ç¡®ä¿æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„è¡Œéƒ½é¡ºåˆ©åŠ é”å¹¶æ›´æ–°dataã€‚            </p>
</blockquote>
<blockquote>
<p>ğŸ¤”: æ€ä¹ˆè·å–tsï¼Ÿ</p>
<p>â€‹      è¿™é‡Œçš„æ—¶åˆ»5ã€6ã€7æ˜¯æ€ä¹ˆå»è·å–çš„ï¼Œä¹Ÿå°±æ˜¯åŸå­é’Ÿã€‚ä»PDå»æ‹¿ï¼Œé‚£ä¹ˆå¾ˆæ˜¾ç„¶ï¼Œå¹¶å‘é«˜çš„æ—¶å€™è¿™é‡Œå°±æ˜¯ç“¶é¢ˆäº†ã€‚</p>
</blockquote>
<p> 3ã€æ¯ä¸€æ¡è®°å½•åˆæœ‰3ä¸ªå‰¯æœ¬ï¼Œæ€ä¹ˆä¿è¯å¤šå‰¯æœ¬çš„åŒæ­¥ï¼Ÿ</p>
<p>â€‹    TiDBä½¿ç”¨Raftåè®®æ¥åœ¨å¤šæ•°èŠ‚ç‚¹ä¸ŠåŒæ­¥æ•°æ®ï¼ŒRaftåè®®çš„å®ç°ä¹‹å‰çš„blogå·²ç»åˆ†æäº†ï¼Œè¯¦æƒ…è¯·ç§»æ­¥ã€‚</p>
<p>4ã€T1/T2åŒæ—¶æ›´æ–°åˆ†ç‰‡2ï¼Œä¼šä¸ä¼šæœ‰å†²çªï¼Ÿå†²çªæ£€æµ‹æ€ä¹ˆåšï¼Ÿå¦‚æœæœ‰å†²çªæ€ä¹ˆåŠï¼Ÿ </p>
<p>â€‹    ä¸Šé¢çš„æµç¨‹ä¸­æˆ‘ä»¬ä½¿ç”¨ä¹è§‚é”æ¥è·å–secondaryé”ï¼Œä½†æ˜¯å®é™…ä½¿ç”¨ä¸Šå†²çªå¤§çš„æ—¶å€™è·å–é”çš„æ¦‚ç‡ä½ï¼Œè¿™æ ·å¾ˆå®¹æ˜“å¯¼è‡´äº‹åŠ¡å›æ»šã€‚æˆ‘ä»¬å…ˆæ¥å¯¹æ¯”ä¸‹ä¹è§‚é” VS æ‚²è§‚é”</p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ç”Ÿæ´»ä¾‹å­</th>
<th>å›¾ä¾‹</th>
<th>ç‰¹å¾</th>
</tr>
</thead>
<tbody><tr>
<td>ä¹è§‚é”</td>
<td>ç›´æ¥å»é¤å…å»åƒé¥­<br />1. äººå¤šæ²¡åœ°ï¼Œåœ¨å›æ¥ï¼Œç™½è·‘ä¸€è¶Ÿ<br />2. äººå°‘æœ‰åœ°ç›´æ¥åƒäº†</td>
<td>T1å•äº‹åŠ¡<br />    a,bæ²¡æœ‰é”,å¯ä»¥ç›´æ¥åŠ ä¸Š<br />T1&amp;T2å¹¶å‘<br />    T1å…ˆæ¥a,bä¸Šé”<br />    T2:b,eæ— æ³•è·å–bçš„é”ï¼Œå›æ»š</td>
<td>å†²çªå°‘ï¼šæ€§èƒ½é«˜<br />å†²çªå¤šï¼šå›æ»šä»£ä»·å¤§</td>
</tr>
<tr>
<td>æ‚²è§‚é”</td>
<td>1. å…ˆæ‰“ç”µè¯ç¡®è®¤&amp;é¢„å®š&amp;ä»˜å®šé‡‘<br />2. å»é¤å…åƒé¥­</td>
<td>T1å•äº‹åŠ¡<br />    å³ä½¿a,bæ²¡æœ‰é”,ä¹Ÿè¦å…ˆç¡®è®¤åœ¨å¼€å§‹äº‹åŠ¡<br />T1&amp;T2å¹¶å‘<br />    T1å…ˆç¡®è®¤ï¼Œå¼€å§‹äº‹åŠ¡ç»™a,bä¸Šé”<br />    T2å…ˆç¡®è®¤æ— æ³•è·å–é”ï¼Œä¸å¼€å§‹äº‹åŠ¡ï¼Œä¸éœ€è¦å›æ»š</td>
<td>å†²çªå°‘ï¼šé”ç¡®è®¤è¿‡ç¨‹æœ‰æ¶ˆè€—<br />å†²çªå¤šï¼šé¿å…ä¸å¿…è¦çš„å›æ»š</td>
</tr>
</tbody></table>
<blockquote>
<p>ğŸ¤” æ‚²è§‚é”çš„æƒ…å†µä¸‹ï¼ŒT1(update a,b)æŒæœ‰a,bè¡Œé”ï¼Œæ­¤æ—¶T2(update b,c)å’ŒT3(update b,a)åŒæ—¶è¿‡æ¥ã€‚æ˜¾ç„¶éƒ½æ— æ³•è·å–éœ€è¦çš„è¡Œbçš„é”ï¼Œæ¥ä¸‹æ¥æ˜¯T2æŒæœ‰cè¡Œé”ï¼ŒT3ç­‰ï¼›è¿˜æ˜¯T2&amp;T3æ’é˜Ÿç­‰ï¼Ÿæ˜¯å°½é‡å…ˆæŒæœ‰èƒ½æŒæœ‰çš„è¡Œé”ï¼Œè¿˜æ˜¯ç­‰èƒ½æŒæœ‰æ‰€æœ‰è¡Œçš„é”ï¼Ÿ</p>
</blockquote>
<p>5ã€T1/T3ç”¨ä¸åŒçš„é¡ºåºæ›´æ–°ç›¸åŒçš„æ•°æ®ï¼Œä¼šä¸ä¼šæ­»é”ï¼Ÿ </p>
<p>â€‹      æ­»é”æ£€æµ‹</p>
<p>6ã€ä¸åŒçš„éš”ç¦»çº§åˆ«æ€ä¹ˆå®ç°ï¼Ÿ</p>
<p>â€‹      MVCCï¼Œä»ä¸Šé¢çš„æµç¨‹æˆ‘ä»¬çœ‹åˆ°äº†ï¼Œä¸€è¡Œè®°å½•çš„ä¿®æ”¹æ˜¯ä¼šä¿ç•™å¤šä¸ªç‰ˆæœ¬çš„ã€‚ä»¥å¯é‡å¤åº¦çš„æƒ…å†µä¸ºä¾‹è¯´æ˜ã€‚åœ¨è¿›è¡Œè¯»æ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœéœ€è¦çš„è¡Œæœ‰lockä¿¡æ¯ï¼Œè¯´æ˜è¿™ä¸€è¡Œæ­£åœ¨è¢«æ”¹ï¼Œæ ¹æ®start_tsæ‰¾åˆ°æœ€è¿‘ä¸€ä¸ªå·²ç»æäº¤çš„ç‰ˆæœ¬(writeåˆ—ä¸­å»æ‰¾)ï¼Œç„¶åå»åˆ°å¯¹åº”çš„(dataåˆ—è·å–åˆ°æ•°æ®)ã€‚</p>
<p>7ã€ç‰ˆæœ¬æ¸…ç†é—®é¢˜</p>
<p>â€‹    é”æ¸…ç†ï¼šprimary_locké”è¶…æ—¶ï¼Œå›æ»šã€‚secondary_lockï¼Œå¦‚æœprimary_lockå·²ç»æäº¤ï¼Œé‚£å°±æäº¤ï¼Œå¦åˆ™å°±å›æ»šã€‚å¦‚æœprimary_lockè¿˜åœ¨ï¼Œé‚£å°±æ˜¯è¶…æ—¶ï¼Œè¶…æ—¶å›æ»šå³å¯ã€‚</p>
<p>â€‹    GCæ¸…ç†ï¼šæ¯”å¦‚æ²¡10minæ¸…ç†ä¸€æ¬¡ï¼Œæœ¬æ¬¡æ¸…ç†çš„è§¦å‘æ“ä½œå°±å°†10minä¹‹å‰çš„æ•°æ®å¹²æ‰ï¼ŒåŸåˆ™ä¸Šä¿ç•™æœ€è¿‘10minçš„æ•°æ®ã€‚ä¸è¿‡å¾—åˆç†è€ƒè™‘ä¸‹æ¸…ç†å¸¦æ¥çš„æŠ–åŠ¨ã€‚å°æ‰¹å¤šæ¬¡ç†è®ºä¸Šæ¯”è¾ƒå¥½è®¾å®šï¼Œå°½é‡å‡å°‘æ¯æ¬¡æ“ä½œçš„åŠ¨é™ã€‚å¯¹drop tableæˆ–è€…truncate tableä¼˜åŒ–ä¸‹å¤§é‡è¿ç»­åˆ é™¤ã€‚</p>
<p>8ã€</p>
<p>â€‹    åŒä¸€ä¸ªserver    </p>
<p>â€‹    ä¸åŒçš„server</p>
<p>Qï¼šé”ä¿¡æ¯ï¼Œå¯¹æ¯”mysqlå•èŠ‚ç‚¹ï¼Œå¤šèŠ‚ç‚¹æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è‡ªå·±çš„é”ä¿¡æ¯ï¼ŒT1è·¨èŠ‚ç‚¹äº†ï¼Œæ€ä¹ˆçŸ¥é“aã€bè¡Œåˆ†åˆ«çš„é”ä¿¡æ¯</p>
<p>Qï¼šé”ä¿¡æ¯çš„ç»Ÿä¸€ç®¡ç†ï¼Œé¿å…ä¸¤é˜¶æ®µç¡®è®¤ï¼Ÿ</p>
<h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><p>åŸç†å›¾ï¼šå…ˆè–…ä¸¤å¼ å®˜ç½‘çš„å›¾è¿‡æ¥çœ‹çœ‹ï¼Œä¹è§‚ VS æ‚²è§‚</p>
<p>Parser -&gt; Optimize -&gt; Executor</p>
<p>Server/conn.go(Run) -&gt;  dispatch -&gt; handleQuery(Parse -&gt; )</p>
<p>session -&gt; Compiler (Compile compiles an ast.StmtNode to a physical plan.) </p>
<p>ExecuteStmt â€“ è¿™é‡Œæ¶‰åŠåˆ°äº‹åŠ¡ç›¸å…³çš„å†…å®¹äº†</p>
<h4 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h4><p><strong>å‚è€ƒæ–‡æ¡£</strong></p>
<p><a href="https://www.jianshu.com/p/bca8a678fafc">https://www.jianshu.com/p/bca8a678fafc</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/349445778">https://zhuanlan.zhihu.com/p/349445778</a></p>
<p><a href="https://www.bilibili.com/video/BV1ox411R7EA?spm_id_from=333.999.0.0">https://www.bilibili.com/video/BV1ox411R7EA?spm_id_from=333.999.0.0</a></p>
]]></content>
      <tags>
        <tag>åˆ†å¸ƒå¼äº‹åŠ¡</tag>
        <tag>tidb</tag>
      </tags>
  </entry>
  <entry>
    <title>hashicorp-raftæºç ç³»åˆ—-4-leaderé€»è¾‘</title>
    <url>/2021/12/20/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-4-leader%E9%80%BB%E8%BE%91/</url>
    <content><![CDATA[<p>å‰é¢ä¸‰ç¯‡æˆ‘ä»¬åˆ†åˆ«ä»‹ç»äº†Raftçš„APIã€ç½‘ç»œå±‚ã€å­˜å‚¨å±‚ï¼Œä»è¿™ä¸€ç¯‡å¼€å§‹æˆ‘ä»¬æ¥çœ‹Raftçš„<code>Leaderã€Candidateã€Follower</code>å®ç°ã€‚</p>
<h4 id="r-runLeaderé€»è¾‘"><a href="#r-runLeaderé€»è¾‘" class="headerlink" title="r.runLeaderé€»è¾‘"></a>r.runLeaderé€»è¾‘</h4><p>äº‹åŠ¡æäº¤çš„è¿‡ç¨‹ï¼šæ¥ç€æˆ‘ä»¬ä¸€ç‚¹ç‚¹åˆ†æï¼Œ</p>
<h5 id="å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•"><a href="#å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•" class="headerlink" title="å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•"></a>å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Apply</span></span><br><span class="line"><span class="comment">//  -&gt; ApplyLog</span></span><br><span class="line"><span class="comment">// å†™çš„æ—¶å€™ä¹Ÿä¸éœ€è¦è¿”å›ä»€ä¹ˆï¼Œä¸»è¦å°±æ˜¯Check Error</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">ApplyLog</span><span class="params">(log Log, timeout time.Duration)</span> <span class="title">ApplyFuture</span></span> &#123;</span><br><span class="line">  logFuture := &amp;logFuture&#123;</span><br><span class="line">    log: Log&#123;</span><br><span class="line">      Type:       LogCommand,</span><br><span class="line">      Data:       log.Data,</span><br><span class="line">      Extensions: log.Extensions,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  logFuture.init()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// è¿™ä¸ªå†™æ³•å¾ˆæœ‰æ„æ€ï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ”¾åˆ°applyChé©¬ä¸Šè¿”å›ï¼Œè¿™ä¸ªæ—¶å€™return logFutureä¸ä¸€å®šæœ‰æ•°æ®çš„å§ï¼Œclientæ€ä¹ˆåˆ¤æ–­æ“ä½œæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥å‘¢ã€‚</span></span><br><span class="line">  <span class="keyword">case</span> r.applyCh &lt;- logFuture:</span><br><span class="line">    <span class="keyword">return</span> logFuture</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="runLeader"><a href="#runLeader" class="headerlink" title="runLeader()"></a>runLeader()</h5><p>æ¥ç€æˆ‘ä»¬çœ‹ä¸‹leaderåˆå§‹åŒ–çš„æ—¶å€™ä¼šå¹²äº›å•¥ï¼Œé‡ç‚¹çœ‹ä¸‹åˆå§‹åŒ–çš„åå°å¤„ç†åç¨‹ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">runLeader</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// ?? leaderChè¿™ä¸ªchanè¿˜çœŸçš„æ˜¯ä¸çŸ¥é“å¹²å•¥çš„ï¼Œåé¢æœ‰æ—¶é—´åœ¨é‡ç‚¹çœ‹ä¸‹</span></span><br><span class="line">  overrideNotifyBool(r.leaderCh, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setup leader stateï¼Œä¸»è¦æ˜¯èŠ‚ç‚¹çš„ä¿¡æ¯</span></span><br><span class="line">  r.setupLeaderState()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®šä¹‰æ¸…ç†é€»è¾‘</span></span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">   ...</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡ç‚¹ï¼šä¸ºæ¯ä¸€ä¸ªpeerå¯åŠ¨ä¸€ä¸ªLogå¤åˆ¶åç¨‹ï¼Œ</span></span><br><span class="line">  r.startStopReplication()</span><br><span class="line">  <span class="comment">//  è°ƒç”¨-&gt; r.goFunc(func() &#123; r.replicate(s) &#125;)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å§‹leaderå¾ªç¯</span></span><br><span class="line">  r.leaderLoop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Leaderæ¶ˆè´¹r-applyCh"><a href="#Leaderæ¶ˆè´¹r-applyCh" class="headerlink" title="Leaderæ¶ˆè´¹r.applyCh"></a>Leaderæ¶ˆè´¹r.applyCh</h5><p>å°†å®¢æˆ·ç«¯çš„å†™å‡‘æˆä¸€æ‰¹ï¼Œ</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> newLog := &lt;-r.applyCh:</span><br><span class="line">  <span class="comment">// Group commit, ç»„æäº¤</span></span><br><span class="line">  ready := []*logFuture&#123;newLog&#125;</span><br><span class="line">GROUP_COMMIT_LOOP:</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; r.config().MaxAppendEntries; i++ &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> newLog := &lt;-r.applyCh:</span><br><span class="line">      ready = <span class="built_in">append</span>(ready, newLog)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span> GROUP_COMMIT_LOOP</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Dispatch the logs</span></span><br><span class="line">  <span class="keyword">if</span> stepDown &#123;</span><br><span class="line">     ....</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    r.dispatchLogs(ready)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€çœ‹çœ‹dispatchLogsé€»è¾‘</p>
<p>åŠ r.leaderState.inflight list, è¡¨ç¤ºéœ€è¦å¤„ç†çš„applyLogs</p>
<p>æ—¥å¿—æŒä¹…åŒ– r.logs.StoreLogs(logs)ï¼Œç±»æ¯”mysql æŒä¹…åŒ–redo log</p>
<p>å°†è‡ªå·±çš„log indexå¾€å‰ï¼Œå¹¶ä¸”é€šçŸ¥<code>commitCh</code></p>
<p>æŒä¹…åŒ–lastIndexï¼Œr.setLastLog(lastIndex, term)</p>
<p>é€šçŸ¥æ¯ä¸ªreplicationæ–°Log â€“  asyncNotifyCh(f.triggerCh)  </p>
<p>æ¥ç€å°±æ˜¯ä¸Šé¢çš„åˆå§‹åŒ–çš„æ—¶å€™å¹²çš„äº‹æƒ…äº†ï¼Œç»™æ¯ä¸ªchannelå‘æ¶ˆæ¯</p>
<p>æƒ³æƒ³å“ªäº›æ˜¯å¼‚æ­¥çš„ï¼Ÿä¸ºå•¥è¦å¼‚æ­¥å¤„ç†å‘¢ï¼Ÿ</p>
<p>ææ¸…æ¥šé‡ç‚¹</p>
<p>ä¸‹é¢çš„<code>observe</code>æ˜¯å¹²å•¥çš„ï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">r.observe(LeaderObservation&#123;Leader: leader&#125;)</span><br></pre></td></tr></table></figure>

<p>client å†™è¯·æ±‚ :api.go   Applyæ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªApplyFutureå¯¹è±¡ï¼ŒåŒ…å«reqã€responseã€error</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>â€“&gt;  å‘æ¶ˆæ¯ append entity â€“&gt; å¤šæ•°æ´¾çš„å›å¤  â€“ &gt; å®¢æˆ·ç«¯è¿”å›  â€“&gt; åº”ç”¨FSM(å¦ä¸€ä¸ªæµç¨‹)â€“&gt; é€šçŸ¥å…¶ä»–èŠ‚ç‚¹å¯ä»¥åº”ç”¨ â€“</p>
<p>clientè¿”å›çš„æ ‡å‡†æ˜¯å•¥ï¼Ÿæ—¥å¿—å¤šæ•°æ´¾ or  Master applyæˆåŠŸ(ä¸å¯èƒ½)   </p>
<p>è®¤çœŸç¢ç£¨å…¶ä¸­çš„ä¼˜åŒ–</p>
<h4 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h4><p>1ã€chané‡Œé¢åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”ä¸èƒ½å¹¶å‘è°ƒç”¨ã€‚ä¸‹é¢ä»£ç çš„ç†è§£ï¼Œåˆ°åº•æ˜¯æ€ä¹ˆé¿å…å¹¶å‘è°ƒç”¨çš„ï¼Ÿè¿˜æœ‰åˆ«çš„å®ç°å—ï¼Ÿè¿™ä¸ªå®ç°æ˜¯ä¸æ˜¯æœ‰ç‚¹trickï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">overrideNotifyBool</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">bool</span>, v <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> ch &lt;- v:</span><br><span class="line">    <span class="comment">// value sent, all done</span></span><br><span class="line">  <span class="keyword">case</span> &lt;-ch:</span><br><span class="line">    <span class="comment">// channel had an old value</span></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ch &lt;- v:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">panic</span>(<span class="string">&quot;race: channel was sent concurrently&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2ã€<code>leaderLoop</code>è¿™ä¸ªé‡Œé¢å…¨æ˜¯å¼‚æ­¥çš„chanï¼Œä»£ç è§„åˆ’çš„éå¸¸å¥½ï¼Œå¾ˆå€¼å¾—å­¦ä¹ </p>
]]></content>
      <tags>
        <tag>raft</tag>
      </tags>
  </entry>
  <entry>
    <title>blogæŠ˜è…¾è®°å½•</title>
    <url>/2021/12/17/blog%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>æœ€è¿‘å¼€å§‹é‡æ‹¾å†™blogçš„ä¹ æƒ¯ï¼Œæƒ³ç€åšæŒç‚¹å•¥å§ã€‚</p>
<p>ç»“æœå°†githubä¸Šçš„ç½‘ç«™æ‰“å¼€ï¼Œ2020-03æœ€è¿‘ä¸€ç¯‡ï¼Œç°åœ¨å¯æ˜¯2021-12æœˆäº†ï¼Œæç½®äº†1å¹´9ä¸ªæœˆï¼ŒçœŸè¡Œã€‚</p>
<p>ç„¶åæ‰“ç®—ä¸Šä¼ ä¸€ç¯‡blogï¼Œå‘ç°æ–°ç”µè„‘ä¸Šç¯å¢ƒä¹Ÿæ²¡æœ‰äº†ã€‚å¤§è„‘å¼€å§‹å‘Šè¯‰è¿è½¬ï¼Œå¥½å§~ å®Œå…¨æ²¡æœ‰ä¸€ç‚¹æ˜ åƒã€‚</p>
<p>å› æ­¤ï¼Œæ‰“ç®—ä¹–ä¹–çš„å†™æ–‡ç« è®°å½•ï¼Œå¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œå…ˆäººä»¬ä¸æ›¾æ¬ºæˆ‘å•Š~</p>
<h4 id="æ“ä½œè®°å½•"><a href="#æ“ä½œè®°å½•" class="headerlink" title="æ“ä½œè®°å½•"></a>æ“ä½œè®°å½•</h4><p>ä¹‹å‰è¿˜æŠ˜è…¾ä»€ä¹ˆmwebï¼Œä¸€é”®éƒ¨ç½²å¤šä¸ªå¹³å°å•¥çš„ã€‚ç°åœ¨å¯èƒ½æ˜¯æ€æƒ³è§‚å¿µå˜äº†ï¼Œå†…å®¹å¹³å°è¿˜æ˜¯ä»¥å†…å®¹ä¸ºä¸»ã€‚æ—¢ç„¶éƒ½èŠ±äº†é‚£ä¹ˆå¤šå¿ƒæ€å†™äº†ï¼Œéš¾é“è¿˜ä¸èƒ½å»å„ä¸ªå¹³å°æºœè¾¾ä¸€åœˆéƒ¨ç½²ä¸‹ã€‚</p>
<h5 id="ç”¨ä»€ä¹ˆå†™ï¼Ÿ"><a href="#ç”¨ä»€ä¹ˆå†™ï¼Ÿ" class="headerlink" title="ç”¨ä»€ä¹ˆå†™ï¼Ÿ"></a>ç”¨ä»€ä¹ˆå†™ï¼Ÿ</h5><blockquote>
<p>Typero</p>
</blockquote>
<h5 id="ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ"><a href="#ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ" class="headerlink" title="ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ"></a>ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ</h5><blockquote>
<p> è·¯è¿‡å›¾åºŠã€‚å°±æ˜¯è§‰å¾—å‰ªè´´æ¿ç›´æ¥ctrl+vå¾ˆæ–¹ä¾¿ï¼Œæ‡’å¾—æ¢ã€‚</p>
</blockquote>
<h5 id="å‘å¸ƒåˆ°å“ª"><a href="#å‘å¸ƒåˆ°å“ª" class="headerlink" title="å‘å¸ƒåˆ°å“ª"></a>å‘å¸ƒåˆ°å“ª</h5><p>åŸåˆ™å°±æ˜¯æ”¯æŒMDå¯¼å…¥</p>
<ul>
<li>githubï¼Œå¯ä»¥å»ç™¾åº¦æ™ºèƒ½äº‘ä¸Šå»ç”³è¯·ä¸€ä¸ªåŸŸåï¼Œä¾¿å®œçš„ä¸€å¹´å°±13å…ƒï¼Œä¸è¿‡ç»­è´¹æ¯”è¾ƒè´µâ˜ºï¸ã€‚</li>
<li>csdn</li>
<li>cnblog(ä¸æ”¯æŒMDå¯¼å…¥ï¼Œæœ‰ç‚¹æ„äºº)</li>
<li>ç®€ä¹¦(ä¸æ”¯æŒMDå¯¼å…¥ï¼Œæ”¾å¼ƒ)</li>
</ul>
<h5 id="hexoä¸githubé…ç½®"><a href="#hexoä¸githubé…ç½®" class="headerlink" title="hexoä¸githubé…ç½®"></a>hexoä¸githubé…ç½®</h5><p>è¯´èµ·æ¥æˆ‘ä¹‹å‰å¼„è¿‡ä¸€ç‰ˆï¼Œä½†æ˜¯å®Œæˆå¿˜è®°äº†ã€‚æ›´æƒ¨çš„æ˜¯gitä»“åº“çš„ä¸œè¥¿éƒ½ä¸çŸ¥é“æ€ä¹ˆå¤ç”¨ï¼Œåªèƒ½å®Œå…¨é‡æ¥ï¼Œå°±å½“æ˜¯ä¸€ä¸ªæ–°çš„å¼€å§‹å¥½äº†ã€‚</p>
<p>å…ˆå°†ä¸€æ¬¡æ€§çš„æ“ä½œåšäº†ï¼Œå®‰è£…&amp;é…ç½®ã€‚é…ç½®æ–‡ä»¶åªæœ‰2ä¸ªï¼Œä¸€å®šè¦åšå¥½å¤‡ä»½</p>
<p>_config.yml: ç½‘ç«™é…ç½®</p>
<p>themes/next/_config.ymlï¼šä¸»é¢˜é…ç½®</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> macä¸Šå®‰è£…hexo</span></span><br><span class="line">brew install hexo</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆå§‹åŒ–é¡¹ç›®</span></span><br><span class="line">hexo init myblog</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> nextä¸»é¢˜</span></span><br><span class="line">git clone https://github.com/theme-next/hexo-theme-next themes/next</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®šåˆ¶åŒ–é…ç½® _config.yml</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># siteï¼š è¿™åŠ›çš„languageè¦å’Œä¸»é¢˜é‡Œé¢çš„themes/next/languagesä¸‹é¢çš„æ–‡ä»¶èƒ½å¯¹åº”æ‰è¡Œ</span></span></span><br><span class="line">title: Moonshine&#x27;s Blog</span><br><span class="line">subtitle: &#x27;æ—¥æ‹±ä¸€å’æ— æœ‰å°½ï¼ŒåŠŸä¸å”æç»ˆå…¥æµ·&#x27;</span><br><span class="line">description: &#x27;é¢¨ãŒå¹ã„ã¦è‘‰ãŒè½ã¡ã€è½ã¡è‘‰ã¯åœŸå£Œã®è‚¥ã‚„ã—ã¨ãªã‚ŠåœŸå£Œã‚’è‚¥ãˆã•ã›ã€æœç‰©ãŒã‚†ã£ãã‚Šã¨ç€å®Ÿã«è‚²ã¤ã®ã§ã™&#x27;</span><br><span class="line">keywords: &#x27;æ•°æ®åº“&#x27;</span><br><span class="line">author: Moonshine</span><br><span class="line">language: zh-CN</span><br><span class="line">timezone: &#x27;&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># url</span></span></span><br><span class="line">url: https://zhangtinglu.github.io/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ä¸»é¢˜</span></span></span><br><span class="line">theme: next</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># éƒ¨ç½²git</span></span></span><br><span class="line">deploy:</span><br><span class="line">  type: &#x27;git&#x27;</span><br><span class="line">  repo: &#x27;https://github.com/zhangtinglu/zhangtinglu.github.io&#x27;</span><br><span class="line">  branch: &#x27;master&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ä»£ç è¯­æ³•é«˜äº®ï¼Œå°†prismjsæ”¹æˆtrueå°±è¡Œäº†</span></span></span><br><span class="line">prismjs:</span><br><span class="line">  enable: true </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®šåˆ¶themeé…ç½® themes/next/_config.yml -- æœ‰ç‚¹å¤šï¼Œç›´æ¥å¤‡ä»½å§</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŠŠè‡ªå·±éœ€è¦çš„éœ€è¦çš„pageå®‰è£…ä¸‹</span></span><br><span class="line">hexo new page about</span><br><span class="line">hexo new page tags</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> é¦–é¡µæ‘˜è¦ -- å¤ªè´¹åŠ²äº†ï¼Œç›´æ¥ç”¨å½’æ¡£é¡µé¢å½“æˆä¸»é¡µ</span></span><br><span class="line">~/myblog/themes/next/layout </span><br><span class="line">mv index.swig index_bak.swig</span><br><span class="line">cp archive.swig index.swig</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä»£ç å¯æŠ˜å  - æ”¶ç¼©</span></span><br><span class="line">codeblock:</span><br><span class="line">  highlight_theme: night</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ˜¾å¾—å¤ªå¤§äº† -- ä¸ç®¡èƒ½çœ‹å°±è¡Œ</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ–‡ç« ç›®å½•</span></span><br><span class="line">toc:</span><br><span class="line">  expand_all: true</span><br></pre></td></tr></table></figure>

<p>æ¥ç€å°±æ˜¯å¹³å¸¸ä½¿ç”¨äº†ï¼Œåˆ›å»ºblog-deploy</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…ˆå°†hello worldè¿™ä¸ªpageåˆ é™¤</span></span><br><span class="line">rm -rf /source/_posts/hello-world.md</span><br><span class="line">hexo new &#x27;blog&#x27;</span><br><span class="line">hexo s</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> éƒ¨ç½²</span></span><br><span class="line">hexo d -g</span><br></pre></td></tr></table></figure>

<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>çœŸçš„å‰ç«¯åšåˆ°æœ€åï¼Œè§‰å¾—ä¼šç–¯ï¼Œå¤ªå®¹æ˜“äº§ç”Ÿå¼ºè¿«ç—‡äº†ã€‚</p>
]]></content>
      <tags>
        <tag>hexoé…ç½®</tag>
      </tags>
  </entry>
  <entry>
    <title>hashicorp:raftæºç ç³»åˆ—(3)--å­˜å‚¨å±‚</title>
    <url>/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-3-%E5%AD%98%E5%82%A8%E5%B1%82/</url>
    <content><![CDATA[<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>æ¥ç€ä¸Šä¸€ç¯‡æˆ‘ä»¬è®²äº†ç½‘ç»œå±‚ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥è®²<code>LogStoreã€StableStoreã€FSMã€SnapshotStore</code>ï¼Œä¸ºå•¥è¿™äº›ä¸€èµ·è®²å‘¢ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯å­˜å‚¨ç›¸å…³ï¼Œå¹¶ä¸”åŠŸèƒ½ç›¸å¯¹ç®€å•ï¼Œå¹¶æ²¡æœ‰åƒ<code>Transport</code>é‚£æ ·æœ‰<code>NetworkTransport</code>å®ç°å¯ä»¥ç”¨æ¥è¿›è¡Œåˆ†æã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">Â <span class="function"><span class="keyword">func</span> <span class="title">NewRaft</span><span class="params">(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans Transport)</span> <span class="params">(*Raft, error)</span></span> &#123; Â    	......&#125;</span><br></pre></td></tr></table></figure>

<h4 id="StableStore"><a href="#StableStore" class="headerlink" title="StableStore"></a>StableStore</h4><p>è¿™ä¸ªç»„ä»¶ä¸»è¦å°±æ˜¯ä¸ºäº†å®‰å…¨è€ƒè™‘è€Œå­˜åœ¨çš„ï¼Œæä¾›ä¸€ä¸ªå¯ä»¥æŒä¹…åŒ–k-vçš„å­˜å‚¨çš„å³å¯ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> StableStore <span class="keyword">interface</span> &#123;</span><br><span class="line">  Set(key []<span class="keyword">byte</span>, val []<span class="keyword">byte</span>) error</span><br><span class="line">  Get(key []<span class="keyword">byte</span>) ([]<span class="keyword">byte</span>, error)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// uint64æ˜¯æ—¥å¿—å·å’Œä»»æœŸå®šä¹‰çš„ç±»å‹ï¼Œæ–¹ä¾¿å­˜</span></span><br><span class="line">  SetUint64(key []<span class="keyword">byte</span>, val <span class="keyword">uint64</span>) error</span><br><span class="line">  GetUint64(key []<span class="keyword">byte</span>) (<span class="keyword">uint64</span>, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="LogStore"><a href="#LogStore" class="headerlink" title="LogStore"></a>LogStore</h4><p>è¿™ä¸ªç»„ä»¶å°±æ˜¯ä¸ºäº†å­˜æ—¥å¿—çš„ï¼Œæ¯”å¦‚ç”¨æˆ·å‘è¿‡æ¥<code>set a=1</code>, å°†è¿™ä¸ªå­˜èµ·æ¥å³å¯ã€‚å’Œä¸Šé¢çš„<code>StableStore</code>èƒ½åŠ›æ˜¯åŒä¸€ç§ï¼Œä¸è¿‡æ—¥å¿—å¯èƒ½æ¯”è¾ƒå¤šï¼Œéœ€è¦æ ¹æ®å®ç°æƒ…å†µè¿›è¡Œé€‰æ‹©ã€‚é¡¹ç›®åœ¨æµ‹è¯•çš„æ—¶å€™å®ç°äº†ä¸€ä¸ª<code>inmem</code>çš„æ—¥å¿—å­˜å‚¨ï¼Œç”¨äº†ä¸€ä¸ª<code>map</code>æ¥è¿›è¡Œå­˜å‚¨ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// inmemæ¨¡æ‹Ÿï¼Œç›´æ¥mapå­˜ï¼ŒåŸºæœ¬èƒ½åŠ›-è¯»å†™ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewInmemStore</span><span class="params">()</span> *<span class="title">InmemStore</span></span> &#123;</span><br><span class="line">  i := &amp;InmemStore&#123;</span><br><span class="line">    logs:  <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">uint64</span>]*Log),</span><br><span class="line">    kv:    <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">byte</span>),</span><br><span class="line">    kvInt: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">uint64</span>),</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="FSM"><a href="#FSM" class="headerlink" title="FSM"></a>FSM</h4><p>FMSçš„åŠŸèƒ½ï¼Œâ‘¡+â‘¢ä¸æ˜¯Raftçš„æ ¸å¿ƒé€»è¾‘ã€‚Raftå¯åŠ¨æ—¶å€™ä¼šæœ‰ä¸€ä¸ªåå°åç¨‹<code>runFSM</code>è´Ÿè´£æ¥åšä¸‹é¢çš„ä¸‰ä»¶äº‹ï¼ŒMainçº¿ç¨‹å°†åº”ç”¨æ—¥å¿—è¯·æ±‚æ”¾åˆ°<code>fsmMutateCh</code>é‡Œé¢ï¼Œå°†æ‰“å¿«ç…§çš„è¯·æ±‚æ”¾åˆ°<code>fsmSnapshotCh</code>é‡Œé¢ï¼Œä¸é˜»å¡Main</p>
<p>â‘  åº”ç”¨æ—¥å¿—ï¼Œraft logå¤šæ•°æ´¾å·²ç»ç¡®è®¤ï¼Œå°±å¯ä»¥åº”ç”¨åˆ°åº•å±‚å­˜å‚¨äº†ã€‚</p>
<p>â‘¡ å¿«ç…§</p>
<p>â‘¢ èŠ‚ç‚¹æ¢å¤</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> FSM <span class="keyword">interface</span> &#123;</span><br><span class="line">  Apply(*Log) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">  Snapshot() (FSMSnapshot, error)</span><br><span class="line">  Restore(io.ReadCloser) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">runFSM</span><span class="params">()</span></span> &#123;</span><br><span class="line">  commitSingle := <span class="function"><span class="keyword">func</span><span class="params">(req *commitTuple)</span></span>&#123;...&#125;</span><br><span class="line">  commitBatch := <span class="function"><span class="keyword">func</span><span class="params">(reqs []*commitTuple)</span></span>&#123;...&#125;</span><br><span class="line">  restore := <span class="function"><span class="keyword">func</span><span class="params">(req *restoreFuture)</span></span>&#123;...&#125;</span><br><span class="line">  snapshot := <span class="function"><span class="keyword">func</span><span class="params">(req *reqSnapshotFuture)</span></span>&#123;...&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ptr := &lt;-r.fsmMutateCh:</span><br><span class="line">      <span class="keyword">switch</span> req := ptr.(<span class="keyword">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> []*commitTuple:</span><br><span class="line">        commitBatch(req)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> *restoreFuture:</span><br><span class="line">        restore(req)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">panic</span>(fmt.Errorf(<span class="string">&quot;bad type passed to fsmMutateCh: %#v&quot;</span>, ptr))</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> req := &lt;-r.fsmSnapshotCh:</span><br><span class="line">      snapshot(req)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> &lt;-r.shutdownCh:</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>snapshotä¸æ˜¯é‡ç‚¹ï¼Œæ‰€ä»¥å…ˆç®€å•ä»‹ç»ä¸‹ï¼Œåç»­é‡è¯»çš„æ—¶å€™è¡¥ä¸Šè¿™ä¸€æ¨¡å—ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥çœ‹æœ€é‡è¦çš„Raftçš„é€»è¾‘ã€‚</p>
]]></content>
      <tags>
        <tag>raft</tag>
      </tags>
  </entry>
  <entry>
    <title>hashicorp:raftæºç ç³»åˆ—(2)--ç½‘ç»œå±‚</title>
    <url>/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-2-%E7%BD%91%E7%BB%9C%E5%B1%82/</url>
    <content><![CDATA[<h4 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><p>æ¥ç€ä¸Šé¢â€“å¯¼è¯»ï¼Œæœ¬ç¯‡è®²è§£Transportä¼ è¾“å±‚å®ç°ã€‚</p>
<p>å¦‚ä¸‹NewRaftå‡½æ•°çš„å‚æ•°ä¸­ï¼Œé™¤äº†Configç»“æ„ï¼Œå…¶ä»–éƒ½æ˜¯ä»¥interfaceå½¢å¼å®ç°ã€‚</p>
<p>æ¥ä¸‹æ¥å‡ ç¯‡æˆ‘ä»¬åˆ†åˆ«å¯¹è¿™5ç±»æ¥å£è¿›è¡Œè¯¦ç»†åˆ†æã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRaft</span><span class="params">(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans Transport)</span> <span class="params">(*Raft, error)</span></span> &#123;</span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶"><a href="#ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶" class="headerlink" title="ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶"></a>ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶</h4><ul>
<li><p>transport.go: å®šä¹‰ä¼ è¾“å±‚æ¥å£ï¼Œä¸‹å›¾ä¸­çš„Transport Interfaceå¯¹è±¡ã€‚</p>
</li>
<li><p>inmem_transport.go: ä»¥å†…å­˜çš„æ–¹å¼å®ç°Transportæ¥å£ï¼Œç”¨äºæµ‹è¯•ã€‚</p>
</li>
<li><p>net_transport.go: ç½‘ç»œæ–¹å¼å®ç°Transportæ¥å£ã€‚</p>
</li>
<li><p>tcp_transport.go: ä»¥TCPçš„æ–¹å¼å®ç°äº†NetworkTransportéœ€è¦çš„SteamLayerã€‚</p>
</li>
<li><p>command.goï¼šè¿™ä¸ªæ–‡ä»¶é‡Œé¢å®šä¹‰äº†å„ç§RPC requestå’Œresponseçš„ç»“æ„ï¼Œeg: AppendEntriesRequestã€AppendEntriesResponse</p>
<p><a href="https://imgtu.com/i/ovlYo6"><img src="https://s4.ax1x.com/2021/12/14/ovlYo6.png" alt="ovlYo6.png"></a></p>
</li>
</ul>
<p>æ€»ç»“ï¼ŒNetworkTransportå’ŒInmemTransportæ˜¯å¯¹Transportå±‚çš„å…·ä½“å®ç°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯¹NetworkTransportè¿›è¡Œè¯¦ç»†åˆ†æã€‚</p>
<h4 id="ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ"><a href="#ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ" class="headerlink" title="ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ"></a>ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</h4><h5 id="ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport-AppendEntrieså¼€å§‹"><a href="#ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport-AppendEntrieså¼€å§‹" class="headerlink" title="ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport_AppendEntrieså¼€å§‹"></a>ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport_AppendEntrieså¼€å§‹</h5><p>æµ‹è¯•ç”¨ä¾‹ä¸€èˆ¬èƒ½å‘Šè¯‰æˆ‘ä»¬æ€ä¹ˆç©ï¼Œè€ŒAppendEntrieså‘é€æ—¥å¿—åˆæ˜¯æœ€å¸¸ç”¨çš„åŠŸèƒ½ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±ä»è¿™é‡Œå¼€å§‹ã€‚</p>
<p><a href="https://imgtu.com/i/ovW3X4"><img src="https://s4.ax1x.com/2021/12/14/ovW3X4.md.png" alt="ovW3X4.md.png"></a></p>
<ol>
<li><p>åˆå§‹åŒ–æ¶ˆè´¹è€…(trans1)ï¼Œè¿™ä¸€æ­¥åé¢æ˜¯è¦è¯¦ç»†çœ‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ ‡æ˜Ÿã€‚</p>
</li>
<li><p>å¯åŠ¨æ¶ˆè´¹è€…ï¼Œç›‘å¬rpcChï¼Œä¹Ÿå°±æ˜¯Consumer()è¿”å›çš„åªè¯»channelã€‚ğŸ¤”ï¼šrpc.Respondå‡½æ•°åªæ˜¯ç»™respChæ·»åŠ äº†ä¸€ä¸ªå…ƒç´ ï¼Œé‚£è°æ¥æ¶ˆè´¹è¿™ä¸ªå…ƒç´ å‘¢ï¼Ÿ</p>
</li>
<li><p>åˆå§‹åŒ–ç”Ÿäº§è€…( trans2)ï¼ŒåŒæ ·ä½¿ç”¨newTCPTransportå®ç°ã€‚</p>
</li>
<li><p>è°ƒç”¨AppendEntriesæ¶ˆæ¯ç»™æ¶ˆè´¹è€…trans1ï¼Œè¿™é‡Œç›´æ¥å°±è·å–è¿”å›äº†ã€‚ä¸ºå•¥çœ‹ç€å°±æ˜¯åŒæ­¥è¿”å›çš„å‘¢? æŒ‰ç†è¯´ç½‘ç»œè°ƒç”¨ä¸€èˆ¬éƒ½æ˜¯å¼‚æ­¥è¿”å›å§ã€‚è¿™ä¸ªæ˜Ÿæ ‡æ­¥éª¤ï¼Œæˆ‘ä»¬åé¢æ¥è¯¦ç»†åˆ†æã€‚</p>
</li>
</ol>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestNetworkTransport_AppendEntries</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> _, useAddrProvider := <span class="keyword">range</span> []<span class="keyword">bool</span>&#123;<span class="literal">true</span>, <span class="literal">false</span>&#125; &#123;</span><br><span class="line">    <span class="comment">// â‘ åˆå§‹åŒ–trans1 -- æ¶ˆè´¹è€…</span></span><br><span class="line">    trans1, err := makeTransport(t, useAddrProvider, <span class="string">&quot;localhost:0&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    rpcCh := trans1.Consumer()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰æµ‹è¯•ä½¿ç”¨çš„RPCè¯·æ±‚</span></span><br><span class="line">    args := AppendEntriesRequest&#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    resp := AppendEntriesResponse&#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¡ å¯åŠ¨æ¶ˆè´¹è€…ç›‘å¬ </span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> rpc := &lt;-rpcCh:</span><br><span class="line">        <span class="comment">// è·å–æ¶ˆæ¯ç„¶åè¿”å›ï¼Œæ³¨æ„Respondå‡½æ•°åªæ˜¯ç»™RPCå¯¹è±¡çš„RespChanæ·»åŠ ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆè°æ¥æ¶ˆè´¹è¿™å’Œchanå‘¢</span></span><br><span class="line">        rpc.Respond(&amp;resp, <span class="literal">nil</span>)</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¢ åˆå§‹åŒ–ç”Ÿäº§è€… trans2</span></span><br><span class="line">    trans2, err := makeTransport(t, useAddrProvider, <span class="keyword">string</span>(trans1.LocalAddr()))</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// â‘£ å‘é€AppendEntriesæ¶ˆæ¯ç»™trans1ï¼Œè¿™é‡Œç›´æ¥å°±è·å–è¿”å›äº†ã€‚ä¸ºå•¥çœ‹ç€å°±æ˜¯åŒæ­¥è¿”å›çš„å‘¢</span></span><br><span class="line">    <span class="keyword">if</span> err := trans2.AppendEntries(<span class="string">&quot;id1&quot;</span>, trans1.LocalAddr(), &amp;args, &amp;out); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      t.Fatalf(<span class="string">&quot;err: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="makeTransportå®ç°åˆ†æ"><a href="#makeTransportå®ç°åˆ†æ" class="headerlink" title="makeTransportå®ç°åˆ†æ"></a>makeTransportå®ç°åˆ†æ</h5><ol>
<li><p>å…ˆçœ‹ä¸‹å‡½æ•°è°ƒç”¨å…³ç³»</p>
<p>newTCPTransportï¼šå°±æ˜¯tcpç«¯å£ç»‘å®šï¼Œç”ŸæˆTCPStreamLayer(ä¸Šé¢çš„ç±»å›¾ä¸­çŸ¥é“æ˜¯NetworkTransportç»“æ„éœ€è¦çš„æˆå‘˜)</p>
<p>NewNetworkTransportWithConfigï¼šåˆ›å»ºNetworkTransportå¯¹è±¡</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">   makeTransport</span><br><span class="line">   -&gt; NewTCPTransportWithConfig</span><br><span class="line">     -&gt; newTCPTransport <span class="comment">// è´Ÿè´£è¿›è¡Œtcpç«¯å£ç»‘å®šï¼Œç”ŸæˆTCPStreamLayer</span></span><br><span class="line">   		-&gt; NewNetworkTransportWithConfig <span class="comment">// çœŸæ­£åˆ›å»ºNetworkTransportå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> newTCPTransport</span><br><span class="line"></span><br><span class="line">   ä¸‹é¢æ˜¯newTCPTransportçš„å®ç°ï¼Œæœ€åtransportCreatorå°±æ˜¯ç½‘ç»œå±‚çš„åˆ›å»ºå™¨</span><br><span class="line"></span><br><span class="line">   <span class="string">``</span><span class="string">`go</span></span><br><span class="line"><span class="string">   // â‘  è°ƒç”¨netåº“ç»‘å®štcpç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="string">   list, err := net.Listen(&quot;tcp&quot;, bindAddr)</span></span><br><span class="line"><span class="string">   // â‘¡ å°†TCPListener -&gt; TCPStreamLayer(ä¸Šé¢çš„ç±»å›¾ä¸­NetworkTransportéœ€è¦å®ç°StreamLayeræ¥å£)</span></span><br><span class="line"><span class="string">   stream := &amp;TCPStreamLayer&#123;</span></span><br><span class="line"><span class="string">   		advertise: advertise,</span></span><br><span class="line"><span class="string">   		listener:  list.(*net.TCPListener),</span></span><br><span class="line"><span class="string">   	&#125;</span></span><br><span class="line"><span class="string">   // â‘¢ å°†ä¸Šé¢çš„ TCPStreamLayer-&gt; NetworkTransportï¼Œè°ƒç”¨ NewNetworkTransportWithConfig</span></span><br><span class="line"><span class="string">   trans := transportCreator(stream)</span></span><br></pre></td></tr></table></figure></li>
<li><p>newNetworkTransport</p>
<p>ä¸‹é¢æ˜¯åˆ›å»ºç½‘ç»œå±‚çš„ä»£ç ï¼Œä¸€ä¸ªAcceptorä¸“é—¨ç”¨æ¥accetorè¿æ¥ï¼Œæ¯ä¸ªæ–°çš„è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªåç¨‹è¿›è¡Œå¤„ç†ã€‚</p>
<p><a href="https://imgtu.com/i/T9BOV1"><img src="https://s4.ax1x.com/2021/12/16/T9BOV1.png" alt="T9BOV1.png"></a></p>
<ul>
<li><p>Mainçº¿ç¨‹è°ƒç”¨trans.listen()å¯åŠ¨ç›‘å¬åç¨‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// â‘  å°†ä¸Šé¢çš„configæ³¨å…¥è¿›æ¥ï¼Œä¸»è¦æ˜¯Stream</span></span><br><span class="line">trans := &amp;NetworkTransport&#123;</span><br><span class="line">    connPool:              <span class="built_in">make</span>(<span class="keyword">map</span>[ServerAddress][]*netConn),</span><br><span class="line">    consumeCh:             <span class="built_in">make</span>(<span class="keyword">chan</span> RPC),</span><br><span class="line">    logger:                config.Logger,</span><br><span class="line">    maxPool:               config.MaxPool,</span><br><span class="line">    shutdownCh:            <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">    stream:                config.Stream,</span><br><span class="line">    timeout:               config.Timeout,</span><br><span class="line">    TimeoutScale:          DefaultTimeoutScale,</span><br><span class="line">    serverAddressProvider: config.ServerAddressProvider,</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// â‘¡ è®¾ç½®Streamä¸Šä¸‹æ–‡</span></span><br><span class="line">trans.setupStreamContext()</span><br><span class="line"><span class="comment">// â‘¢ å¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¸“é—¨æ¥å¤„ç†è¿æ¥</span></span><br><span class="line"><span class="keyword">go</span> trans.listen()</span><br></pre></td></tr></table></figure></li>
<li><p>Acceptorç›‘å¬æ–°è¿æ¥ï¼Œå¹¶å¯åŠ¨å¤„ç†åç¨‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">listen</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// â‘  æ¥æ”¶æ–°è¿æ¥ï¼Œè¿™ä¸ªåº•å±‚æ˜¯epollå®ç°ï¼Œ</span></span><br><span class="line">    conn, err := n.stream.Accept()</span><br><span class="line">    <span class="comment">// â‘¡ å¯åŠ¨å¤„ç†åç¨‹</span></span><br><span class="line">    <span class="keyword">go</span> n.handleConn(n.getStreamContext(), conn)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>å¯¹è¿æ¥è¿›è¡Œå¤„ç†</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">handleConn</span><span class="params">(connCtx context.Context, conn net.Conn)</span></span> &#123;</span><br><span class="line">  r := bufio.NewReaderSize(conn, connReceiveBufferSize)</span><br><span class="line">  w := bufio.NewWriter(conn)</span><br><span class="line">  dec := codec.NewDecoder(r, &amp;codec.MsgpackHandle&#123;&#125;)</span><br><span class="line">  enc := codec.NewEncoder(w, &amp;codec.MsgpackHandle&#123;&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// â‘  è¯»æ•°æ® -- è§£ç  -- å¤„ç† -- ç¼–ç </span></span><br><span class="line">    <span class="keyword">if</span> err := n.handleCommand(r, dec, enc); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// â‘¡ è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> err := w.Flush(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handleCommandæ˜¯æ ¸å¿ƒçš„å¤„ç†é€»è¾‘ï¼Œè¿™é‡Œé€šè¿‡chanè®©ç”¨æˆ·ä½¿ç”¨çš„æ—¶å€™æ„Ÿè§‰æ˜¯åŒæ­¥çš„ã€‚</p>
<ol>
<li><p>è·å–ç±»å‹ReadByteï¼Œçº¦å®šç¬¬ä¸€ä½è¡¨ç¤ºçš„RPCç±»å‹ï¼Œeg:AppendEntries RequestVote</p>
</li>
<li><p>å®šä¹‰respChã€‚</p>
</li>
<li><p>å¯¹ä¸åŒç±»å‹çš„Requestè¿›è¡Œè§£ç ã€‚</p>
</li>
<li><p>å°†è§£ç å‡ºæ¥çš„RPCæ¶ˆæ¯æ”¾åˆ°æ¶ˆè´¹channelä¸­</p>
</li>
<li><p>ç­‰respChè¿”å›å¤„ç†åçš„ç»“æ„</p>
</li>
<li><p>å°†ç»“æ„è¿›è¡Œç¼–ç ã€‚</p>
<p>ä¸‹é¢æ˜¯å’Œåˆ«çš„åç¨‹è¿›è¡Œäº¤äº’çš„æ–¹å¼ï¼Œå®é™…ä¸Šå¤„ç†é€»è¾‘æ˜¯å¤–åŒ…å‡ºå»è¿›è¡Œå¤„ç†çš„ã€‚</p>
</li>
</ol>
<p><a href="https://imgtu.com/i/T9R9Hg"><img src="https://s4.ax1x.com/2021/12/16/T9R9Hg.png" alt="T9R9Hg.png"></a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">handleCommand</span><span class="params">(r *bufio.Reader, dec *codec.Decoder, enc *codec.Encoder)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  getTypeStart := time.Now()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘  è·å–ç±»å‹ï¼Œçº¦å®šç¬¬ä¸€ä½è¡¨ç¤ºçš„RPCç±»å‹ï¼Œeg:AppendEntries RequestVote</span></span><br><span class="line">  rpcType, err := r.ReadByte()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ å®šä¹‰respCh</span></span><br><span class="line">  respCh := <span class="built_in">make</span>(<span class="keyword">chan</span> RPCResponse, <span class="number">1</span>)</span><br><span class="line">  rpc := RPC&#123;</span><br><span class="line">    RespChan: respCh,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¢ å¯¹ä¸åŒç±»å‹çš„Requestè¿›è¡Œè§£ç </span></span><br><span class="line">  <span class="keyword">switch</span> rpcType &#123;</span><br><span class="line">  <span class="keyword">case</span> rpcAppendEntries:</span><br><span class="line">    <span class="keyword">var</span> req AppendEntriesRequest</span><br><span class="line">    <span class="keyword">if</span> err := dec.Decode(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    rpc.Command = &amp;req</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> rpcRequestVote:</span><br><span class="line">    <span class="keyword">var</span> req RequestVoteRequest</span><br><span class="line">    <span class="keyword">if</span> err := dec.Decode(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    rpc.Command = &amp;req</span><br><span class="line">   ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘£ å°†è§£ç å‡ºæ¥çš„çŒåˆ°Raft.consumeCh</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> n.consumeCh &lt;- rpc:</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¤ ç­‰ç»“æœï¼Œä¸Šé¢çš„consumeChè¢«Raftçš„runLeaderä¹‹ç±»çš„å…¶ä»–åç¨‹è¿›è¡Œå¤„ç†åï¼Œå°†ç»“æœå¡ä¼šåˆ°respChã€‚</span></span><br><span class="line">RESP:</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> resp := &lt;-respCh:</span><br><span class="line">    <span class="comment">// â‘¥ å¯¹ç»“æœè¿›è¡Œç¼–ç </span></span><br><span class="line">    <span class="keyword">if</span> err := enc.Encode(resp.Response); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h5 id="AppendEntrieså®ç°åˆ†æ"><a href="#AppendEntrieså®ç°åˆ†æ" class="headerlink" title="AppendEntrieså®ç°åˆ†æ"></a>AppendEntrieså®ç°åˆ†æ</h5><p>ä¸Šé¢çš„ä¼ è¾“å±‚å·²ç»åˆ›å»ºå¥½äº†è¿æ¥çš„å¤„ç†å™¨(æ¶ˆè´¹è€…)ï¼Œç°åœ¨éœ€è¦æ¶ˆæ¯çš„ç”Ÿäº§è€…ï¼ŒAppendEntrieså°±èƒ½å……å½“è¿™ä¸€è§’è‰²ã€‚</p>
<p>éœ€è¦ç½‘ç»œäº¤äº’çš„RequestVoteã€AppendEntriesã€TimeoutNowéƒ½æ˜¯è°ƒç”¨çš„genericRPCå®ç°çš„ï¼ŒgenericRPCæ˜¯çœŸæ­£æ‰§è¡Œè¯·æ±‚çš„å‡½æ•°ã€‚</p>
<p><a href="https://imgtu.com/i/ovxupF"><img src="https://s4.ax1x.com/2021/12/14/ovxupF.png" alt="ovxupF.png"></a></p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªgenericRPCçš„æµç¨‹ï¼š</p>
<p>â‘  ä»è¿æ¥æ± è·å–è¿æ¥å¯¹è±¡ï¼Œç®€å•çš„ç»´æŠ¤äº†ä¸€ä¸ªè¿æ¥æ± ã€‚</p>
<p>â‘¡ åœ¨è¿æ¥ä¸Šå‘é€RPCè¯·æ±‚ã€‚</p>
<p>â‘¢ è§£ç Responseï¼Œå°†connè¿”è¿˜è¿æ¥æ± å¦‚æœå¯ä»¥çš„è¯ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šè¿™é‡Œå‘é€è¯·æ±‚ä¹‹åï¼ŒåŒæ­¥è·å–Responseã€‚å¦‚æœæ˜¯çŸ­é“¾æ¥ï¼Œä¸ºäº†é«˜æ•ˆå°±ä¸ä¼šç›´æ¥åœ¨è¿™é‡Œç­‰ç»“æœäº†ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">genericRPC</span><span class="params">(id ServerID, target ServerAddress, rpcType <span class="keyword">uint8</span>, args <span class="keyword">interface</span>&#123;&#125;, resp <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="comment">// â‘  ä»è¿æ¥æ± ä¸­è·å–è¿æ¥ï¼ŒNetworkTransportç»´æŠ¤äº†ä¸€ä¸ªè¿æ¥æ± </span></span><br><span class="line">  conn, err := n.getConnFromAddressProvider(id, target)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ å‘é€RPCè¯·æ±‚</span></span><br><span class="line">  <span class="keyword">if</span> err = sendRPC(conn, rpcType, args); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¢ è§£ç Responseï¼Œå¹¶ä¸”å½’è¿˜è¿æ¥ã€‚æ³¨æ„ï¼šè¿™é‡Œå‘é€äº†è¯·æ±‚ä¹‹åï¼Œé©¬ä¸Šå°±è§£ç Responseäº†ã€‚æƒ³æƒ³æˆ‘ä»¬çš„mysqlå®¢æˆ·ç«¯ï¼Œ(å‘æ¶ˆæ¯,ç­‰ç»“æœï¼‰ï¼Œä¸å¯ä»¥ä¸€ç›´å‘æ¶ˆæ¯è€Œä¸æ¥æ”¶ã€‚</span></span><br><span class="line">  canReturn, err := decodeResponse(conn, resp)</span><br><span class="line">  <span class="keyword">if</span> canReturn &#123;</span><br><span class="line">    n.returnConn(conn)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯¹æ¯”çœ‹çœ‹InmemTransport.makeRPCæ–¹æ³•æ¥ä½“ä¼šå…¶ä¸­çš„ä¸åŒï¼Œè¿™è¾¹è·å–ç»“æœéœ€è¦ä»respChè¯»å–ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªResponseæ˜¯è°å¡è¿›å»respChçš„å‘¢ï¼Œæ¯•ç«Ÿæˆ‘ä»¬åªæ˜¯è·å–äº†ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *InmemTransport)</span> <span class="title">makeRPC</span><span class="params">(target ServerAddress, args <span class="keyword">interface</span>&#123;&#125;, r io.Reader, timeout time.Duration)</span> <span class="params">(rpcResp RPCResponse, err error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// å®šä¹‰äº¤äº’ç”¨çš„RPCå¯¹è±¡</span></span><br><span class="line">  req := RPC&#123;</span><br><span class="line">    Command:  args,</span><br><span class="line">    Reader:   r,</span><br><span class="line">    RespChan: respCh,</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// å‘é€æ¶ˆæ¯ï¼Œç›´æ¥å°†æ„é€ å‡ºæ¥çš„reqçŒåˆ°peer.consumerChæ¶ˆè´¹channelï¼Œæœ¬æ¥å°±æ˜¯å†…å­˜ä¸­çš„å¯¹è±¡ã€‚</span></span><br><span class="line">   <span class="keyword">select</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> peer.consumerCh &lt;- req:</span><br><span class="line">     ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ç­‰respChç»“æœï¼Œæ¶ˆè´¹åç¨‹æŠŠRPCæ‹¿å‡ºæ¥-å¤„ç†-ç»“æœå¡å›åˆ°respChã€‚</span></span><br><span class="line">   <span class="keyword">select</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> rpcResp = &lt;-respCh:</span><br><span class="line">      <span class="keyword">if</span> rpcResp.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">         err = rpcResp.Error</span><br><span class="line">      &#125;</span><br><span class="line">     .... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€è€ƒï¼š</p>
<p>1ã€ä¸Šé¢çš„å®ç°æ˜¯ä¸€æ¡ä¸€æ¡çš„å‘ï¼Œå®é™…ä¸Šä¸ºäº†é«˜æ•ˆï¼Œæˆ‘ä»¬å¾€å¾€éƒ½æ˜¯æ‰¹å¤„ç†çš„ã€‚</p>
<p>2ã€æƒ³RequestVoteè¦ç»™å¤šä¸ªå¯¹è±¡å‘æŠ•ç¥¨æ¶ˆæ¯ï¼Œé‚£ä¹ˆè‚¯å®šä¸ä¼šå‘ä¸€ä¸ªæ¶ˆæ¯ç­‰ä¸€ä¸ªç»“æœï¼Œè€Œæ˜¯ç¾¤å‘ï¼Œç„¶åå¤„ç†ç»“æ„ã€‚</p>
<h5 id="AppendEntriesPipelineå®ç°"><a href="#AppendEntriesPipelineå®ç°" class="headerlink" title="AppendEntriesPipelineå®ç°"></a>AppendEntriesPipelineå®ç°</h5><p>åŒæ ·çš„æˆ‘ä»¬ä»æµ‹è¯•ç”¨ä¾‹å¼€å§‹ï¼Œçœ‹çœ‹æ‰¹å¤„ç†æ˜¯æ€ä¹ˆç©çš„ã€‚ä¸»è¦çœ‹çœ‹æ‰¹å¤„ç†å’Œå•æ¡å¤„ç†çš„åŒºåˆ«ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–AppendEntriesPipelineå¯¹è±¡ï¼Œå¯åŠ¨åç¨‹å¤„ç† inprogressCh -&gt; doneCh</span></span><br><span class="line">pipeline, err := trans2.AppendEntriesPipeline(<span class="string">&quot;id1&quot;</span>, trans1.LocalAddr())</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘10ä¸ªæ¶ˆæ¯ï¼Œå¹¶ä¸”å°†RPCåŠ å…¥åˆ°inprogressCh</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">  out := <span class="built_in">new</span>(AppendEntriesResponse)</span><br><span class="line">  <span class="keyword">if</span> _, err := pipeline.AppendEntries(&amp;args, out); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    t.Fatalf(<span class="string">&quot;err: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Consumer()ä¼šè¿”å›doneChï¼Œä»doneChè·å–æ•°æ®ï¼Œå‘äº†10ä¸ªæ¶ˆæ¯ï¼Œæ‰€ä»¥éœ€è¦è·å–10æ¬¡ç»“æœ</span></span><br><span class="line">respCh := pipeline.Consumer()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ready := &lt;-respCh:</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯å‘æ¶ˆæ¯çš„æ—¶å€™  épipeline VS pipelineçš„åŒºåˆ«</p>
<p><a href="https://imgtu.com/i/TCM7Us"><img src="https://s4.ax1x.com/2021/12/16/TCM7Us.md.png" alt="TCM7Us.md.png"></a></p>
<p>ä¸‹é¢æ˜¯è§£ç æ¶ˆæ¯çš„æ—¶å€™  épipeline VS pipelineçš„åŒºåˆ«ï¼Œpipelineçš„decodeResponsesæ–¹æ³•æ˜¯åˆå§‹åŒ–AppendEntriesPipelineå¯¹è±¡çš„æ—¶å€™å°±å¯åŠ¨çš„åç¨‹ã€‚</p>
<p><a href="https://imgtu.com/i/TClAFs"><img src="https://s4.ax1x.com/2021/12/16/TClAFs.md.png" alt="TClAFs.md.png"></a></p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªâ“ç–‘é—®å…³äºnet.Connçš„ A-&gt;B-&gt;Aï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨ç½‘ç»œä¸Šæ˜¯ä¸¤è¾¹å¯ä»¥åŒæ—¶å‘é€æ•°æ®å—ï¼Ÿä¸ºå•¥ä¸Šé¢çš„épipelineæ¨¡å¼ï¼Œsendä¹‹åé©¬ä¸Šå°±å¯ä»¥decodeæ¶ˆæ¯äº†ï¼Œconnè¿™é‡Œå¸®æˆ‘ä»¬åšäº†ä»€ä¹ˆã€‚</p>
<p>æ‰¹å¤„ç†çš„æ•´ä½“å®ç°å°±æ˜¯ï¼Œå¯åŠ¨ä¸€ä¸ªåç¨‹ç›‘æ§inprogressçš„ä»»åŠ¡ã€‚ç„¶åå¼€å‘æ‰¹é‡çš„å‘æ¶ˆæ¯ï¼Œæ¯”å¦‚ä¸€æ¬¡å‘10æ¡ï¼Œç„¶åinprogressåç¨‹è¢«æ¿€æ´»ï¼Œå¼€å§‹å¤„ç†ã€‚å°†å¤„ç†çš„ç»“æœæ”¾åˆ°doneChï¼Œæœ€åç”¨æˆ·ä»doneChè·å–æ¶ˆæ¯å³å¯ã€‚</p>
<h5 id="RequestVoteè¿‡ç¨‹"><a href="#RequestVoteè¿‡ç¨‹" class="headerlink" title="RequestVoteè¿‡ç¨‹"></a>RequestVoteè¿‡ç¨‹</h5><p>ä¸Šé¢æˆ‘ä»¬åˆ†æäº†ä¸€å¯¹ä¸€pipelineå‘æ¶ˆæ¯ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹1:Nï¼Œåœ¨é›†ç¾¤é‡Œé¢ç»™æ‰€æœ‰äººå‘æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ç»“æ„</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">electSelf</span><span class="params">()</span> &lt;-<span class="title">chan</span> *<span class="title">voteResult</span></span> &#123;</span><br><span class="line">  <span class="comment">// â‘  åˆ›å»ºä¸€ä¸ªåŒ…å«peersæ•°é‡çš„respCh</span></span><br><span class="line">  respCh := <span class="built_in">make</span>(<span class="keyword">chan</span> *voteResult, <span class="built_in">len</span>(r.configurations.latest.Servers))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ å¹¶å‘å‘æ¶ˆæ¯ï¼Œç„¶åå°†ç»“æœçŒå›åˆ°respChã€‚åé¢ä»respChè·å–æŠ•ç¥¨ç»“æœå³å¯è¿›è¡Œå¤„ç†ã€‚</span></span><br><span class="line">  askPeer := <span class="function"><span class="keyword">func</span><span class="params">(peer Server)</span></span> &#123;</span><br><span class="line">    r.goFunc(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      resp := &amp;voteResult&#123;voterID: peer.ID&#125;</span><br><span class="line">      err := r.trans.RequestVote(peer.ID, peer.Address, req, &amp;resp.RequestVoteResponse)</span><br><span class="line">      ... </span><br><span class="line">      respCh &lt;- resp</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> respCh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ€»ç»“ğŸ¤”"><a href="#æ€»ç»“ğŸ¤”" class="headerlink" title="æ€»ç»“ğŸ¤”"></a>æ€»ç»“ğŸ¤”</h4><p>ç½‘ç»œæ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„æ¨¡å—ï¼Œåç»­å¯ä»¥çœ‹çœ‹æ¯”è¾ƒç»å…¸çš„Redisã€Nginxè¿™äº›ä¼˜ç§€ç»„ä»¶çš„å®ç°ã€‚</p>
<p>ProxySQLï¼šæƒŠç¾¤æ•ˆåº”æ€è€ƒ</p>
]]></content>
      <tags>
        <tag>raft</tag>
      </tags>
  </entry>
  <entry>
    <title>hashicorp:raftæºç ç³»åˆ—(1)--å¯¼è¯»</title>
    <url>/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-1-%E5%AF%BC%E8%AF%BB/</url>
    <content><![CDATA[<h3 id="Raftæ˜¯å¹²å•¥çš„ï¼Ÿ"><a href="#Raftæ˜¯å¹²å•¥çš„ï¼Ÿ" class="headerlink" title="Raftæ˜¯å¹²å•¥çš„ï¼Ÿ"></a>Raftæ˜¯å¹²å•¥çš„ï¼Ÿ</h3><p><a href="http://thesecretlivesofdata.com/raft/">åŠ¨ç”»è¯´æ˜</a></p>
<p>ç®€è¿°å¦‚ä¸‹å›¾ï¼šç”¨æˆ·SET 5ï¼Œ3ä¸ªä¸åŒèŠ‚ç‚¹éƒ½èƒ½è·å–SET 5çš„æ“ä½œã€‚æ‰€è°“çš„æœ€ç®€å•çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ã€‚</p>
<p><a href="https://imgtu.com/i/oO3r0P"><img src="https://s4.ax1x.com/2021/12/13/oO3r0P.png" alt="oO3r0P.png"></a></p>
<h3 id="Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ"><a href="#Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ" class="headerlink" title="Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ"></a>Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ</h3><h4 id="é¡¹ç›®æœ‰å¤šå°‘è¡Œ"><a href="#é¡¹ç›®æœ‰å¤šå°‘è¡Œ" class="headerlink" title="é¡¹ç›®æœ‰å¤šå°‘è¡Œ?"></a>é¡¹ç›®æœ‰å¤šå°‘è¡Œ?</h4><p>åˆ†æä¸‹æ•´ä¸ªé¡¹ç›®å¤§æ¦‚æ˜¯1Wå¤šè¡Œï¼Œå¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œä»£ç æ³¨é‡Šéå¸¸é½å…¨ï¼Œç†è§£èµ·æ¥æ¯”è¾ƒè½»æ¾ã€‚ä»£ç æŠ½è±¡å¾—å¾ˆå¥½ï¼Œéå¸¸å€¼å¾—å­¦ä¹ ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">-&gt;</span><span class="bash"> % cloc ./</span></span><br><span class="line">      77 text files.</span><br><span class="line">      77 unique files.</span><br><span class="line">       8 files ignored.</span><br><span class="line"></span><br><span class="line">github.com/AlDanial/cloc v 1.90  T=0.09 s (814.1 files/s, 201614.7 lines/s)</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Language                     files          blank        comment           code</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Go                              57           2207           2786          11864</span><br><span class="line">Markdown                         4            106              0            255</span><br><span class="line">YAML                             4             26             29            141</span><br><span class="line">XML                              4              0              0            108</span><br><span class="line">make                             1             10              2             33</span><br><span class="line">Bourne Shell                     1              3              3             10</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">SUM:                            71           2352           2820          12411</span><br><span class="line">-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h4 id="ä»å“ªé‡Œå¼€å§‹ï¼Ÿ"><a href="#ä»å“ªé‡Œå¼€å§‹ï¼Ÿ" class="headerlink" title="ä»å“ªé‡Œå¼€å§‹ï¼Ÿ"></a>ä»å“ªé‡Œå¼€å§‹ï¼Ÿ</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹<code>api.go/Raft</code>ç»“æ„ï¼Œè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªRaftèŠ‚ç‚¹ï¼Œæœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ã€‚åˆ’åˆ†3å¤§å—</p>
<ol>
<li><p>NewRaftèŠ‚ç‚¹éœ€è¦çš„ä¿¡æ¯ï¼šä¸‹å›¾ä¸­æ ‡çº¢ç‚¹çš„ï¼Œå‡ å¤§æ ¸å¿ƒç»„æˆã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬ä»ç½‘ç»œå±‚å¼€å§‹è¯¦ç»†åˆ†æã€‚</p>
<blockquote>
<p>é™¤äº†raftStateï¼Œå…¶ä»–éƒ¨åˆ†å…¨æ˜¯interfaceï¼Œæ¨¡å—æŠ½è±¡çš„å¾ˆç»†è‡´ã€‚</p>
</blockquote>
</li>
<li><p>Leaderæ“ä½œç›¸å…³ï¼šæ•´ä¸ªRaftæœ€æ ¸å¿ƒçš„å°±æ˜¯Leaderçš„çŠ¶æ€è½¬æ¢è¿‡ç¨‹ã€‚æˆ‘ä»¬åç»­ä¹Ÿä¼šå¯¹è¿™ä¸€éƒ¨åˆ†çš„å®ç°åšè¯¦ç»†è¯´æ˜ã€‚</p>
</li>
<li><p>ä¸€äº›å¼‚æ­¥æ“ä½œï¼šè¿™ä¸€å—æ˜¯åµŒå…¥åœ¨å„ä¸ªæ¨¡å—çš„å®ç°ä¸­çš„ã€‚é¡¹ç›®é‡Œé¢ä¸€äº›chançš„ä½¿ç”¨ä¹Ÿæ˜¯å€¼å¾—å­¦ä¹ çš„ã€‚</p>
</li>
</ol>
<p><a href="https://imgtu.com/i/oO0Ein"><img src="https://s4.ax1x.com/2021/12/13/oO0Ein.png" alt="oO0Ein.png"></a></p>
<h4 id="æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ"><a href="#æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ" class="headerlink" title="æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ"></a>æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ</h4><ul>
<li><p>â‘  æ ¡éªŒé…ç½®</p>
</li>
<li><p>â‘¡ è·å–å½“å‰ä»»åŠ¡ï¼Œè¿™é‡Œæ˜¯ä»StableStoreä¸­è·å–</p>
</li>
<li><p>â‘¢ è·å–æœ€è¿‘çš„æ—¥å¿—å·å’Œå…·ä½“Logï¼Œä»LogStoreä¸­è·å–</p>
</li>
<li><p>â‘£ åˆ›å»ºBuffer applyChï¼Œç”¨æ¥åº”ç”¨Logåˆ°FSMã€‚è¿™é‡ŒFutureçš„åº”ç”¨å¯ä»¥å­¦ä¹ ä¸‹ï¼Œåé¢å†™applyLogçš„æ—¶å€™å¯ä»¥è¯¦ç»†åˆ†æã€‚</p>
</li>
<li><p>â‘¤ åˆå§‹åŒ–Raftç»“æ„ã€‚</p>
</li>
<li><p>â‘¥ Setå„ç§å˜é‡ï¼Œè¿™é‡Œå¯ä»¥ç ”ç©¶ä¸‹configæ˜¯æ€ä¹ˆå®ç°çº¿ç¨‹å®‰å…¨çš„å˜æ›´ã€‚</p>
</li>
<li><p>â‘¦ å°è¯•ä»å¤‡ä»½ä¸­æ¢å¤ï¼Œå¤„ç†peerå˜æ›´æ—¥å¿—ï¼Œegï¼šæ·»åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹ã€‚è¿™é‡Œä¸ºå•¥åªå¤„ç†Peerå˜æ›´ä¿¡æ¯ï¼Œéƒ½å·²ç»å°†Logè§£æå‡ºæ¥äº†ï¼Œä¸ºå•¥ä¸ç›´æ¥åº”ç”¨å‘¢ï¼Ÿ</p>
</li>
<li><p>â‘§ ç»™ä¼ è¾“å±‚æ³¨å†Œå¿ƒè·³å¤„ç†å™¨ã€‚åœ¨è¿™é‡Œåˆå§‹åŒ–ï¼Œè€Œä¸æ˜¯åœ¨goroutineé‡Œé¢å¤„ç†ï¼Œæ˜¯ä¸ºäº†é¿å…é˜Ÿå¤´é˜»å¡ã€‚</p>
</li>
<li><p>â‘¨ å¯åŠ¨goroutineï¼Œå¦‚ä¸‹å¯åŠ¨äº†3ä¸ªåç¨‹ã€‚</p>
<p><a href="https://imgtu.com/i/oOhDud"><img src="https://s4.ax1x.com/2021/12/13/oOhDud.png" alt="oOhDud.png"></a></p>
</li>
</ul>
<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRaft</span><span class="params">(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans Transport)</span> <span class="params">(*Raft, error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// â‘  æ ¡éªŒé…ç½®</span></span><br><span class="line">  <span class="keyword">if</span> err := ValidateConfig(conf); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ è·å–å½“å‰ä»»åŠ¡ï¼Œè¿™é‡Œæ˜¯ä»StableStoreä¸­è·å–</span></span><br><span class="line">  currentTerm, err := stable.GetUint64(keyCurrentTerm)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¢ è·å–æœ€è¿‘çš„æ—¥å¿—å·å’Œå…·ä½“Logï¼Œä»LogStoreä¸­è·å–ï¼›</span></span><br><span class="line">  lastIndex, err := logs.LastIndex()</span><br><span class="line">  <span class="keyword">if</span> err = logs.GetLog(lastIndex, &amp;lastLog); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to get last log at index %d: %v&quot;</span>, lastIndex, err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘£ åˆ›å»ºBuffer applyChï¼Œç”¨æ¥åº”ç”¨Logåˆ°FSMã€‚è¿™é‡ŒFutureçš„åº”ç”¨å¯ä»¥å­¦ä¹ ä¸‹ã€‚</span></span><br><span class="line">  applyCh := <span class="built_in">make</span>(<span class="keyword">chan</span> *logFuture)</span><br><span class="line">  <span class="keyword">if</span> conf.BatchApplyCh &#123;</span><br><span class="line">    applyCh = <span class="built_in">make</span>(<span class="keyword">chan</span> *logFuture, conf.MaxAppendEntries)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¤ åˆå§‹åŒ–Raftç»“æ„ã€‚</span></span><br><span class="line">  r := &amp;Raft&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¥ Setå„ç§å˜é‡ï¼Œä¸‹é¢è¿™ä¸€è¡Œçš„å®ç°å¯ä»¥ç ”ç©¶ä¸‹ï¼Œä¸ºå•¥ä¸ç›´æ¥r.conf = conf</span></span><br><span class="line">  r.conf.Store(*conf)</span><br><span class="line">  r.setState(Follower)</span><br><span class="line">  r.setCurrentTerm(currentTerm)</span><br><span class="line">  r.setLastLog(lastLog.Index, lastLog.Term)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¦ å°è¯•ä»å¤‡ä»½ä¸­æ¢å¤ï¼Œå¤„ç†peerå˜æ›´æ—¥å¿—ï¼Œegï¼šæ·»åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹. </span></span><br><span class="line">  <span class="keyword">if</span> err := r.restoreSnapshot(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">  &#125;</span><br><span class="line">  snapshotIndex, _ := r.getLastSnapshot()</span><br><span class="line">  <span class="keyword">for</span> index := snapshotIndex + <span class="number">1</span>; index &lt;= lastLog.Index; index++ &#123;</span><br><span class="line">    <span class="keyword">var</span> entry Log</span><br><span class="line">    <span class="keyword">if</span> err := r.logs.GetLog(index, &amp;entry); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := r.processConfigurationLogEntry(&amp;entry); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// â‘§ ç»™ä¼ è¾“å±‚æ³¨å†Œå¿ƒè·³å¤„ç†å™¨</span></span><br><span class="line">  trans.SetHeartbeatHandler(r.processHeartbeat)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¨ å¯åŠ¨goroutine</span></span><br><span class="line">  r.goFunc(r.run)</span><br><span class="line">  r.goFunc(r.runFSM)</span><br><span class="line">  r.goFunc(r.runSnapshots)</span><br><span class="line">  <span class="keyword">return</span> r, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å°†RaftèŠ‚ç‚¹å¯åŠ¨èµ·æ¥äº†</p>
<h4 id="æŠ€æœ¯ç‚¹1ï¼šatomic-Value"><a href="#æŠ€æœ¯ç‚¹1ï¼šatomic-Value" class="headerlink" title="æŠ€æœ¯ç‚¹1ï¼šatomic.Value"></a>æŠ€æœ¯ç‚¹1ï¼šatomic.Value</h4><p><img src="https://blog.betacat.io/image/golang-atomic-value/atomic-value-store.drawio.png" alt="atomic.Value Store æµç¨‹"></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// confè¿™ä¸ªå˜é‡ä¼šæ¶‰åŠåˆ°å¤šä¸ªgoroutineçš„å¹¶å‘ä¿®æ”¹&amp;è¯»å–ã€‚</span></span><br><span class="line"><span class="comment">// ä¸ºäº†ä¿è¯è¯»å†™çš„åŸå­æ€§ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåŠ é”ã€‚ä½†æ˜¯åŠ é”åˆæœ‰ç‚¹è¿‡é‡äº†ï¼Œä¸ºäº†æ›´åŠ é«˜æ•ˆçš„å®ç°ï¼Œä½¿ç”¨äº†atomicã€‚</span></span><br><span class="line">conf atomic.Value</span><br><span class="line">r.conf.Store(*conf)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 8ä¸ªå†™routine + 1ä¸ªè¯»routine</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestAtomic</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">  <span class="keyword">var</span> gloMy = my&#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      wg.Add(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">for</span> &#123;</span><br><span class="line">        tmp := rand.Uint64() % <span class="number">100</span></span><br><span class="line">        gloMy.v1 = tmp</span><br><span class="line">        <span class="comment">// åœ¨è¿™ä¸¤æ¬¡æ“ä½œä¹‹é—´å°±ä¼šäº§ç”Ÿä¸­é—´çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€å°±å¾ˆå¥‡æ€ªæ²¡æœ‰æ„ä¹‰</span></span><br><span class="line">        gloMy.v2 = fmt.Sprintf(<span class="string">&quot;s%d&quot;</span>, tmp)</span><br><span class="line">      &#125;</span><br><span class="line">      wg.Done()</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  wg.Add(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">      t.Log(gloMy.v1, gloMy.v2)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Done()</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=== RUN   TestAtomic</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">75</span> s64 <span class="comment">// ä¸åˆç¬¦é¢„æœŸï¼Œè„è¯»äº†</span></span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">63</span> s63</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">48</span> s48</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">5</span> s5</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">1</span> s1</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.betacat.io/post/golang-atomic-value-exploration/">æ¨èä¸€ç¯‡æ–‡ç« </a> ï¼šæ–‡ä¸­å°†atomicçš„æ¥é¾™å»è„‰éƒ½è§£é‡Šäº†ä¸€éã€‚</p>
<h4 id="æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡"><a href="#æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡" class="headerlink" title="æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡"></a>æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿™è¡Œçš„ä½ç½®ï¼Œåœ¨goroutineå¯åŠ¨ä¹‹å‰æ³¨å†ŒHeartbeatHandlerå¤„ç†å™¨</span></span><br><span class="line">trans.SetHeartbeatHandler(r.processHeartbeat)</span><br></pre></td></tr></table></figure>



<h4 id="å°å°ç–‘é—®â“"><a href="#å°å°ç–‘é—®â“" class="headerlink" title="å°å°ç–‘é—®â“"></a>å°å°ç–‘é—®â“</h4><p>Q: ä¸ºå•¥è¦å«FSMï¼Œæˆ‘çš„ç†è§£FSMä¸å°±æ˜¯ç±»ä¼¼äºMySQLè¿™ç§å¯ä»¥åº”ç”¨Logçš„åœ°æ–¹å—ï¼Ÿæ€»æ„Ÿè§‰ç”¨çŠ¶æ€æœºå‘½åæ€ªæ€ªçš„ï¼Œå®¹æ˜“è¯¯ä¼šã€‚</p>
<p>Q: Config å’Œ Configurationçš„åŒºåˆ«? Configé‡Œé¢éƒ½æ˜¯å•ä¸ªRaftèŠ‚ç‚¹çš„é…ç½®ï¼Œæ¯”å¦‚è¶…æ—¶ä¹‹ç±»çš„ï¼›Configurationæ˜¯Raft Clusterç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æœ‰å‡ ä¸ªèŠ‚ç‚¹ä¹‹ç±»çš„ã€‚</p>
<p>â€‹           </p>
]]></content>
      <tags>
        <tag>raft</tag>
      </tags>
  </entry>
</search>
