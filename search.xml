<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>æ€ä¹ˆå°†youtubeè§†é¢‘æ¬è¿åˆ°Bç«™</title>
    <url>/2022/02/10/%E6%80%8E%E4%B9%88%E5%B0%86youtube%E8%A7%86%E9%A2%91%E6%90%AC%E8%BF%90B%E7%AB%99/</url>
    <content><![CDATA[<h3 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h3><p>éœ€æ±‚ï¼šå°†YouTubeçš„è§†é¢‘æ¬è¿åˆ°Bç«™é‡Œé¢æ¥ã€‚æ–‡ç« ä¸»è¦è®²äº†ä»¥ä¸‹å‡ ç‚¹</p>
<ul>
<li>æ€æ ·ä¸‹è½½YouTubeè§†é¢‘</li>
<li>æ€æ ·ä¸Šä¼ Bç«™</li>
<li>æ€æ ·æ·»åŠ å­—å¹•</li>
<li>Macæ€ä¹ˆåšè§†é¢‘åˆé›†</li>
</ul>
<h3 id="å‰æè¯´æ˜"><a href="#å‰æè¯´æ˜" class="headerlink" title="å‰æè¯´æ˜"></a>å‰æè¯´æ˜</h3><ol>
<li>Bç«™è´¦å· &amp; YouTubeè´¦å·</li>
<li>èƒ½è®¿é—®YouTubeçš„ç½‘ç»œç¯å¢ƒ</li>
</ol>
<blockquote>
<p>ç¬”è€…ä½¿ç”¨çš„Macç”µè„‘ï¼Œä¸‹é¢çš„æ‰€æœ‰æ“ä½œå‡åŸºäºMacOS</p>
</blockquote>
<h3 id="å…·ä½“æ“ä½œ"><a href="#å…·ä½“æ“ä½œ" class="headerlink" title="å…·ä½“æ“ä½œ"></a>å…·ä½“æ“ä½œ</h3><h4 id="1-å®‰è£…youtube-dl"><a href="#1-å®‰è£…youtube-dl" class="headerlink" title="1. å®‰è£…youtube-dl"></a>1. å®‰è£…<code>youtube-dl</code></h4><p>é¡¹ç›®githubåœ°å€ï¼š<a href="https://github.com/ytdl-org/youtube-dl">https://github.com/ytdl-org/youtube-dl</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">brew install youtube-dl</span><br></pre></td></tr></table></figure>

<h4 id="2-å®‰è£…ä¾èµ–"><a href="#2-å®‰è£…ä¾èµ–" class="headerlink" title="2. å®‰è£…ä¾èµ–"></a>2. å®‰è£…ä¾èµ–</h4><p>å®‰è£…youtube-dlè¿è¡Œéœ€è¦çš„ä¾èµ–</p>
<ul>
<li>ffmpegç”¨æ¥å¯¹å­—å¹•æ ¼å¼è¿›è¡Œè½¬æ¢</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">brew install ffmpeg</span><br></pre></td></tr></table></figure>

<h4 id="3-ä¸‹è½½è§†é¢‘"><a href="#3-ä¸‹è½½è§†é¢‘" class="headerlink" title="3. ä¸‹è½½è§†é¢‘"></a>3. ä¸‹è½½è§†é¢‘</h4><p>å¸¸ç”¨æ“ä½œ</p>
<ul>
<li><p>ä¸‹è½½å•ä¸ªè§†é¢‘</p>
</li>
<li><p>ä¸‹è½½è§†é¢‘åˆ—è¡¨</p>
</li>
<li><p>ä¸‹è½½è‡ªåŠ¨ç”Ÿæˆçš„å­—å¹•ï¼Œé»˜è®¤æ˜¯è‹±æ–‡</p>
</li>
</ul>
<blockquote>
<p>  é»˜è®¤ä¸‹è½½çš„æ˜¯vvtï¼Œè¿™ä¸ªæ ¼å¼Bç«™ä¸Šä¸æ”¯æŒã€‚</p>
<p>  å­—å¹•æ ¼å¼è½¬æ¢è¯·ä½¿ç”¨å­—å¹•æ ¼å¼è½¬æ¢è¯·ä½¿ç”¨ â€“write-auto-sub â€“convert-subs=srt</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä¸‹è½½å•ä¸ªè§†é¢‘</span></span><br><span class="line">youtube-dl --write-auto-sub --convert-subs=srt https://www.youtube.com/watch?v=clFR9NfObvc</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸‹è½½è§†é¢‘åˆ—è¡¨</span></span><br><span class="line">youtube-dl --yes-playlist --write-auto-sub --convert-subs=srt -o &#x27;%(playlist)s/%(playlist_index)s-%(title)s.%(ext)s&#x27; https://www.youtube.com/playlist?list=PLWwSgbaBp9XqeuIuTWqpNtvf_EL0I4TJ2</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å…¶ä»–å¸¸ç”¨è¯´æ˜</span> </span><br><span class="line">--skip-download å•ç‹¬ä¸‹è½½å­—å¹•ï¼Œä¸ä¸‹è½½æ–‡ä»¶</span><br><span class="line">--write-sub  ä¸‹è½½è‡ªåŠ¨ç”Ÿæˆçš„å­—å¹•</span><br><span class="line">--convert-subs=srt è½¬æ¢å­—å¹•æ ¼å¼</span><br><span class="line">--embed-subs  è§†é¢‘ä¸­åµŒå…¥å­—å¹•</span><br></pre></td></tr></table></figure>

<!--æœ€ç®€å•çš„æ˜¯ä½¿ç”¨--embed-subsï¼Œä½†æ˜¯ç¬”è€…å°è¯•äº†ä¸€ä¸ªè§†é¢‘å¹¶æœªæˆåŠŸï¼Œæ±‚æŒ‡æ•™-->

<p>å¯é€‰ï¼šå¦‚æœä½¿ç”¨çš„æ˜¯Macç”µè„‘ï¼Œå¯ç›´æ¥<a href="https://www.macwk.com/soft/4k-video-downloader">ç‚¹å‡»è¿™é‡Œ</a>ä¸‹è½½å¯¹åº”è½¯ä»¶æ¥ä¸‹è½½(ç°å¸¸ç®€å•)ã€‚</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220210143706701.png" alt="image-20220210143706701" style="zoom:50%;float:left" />

<blockquote>
<ol>
<li>å¦‚æœåŒæ—¶ä¸‹è½½å¹¶å‘å¼€å¾—å¤ªå¤§ï¼Œå®¹æ˜“å‘ç”Ÿå¡æ­»åœ¨æœ€åä¸åŒã€‚æœ¬äººï¼š2ä¸ªå¹¶å‘ï¼Œç½‘é€Ÿ2MB/sæ˜¯OKçš„</li>
<li>è½¯ä»¶ä¸æ”¯æŒæ–­ç‚¹ä¸‹è½½ï¼Œé€€å‡ºåå…¨éƒ¨é‡æ¥ã€‚æ±‚å¥½çš„æ–¹æ³•~</li>
</ol>
</blockquote>
<h4 id="4-ä¸Šä¼ è§†é¢‘"><a href="#4-ä¸Šä¼ è§†é¢‘" class="headerlink" title="4. ä¸Šä¼ è§†é¢‘"></a>4. ä¸Šä¼ è§†é¢‘</h4><p>é‡‡å‘&amp;æ€»ç»“çš„tips</p>
<ul>
<li><p>Bç«™ä¸Šä¼ çš„è§†é¢‘éœ€è¦å®¡æ ¸ï¼Œå¤§éƒ¨åˆ†è¯´æ˜¯20min</p>
</li>
<li><p>ä¼šæœ‰é‡å¤è§†é¢‘æ£€æŸ¥ï¼Œä»Šæ—©ä¸Šä¼ </p>
</li>
<li><p>Playlistæœ€å¥½ä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„è§†é¢‘ä¸Šä¼ ï¼Œåé¢æœ‰æ›´æ–°åœ¨ç¼–è¾‘</p>
</li>
</ul>
<h4 id="5-æ·»åŠ å­—å¹•-å¯é€‰"><a href="#5-æ·»åŠ å­—å¹•-å¯é€‰" class="headerlink" title="5. æ·»åŠ å­—å¹•(å¯é€‰)"></a>5. æ·»åŠ å­—å¹•(å¯é€‰)</h4><p>å­—å¹•å’Œè§†é¢‘å¹¶éåŒæ­¥ä¸Šä¼ </p>
<ol>
<li>æ‰¾åˆ°å¯¹åº”çš„è§†é¢‘é¡µ</li>
<li>ç‚¹å‡»å­—å¹•æŒ‰é’®ï¼Œå¹¶æ·»åŠ ä¸Šé¢ä¸‹è½½çš„å­—å¹•æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾ã€‚</li>
</ol>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220210143922087.png" alt="image-20220210143922087" style="zoom:50%;float:left" />

<h4 id="6-å‘å¸ƒblog-å¯é€‰"><a href="#6-å‘å¸ƒblog-å¯é€‰" class="headerlink" title="6. å‘å¸ƒblog(å¯é€‰)"></a>6. å‘å¸ƒblog(å¯é€‰)</h4><p>ç¬”è€…åŸºæœ¬æ˜¯å­¦ä¹ ä¸€ä¸ªè§†é¢‘æ€»ç»“ä¸€ä¸ªblogï¼Œæ‰€ä»¥ä¸Šä¼ è§†é¢‘ä¹‹åä¼šä¸Šä¼ å¯¹åº”çš„æ–‡ç« . è§†é¢‘ä¼˜å…ˆï¼Œè§†é¢‘å¥½äº›éƒ½æ˜¯ä¸€æ¬¡æ€§ä¸Šä¼ çš„ã€‚</p>
<ul>
<li>æŠ•ç¨¿-&gt;ä¸“æ ç®¡ç†</li>
<li>å¯¹.mdæ–‡ç¨¿æ”¯æŒä¸å¤ªè¡Œ</li>
</ul>
<h4 id="7-æ€ä¹ˆåšè§†é¢‘åˆé›†"><a href="#7-æ€ä¹ˆåšè§†é¢‘åˆé›†" class="headerlink" title="7. æ€ä¹ˆåšè§†é¢‘åˆé›†"></a>7. æ€ä¹ˆåšè§†é¢‘åˆé›†</h4><p>Macä¸Šæ²¡æœ‰ä¸Šä¼ å·¥å…·ï¼Œæ²¡æ³•åšè§†é¢‘åˆé›†</p>
<ul>
<li>åœ¨Macä¸Šå®‰è£…è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºä¸Šå®‰è£…windowç³»ç»Ÿï¼Œç„¶åå®‰è£…ä¸Šä¼ å·¥å…·ï¼Œå°±å¯ä»¥å¼„åˆé›†äº†ã€‚è™šæ‹Ÿæœºæ˜¯çœŸçš„å¾ˆé‡ï¼Œä¸æƒ³è¿™æ ·</li>
<li>githubæœ‰<a href="https://github.com/WLiK/Move_Video_to_Bilibili/blob/main/readme.md">è„šæœ¬</a>ï¼Œéœ€è¦æœ‰ä¸€å®šçš„ç¨‹åºåŸºç¡€</li>
<li>æ±‚å„ä½æŒ‡æ•™ç®€å•å¥½ç”¨çš„æ–¹æ¡ˆ</li>
</ul>
]]></content>
      <tags>
        <tag>youtube</tag>
        <tag>è§†é¢‘æ¬è¿</tag>
        <tag>æ·»åŠ å­—å¹•</tag>
        <tag>è§†é¢‘åˆé›†</tag>
      </tags>
  </entry>
  <entry>
    <title>æ€ä¹ˆå®ç°ä¸€ä¸ªåˆ†å¸ƒå¼kvç³»ç»Ÿ(1)-æœ¬åœ°db</title>
    <url>/2022/01/30/%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%88%86%E5%B8%83%E5%BC%8Fkv%E7%B3%BB%E7%BB%9F-1-%E6%9C%AC%E5%9C%B0db/</url>
    <content><![CDATA[<p>[TOC]</p>
<h3 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h3><p>æœ¬èŠ‚è¦å®ç°çš„æœ‰2ç‚¹</p>
<ul>
<li>ç¯å¢ƒé…ç½®ï¼šè¿œç¨‹æœåŠ¡å™¨ + VS Codeè®¾ç½®</li>
<li>å®ç°ç±»ä¼¼redisçš„setå’ŒgetåŠŸèƒ½<ul>
<li>åŸºäºbolt.DBå®ç°dbæ¨¡å—</li>
<li>å®ç°ç®€å•çš„http webæ¨¡å—</li>
</ul>
</li>
</ul>
<h3 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><h4 id="1-è¿œç¨‹æœåŠ¡å™¨-å¯é€‰æ‹©"><a href="#1-è¿œç¨‹æœåŠ¡å™¨-å¯é€‰æ‹©" class="headerlink" title="1. è¿œç¨‹æœåŠ¡å™¨[å¯é€‰æ‹©]"></a>1. è¿œç¨‹æœåŠ¡å™¨[å¯é€‰æ‹©]</h4><p>è¿œç¨‹æœåŠ¡å™¨æ¯”è¾ƒç¨³å®šï¼Œå½“ç„¶ä¹Ÿæ˜¯å¤šæŠ˜è…¾ä½“éªŒã€‚</p>
<p>è…¾è®¯äº‘æœåŠ¡å™¨è´­ä¹°è¯¦æƒ…&amp;ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„è½¯ä»¶è®¾ç½®ï¼Œè¯·å‚è€ƒ: <a href="https://blog.csdn.net/luzhangting/article/details/122435641">è¯¦ç»†çš„é…ç½®ä¿¡æ¯</a></p>
<h4 id="2-é…ç½®VSCode"><a href="#2-é…ç½®VSCode" class="headerlink" title="2. é…ç½®VSCode"></a>2. é…ç½®VSCode</h4><p>å®‰è£… Remote SSHæ’ä»¶</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220130144339299.png" alt="image-20220130144339299" style="zoom:50%;float:left" />

<p>è¿æ¥æœåŠ¡å™¨</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220130144737817.png" alt="image-20220130144737817" style="zoom:50%;float:left" />

<p>åˆ‡æ¢ç¬¬ä¸€ä¸ªtabï¼Œæ‰“å¼€èµ„æºç®¡ç†å™¨ï¼Œæ·»åŠ ç›®å½•</p>
<h4 id="3-è®¾ç½®go-mod"><a href="#3-è®¾ç½®go-mod" class="headerlink" title="3. è®¾ç½®go mod"></a>3. è®¾ç½®go mod</h4><p>æŸ¥çœ‹goç‰ˆæœ¬å’Œé…ç½®</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@VM-24-14-centos ~]# go version</span><br><span class="line">go version go1.17 linux/amd64</span><br><span class="line">[root@VM-24-14-centos ~]# echo $GOPATH</span><br><span class="line">/data/go</span><br><span class="line">[root@VM-24-14-centos ~]# echo $GOROOT</span><br><span class="line">/usr/local/go</span><br></pre></td></tr></table></figure>

<p>vscodeå®‰è£…tools</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220130145506314.png" alt="image-20220130145506314" style="zoom:50%;float:left" />

<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220130145616468.png" alt="image-20220130145616468" style="zoom:50%;float:left" />

<p>è®¾ç½®vscode goçš„é€‰é¡¹</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;go.installDependenciesWhenBuilding&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;go.useCodeSnippetsOnFunctionSuggestWithoutType&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;go.autocompleteUnimportedPackages&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;go.gotoSymbol.includeImports&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;go.useCodeSnippetsOnFunctionSuggest&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;go.inferGopath&quot;</span>: <span class="literal">true</span>,</span><br></pre></td></tr></table></figure>

<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220130150202540.png" alt="image-20220130150202540" style="zoom:50%;float:left" />

<h3 id="ç¼–ç¨‹å®ç°"><a href="#ç¼–ç¨‹å®ç°" class="headerlink" title="ç¼–ç¨‹å®ç°"></a>ç¼–ç¨‹å®ç°</h3><h4 id="1-å¯¼å…¥boltdb"><a href="#1-å¯¼å…¥boltdb" class="headerlink" title="1. å¯¼å…¥boltdb"></a>1. å¯¼å…¥boltdb</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@VM-24-14-centos go]# mkdir kv-demo</span><br><span class="line">[root@VM-24-14-centos go]# cd kv-demo</span><br><span class="line">[root@VM-24-14-centos kv-demo]# go mod init example.com/kv-demo</span><br><span class="line">[root@VM-24-14-centos kv-demo]# go mod tidy</span><br><span class="line">[root@VM-24-14-centos kv-demo]# go mod vendor</span><br><span class="line">[root@VM-24-14-centos kv-demo]# go run main.go</span><br></pre></td></tr></table></figure>

<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220130151055573.png" alt="image-20220130151055573" style="zoom:50%;float:left" />

<h4 id="2-è®¾ç½®flag"><a href="#2-è®¾ç½®flag" class="headerlink" title="2. è®¾ç½®flag"></a>2. è®¾ç½®flag</h4><p>ç›®å‰å°±ä¸€ä¸ªå‚æ•°db-location,åç»­å¯ä»¥æ·»åŠ </p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.go</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  dbLocation = flag.String(<span class="string">&quot;db-location&quot;</span>, <span class="string">&quot;my.db&quot;</span>, <span class="string">&quot;The path to the database location&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  flag.Parse()</span><br><span class="line">  db, err := bolt.Open(*dbLocation, <span class="number">0600</span>, <span class="literal">nil</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">defer</span> db.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-åˆ›å»ºHTTP-API"><a href="#3-åˆ›å»ºHTTP-API" class="headerlink" title="3. åˆ›å»ºHTTP API"></a>3. åˆ›å»ºHTTP API</h4><p>å…ˆç®€å•çš„mock http api</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.go</span></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/get&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    fmt.Fprintf(w, <span class="string">&quot;Get Called&quot;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/set&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  fmt.Fprintf(w, <span class="string">&quot;Set called&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">log.Fatal(http.ListenAndServe(<span class="string">&quot;:8090&quot;</span>, <span class="literal">nil</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@VM-24-14-centos kv-demo]# curl http://127.0.0.1:8090/set</span><br><span class="line">Set called</span><br><span class="line">[root@VM-24-14-centos kv-demo]# curl http://127.0.0.1:8090/get</span><br><span class="line">Get Called</span><br></pre></td></tr></table></figure>

<h4 id="4-DBæ¨¡å—"><a href="#4-DBæ¨¡å—" class="headerlink" title="4. DBæ¨¡å—"></a>4. DBæ¨¡å—</h4><p>ç›®å‰ä½ç½®dbçš„åŠŸèƒ½éƒ½åœ¨mainé‡Œé¢ï¼Œæˆ‘ä»¬åˆ†ç¦»å‡ºå•ç‹¬çš„dbæ¨¡å—</p>
<ul>
<li>åˆ›å»ºDB</li>
<li>è®¾ç½®key</li>
<li>è·å–key</li>
<li>åˆ›å»ºé»˜è®¤Bucket</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDatabase</span><span class="params">(dbLocation <span class="keyword">string</span>)</span> <span class="params">(db *Database, closeFunc <span class="keyword">func</span>()</span> <span class="title">error</span>, <span class="title">err</span> <span class="title">error</span>)</span> &#123;</span><br><span class="line">  boltDb, err := bolt.Open(dbLocation, <span class="number">0600</span>, <span class="literal">nil</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">  &#125;</span><br><span class="line">  db = &amp;Database&#123;db: boltDb&#125;</span><br><span class="line">  closeFunc = boltDb.Close</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := db.createDefaultBucket(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;create default bucket failed: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> db, closeFunc, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *Database)</span> <span class="title">SetKey</span><span class="params">(key <span class="keyword">string</span>, value []<span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> db.db.Update(<span class="function"><span class="keyword">func</span><span class="params">(tx *bolt.Tx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    b := tx.Bucket(defaultBucket)</span><br><span class="line">    <span class="keyword">return</span> b.Put([]<span class="keyword">byte</span>(key), value)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *Database)</span> <span class="title">GetKey</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> rc []<span class="keyword">byte</span></span><br><span class="line">  err := db.db.View(<span class="function"><span class="keyword">func</span><span class="params">(tx *bolt.Tx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    b := tx.Bucket(defaultBucket)</span><br><span class="line">    rc = b.Get([]<span class="keyword">byte</span>(key))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> rc, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *Database)</span> <span class="title">createDefaultBucket</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> db.db.Update(<span class="function"><span class="keyword">func</span><span class="params">(tx *bolt.Tx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    _, err := tx.CreateBucketIfNotExists([]<span class="keyword">byte</span>(defaultBucket))</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-æ›´æ–°API"><a href="#5-æ›´æ–°API" class="headerlink" title="5. æ›´æ–°API"></a>5. æ›´æ–°API</h4><p>æ›´æ–°set &amp; get http apiæ¥</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">http.HandleFunc(<span class="string">&quot;/get&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  r.ParseForm()</span><br><span class="line">  key := r.Form.Get(<span class="string">&quot;key&quot;</span>)</span><br><span class="line">  value, err := db.GetKey(key)</span><br><span class="line">  fmt.Fprintf(w, <span class="string">&quot;%q:%q; %v Get Called\n&quot;</span>, key, value, err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/set&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  r.ParseForm()</span><br><span class="line">  key := r.Form.Get(<span class="string">&quot;key&quot;</span>)</span><br><span class="line">  value := r.Form.Get(<span class="string">&quot;value&quot;</span>)</span><br><span class="line">  err := db.SetKey(key, []<span class="keyword">byte</span>(value))</span><br><span class="line">  fmt.Fprintf(w, <span class="string">&quot;err: %v; Set called\n&quot;</span>, err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="6-æµ‹è¯•"><a href="#6-æµ‹è¯•" class="headerlink" title="6. æµ‹è¯•"></a>6. æµ‹è¯•</h4><ul>
<li>Set a:b</li>
<li>Get a</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@VM-24-14-centos src]# curl &#x27;http://127.0.0.1:8090/set?value=b&amp;key=a&#x27;</span><br><span class="line">&quot;a&quot;:&quot;b&quot;; &lt;nil&gt;; Set called</span><br><span class="line">[root@VM-24-14-centos src]# curl http://127.0.0.1:8090/get?key=a</span><br><span class="line">&quot;a&quot;:&quot;b&quot;; &lt;nil&gt; Get Called</span><br></pre></td></tr></table></figure>

<h4 id="7-webåˆ†ç¦»"><a href="#7-webåˆ†ç¦»" class="headerlink" title="7. webåˆ†ç¦»"></a>7. webåˆ†ç¦»</h4><p>ç±»ä¼¼dbåˆ†ç¦»ï¼Œwebä¹Ÿæ˜¯å•ç‹¬çš„æ¨¡å—</p>
<ul>
<li>åˆ›å»º</li>
<li>å¤„ç†get</li>
<li>å¤„ç†set</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">  db *db.Database</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(db *db.Database)</span> *<span class="title">Server</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;Server&#123;db: db&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">GetHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  r.ParseForm()</span><br><span class="line">  key := r.Form.Get(<span class="string">&quot;key&quot;</span>)</span><br><span class="line">  value, err := s.db.GetKey(key)</span><br><span class="line">  fmt.Fprintf(w, <span class="string">&quot;%q:%q; %v Get Called\n&quot;</span>, key, value, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">SetHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  r.ParseForm()</span><br><span class="line">  key := r.Form.Get(<span class="string">&quot;key&quot;</span>)</span><br><span class="line">  value := r.Form.Get(<span class="string">&quot;value&quot;</span>)</span><br><span class="line">  err := s.db.SetKey(key, []<span class="keyword">byte</span>(value))</span><br><span class="line">  fmt.Fprintf(w, <span class="string">&quot;%q:%q; %v; Set called\n&quot;</span>, key, value, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="8-æ›´æ–°main"><a href="#8-æ›´æ–°main" class="headerlink" title="8. æ›´æ–°main"></a>8. æ›´æ–°main</h4><p>webæ¨¡å—åœ¨mainä¸­è°ƒç”¨</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">svr := web.NewServer(db)</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/get&quot;</span>, svr.GetHandler)</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/set&quot;</span>, svr.SetHandler)</span><br><span class="line"></span><br><span class="line">log.Fatal(http.ListenAndServe(*httpAddress, <span class="literal">nil</span>))</span><br></pre></td></tr></table></figure>

<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p>æœ¬èŠ‚å®Œæ•´ä»£ç ï¼š<a href="https://github.com/YuriyNasretdinov/distribkv/tree/part1">https://github.com/YuriyNasretdinov/distribkv/tree/part1</a></p>
<p>youtubeè§†é¢‘ï¼š<a href="https://www.youtube.com/watch?v=oPwGrCoOUdo&amp;list=PLWwSgbaBp9XrMkjEhmTIC37WX2JfwZp7I&amp;index=2">https://www.youtube.com/watch?v=oPwGrCoOUdo&amp;list=PLWwSgbaBp9XrMkjEhmTIC37WX2JfwZp7I&amp;index=2</a></p>
<p>Bç«™è§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV1nR4y177YM?p=1">https://www.bilibili.com/video/BV1nR4y177YM?p=1</a></p>
]]></content>
      <tags>
        <tag>kv</tag>
        <tag>local database</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”¨Goå®ç°ä¸€æ­¥æ­¥å®ç°çš„åˆ†å¸ƒå¼Key-Valueæ•°æ®åº“(0)-å®ç°ç›®æ ‡</title>
    <url>/2022/01/30/%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%88%86%E5%B8%83%E5%BC%8Fkv%E7%B3%BB%E7%BB%9F-0-%E5%AE%9E%E7%8E%B0%E7%9B%AE%E6%A0%87/</url>
    <content><![CDATA[<h3 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h3><p>æœ¬èŠ‚ä¸ºã€Šç”¨Goå®ç°ä¸€æ­¥æ­¥å®ç°çš„åˆ†å¸ƒå¼Key-Valueæ•°æ®åº“ã€‹ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ï¼Œè®²äº†æˆ‘ä»¬è¿™ä¸ªç³»åˆ—è¦å®ç°å•¥ç›®æ ‡ã€‚</p>
<h3 id="è¯¦ç»†è¯´æ˜"><a href="#è¯¦ç»†è¯´æ˜" class="headerlink" title="è¯¦ç»†è¯´æ˜"></a>è¯¦ç»†è¯´æ˜</h3><h4 id="æ¶æ„å›¾"><a href="#æ¶æ„å›¾" class="headerlink" title="æ¶æ„å›¾"></a>æ¶æ„å›¾</h4><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220228182912030.png" alt="image-20220228182912030" style="zoom:100%; float:left" />

<p>SRV1-4ï¼šå†™èŠ‚ç‚¹</p>
<p>RPL1-4ï¼šè¯»èŠ‚ç‚¹ </p>
<p>çº¢è‰²ç®­å¤´: å†™æµé‡</p>
<p>ç»¿è‰²ç®­å¤´ï¼šè¯»æµé‡</p>
<p>SVR1-&gt;RPL1: æ•°æ®åŒæ­¥</p>
<p>Magicç»„ä»¶ä¸»è¦å®ç°çš„å‡ ç‚¹åŠŸèƒ½ï¼š</p>
<ul>
<li>å†™ä¸»åº“ï¼Œè¯»ä»åº“</li>
<li>æ•°æ®è·¯ç”±ï¼Œè·¯ç”±è§„åˆ™ï¼šServer(â€œkeyâ€) = Hash(â€œkeyâ€)%NUM</li>
<li>æ•°æ®åŒæ­¥ï¼Œå†™èŠ‚ç‚¹-&gt;è¯»èŠ‚ç‚¹</li>
</ul>
]]></content>
      <tags>
        <tag>æ‘˜è¦</tag>
      </tags>
  </entry>
  <entry>
    <title>go-åŒ…ç®¡ç†</title>
    <url>/2022/01/21/go-%E5%8C%85%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>æ¯æ¬¡æ‰“å¼€IDEï¼Œéƒ½å˜çº¢ã€‚å¦‚æœè¶…è¿‡3æ¬¡ï¼Œæˆ‘æƒ³ç€æ˜¯ä¸æ˜¯åº”è¯¥å°†äº‹å®å¼„æ˜ç™½å‘¢ã€‚</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220121111115117.png" alt="image-20220121111115117" style="zoom:100%;float:left" />

<h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><h5 id="1ã€ä¸ºå•¥ä¼šæŠ¥é”™ï¼Ÿ"><a href="#1ã€ä¸ºå•¥ä¼šæŠ¥é”™ï¼Ÿ" class="headerlink" title="1ã€ä¸ºå•¥ä¼šæŠ¥é”™ï¼Ÿ"></a>1ã€ä¸ºå•¥ä¼šæŠ¥é”™ï¼Ÿ</h5><blockquote>
<p>è‚¯å®šæ˜¯æ‰¾ä¸åˆ°å¯¹åº”çš„pkg</p>
</blockquote>
<h5 id="2ã€é‚£IDEåˆ°åº•æ˜¯å»å“ªé‡Œæ‰¾äº†å‘¢ï¼Ÿ"><a href="#2ã€é‚£IDEåˆ°åº•æ˜¯å»å“ªé‡Œæ‰¾äº†å‘¢ï¼Ÿ" class="headerlink" title="2ã€é‚£IDEåˆ°åº•æ˜¯å»å“ªé‡Œæ‰¾äº†å‘¢ï¼Ÿ"></a>2ã€é‚£IDEåˆ°åº•æ˜¯å»å“ªé‡Œæ‰¾äº†å‘¢ï¼Ÿ</h5><blockquote>
<p>ç†è®ºä¸Šæ˜¯gopathè·¯å¾„ä¸‹é¢ï¼ŒğŸ‘‡ğŸ»GOPATH=â€/root/gopathâ€ è¿™é‡Œï¼ŒIDEé‡Œé¢å¯ä»¥è®¾ç½®çš„é¡¹ç›®æ›´å¤š</p>
</blockquote>
<p>go envçš„è¾“å‡º</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GO111MODULE=&quot;on&quot; </span><br><span class="line">GOPATH=&quot;/root/gopath&quot;</span><br><span class="line">GOPROXY=&quot;https://goproxy.cn,direct&quot;  # è®¾ç½®ä»£ç†ï¼Œgo getçš„æ—¶å€™å¿«ç‚¹</span><br><span class="line">GOROOT=&quot;/usr/local/go&quot;  # goäºŒè¿›åˆ¶åŒ…çš„å®‰è£…åœ°å€</span><br><span class="line">GOVERSION=&quot;go1.17&quot;  # goç‰ˆæœ¬</span><br></pre></td></tr></table></figure>

<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220121181545764.png" alt="image-20220121181545764" style="zoom:100%;float:left" />

<h5 id="3ã€å®é™…ä¸ŠGOPATHä¸‹é¢æ˜¯æœ‰éœ€è¦çš„pkgçš„"><a href="#3ã€å®é™…ä¸ŠGOPATHä¸‹é¢æ˜¯æœ‰éœ€è¦çš„pkgçš„" class="headerlink" title="3ã€å®é™…ä¸ŠGOPATHä¸‹é¢æ˜¯æœ‰éœ€è¦çš„pkgçš„"></a>3ã€å®é™…ä¸ŠGOPATHä¸‹é¢æ˜¯æœ‰éœ€è¦çš„pkgçš„</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> éœ€è¦çš„åŒ…</span>	</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> % ll /Users/linmi/go/pkg/mod/github.com/prometheus</span></span><br><span class="line">total 0</span><br><span class="line">dr-xr-xr-x   23 linmi  staff   736B  1 21 12:01 client_golang@v1.12.0</span><br><span class="line">dr-xr-xr-x   13 linmi  staff   416B  1 21 12:01 client_model@v0.2.0</span><br><span class="line">dr-xr-xr-x   24 linmi  staff   768B  1 21 12:01 common@v0.32.1</span><br><span class="line">dr-xr-xr-x  122 linmi  staff   3.8K  1 21 12:01 procfs@v0.7.3</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IDEæŠ¥é”™çš„è·¯å¾„</span></span><br><span class="line">/Users/linmi/go/pkg/mod/src/github.com/prometheus/client_golang/prometheus/promhttp (from $GOPATH)</span><br></pre></td></tr></table></figure>

<p>ğŸ“¢ï¼šIDEæŠ¥é”™çš„è·¯å¾„é‡Œé¢å¤šäº†ä¸€å±‚<code>src</code>ç›®å½•ï¼Œè¿™å°±æœ‰ç‚¹å‡ºä¹æ„æ–™äº†ã€‚</p>
<h5 id="4ã€æœ€ä½³å®è·µ"><a href="#4ã€æœ€ä½³å®è·µ" class="headerlink" title="4ã€æœ€ä½³å®è·µ"></a>4ã€æœ€ä½³å®è·µ</h5><p>gopathå’Œgo modæ˜¯äº’æ–¥çš„ï¼Œç°åœ¨çš„è¯è‚¯å®šæ˜¯go modäº†ã€‚æœ€ç®€å•&amp;æœ‰æ•ˆçš„æ–¹æ³•ï¼Œç±»ä¼¼pythoné‚£æ ·ï¼Œå„ä¸ªé¡¹ç›®è‡ªå·±ç®¡ç†è‡ªå·±çš„åŒ…ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">go mod vendor # åˆ›å»ºvendorä¾èµ–</span><br><span class="line">go mod tidy </span><br></pre></td></tr></table></figure>

<p>IDEæ‰“å¼€go modulesçš„é€‰é¡¹ï¼Œé—®é¢˜è‡ªç„¶å°±è§£å†³äº†</p>
<h5 id="5ã€Macä¸Šgoå¤šç‰ˆæœ¬æ€ä¹ˆç®¡ç†"><a href="#5ã€Macä¸Šgoå¤šç‰ˆæœ¬æ€ä¹ˆç®¡ç†" class="headerlink" title="5ã€Macä¸Šgoå¤šç‰ˆæœ¬æ€ä¹ˆç®¡ç†"></a>5ã€Macä¸Šgoå¤šç‰ˆæœ¬æ€ä¹ˆç®¡ç†</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…ˆç¡®è®¤æ˜¯ä¸æ˜¯brewç®¡ç†</span></span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> % <span class="built_in">which</span> go</span></span><br><span class="line">/usr/local/bin/go</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> % ll -h /usr/<span class="built_in">local</span>/bin/go</span></span><br><span class="line">lrwxr-xr-x  1 linmi  admin    26B 10 12 23:34 /usr/local/bin/go -&gt; ../Cellar/go/1.17.2/bin/go # Cellarè¿™é‡Œå°±èƒ½è¯´æ˜æ˜¯çš„</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¥ç€çœ‹çœ‹æœ‰å“ªäº›ç‰ˆæœ¬ï¼Œæˆ‘çš„æœ¬æœºæœ‰3ä¸ªç‰ˆæœ¬</span></span><br><span class="line">ll /usr/local/opt | grep go  # opt=optionsæŸ¥çœ‹å¯é€‰æ‹©çš„ç‰ˆæœ¬</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    19B 10 12 23:34 go -&gt; ../Cellar/go/1.17.2</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    25B 10 13 10:54 go@1.15 -&gt; ../Cellar/go@1.15/1.15.15</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    24B  9 23 11:27 go@1.16 -&gt; ../Cellar/go@1.16/1.16.8</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    19B 10 12 23:34 go@1.17 -&gt; ../Cellar/go/1.17.2</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    19B 10 12 23:34 golang -&gt; ../Cellar/go/1.17.2</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    19B 10 12 23:34 google-go -&gt; ../Cellar/go/1.17.2</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> é‚£è¦æ€ä¹ˆä½¿ç”¨brewå¿«æ·çš„è¿›è¡Œè®¾ç½®å‘¢</span></span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> % brew link go</span></span><br><span class="line">Warning: Already linked: /usr/local/Cellar/go/1.17.2</span><br><span class="line">To relink, run:</span><br><span class="line">  brew unlink go &amp;&amp; brew link go   # é‡æ–°å›åˆ°æœ€è¿‘çš„ç‰ˆæœ¬</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash">% brew link --overwrite go@1.16  <span class="comment"># çœ‹è¿™ä¸ªå°±çŸ¥é“æ˜¯é‡å†™äº†</span></span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>go</tag>
        <tag>åŒ…ç®¡ç†</tag>
      </tags>
  </entry>
  <entry>
    <title>tikv-4-DEADLINE_EXCEEDED</title>
    <url>/2022/01/20/tikv-4-DEADLINE-EXCEEDED/</url>
    <content><![CDATA[<h3 id="æŠ¥é”™è¯¦æƒ…"><a href="#æŠ¥é”™è¯¦æƒ…" class="headerlink" title="æŠ¥é”™è¯¦æƒ…"></a>æŠ¥é”™è¯¦æƒ…</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[2022/01/20 12:38:23.922 +08:00] [WARN] [prewrite.rs:469] [&quot;commit_ts is too large, fallback to normal 2PC&quot;] [lock=&quot;Lock &#123; lock_type: Delete, primary_key: 7480000000000000415F6980000000000000010380000000002AB89803800000000026466A, start_ts: TimeStamp(430611757768638581), ttl: 4003, short_value: , for_update_ts: TimeStamp(0), txn_size: 1, min_commit_ts: TimeStamp(430611757768638582), use_async_commit: true, secondaries: [], rollback_ts: [] &#125;&quot;] [max_commit_ts=430611758555857013] [min_commit_ts=430611760114565123] [start_ts=430611757768638581] [key=7480000000000000FF415F728000000000FF26466A0000000000FA]</span><br><span class="line">[2022/01/20 12:38:29.199 +08:00] [INFO] [compaction_filter.rs:501] [&quot;Compaction filter reports&quot;] [filtered=382901] [total=2812852]</span><br><span class="line">[2022/01/20 12:38:40.004 +08:00] [ERROR] [util.rs:419] [&quot;request failed, retry&quot;] [err_code=KV:PD:gRPC] [err=&quot;Grpc(RpcFailure(RpcStatus &#123; code: 4-DEADLINE_EXCEEDED, message: \&quot;Deadline Exceeded\&quot;, details: [] &#125;))&quot;]</span><br></pre></td></tr></table></figure>

<h3 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h3><h3 id="åŸå› åˆ†æ"><a href="#åŸå› åˆ†æ" class="headerlink" title="åŸå› åˆ†æ"></a>åŸå› åˆ†æ</h3>]]></content>
      <tags>
        <tag>tikv</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoæ–‡ç« è®¾ç½®è‰ç¨¿-æš‚ä¸å‘å¸ƒ-æ–‡ç« åˆ†ç±»</title>
    <url>/2022/01/12/hexo%E6%96%87%E7%AB%A0%E8%AE%BE%E7%BD%AE%E8%8D%89%E7%A8%BF-%E6%9A%82%E4%B8%8D%E5%8F%91%E5%B8%83-%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB/</url>
    <content><![CDATA[<h4 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h4><p>1ã€æ¯æ¬¡æ‰§è¡Œhexo d -géƒ½ä¼šå°†æ‰€æœ‰çš„æ‰€æœ‰æ–‡ç« pushä¸Šå»ï¼Œæœ‰çš„æ–‡ç« å…¶å®ä¸€ä¸ªæ˜¯æ²¡æœ‰å†™å®Œï¼Œä¸€ä¸ªæ˜¯æ•æ„Ÿä¿¡æ¯è¿˜éœ€è¦å¤„ç†</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo new draft &lt;title&gt;  # source/_drafts</span><br><span class="line">hexo P &lt;filename&gt;       # source/_drafts  -&gt;  source/_post</span><br></pre></td></tr></table></figure>

<p>2ã€èƒ½ä¸èƒ½åˆ†ç±»ï¼Œå½“å‰æ‰€æœ‰çš„æ–‡ç« éƒ½åœ¨source/_postsä¸‹é¢(å¦‚ä¸‹å›¾)ï¼Œåé¢è¶Šæ¥è¶Šå¤šï¼ŒçœŸçš„ä¸å¥½ç®¡ç†ï¼Œä¹Ÿä¸å¥½æ‰¾</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220112102324526.png" alt="image-20220112102324526" style="zoom:50%;float:left" />

<h4 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h4>]]></content>
      <tags>
        <tag>hexo</tag>
        <tag>blog</tag>
        <tag>è‰ç¨¿</tag>
        <tag>æ–‡ç« åˆ†ç±»</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¹°ä¸€ä¸ª3å¹´è…¾è®¯äº‘æœåŠ¡-æ—¥å¸¸å¼€å‘ä½¿ç”¨</title>
    <url>/2022/01/11/%E4%B9%B0%E4%B8%80%E4%B8%AA3%E5%B9%B4%E8%85%BE%E8%AE%AF%E4%BA%91%E6%9C%8D%E5%8A%A1-%E6%97%A5%E5%B8%B8%E5%BC%80%E5%8F%91%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h3 id="èƒŒæ™¯2022-01-11-â€“-è…¾è®¯äº‘æœåŠ¡å™¨å¼€å‘"><a href="#èƒŒæ™¯2022-01-11-â€“-è…¾è®¯äº‘æœåŠ¡å™¨å¼€å‘" class="headerlink" title="èƒŒæ™¯2022-01-11 â€“ è…¾è®¯äº‘æœåŠ¡å™¨å¼€å‘"></a>èƒŒæ™¯2022-01-11 â€“ è…¾è®¯äº‘æœåŠ¡å™¨å¼€å‘</h3><p>ä»Šå¤©åœ¨çœ‹å¤§ä½¬å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œå¤§ä½¬è¯´æˆ‘ä¸æƒ³åœ¨æœ¬åœ°å¼€å‘ï¼Œç¯å¢ƒé‡å¯éº»çƒ¦ï¼Œæˆ‘æƒ³ä¸‡åˆ†èµåŒã€‚æ¯æ¬¡æ¢ç”µè„‘éƒ½æ˜¯çƒ¦äººã€‚</p>
<p>ç„¶åæˆ‘å°±æ‰“å¼€äº†é˜¿é‡Œäº‘ï¼Œä¸€çœ‹å¥½è´µï¼Œæ¥ç€æ‰“å¼€äº†è…¾è®¯äº‘ï¼Œå—¯ï¼Œå¥½åƒä¾¿å®œç‚¹ã€‚æˆ‘æ‰¿è®¤æˆ‘å°±æ˜¯è¢«ä¸‹é¢çš„å¹¿å‘Šå¸å¼•çš„ã€‚ç„¶åæˆ‘å°±ç‚¹äº†ç«‹å³è´­ä¹°çš„æŒ‰é’®ğŸ˜‚</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111143908730.png" alt="image-20220111143908730" style="zoom:50%;float:left" />

<p>æ¥ç€æˆ‘æƒ³1æ ¸2Gå®åœ¨æ˜¯æ°”è´¨ä¸ç¬¦ï¼Œå¤´è„‘ä¸€çƒ­2æ ¸4Gï¼Œä¸€çœ‹1å¹´è™½ç„¶ä¹Ÿå¾ˆé•¿ï¼Œ ä¸è¿‡3å¹´å¥½åƒæ›´ä¸ç”¨æ“å¿ƒï¼Œä¸»è¦æ˜¯æ€•è¢«å‚¬è´¦ã€‚</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111144433048.png" alt="image-20220111144433048" style="zoom:50%;float:left" />

<p>å¥½ï¼Œæ¥ç€å°±æ˜¯æ‰“å¼€å¾®ä¿¡-ç»‘å®š+ä»˜é’±äº†,è®¢å•å°±å¥½äº†</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111144703537.png" alt="image-20220111144703537" style="zoom:50%;float:left" />

<h4 id="sshç™»å½•è®¾ç½®"><a href="#sshç™»å½•è®¾ç½®" class="headerlink" title="sshç™»å½•è®¾ç½®"></a>sshç™»å½•è®¾ç½®</h4><p>è¯´å®è¯ï¼Œä¸è®ºæ˜¯é˜¿é‡Œäº‘è¿˜æ˜¯è…¾è®¯äº‘çš„webéƒ½å¼‚å¸¸çš„å¤æ‚ï¼Œå„ç§ç‚¹ç‚¹ç‚¹éƒ½æ˜¯äº§å“+äº§å“ï¼Œè´¦å•+è´¦å•ã€‚å°±æƒ³é—®åˆšä¹°çš„æœåŠ¡å™¨å»å“ªäº†ã€‚</p>
<p>ä¸æµªè´¹æ—¶é—´ï¼š<a href="https://console.cloud.tencent.com/lighthouse/instance/index">https://console.cloud.tencent.com/lighthouse/instance/index</a>  chromeä¿å­˜ğŸ”–å§ï¼Œæ‰¾èµ·æ¥è´¹åŠ²ã€‚</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111145804003.png" alt="image-20220111145804003" style="zoom:50%;float:left" />

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ç¼–è¾‘sshd_config,å¦‚ä¸‹</span></span></span><br><span class="line">sudo vi /etc/ssh/sshd_config</span><br><span class="line">[lighthouse@VM-24-14-centos ~]$ # vim /etc/ssh/sshd_config </span><br><span class="line">[lighthouse@VM-24-14-centos ~]$ # PermitRootLogin yes å»æ‰æ³¨é‡Š</span><br><span class="line">[lighthouse@VM-24-14-centos ~]$ # pubkeyAuthentication yes å»æ‰æ³¨é‡Š</span><br><span class="line">[lighthouse@VM-24-14-centos ~]$ # PasswordAuthentication yes å»æ‰æ³¨é‡Š</span><br><span class="line"><span class="meta">#</span><span class="bash"> é‡å¯sshdæœåŠ¡</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="æœ¬æœºé…ç½®sshå¹¶ç™»å½•"><a href="#æœ¬æœºé…ç½®sshå¹¶ç™»å½•" class="headerlink" title="æœ¬æœºé…ç½®sshå¹¶ç™»å½•"></a>æœ¬æœºé…ç½®sshå¹¶ç™»å½•</h4><p>æ‰¾åˆ°å…¬ç½‘ip</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111150006715.png" alt="image-20220111150006715" style="zoom:50%;float:left" />

<p>å°†æœ¬æœºçš„å…¬é’¥é€šè¿‡ssh-copy-idæ‹·è´åˆ°remote host</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-copy-id root@ip</span><br><span class="line">ssh root@ip  # ç›´æ¥ç™»å½•</span><br></pre></td></tr></table></figure>

<h4 id="é€šè¿‡vscodeç™»å½•å¹¶ä¸”code"><a href="#é€šè¿‡vscodeç™»å½•å¹¶ä¸”code" class="headerlink" title="é€šè¿‡vscodeç™»å½•å¹¶ä¸”code"></a>é€šè¿‡vscodeç™»å½•å¹¶ä¸”code</h4><h5 id="å…ˆå®‰è£…remote-sshæ’ä»¶"><a href="#å…ˆå®‰è£…remote-sshæ’ä»¶" class="headerlink" title="å…ˆå®‰è£…remote sshæ’ä»¶"></a>å…ˆå®‰è£…remote sshæ’ä»¶</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111150257939.png" alt="image-20220111150257939" style="zoom:50%;float:left" />

<h5 id="è¾“å…¥ssh-root-ipå¹¶é€‰æ‹©ssh-configï¼ŒåŸè°…è‰²å‡ºç°æå®Œï¼Œæ¥ç€å°±æ˜¯æ„‰å¿«çš„coding"><a href="#è¾“å…¥ssh-root-ipå¹¶é€‰æ‹©ssh-configï¼ŒåŸè°…è‰²å‡ºç°æå®Œï¼Œæ¥ç€å°±æ˜¯æ„‰å¿«çš„coding" class="headerlink" title="è¾“å…¥ssh root@ipå¹¶é€‰æ‹©ssh configï¼ŒåŸè°…è‰²å‡ºç°æå®Œï¼Œæ¥ç€å°±æ˜¯æ„‰å¿«çš„coding"></a>è¾“å…¥ssh root@ipå¹¶é€‰æ‹©ssh configï¼ŒåŸè°…è‰²å‡ºç°æå®Œï¼Œæ¥ç€å°±æ˜¯æ„‰å¿«çš„coding</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111150401476.png" alt="image-20220111150401476" style="zoom:50%;float:left" />

<h5 id="æ‰“å¼€è¿œç«¯çš„æ–‡ä»¶"><a href="#æ‰“å¼€è¿œç«¯çš„æ–‡ä»¶" class="headerlink" title="æ‰“å¼€è¿œç«¯çš„æ–‡ä»¶"></a>æ‰“å¼€è¿œç«¯çš„æ–‡ä»¶</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111151140566.png" alt="image-20220111151140566" style="zoom:50%;float:left" />

<h5 id="åˆ é™¤ä¸‹remote-hostï¼Œæ¯”å¦‚ipå†™é”™äº†ä¹‹ç±»ï¼Œç¼–è¾‘-ssh-configæ–‡ä»¶æ‰è¡Œ"><a href="#åˆ é™¤ä¸‹remote-hostï¼Œæ¯”å¦‚ipå†™é”™äº†ä¹‹ç±»ï¼Œç¼–è¾‘-ssh-configæ–‡ä»¶æ‰è¡Œ" class="headerlink" title="åˆ é™¤ä¸‹remote hostï¼Œæ¯”å¦‚ipå†™é”™äº†ä¹‹ç±»ï¼Œç¼–è¾‘~/.ssh/configæ–‡ä»¶æ‰è¡Œ"></a>åˆ é™¤ä¸‹remote hostï¼Œæ¯”å¦‚ipå†™é”™äº†ä¹‹ç±»ï¼Œç¼–è¾‘~/.ssh/configæ–‡ä»¶æ‰è¡Œ</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111151753449.png" alt="image-20220111151753449" style="zoom:50%;float:left" />

<h5 id="è‡ªå·±å®‰è£…éœ€è¦çš„æ’ä»¶ï¼Œæ³¨æ„æœ¬åœ°å’Œè¿œç¨‹æ˜¯ä¸ä¸€æ ·çš„"><a href="#è‡ªå·±å®‰è£…éœ€è¦çš„æ’ä»¶ï¼Œæ³¨æ„æœ¬åœ°å’Œè¿œç¨‹æ˜¯ä¸ä¸€æ ·çš„" class="headerlink" title="è‡ªå·±å®‰è£…éœ€è¦çš„æ’ä»¶ï¼Œæ³¨æ„æœ¬åœ°å’Œè¿œç¨‹æ˜¯ä¸ä¸€æ ·çš„"></a>è‡ªå·±å®‰è£…éœ€è¦çš„æ’ä»¶ï¼Œæ³¨æ„æœ¬åœ°å’Œè¿œç¨‹æ˜¯ä¸ä¸€æ ·çš„</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111152351292.png" alt="image-20220111152351292" style="zoom:50%;float:left" />

<h5 id="åœ¨centos7ä¸Šå®‰è£…goï¼Œè®¾ç½®go-env"><a href="#åœ¨centos7ä¸Šå®‰è£…goï¼Œè®¾ç½®go-env" class="headerlink" title="åœ¨centos7ä¸Šå®‰è£…goï¼Œè®¾ç½®go env"></a>åœ¨centos7ä¸Šå®‰è£…goï¼Œè®¾ç½®go env</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">yum update -y</span><br><span class="line">yum install -y go # å®‰è£…çš„æ˜¯1.15</span><br><span class="line">go env -w GOPROXY=https://goproxy.cn,direct</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="ä¸ºå•¥è¿™ä¸ªå¯¼å…¥ä¼šæŠ¥é”™å‘¢ï¼Ÿ-å—¯ï¼Œå¤§æ¦‚ç‡å°±æ˜¯ç¯å¢ƒçš„é—®é¢˜ï¼Œç”¨ä¸ªgo-mod-initè§£å†³å°±è¡Œ"><a href="#ä¸ºå•¥è¿™ä¸ªå¯¼å…¥ä¼šæŠ¥é”™å‘¢ï¼Ÿ-å—¯ï¼Œå¤§æ¦‚ç‡å°±æ˜¯ç¯å¢ƒçš„é—®é¢˜ï¼Œç”¨ä¸ªgo-mod-initè§£å†³å°±è¡Œ" class="headerlink" title="ä¸ºå•¥è¿™ä¸ªå¯¼å…¥ä¼šæŠ¥é”™å‘¢ï¼Ÿ å—¯ï¼Œå¤§æ¦‚ç‡å°±æ˜¯ç¯å¢ƒçš„é—®é¢˜ï¼Œç”¨ä¸ªgo mod initè§£å†³å°±è¡Œ"></a>ä¸ºå•¥è¿™ä¸ªå¯¼å…¥ä¼šæŠ¥é”™å‘¢ï¼Ÿ å—¯ï¼Œå¤§æ¦‚ç‡å°±æ˜¯ç¯å¢ƒçš„é—®é¢˜ï¼Œç”¨ä¸ªgo mod initè§£å†³å°±è¡Œ</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111161358986.png" alt="image-20220111161358986" style="zoom:50%;float:left" />

<p>2021-01-11ä»Šå¤©å…ˆåˆ°è¿™ï¼Œç­‰ä¼šé¢æœ‰æ–°çš„æƒ³æ³•äº†åœ¨æ›´æ–°</p>
<p>2021-01-14å·ï¼Œæ¥ç€ä¸Šé¢ï¼Œè¢«æ”»å‡»äº†</p>
<h3 id="èƒŒæ™¯2021-01-14-è…¾è®¯äº‘æœåŠ¡å™¨è¢«æ”»å‡»"><a href="#èƒŒæ™¯2021-01-14-è…¾è®¯äº‘æœåŠ¡å™¨è¢«æ”»å‡»" class="headerlink" title="èƒŒæ™¯2021-01-14-è…¾è®¯äº‘æœåŠ¡å™¨è¢«æ”»å‡»"></a>èƒŒæ™¯2021-01-14-è…¾è®¯äº‘æœåŠ¡å™¨è¢«æ”»å‡»</h3><p>æˆ‘çš„è…¾è®¯äº‘çš„è½»é‡æœåŠ¡å™¨ï¼Œçªç„¶ç»™æˆ‘å‘æ¶ˆæ¯è¯´æˆ‘æœ‰è¿è§„è¡Œä¸ºï¼Œæˆ‘å°±å¼€äº†22ç«¯å£åšäº†ä¸€ä¸ªè¿œç¨‹ç™»å½•ğŸ˜‚</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220114115516893.png" alt="image-20220114115516893" style="zoom:50%;float:left" />

<h4 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h4><p>1ã€æˆ‘å…ˆç­‰äº†ä¸€å¤©ï¼Œé€šçŸ¥çš„24hæ¥è§¦å°ç¦</p>
<p>2ã€ç»“æœè¿˜æ˜¯ä¸èƒ½ç™»å½•</p>
<p>3ã€å®¢æœè¯´å¾—ç”¨VNCç™»å½•ï¼Œ<a href="https://cloud.tencent.com/document/product/1207/46824">https://cloud.tencent.com/document/product/1207/46824</a> ï¼Œ å°±æ˜¯ä¸‹é¢çš„è¿™ä¸ªæŒ‰é’®</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220114115847427.png" alt="image-20220114115847427" style="zoom:50%;float:left" />

<p>4ã€æˆ‘å‘ç°å¾—è¦ä¸ªå¯†ç ä¸æ˜¯ï¼Œå¯æ˜¯æ²¡æœ‰åˆå§‹å¯†ç ï¼Œè®°ä½ç¬¬ä¸€æ¬¡å¿…é¡»æ˜¯é‡ç½®å¯†ç ï¼Œåœ¨é¡µé¢ä¸Šctrl+fæœç´¢å¯†ç ,å°±æ˜¯ä¸‹é¢çš„&lt;é‡ç½®å¯†ç &gt;æŒ‰é’®ã€‚å®é™…ä¸Šæ“ä½œå°±æ˜¯ä¹‹å‰æˆ‘ä»¬åšçš„sudo passwd root  â€“ æ³¨æ„è¿™é‡Œå‰å¾€ä¸è¦å¼„çš„å¤ªç®€å•äº†ï¼ŒçœŸçš„å¾ˆå®¹æ˜“è¢«ç ´è§£ã€‚</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220114120029547.png" alt="image-20220114120029547" style="zoom:50%;float:left" />

<p>5ã€å¥½äº†ä¸€æ¬¡æ¬¡é‡å¯ä¹‹åä½ å°±å¯ä»¥åœ¨&lt;é¡µé¢ä¸Š&gt;æ­£å¸¸ç™»å½•äº†ï¼Œæ¥ç€è‚¯å®šæ˜¯æœ¬æœºç™»å½•ï¼Œå‘ç°å°±å‡ºç°äº†ä¸‹é¢çš„ä¸œè¥¿ğŸ˜‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">-&gt;</span><span class="bash"> % ssh root@ip</span></span><br><span class="line">root@ip: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).</span><br></pre></td></tr></table></figure>

<p>6ã€ä¸ºå•¥ä¸è¡Œäº†å‘¢ï¼Œ çœ‹æ–‡æ¡£è¯´æ˜¯è¦ä¹ˆä½¿ç”¨å¯†ç ï¼Œè¦ä¹ˆä½¿ç”¨ç§˜é’¥ï¼Œå®é™…ä¸Šæ˜¯éƒ½å¯ä»¥ç”¨ï¼Œä¸è¿‡å°±æ˜¯æˆæƒçš„æ–¹å¼ä¸åŒ</p>
<ul>
<li>ç®¡ç†å¯†é’¥  <a href="https://cloud.tencent.com/document/product/1207/44573">https://cloud.tencent.com/document/product/1207/44573</a></li>
</ul>
<p>å› ä¸ºä¹‹å‰æˆ‘ä»¬ç™»å½•è¿‡ï¼Œåœ¨~/.ssh/known_hostsè¿™é‡Œå·²ç»æœ‰ipè®°å½•äº†ï¼ŒæŠŠå¯¹åº”ipçš„è®°å½•å»æ‰å†è¯•ã€‚</p>
<p>7ã€è°ƒæ•´å¥½äº†ä¹‹åæˆ‘ä»¬æ¥ç€ssh root@ip, è¿™äº›æ›´å¥½äº†ï¼Œç›´æ¥ç»™æˆ‘é—ªé€€äº†ã€‚åŒæ—¶ï¼Œæˆ‘è¿˜å‘ç°äº†ä¸€ä¸ªæ–°é—®é¢˜ï¼Œæˆ‘ä¸èƒ½su rootäº†</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220114141342311.png" alt="image-20220114141342311" style="zoom:50%;float:left" />

<p>8ã€çªç„¶ï¼Œæˆ‘çš„æœåŠ¡å™¨å’‹äº†ï¼Œè¢«æ”»å‡»äº†~ ç›²çŒœåº”è¯¥æ˜¯å°†æˆ‘çš„sshæœåŠ¡ç»™ç¯¡æ”¹äº†ã€‚å¯¼è‡´äº†æˆ‘sshè¿æ¥äº†å°±é—ªé€€ï¼Œè¿˜æœ‰æˆ‘ä¸èƒ½åˆ‡æ¢rootè´¦å·ã€‚</p>
<p>9ã€å¥½åœ¨æˆ‘æ²¡å•¥ä¸œè¥¿ï¼Œå…¶å®æˆ‘è§‰å¾—é‡æ–°å®‰è£…sshdå³å¯ï¼Œä½†æ˜¯ä¸ºäº†ä¿é™©èµ·è§ï¼Œæˆ‘è¿˜æ˜¯é‡æ–°å®‰è£…OSå§ã€‚</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220114142036461.png" alt="image-20220114142036461" style="zoom:50%;float:left" />

<p>å¥½å®¶ä¼™ï¼Œè¿™ä¸ªæ“ä½œè´¼å¿«ï¼Œè¿™ä¸ªæ‰€è°“çš„è½»é‡æœåŠ¡å™¨å®¹å™¨æ²¡è·‘äº†</p>
<p>10ã€ä¸ºå•¥ssh-copy-idä¸éœ€è¦å¯†ç ï¼Ÿå¯¹æ¯”æ‰‹åŠ¨å’Œssh-copy-idï¼Œå¤§æ¦‚æ˜¯ssh-copy-idæœ‰å›ºå®šç¨‹åºå§ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æ‰‹åŠ¨</span></span><br><span class="line">ssh root@ip # è¾“å…¥rootå¯†ç </span><br><span class="line">vim ~/.ssh/authorized_keys  # æ·»åŠ å…¬é’¥</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ssh-copy-id</span></span><br><span class="line">ssh-copy-id root@ip # ä¸éœ€è¦è¾“å…¥å¯†ç  -- ä¸ºå•¥ï¼Ÿ</span><br></pre></td></tr></table></figure>

<p>11ã€å…¬é’¥å’Œç§é’¥æ˜¯æ€ä¹ˆä¸€èµ·èµ·ä½œç”¨çš„?</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…ˆè¯´é—®é¢˜çš„æ¥æº</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æœ¬æœº -&gt; remote</span></span><br><span class="line">ssh-copy-id å°†æœ¬åœ°çš„å…¬é’¥copyåˆ° ~/.ssh/authorized_keys    ---&gt;  æœ¬åœ°å¯ä»¥ç™»å½•è¿œç«¯</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è…¾è®¯äº‘ æˆæƒè¿‡ç¨‹  ç§˜é’¥ç®¡ç†</span></span><br><span class="line">ç”Ÿæˆç§˜é’¥ä¸€å¯¹ï¼Œæœ¬åœ°ä¿å­˜ç§é’¥</span><br><span class="line">ä¸‹å‘å…¬é’¥åˆ°å®ä¾‹</span><br><span class="line">ssh -i ç§é’¥ root@ip </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®é™…ä¸Šä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæœ¬åœ°è¿æ¥çš„æ—¶å€™ä½¿ç”¨ç§é’¥å»åŒ¹é…remote ~/.ssh/authorized_keys é‡Œé¢çš„å…¬é’¥ã€‚</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç»å†ä¸€äº›é—®é¢˜å¯ä»¥æ›´å¿«çš„å»ç†è§£å¾ˆå¤šä¸œè¥¿çš„åŸç†</span></span><br></pre></td></tr></table></figure>

<h3 id="èƒŒæ™¯2021-01-26-RAKsmartäº‘æœåŠ¡å™¨è¢«æ”»å‡»"><a href="#èƒŒæ™¯2021-01-26-RAKsmartäº‘æœåŠ¡å™¨è¢«æ”»å‡»" class="headerlink" title="èƒŒæ™¯2021-01-26-RAKsmartäº‘æœåŠ¡å™¨è¢«æ”»å‡»"></a>èƒŒæ™¯2021-01-26-RAKsmartäº‘æœåŠ¡å™¨è¢«æ”»å‡»</h3><p>å†™ç€å†™ç€æˆ‘å‘ç°è¶Šå†™è¶Šé•¿ï¼ŒçœŸè¡Œï¼Œä½†æ˜¯æˆ‘ä¹Ÿæ‡’å¾—å†å¼€ä¸€ç¯‡ï¼Œæ¯•ç«Ÿéƒ½æ˜¯ä¸€ä¸ªç³»åˆ—çš„ï¼ŒæŠ˜è…¾å®Œäº†å›½å†…çš„æœåŠ¡å™¨ï¼Œå°±å¼€å§‹æŠ˜è…¾å›½å¤–çš„äº†ã€‚</p>
<p>1ã€ä¸ºå•¥é€‰æ‹©RAKsmartï¼Œè´§æ¯”ä¸‰å®¶æ€§ä»·æ¯”ï¼Œç®—äº†ï¼Œå°±æ˜¯æœ€ä¾¿å®œ</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220126144535536.png" alt="image-20220126144535536" style="zoom:80%;float:left" />

<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220126144740691.png" alt="image-20220126144740691" style="zoom:50%;float:left" />

<p>ç„¶åå‘¢ï¼Œæˆ‘å°±ä¹°äº†ä¸€ä¸ªHKçš„æœåŠ¡å™¨ï¼Œæ¯•ç«Ÿéƒ½ä¸æ˜¯å°æ°”çš„äººã€‚</p>
<p>2ã€ç™»å½•æœºå™¨</p>
<p>æ€ä¹ˆç™»å½•æœåŠ¡å™¨çœŸçš„å¾ˆå‚»ç“œï¼Œæ²¡å•¥é™åˆ¶ï¼Œåœ¨å“ªéƒ½èƒ½å¾ˆå¿«çš„ssh root@ipï¼Œç›´æ¥åœ¨ä¸‹é¢çš„é¡µé¢ä¸Šè·å–å¯¹åº”çš„ä¿¡æ¯ï¼Œæ¸…æ™°æ˜äº†ã€‚</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220126145033587.png" alt="image-20220126145033587" style="zoom:50%;float:left" />

<p>3ã€ä¸‹è½½ä¸€ä¸ªgithubé¡¹ç›®(è‡ªå·±æ‰¾å¥½ç©çš„é¡¹ç›®å•Š)</p>
<p>æˆ‘æ‰¾çš„é¡¹ç›®æ˜¯ï¼š<a href="https://github.com/hwdsl2/setup-ipsec-vpn%EF%BC%8C%E8%87%B3%E4%BA%8E%E4%BD%A0%E6%89%BE%E5%95%A5%E9%9A%8F%E6%84%8F">https://github.com/hwdsl2/setup-ipsec-vpnï¼Œè‡³äºä½ æ‰¾å•¥éšæ„</a>~~</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://git.io/vpnquickstart -O vpn.sh &amp;&amp; sudo sh vpn.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¼šç”Ÿæˆç±»ä¼¼ä¸‹é¢çš„ä¿¡æ¯ï¼Œä¸‹é¢å°±å¯ä»¥ç›´æ¥ä½¿ç”¨IPsecè¿æ¥äº†ã€‚ æœºå™¨å·²ç»â™»ï¸ï¼Œæ‰€ä»¥â˜ºï¸~</span></span><br><span class="line">Server IP: 107.148.237.19</span><br><span class="line">IPsec PSK: E5ux2YRkHVN8LJv9XeGd</span><br><span class="line">Username: vpnuser</span><br><span class="line">Password: skcbn9ypy3UWwjch</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤å®Œäº‹ï¼Œå¦‚æœä¸­é€”æœ‰ä¾èµ–é—®é¢˜ï¼Œç™¾åº¦å³å¯è§£å†³ã€‚</p>
<p>4ã€æµ‹è¯•ï¼šæ‰‹æœºè¿æ¥</p>
<p>è¯¦ç»†æ–‡æ¡£ï¼š<a href="https://github.com/hwdsl2/setup-ipsec-vpn/blob/master/docs/clients-zh.md#ios">https://github.com/hwdsl2/setup-ipsec-vpn/blob/master/docs/clients-zh.md#ios</a>  </p>
<p>äº²æµ‹å¯ç”¨ï¼Œæ¥ç€å°±å¯ä»¥ä¸‹è½½æ¯”å¦‚googleæµè§ˆå™¨ä¹‹ç±»çš„ï¼Œç„¶åæ„‰å¿«çš„å­¦ä¹ ã€‚</p>
<p>5ã€æƒŠå–œï¼šæˆ‘å‘ç°å•¥ä¹Ÿä¸é™åˆ¶ï¼Œå°±æ˜¯ç½‘é€Ÿ116KB/sï¼ŒçœŸçš„å°±åªå¤Ÿä¸€ä¸ªçœ‹çœ‹è§†é¢‘ï¼Œå…¶ä»–å°±ä¸ç”¨å¥¢æœ›äº†ã€‚æ‰€ä»¥æˆ‘å†³å®šé€€è´§ã€‚</p>
<p>6ã€é€€è´§ï¼šè¿™é‡Œå°±ä¸å¾—ä¸å¤¸ä¸€å¤¸æœåŠ¡æ€åº¦ï¼Œçœ‹è§äº†å§ï¼Œ3å°æ—¶å›å¤é€Ÿåº¦ï¼Œä¹Ÿä¸åºŸè¯ï¼Œè¯´æ¸…æ¥šäº†ï¼Œç›´æ¥ç»™é€€è´§äº†ã€‚è¡¨ç¤ºéå¸¸æ»¡æ„ï¼Œè¦ä¸æ˜¯ç½‘é€Ÿæ˜¯åœ¨æ„Ÿäººï¼Œæˆ‘éƒ½ä¸æƒ³é€€äº†ã€‚</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220126150158167.png" alt="image-20220126150158167" style="zoom:50%;float:left" />

<h3 id="èƒŒæ™¯2021-01-26-surfshark"><a href="#èƒŒæ™¯2021-01-26-surfshark" class="headerlink" title="èƒŒæ™¯2021-01-26-surfshark"></a>èƒŒæ™¯2021-01-26-surfshark</h3><p>1ã€ä¸Šé¢çš„ä¸æ˜¯ç½‘é€Ÿæ…¢ï¼Œæˆ‘æƒ³ç€å°±ä¸ç”¨æœåŠ¡å™¨ï¼Œç›´æ¥ä¹°æœåŠ¡å§ã€‚äºæ˜¯ï¼Œåˆæ˜¯ä¸€é€šæ“ä½œï¼Œç¡®å®šäº†surfsharkï¼Œè‡³äºä¸ºå•¥ï¼Œç½‘ä¸Šéƒ½è¯´surfshark=æ€§ä»·æ¯”ï¼Œäºæ˜¯æˆ‘å°±ä¸äº‰æ°”çš„é€‰æ‹©äº†è¿™ä¸ªï¼Œå¯¹æ¯”express<em>ã€norv</em> è¿˜çœŸæ˜¯ã€‚</p>
<p>2ã€æ¥ç€å°±æ˜¯ä¹°æœåŠ¡ï¼Œï¿¥380 = 24æœˆ+2æœˆï¼Œå¯ä»¥AliPayï¼Œå…¶å®è¿˜æ˜¯å¾ˆä¾¿å®œçš„ï¼Œä¸é™é€Ÿåº¦+ä¸é™ç»ˆç«¯ã€‚</p>
<p>3ã€ç„¶åå°±æŒ‰ç…§å®˜ç½‘æŠ˜è…¾ï¼Œsurfshark + Open***(çœ‹å®˜ç½‘)éƒ½ä¸å¤ªè¡Œçš„ã€‚ä¸ç®¡ä»€ä¹ˆæ“ä½œæ‰‹åŠ¿ï¼Œéƒ½éš¾ä»¥å®ç°ã€‚</p>
<p>4ã€ä½ ä»¥ä¸ºæˆ‘å°±æ”¾å¼ƒäº†ï¼Œæˆ‘ç¡®å®æ˜¯è¦æ”¾æ‰‹äº†ï¼Œç„¶åæˆ‘å°±å¼€å§‹æœç´¢<code>é€€è´§</code>è‹±æ–‡å’‹è¯´ã€‚</p>
<p>5ã€è¿™å®¶æ˜¯7*24hå®¢æœï¼Œäºæ˜¯æˆ‘å°±Englishå®¢æœäº†ï¼Œä¸€é¡¿è¯´refundï¼Œç„¶åæˆ‘å°±æ”¶åˆ°å¥½å¤šé…ç½®æ–‡æ¡£PDF + ä¸€ä¸ª<code>config</code>,  æ³¨æ„è¿™ä¸ªconfigæ˜¯æˆ‘ä¹‹å‰å¿½ç•¥çš„è½¬æœºã€‚</p>
<p>6ã€æ¥ç€æˆ‘å°±æ˜¯æŒ‰ç…§PDFä¸€é¡¿æ“ä½œï¼Œå…¶å®å’Œå®˜æ–¹è§†é¢‘æ²¡å•¥åŒºåˆ«ï¼Œæ²¡è¾™äº†å°±email supportäº†ï¼Œsupportè¯´å¯ä»¥refundï¼Œä½†æ˜¯èƒ½ä¸èƒ½æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œæˆ‘æƒ³ç€å¯ä»¥ï¼Œå°±å‡†å¤‡äº†ä¸€ä¸ªnotionæ–‡æ¡£ã€‚ç„¶åæœ‰å¼€å§‹ç­‰ï¼Œæ„Ÿè§‰7*24hä¹Ÿå¾ˆæ…¢ï¼Œäººå®¶ç¡è§‰çš„æ—¶å€™è¿˜æ˜¯è¦ç­‰ã€‚</p>
<p>7ã€æˆ‘å°±æƒ³è¦å¥½å¥½ç†è§£ä¸‹æˆ‘åˆ°åº•æ˜¯ä¹°äº†ä¸€ä¸ªå•¥ï¼Œåé¢å­å“§å­å“§å‘ç°ï¼Œæˆ‘è¿˜éœ€è¦ä¸€ä¸ªproxyï¼Œå°±æ˜¯è®¾ç½®å„ç§è·¯ç”±è§„åˆ™çš„ã€‚æ¯”å¦‚ç™¾åº¦å°±ä¸åŒä»£ç†ï¼Œéœ€è¦proxyçš„å°±proxyã€‚</p>
<p>8ã€æˆ‘å°±githubä¸Šå­¦ä¹ äº†ä¸€ä¼šï¼Œæœ‰å­¦ä¹ äº†ä¸¤ä¸ªæ–°é¡¹ç›®ï¼š</p>
<p><a href="https://github.com/yichengchen/clashX">https://github.com/yichengchen/clashX</a></p>
<p><a href="https://github.com/Dreamacro/clash">https://github.com/Dreamacro/clash</a></p>
<p><a href="https://github.com/txthinking/brook">https://github.com/txthinking/brook</a> ï¼šåœ¨iosä¸Šæœ‰app</p>
<p>9ã€æ¥ç€æˆ‘å°±å®‰è£…äº†ä¸€ä¸ªå°çŒ«çŒ«è½¯ä»¶ = Surge(å¥½ç”¨ä½†æ˜¯è´µçš„å“Ÿ)</p>
<p>è¿˜è®°å¾—Englishå®¢æœå°å§å§ç»™äº†æˆ‘ä¸€ä¸ªConfigæ–‡ä»¶(ç›´æ¥ç»ƒä¹ å®¢æœè¯´è¦configæ–‡ä»¶ï¼Œæä¾›çš„appåœ¨**ä¸èƒ½ç”¨)ï¼Œè¿™ä¸ªæ—¶å€™å°±æ˜¯å‘æŒ¥ä½œç”¨äº†ï¼Œæ‰“å¼€é…ç½®æ–‡ä»¶ï¼Œç›´æ¥å°†é…ç½®å¡è¿›å»ï¼Œå°±å¯ä»¥ç©äº†ã€‚</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220126152837014.png" alt="image-20220126152837014" style="zoom:50%;float:left" />

<p>10ã€ä½ ä»¥ä¸ºBrookæ˜¯ä½ æƒ³ä¸‹è½½å°±èƒ½ä¸‹è½½ï¼Œè¿™ä¸ªæ—¶å€™ä½ éœ€è¦ä¸€ä¸ªå¯¹åº”çš„ç¾åŒºçš„apple idï¼Œè¿™ä¸ªå°±ä¸åºŸè¯äº†ï¼Œå› ä¸ºæœ¬äººæä¾›å…è´¹çš„æ”¯æŒğŸ˜ï¼Œè¯·è”ç³»ã€‚</p>
]]></content>
      <tags>
        <tag>è…¾è®¯äº‘</tag>
        <tag>ECS</tag>
        <tag>RAKsmart</tag>
      </tags>
  </entry>
  <entry>
    <title>æœ¬åœ°è°ƒè¯•proxysql</title>
    <url>/2021/12/29/%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95proxysql/</url>
    <content><![CDATA[<h4 id="1-æ„å»ºé•œåƒ"><a href="#1-æ„å»ºé•œåƒ" class="headerlink" title="1. æ„å»ºé•œåƒ"></a>1. æ„å»ºé•œåƒ</h4><p>Dockerfile + æ„å»ºé•œåƒ</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> description=<span class="string">&quot;Container for dev &amp; debug&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y automake bzip2 cmake make gcc-c++ gcc git openssl openssl-devel gnutls gnutls-devel libtool patch openssh-server perl-IPC-Cmd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y gdb-gdbserver <span class="built_in">which</span> </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®sshæœåŠ¡</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&#x27;PermitRootLogin yes&#x27;</span> &gt;&gt; /etc/ssh/sshd_config &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">&#x27;PermitEmptyPasswords yes&#x27;</span> &gt;&gt; /etc/ssh/sshd_config &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">&#x27;PasswordAuthentication yes&#x27;</span> &gt;&gt; /etc/ssh/sshd_config &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">&#x27;root:root&#x27;</span> | chpasswd &amp;&amp; \</span></span><br><span class="line"><span class="bash">    ssh-keygen -A</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">22</span> </span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;/usr/sbin/sshd&quot;</span>, <span class="string">&quot;-D&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker build -t proxysqldebug:v1 .</span><br></pre></td></tr></table></figure>

<h4 id="2-è¿è¡Œå®¹å™¨"><a href="#2-è¿è¡Œå®¹å™¨" class="headerlink" title="2. è¿è¡Œå®¹å™¨"></a>2. è¿è¡Œå®¹å™¨</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d -p 2222:22 --security-opt seccomp:unconfined -v $PWD:/home/luzhangting001/proxysql --name proxysqldev proxysqldebug:v1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åé¢å®¹å™¨stop + start ä¸è¦åœ¨é‡å¯ï¼Œå¦‚ä¸‹å›¾</span></span><br></pre></td></tr></table></figure>

<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211229121528631.png" alt="image-20211229121528631" style="zoom:100%; float:left" />

<h4 id="3-å¯åŠ¨debug"><a href="#3-å¯åŠ¨debug" class="headerlink" title="3. å¯åŠ¨debug"></a>3. å¯åŠ¨debug</h4><p>é…ç½®launch.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;configurations&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;(gdb) Launch&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;cppdbg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;/home/luzhangting001/proxysql/src/proxysql&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;--foreground&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--debug&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--config&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/home/luzhangting001/proxysql/src/proxysql.cfg&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--initial&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;stopAtEntry&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;/home/luzhangting001/proxysql&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;pipeTransport&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;debuggerPath&quot;</span>: <span class="string">&quot;/usr/bin/gdb&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pipeProgram&quot;</span>: <span class="string">&quot;/usr/bin/ssh&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pipeArgs&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;root@localhost&quot;</span>,</span><br><span class="line">                <span class="string">&quot;-p&quot;</span>,</span><br><span class="line">                <span class="string">&quot;2222&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;pipeCwd&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;environment&quot;</span>: [],</span><br><span class="line">        <span class="attr">&quot;externalConsole&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;MIMode&quot;</span>: <span class="string">&quot;gdb&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;sourceFileMap&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;/home/luzhangting001/proxysql&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨æŠ¥é”™ï¼šå› ä¸ºä¹‹å‰å¼„è¿‡ï¼ŒsshæŠ¥é”™äº†</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211229121827990.png" alt="image-20211229121827990" style="zoom:100%; float:left" />

<p>å°†known_hostsé‡Œé¢çš„ç›¸å…³ä¿¡æ¯åˆ é™¤, å…¶å®æˆ‘ä¸çŸ¥é“æ˜¯ä¸æ˜¯å¿…é¡»è¿™ä¹ˆåšï¼Œå¯èƒ½ä¸æ˜¯å¿…é¡»çš„</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211229122615654.png" alt="image-20211229122615654" style="zoom:100%; float:left" />

<p>å°†æœ¬æœºçš„å…¬é’¥ä¸Šä¼ </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-copy-id -p 2222 root@localhost</span><br></pre></td></tr></table></figure>

<p>vscodeé‡Œé¢å¯åŠ¨</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211229153334425.png" alt="image-20211229153334425" style="zoom:80%;float:left" />
]]></content>
      <tags>
        <tag>proxysql</tag>
        <tag>macæœ¬åœ°ç¯å¢ƒ</tag>
      </tags>
  </entry>
  <entry>
    <title>Typoraå†™blogä¸­ç²˜è´´å›¾ç‰‡è‡ªåŠ¨ä¸Šä¼ å›¾åºŠ</title>
    <url>/2021/12/24/blog%E5%9B%BE%E5%BA%8A%E7%AF%87/</url>
    <content><![CDATA[<h4 id="Goal"><a href="#Goal" class="headerlink" title="Goal"></a>Goal</h4><p>æˆ‘ç”µè„‘ä¸Š cmd + trl + a(å¾®ä¿¡æˆªå›¾) -&gt; æ¥åˆ°Typora(cmd + v) ç²˜è´´ã€‚</p>
<p>ç„¶åå°±è‡ªåŠ¨å¸®æˆ‘ä¸Šä¼ å›¾åºŠï¼Œå¹¶ä¸”æ›¿æ¢æˆå›¾åºŠç…§ç‰‡å§ï¼Œè¿™æ ·æˆ‘ä¹Ÿä¸éœ€è¦åˆ‡æ¢åˆ°å›¾åºŠä¸Šå»æ£é¼“äº†ï¼Œå°±ä¸“æ³¨åœ¨Typoraä¸Šå»æ‰“å­—ã€‚</p>
<h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><p>å›¾åºŠï¼š<a href="https://blog.svend.cc/upic/tutorials/github/">github</a>ã€<a href="https://blog.svend.cc/upic/tutorials/gitee/">gitee</a>ï¼Œæˆ‘è‡ªå·±æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯è·¯è¿‡å›¾åºŠï¼Œä½†æ˜¯uPicä¸ä¼šé…ç½®ï¼Œé‚£å°±ç®—å•¦ï¼Œä½›ç³»æ‰¾ä¸ªèƒ½æˆåŠŸçš„ã€‚</p>
<blockquote>
<p>é‡‡å‘ï¼šgithubå›¾ç‰‡å¯ä»¥æ­£å¸¸ä¸Šä¼ ï¼Œä½†æ˜¯å±•ç¤ºå‡ºæ¥</p>
</blockquote>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211225084632762.png" alt="image-20211225084632762" style="zoom:30%;float:left" />

<p>å› æ­¤ï¼Œæˆ‘ä»¬è¿˜å¥½æŠ˜è…¾Giteeé…ç½®ã€‚</p>
<ol>
<li><p>åˆ›å»ºä»“åº“</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211225085435762.png" alt="image-20211225085435762" style="zoom:25%;float:left" />

<ol start="2">
<li>ç”Ÿæˆç§äººä»¤ç‰Œ</li>
</ol>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211225083650340.png" alt="image-20211225083650340" style="zoom:25%;float:left" />

<ol start="3">
<li><p>é…ç½®uPic</p>
<p>uPicç›´æ¥githubä¸Šä¸‹è½½äº†å®‰è£…å¥½ï¼Œç„¶åæŒ‰ç…§ä¸‹é¢çš„æ–¹æ³•é…ç½®</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211225090108133.png" alt="image-20211225090108133" style="zoom:25%;float:left" /></li>
<li><p>é…ç½®Typora</p>
<p>cmd+,æ‰“å¼€è½¯ä»¶åå¥½è®¾ç½®,æˆåŠŸäº†ä¹‹åå°±åœ¨å†™blogçš„æ—¶å€™ç›´æ¥æˆªå›¾+ç²˜è´´å§ï¼Œå·´æ–¯çš„å¾ˆ~</p>
<img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211225090323825.png" alt="image-20211225090323825" style="zoom:25%;float:left" /></li>
</ol>
</li>
</ol>
]]></content>
      <tags>
        <tag>Typora</tag>
        <tag>å›¾ç‰‡ç²˜è´´</tag>
        <tag>ä¸Šä¼ å›¾åºŠ</tag>
      </tags>
  </entry>
  <entry>
    <title>hashicorp-raftæºç ç³»åˆ—-4-leaderé€»è¾‘</title>
    <url>/2021/12/20/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-4-leader%E9%80%BB%E8%BE%91/</url>
    <content><![CDATA[<p>å‰é¢ä¸‰ç¯‡æˆ‘ä»¬åˆ†åˆ«ä»‹ç»äº†Raftçš„APIã€ç½‘ç»œå±‚ã€å­˜å‚¨å±‚ï¼Œä»è¿™ä¸€ç¯‡å¼€å§‹æˆ‘ä»¬æ¥çœ‹Raftçš„<code>Leaderã€Candidateã€Follower</code>å®ç°ã€‚</p>
<h4 id="r-runLeaderé€»è¾‘"><a href="#r-runLeaderé€»è¾‘" class="headerlink" title="r.runLeaderé€»è¾‘"></a>r.runLeaderé€»è¾‘</h4><p>äº‹åŠ¡æäº¤çš„è¿‡ç¨‹ï¼šæ¥ç€æˆ‘ä»¬ä¸€ç‚¹ç‚¹åˆ†æï¼Œ</p>
<h5 id="å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•"><a href="#å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•" class="headerlink" title="å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•"></a>å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Apply</span></span><br><span class="line"><span class="comment">//  -&gt; ApplyLog</span></span><br><span class="line"><span class="comment">// å†™çš„æ—¶å€™ä¹Ÿä¸éœ€è¦è¿”å›ä»€ä¹ˆï¼Œä¸»è¦å°±æ˜¯Check Error</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">ApplyLog</span><span class="params">(log Log, timeout time.Duration)</span> <span class="title">ApplyFuture</span></span> &#123;</span><br><span class="line">  logFuture := &amp;logFuture&#123;</span><br><span class="line">    log: Log&#123;</span><br><span class="line">      Type:       LogCommand,</span><br><span class="line">      Data:       log.Data,</span><br><span class="line">      Extensions: log.Extensions,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  logFuture.init()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// è¿™ä¸ªå†™æ³•å¾ˆæœ‰æ„æ€ï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ”¾åˆ°applyChé©¬ä¸Šè¿”å›ï¼Œè¿™ä¸ªæ—¶å€™return logFutureä¸ä¸€å®šæœ‰æ•°æ®çš„å§ï¼Œclientæ€ä¹ˆåˆ¤æ–­æ“ä½œæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥å‘¢ã€‚</span></span><br><span class="line">  <span class="keyword">case</span> r.applyCh &lt;- logFuture:</span><br><span class="line">    <span class="keyword">return</span> logFuture</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="runLeader"><a href="#runLeader" class="headerlink" title="runLeader()"></a>runLeader()</h5><p>æ¥ç€æˆ‘ä»¬çœ‹ä¸‹leaderåˆå§‹åŒ–çš„æ—¶å€™ä¼šå¹²äº›å•¥ï¼Œé‡ç‚¹çœ‹ä¸‹åˆå§‹åŒ–çš„åå°å¤„ç†åç¨‹ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">runLeader</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// ?? leaderChè¿™ä¸ªchanè¿˜çœŸçš„æ˜¯ä¸çŸ¥é“å¹²å•¥çš„ï¼Œåé¢æœ‰æ—¶é—´åœ¨é‡ç‚¹çœ‹ä¸‹</span></span><br><span class="line">  overrideNotifyBool(r.leaderCh, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setup leader stateï¼Œä¸»è¦æ˜¯èŠ‚ç‚¹çš„ä¿¡æ¯</span></span><br><span class="line">  r.setupLeaderState()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®šä¹‰æ¸…ç†é€»è¾‘</span></span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">   ...</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡ç‚¹ï¼šä¸ºæ¯ä¸€ä¸ªpeerå¯åŠ¨ä¸€ä¸ªLogå¤åˆ¶åç¨‹ï¼Œ</span></span><br><span class="line">  r.startStopReplication()</span><br><span class="line">  <span class="comment">//  è°ƒç”¨-&gt; r.goFunc(func() &#123; r.replicate(s) &#125;)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å§‹leaderå¾ªç¯</span></span><br><span class="line">  r.leaderLoop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Leaderæ¶ˆè´¹r-applyCh"><a href="#Leaderæ¶ˆè´¹r-applyCh" class="headerlink" title="Leaderæ¶ˆè´¹r.applyCh"></a>Leaderæ¶ˆè´¹r.applyCh</h5><p>å°†å®¢æˆ·ç«¯çš„å†™å‡‘æˆä¸€æ‰¹ï¼Œ</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> newLog := &lt;-r.applyCh:</span><br><span class="line">  <span class="comment">// Group commit, ç»„æäº¤</span></span><br><span class="line">  ready := []*logFuture&#123;newLog&#125;</span><br><span class="line">GROUP_COMMIT_LOOP:</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; r.config().MaxAppendEntries; i++ &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> newLog := &lt;-r.applyCh:</span><br><span class="line">      ready = <span class="built_in">append</span>(ready, newLog)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span> GROUP_COMMIT_LOOP</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Dispatch the logs</span></span><br><span class="line">  <span class="keyword">if</span> stepDown &#123;</span><br><span class="line">     ....</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    r.dispatchLogs(ready)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€çœ‹çœ‹dispatchLogsé€»è¾‘</p>
<p>åŠ r.leaderState.inflight list, è¡¨ç¤ºéœ€è¦å¤„ç†çš„applyLogs</p>
<p>æ—¥å¿—æŒä¹…åŒ– r.logs.StoreLogs(logs)ï¼Œç±»æ¯”mysql æŒä¹…åŒ–redo log</p>
<p>å°†è‡ªå·±çš„log indexå¾€å‰ï¼Œå¹¶ä¸”é€šçŸ¥<code>commitCh</code></p>
<p>æŒä¹…åŒ–lastIndexï¼Œr.setLastLog(lastIndex, term)</p>
<p>é€šçŸ¥æ¯ä¸ªreplicationæ–°Log â€“  asyncNotifyCh(f.triggerCh)  </p>
<p>æ¥ç€å°±æ˜¯ä¸Šé¢çš„åˆå§‹åŒ–çš„æ—¶å€™å¹²çš„äº‹æƒ…äº†ï¼Œç»™æ¯ä¸ªchannelå‘æ¶ˆæ¯</p>
<p>æƒ³æƒ³å“ªäº›æ˜¯å¼‚æ­¥çš„ï¼Ÿä¸ºå•¥è¦å¼‚æ­¥å¤„ç†å‘¢ï¼Ÿ</p>
<p>ææ¸…æ¥šé‡ç‚¹</p>
<p>ä¸‹é¢çš„<code>observe</code>æ˜¯å¹²å•¥çš„ï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">r.observe(LeaderObservation&#123;Leader: leader&#125;)</span><br></pre></td></tr></table></figure>

<p>client å†™è¯·æ±‚ :api.go   Applyæ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªApplyFutureå¯¹è±¡ï¼ŒåŒ…å«reqã€responseã€error</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>â€“&gt;  å‘æ¶ˆæ¯ append entity â€“&gt; å¤šæ•°æ´¾çš„å›å¤  â€“ &gt; å®¢æˆ·ç«¯è¿”å›  â€“&gt; åº”ç”¨FSM(å¦ä¸€ä¸ªæµç¨‹)â€“&gt; é€šçŸ¥å…¶ä»–èŠ‚ç‚¹å¯ä»¥åº”ç”¨ â€“</p>
<p>clientè¿”å›çš„æ ‡å‡†æ˜¯å•¥ï¼Ÿæ—¥å¿—å¤šæ•°æ´¾ or  Master applyæˆåŠŸ(ä¸å¯èƒ½)   </p>
<p>è®¤çœŸç¢ç£¨å…¶ä¸­çš„ä¼˜åŒ–</p>
<h4 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h4><p>1ã€chané‡Œé¢åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”ä¸èƒ½å¹¶å‘è°ƒç”¨ã€‚ä¸‹é¢ä»£ç çš„ç†è§£ï¼Œåˆ°åº•æ˜¯æ€ä¹ˆé¿å…å¹¶å‘è°ƒç”¨çš„ï¼Ÿè¿˜æœ‰åˆ«çš„å®ç°å—ï¼Ÿè¿™ä¸ªå®ç°æ˜¯ä¸æ˜¯æœ‰ç‚¹trickï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">overrideNotifyBool</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">bool</span>, v <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> ch &lt;- v:</span><br><span class="line">    <span class="comment">// value sent, all done</span></span><br><span class="line">  <span class="keyword">case</span> &lt;-ch:</span><br><span class="line">    <span class="comment">// channel had an old value</span></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ch &lt;- v:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">panic</span>(<span class="string">&quot;race: channel was sent concurrently&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2ã€<code>leaderLoop</code>è¿™ä¸ªé‡Œé¢å…¨æ˜¯å¼‚æ­¥çš„chanï¼Œä»£ç è§„åˆ’çš„éå¸¸å¥½ï¼Œå¾ˆå€¼å¾—å­¦ä¹ </p>
]]></content>
      <tags>
        <tag>raft</tag>
      </tags>
  </entry>
  <entry>
    <title>hashicorp:raftæºç ç³»åˆ—(3)--å­˜å‚¨å±‚</title>
    <url>/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-3-%E5%AD%98%E5%82%A8%E5%B1%82/</url>
    <content><![CDATA[<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>æ¥ç€ä¸Šä¸€ç¯‡æˆ‘ä»¬è®²äº†ç½‘ç»œå±‚ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥è®²<code>LogStoreã€StableStoreã€FSMã€SnapshotStore</code>ï¼Œä¸ºå•¥è¿™äº›ä¸€èµ·è®²å‘¢ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯å­˜å‚¨ç›¸å…³ï¼Œå¹¶ä¸”åŠŸèƒ½ç›¸å¯¹ç®€å•ï¼Œå¹¶æ²¡æœ‰åƒ<code>Transport</code>é‚£æ ·æœ‰<code>NetworkTransport</code>å®ç°å¯ä»¥ç”¨æ¥è¿›è¡Œåˆ†æã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">Â <span class="function"><span class="keyword">func</span> <span class="title">NewRaft</span><span class="params">(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans Transport)</span> <span class="params">(*Raft, error)</span></span> &#123; Â    	......&#125;</span><br></pre></td></tr></table></figure>

<h4 id="StableStore"><a href="#StableStore" class="headerlink" title="StableStore"></a>StableStore</h4><p>è¿™ä¸ªç»„ä»¶ä¸»è¦å°±æ˜¯ä¸ºäº†å®‰å…¨è€ƒè™‘è€Œå­˜åœ¨çš„ï¼Œæä¾›ä¸€ä¸ªå¯ä»¥æŒä¹…åŒ–k-vçš„å­˜å‚¨çš„å³å¯ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> StableStore <span class="keyword">interface</span> &#123;</span><br><span class="line">  Set(key []<span class="keyword">byte</span>, val []<span class="keyword">byte</span>) error</span><br><span class="line">  Get(key []<span class="keyword">byte</span>) ([]<span class="keyword">byte</span>, error)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// uint64æ˜¯æ—¥å¿—å·å’Œä»»æœŸå®šä¹‰çš„ç±»å‹ï¼Œæ–¹ä¾¿å­˜</span></span><br><span class="line">  SetUint64(key []<span class="keyword">byte</span>, val <span class="keyword">uint64</span>) error</span><br><span class="line">  GetUint64(key []<span class="keyword">byte</span>) (<span class="keyword">uint64</span>, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="LogStore"><a href="#LogStore" class="headerlink" title="LogStore"></a>LogStore</h4><p>è¿™ä¸ªç»„ä»¶å°±æ˜¯ä¸ºäº†å­˜æ—¥å¿—çš„ï¼Œæ¯”å¦‚ç”¨æˆ·å‘è¿‡æ¥<code>set a=1</code>, å°†è¿™ä¸ªå­˜èµ·æ¥å³å¯ã€‚å’Œä¸Šé¢çš„<code>StableStore</code>èƒ½åŠ›æ˜¯åŒä¸€ç§ï¼Œä¸è¿‡æ—¥å¿—å¯èƒ½æ¯”è¾ƒå¤šï¼Œéœ€è¦æ ¹æ®å®ç°æƒ…å†µè¿›è¡Œé€‰æ‹©ã€‚é¡¹ç›®åœ¨æµ‹è¯•çš„æ—¶å€™å®ç°äº†ä¸€ä¸ª<code>inmem</code>çš„æ—¥å¿—å­˜å‚¨ï¼Œç”¨äº†ä¸€ä¸ª<code>map</code>æ¥è¿›è¡Œå­˜å‚¨ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// inmemæ¨¡æ‹Ÿï¼Œç›´æ¥mapå­˜ï¼ŒåŸºæœ¬èƒ½åŠ›-è¯»å†™ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewInmemStore</span><span class="params">()</span> *<span class="title">InmemStore</span></span> &#123;</span><br><span class="line">  i := &amp;InmemStore&#123;</span><br><span class="line">    logs:  <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">uint64</span>]*Log),</span><br><span class="line">    kv:    <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">byte</span>),</span><br><span class="line">    kvInt: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">uint64</span>),</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="FSM"><a href="#FSM" class="headerlink" title="FSM"></a>FSM</h4><p>FMSçš„åŠŸèƒ½ï¼Œâ‘¡+â‘¢ä¸æ˜¯Raftçš„æ ¸å¿ƒé€»è¾‘ã€‚Raftå¯åŠ¨æ—¶å€™ä¼šæœ‰ä¸€ä¸ªåå°åç¨‹<code>runFSM</code>è´Ÿè´£æ¥åšä¸‹é¢çš„ä¸‰ä»¶äº‹ï¼ŒMainçº¿ç¨‹å°†åº”ç”¨æ—¥å¿—è¯·æ±‚æ”¾åˆ°<code>fsmMutateCh</code>é‡Œé¢ï¼Œå°†æ‰“å¿«ç…§çš„è¯·æ±‚æ”¾åˆ°<code>fsmSnapshotCh</code>é‡Œé¢ï¼Œä¸é˜»å¡Main</p>
<p>â‘  åº”ç”¨æ—¥å¿—ï¼Œraft logå¤šæ•°æ´¾å·²ç»ç¡®è®¤ï¼Œå°±å¯ä»¥åº”ç”¨åˆ°åº•å±‚å­˜å‚¨äº†ã€‚</p>
<p>â‘¡ å¿«ç…§</p>
<p>â‘¢ èŠ‚ç‚¹æ¢å¤</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> FSM <span class="keyword">interface</span> &#123;</span><br><span class="line">  Apply(*Log) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">  Snapshot() (FSMSnapshot, error)</span><br><span class="line">  Restore(io.ReadCloser) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">runFSM</span><span class="params">()</span></span> &#123;</span><br><span class="line">  commitSingle := <span class="function"><span class="keyword">func</span><span class="params">(req *commitTuple)</span></span>&#123;...&#125;</span><br><span class="line">  commitBatch := <span class="function"><span class="keyword">func</span><span class="params">(reqs []*commitTuple)</span></span>&#123;...&#125;</span><br><span class="line">  restore := <span class="function"><span class="keyword">func</span><span class="params">(req *restoreFuture)</span></span>&#123;...&#125;</span><br><span class="line">  snapshot := <span class="function"><span class="keyword">func</span><span class="params">(req *reqSnapshotFuture)</span></span>&#123;...&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ptr := &lt;-r.fsmMutateCh:</span><br><span class="line">      <span class="keyword">switch</span> req := ptr.(<span class="keyword">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> []*commitTuple:</span><br><span class="line">        commitBatch(req)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> *restoreFuture:</span><br><span class="line">        restore(req)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">panic</span>(fmt.Errorf(<span class="string">&quot;bad type passed to fsmMutateCh: %#v&quot;</span>, ptr))</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> req := &lt;-r.fsmSnapshotCh:</span><br><span class="line">      snapshot(req)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> &lt;-r.shutdownCh:</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>snapshotä¸æ˜¯é‡ç‚¹ï¼Œæ‰€ä»¥å…ˆç®€å•ä»‹ç»ä¸‹ï¼Œåç»­é‡è¯»çš„æ—¶å€™è¡¥ä¸Šè¿™ä¸€æ¨¡å—ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥çœ‹æœ€é‡è¦çš„Raftçš„é€»è¾‘ã€‚</p>
]]></content>
      <tags>
        <tag>raft</tag>
      </tags>
  </entry>
  <entry>
    <title>blogæŠ˜è…¾è®°å½•</title>
    <url>/2021/12/17/blog%E9%83%A8%E7%BD%B2%E7%AF%87/</url>
    <content><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>æœ€è¿‘å¼€å§‹é‡æ‹¾å†™blogçš„ä¹ æƒ¯ï¼Œæƒ³ç€åšæŒç‚¹å•¥å§ã€‚</p>
<p>ç»“æœå°†githubä¸Šçš„ç½‘ç«™æ‰“å¼€ï¼Œ2020-03æœ€è¿‘ä¸€ç¯‡ï¼Œç°åœ¨å¯æ˜¯2021-12æœˆäº†ï¼Œæç½®äº†1å¹´9ä¸ªæœˆï¼ŒçœŸè¡Œã€‚</p>
<p>ç„¶åæ‰“ç®—ä¸Šä¼ ä¸€ç¯‡blogï¼Œå‘ç°æ–°ç”µè„‘ä¸Šç¯å¢ƒä¹Ÿæ²¡æœ‰äº†ã€‚å¤§è„‘å¼€å§‹é«˜é€Ÿè¿è½¬ï¼Œå¥½å§~ å®Œå…¨æ²¡æœ‰ä¸€ç‚¹æ˜ åƒã€‚</p>
<p>å› æ­¤ï¼Œæ‰“ç®—ä¹–ä¹–çš„å†™æ–‡ç« è®°å½•ï¼Œå¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œå…ˆäººä»¬ä¸æ›¾æ¬ºæˆ‘å•Š~</p>
<h4 id="æ“ä½œè®°å½•"><a href="#æ“ä½œè®°å½•" class="headerlink" title="æ“ä½œè®°å½•"></a>æ“ä½œè®°å½•</h4><p>ä¹‹å‰è¿˜æŠ˜è…¾ä»€ä¹ˆmwebï¼Œä¸€é”®éƒ¨ç½²å¤šä¸ªå¹³å°å•¥çš„ã€‚ç°åœ¨å¯èƒ½æ˜¯æ€æƒ³è§‚å¿µå˜äº†ï¼Œå†…å®¹å¹³å°è¿˜æ˜¯ä»¥å†…å®¹ä¸ºä¸»ã€‚æ—¢ç„¶éƒ½èŠ±äº†é‚£ä¹ˆå¤šå¿ƒæ€å†™äº†ï¼Œéš¾é“è¿˜ä¸èƒ½å»å„ä¸ªå¹³å°æºœè¾¾ä¸€åœˆå¯¼å…¥ä¸‹å—ã€‚</p>
<h5 id="ç”¨ä»€ä¹ˆå†™ï¼Ÿ"><a href="#ç”¨ä»€ä¹ˆå†™ï¼Ÿ" class="headerlink" title="ç”¨ä»€ä¹ˆå†™ï¼Ÿ"></a>ç”¨ä»€ä¹ˆå†™ï¼Ÿ</h5><blockquote>
<p>Typero</p>
</blockquote>
<h5 id="ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ"><a href="#ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ" class="headerlink" title="ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ"></a>ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ</h5><blockquote>
<p> è·¯è¿‡å›¾åºŠã€‚å°±æ˜¯è§‰å¾—å‰ªè´´æ¿ç›´æ¥ctrl+vå¾ˆæ–¹ä¾¿ï¼Œæ‡’å¾—æ¢ã€‚</p>
</blockquote>
<h5 id="å‘å¸ƒåˆ°å“ª"><a href="#å‘å¸ƒåˆ°å“ª" class="headerlink" title="å‘å¸ƒåˆ°å“ª"></a>å‘å¸ƒåˆ°å“ª</h5><p>åŸåˆ™å°±æ˜¯æ”¯æŒMDå¯¼å…¥</p>
<ul>
<li>githubï¼Œå¯ä»¥å»ç™¾åº¦æ™ºèƒ½äº‘ä¸Šå»ç”³è¯·ä¸€ä¸ªåŸŸåï¼Œä¾¿å®œçš„ä¸€å¹´å°±13å…ƒï¼Œä¸è¿‡ç»­è´¹æ¯”è¾ƒè´µâ˜ºï¸ã€‚ â€“  ç®—äº†ï¼Œå®åè®¤è¯å•¥çš„éº»çƒ¦ã€‚</li>
<li>csdn</li>
<li>cnblog(ä¸æ”¯æŒMDå¯¼å…¥ï¼Œæœ‰ç‚¹æ„äºº)</li>
<li>ç®€ä¹¦(ä¸æ”¯æŒMDå¯¼å…¥ï¼Œæ”¾å¼ƒ)</li>
</ul>
<h5 id="hexoä¸githubé…ç½®"><a href="#hexoä¸githubé…ç½®" class="headerlink" title="hexoä¸githubé…ç½®"></a>hexoä¸githubé…ç½®</h5><p>è¯´èµ·æ¥æˆ‘ä¹‹å‰å¼„è¿‡ä¸€ç‰ˆï¼Œä½†æ˜¯å®Œæˆå¿˜è®°äº†ã€‚æ›´æƒ¨çš„æ˜¯gitä»“åº“çš„ä¸œè¥¿éƒ½ä¸çŸ¥é“æ€ä¹ˆå¤ç”¨ï¼Œåªèƒ½å®Œå…¨é‡æ¥ï¼Œå°±å½“æ˜¯ä¸€ä¸ªæ–°çš„å¼€å§‹å¥½äº†ã€‚</p>
<p>å…ˆå°†ä¸€æ¬¡æ€§çš„æ“ä½œåšäº†ï¼Œå®‰è£…&amp;é…ç½®ã€‚é…ç½®æ–‡ä»¶åªæœ‰2ä¸ªï¼Œä¸€å®šè¦åšå¥½å¤‡ä»½</p>
<p>_config.yml: ç½‘ç«™é…ç½®</p>
<p>themes/next/_config.ymlï¼šä¸»é¢˜é…ç½®</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> macä¸Šå®‰è£…hexo</span></span><br><span class="line">brew install hexo</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆå§‹åŒ–é¡¹ç›®</span></span><br><span class="line">hexo init myblog</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> nextä¸»é¢˜</span></span><br><span class="line">git clone https://github.com/theme-next/hexo-theme-next themes/next</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®šåˆ¶åŒ–é…ç½® _config.yml</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># siteï¼š è¿™åŠ›çš„languageè¦å’Œä¸»é¢˜é‡Œé¢çš„themes/next/languagesä¸‹é¢çš„æ–‡ä»¶èƒ½å¯¹åº”æ‰è¡Œ</span></span></span><br><span class="line">title: Moonshine&#x27;s Blog</span><br><span class="line">subtitle: &#x27;æ—¥æ‹±ä¸€å’æ— æœ‰å°½ï¼ŒåŠŸä¸å”æç»ˆå…¥æµ·&#x27;</span><br><span class="line">description: &#x27;é¢¨ãŒå¹ã„ã¦è‘‰ãŒè½ã¡ã€è½ã¡è‘‰ã¯åœŸå£Œã®è‚¥ã‚„ã—ã¨ãªã‚ŠåœŸå£Œã‚’è‚¥ãˆã•ã›ã€æœç‰©ãŒã‚†ã£ãã‚Šã¨ç€å®Ÿã«è‚²ã¤ã®ã§ã™&#x27;</span><br><span class="line">keywords: &#x27;æ•°æ®åº“&#x27;</span><br><span class="line">author: Moonshine</span><br><span class="line">language: zh-CN</span><br><span class="line">timezone: &#x27;&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># url</span></span></span><br><span class="line">url: https://zhangtinglu.github.io/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ä¸»é¢˜</span></span></span><br><span class="line">theme: next</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># éƒ¨ç½²git</span></span></span><br><span class="line">deploy:</span><br><span class="line">  type: &#x27;git&#x27;</span><br><span class="line">  repo: &#x27;https://github.com/zhangtinglu/zhangtinglu.github.io&#x27;</span><br><span class="line">  branch: &#x27;master&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ä»£ç è¯­æ³•é«˜äº®ï¼Œå°†prismjsæ”¹æˆtrueå°±è¡Œäº†</span></span></span><br><span class="line">prismjs:</span><br><span class="line">  enable: true </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®šåˆ¶themeé…ç½® themes/next/_config.yml -- æœ‰ç‚¹å¤šï¼Œç›´æ¥å¤‡ä»½å§</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŠŠè‡ªå·±éœ€è¦çš„éœ€è¦çš„pageå®‰è£…ä¸‹</span></span><br><span class="line">hexo new page about</span><br><span class="line">hexo new page tags</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> é¦–é¡µæ‘˜è¦ -- å¤ªè´¹åŠ²äº†ï¼Œç›´æ¥ç”¨å½’æ¡£é¡µé¢å½“æˆä¸»é¡µ</span></span><br><span class="line">~/myblog/themes/next/layout </span><br><span class="line">mv index.swig index_bak.swig</span><br><span class="line">cp archive.swig index.swig</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä»£ç å¯æŠ˜å  - æ”¶ç¼©</span></span><br><span class="line">codeblock:</span><br><span class="line">  highlight_theme: night</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ˜¾å¾—å¤ªå¤§äº† -- ä¸ç®¡èƒ½çœ‹å°±è¡Œ</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ–‡ç« ç›®å½•</span></span><br><span class="line">toc:</span><br><span class="line">  expand_all: true</span><br></pre></td></tr></table></figure>

<p>æ¥ç€å°±æ˜¯å¹³å¸¸ä½¿ç”¨äº†ï¼Œåˆ›å»ºblog-deploy</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…ˆå°†hello worldè¿™ä¸ªpageåˆ é™¤</span></span><br><span class="line">rm -rf /source/_posts/hello-world.md</span><br><span class="line">hexo new &#x27;blog&#x27;</span><br><span class="line">hexo s</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> éƒ¨ç½²</span></span><br><span class="line">hexo d -g</span><br></pre></td></tr></table></figure>

<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>çœŸçš„å‰ç«¯åšåˆ°æœ€åä¼šç–¯ï¼Œå¤ªå®¹æ˜“äº§ç”Ÿå¼ºè¿«ç—‡äº†ã€‚</p>
<p>å•¥ä¹Ÿä¸è¯´äº†ï¼Œé‡å¤æ€§åŠ³åŠ¨ï¼Œå¦‚æœæ¢ä¸ªç”µè„‘ï¼Œç›´æ¥å°†æ•´ä¸ªé¡¹ç›®å¤‡ä»½ã€‚</p>
]]></content>
      <tags>
        <tag>hexoé…ç½®</tag>
      </tags>
  </entry>
  <entry>
    <title>hashicorp:raftæºç ç³»åˆ—(2)--ç½‘ç»œå±‚</title>
    <url>/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-2-%E7%BD%91%E7%BB%9C%E5%B1%82/</url>
    <content><![CDATA[<h4 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><p>æ¥ç€ä¸Šé¢â€“å¯¼è¯»ï¼Œæœ¬ç¯‡è®²è§£Transportä¼ è¾“å±‚å®ç°ã€‚</p>
<p>å¦‚ä¸‹NewRaftå‡½æ•°çš„å‚æ•°ä¸­ï¼Œé™¤äº†Configç»“æ„ï¼Œå…¶ä»–éƒ½æ˜¯ä»¥interfaceå½¢å¼å®ç°ã€‚</p>
<p>æ¥ä¸‹æ¥å‡ ç¯‡æˆ‘ä»¬åˆ†åˆ«å¯¹è¿™5ç±»æ¥å£è¿›è¡Œè¯¦ç»†åˆ†æã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRaft</span><span class="params">(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans Transport)</span> <span class="params">(*Raft, error)</span></span> &#123;</span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶"><a href="#ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶" class="headerlink" title="ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶"></a>ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶</h4><ul>
<li><p>transport.go: å®šä¹‰ä¼ è¾“å±‚æ¥å£ï¼Œä¸‹å›¾ä¸­çš„Transport Interfaceå¯¹è±¡ã€‚</p>
</li>
<li><p>inmem_transport.go: ä»¥å†…å­˜çš„æ–¹å¼å®ç°Transportæ¥å£ï¼Œç”¨äºæµ‹è¯•ã€‚</p>
</li>
<li><p>net_transport.go: ç½‘ç»œæ–¹å¼å®ç°Transportæ¥å£ã€‚</p>
</li>
<li><p>tcp_transport.go: ä»¥TCPçš„æ–¹å¼å®ç°äº†NetworkTransportéœ€è¦çš„SteamLayerã€‚</p>
</li>
<li><p>command.goï¼šè¿™ä¸ªæ–‡ä»¶é‡Œé¢å®šä¹‰äº†å„ç§RPC requestå’Œresponseçš„ç»“æ„ï¼Œeg: AppendEntriesRequestã€AppendEntriesResponse</p>
<p><a href="https://imgtu.com/i/ovlYo6"><img src="https://s4.ax1x.com/2021/12/14/ovlYo6.png" alt="ovlYo6.png"></a></p>
</li>
</ul>
<p>æ€»ç»“ï¼ŒNetworkTransportå’ŒInmemTransportæ˜¯å¯¹Transportå±‚çš„å…·ä½“å®ç°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯¹NetworkTransportè¿›è¡Œè¯¦ç»†åˆ†æã€‚</p>
<h4 id="ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ"><a href="#ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ" class="headerlink" title="ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ"></a>ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</h4><h5 id="ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport-AppendEntrieså¼€å§‹"><a href="#ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport-AppendEntrieså¼€å§‹" class="headerlink" title="ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport_AppendEntrieså¼€å§‹"></a>ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport_AppendEntrieså¼€å§‹</h5><p>æµ‹è¯•ç”¨ä¾‹ä¸€èˆ¬èƒ½å‘Šè¯‰æˆ‘ä»¬æ€ä¹ˆç©ï¼Œè€ŒAppendEntrieså‘é€æ—¥å¿—åˆæ˜¯æœ€å¸¸ç”¨çš„åŠŸèƒ½ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±ä»è¿™é‡Œå¼€å§‹ã€‚</p>
<p><a href="https://imgtu.com/i/ovW3X4"><img src="https://s4.ax1x.com/2021/12/14/ovW3X4.md.png" alt="ovW3X4.md.png"></a></p>
<ol>
<li><p>åˆå§‹åŒ–æ¶ˆè´¹è€…(trans1)ï¼Œè¿™ä¸€æ­¥åé¢æ˜¯è¦è¯¦ç»†çœ‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ ‡æ˜Ÿã€‚</p>
</li>
<li><p>å¯åŠ¨æ¶ˆè´¹è€…ï¼Œç›‘å¬rpcChï¼Œä¹Ÿå°±æ˜¯Consumer()è¿”å›çš„åªè¯»channelã€‚ğŸ¤”ï¼šrpc.Respondå‡½æ•°åªæ˜¯ç»™respChæ·»åŠ äº†ä¸€ä¸ªå…ƒç´ ï¼Œé‚£è°æ¥æ¶ˆè´¹è¿™ä¸ªå…ƒç´ å‘¢ï¼Ÿ</p>
</li>
<li><p>åˆå§‹åŒ–ç”Ÿäº§è€…( trans2)ï¼ŒåŒæ ·ä½¿ç”¨newTCPTransportå®ç°ã€‚</p>
</li>
<li><p>è°ƒç”¨AppendEntriesæ¶ˆæ¯ç»™æ¶ˆè´¹è€…trans1ï¼Œè¿™é‡Œç›´æ¥å°±è·å–è¿”å›äº†ã€‚ä¸ºå•¥çœ‹ç€å°±æ˜¯åŒæ­¥è¿”å›çš„å‘¢? æŒ‰ç†è¯´ç½‘ç»œè°ƒç”¨ä¸€èˆ¬éƒ½æ˜¯å¼‚æ­¥è¿”å›å§ã€‚è¿™ä¸ªæ˜Ÿæ ‡æ­¥éª¤ï¼Œæˆ‘ä»¬åé¢æ¥è¯¦ç»†åˆ†æã€‚</p>
</li>
</ol>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestNetworkTransport_AppendEntries</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> _, useAddrProvider := <span class="keyword">range</span> []<span class="keyword">bool</span>&#123;<span class="literal">true</span>, <span class="literal">false</span>&#125; &#123;</span><br><span class="line">    <span class="comment">// â‘ åˆå§‹åŒ–trans1 -- æ¶ˆè´¹è€…</span></span><br><span class="line">    trans1, err := makeTransport(t, useAddrProvider, <span class="string">&quot;localhost:0&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    rpcCh := trans1.Consumer()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰æµ‹è¯•ä½¿ç”¨çš„RPCè¯·æ±‚</span></span><br><span class="line">    args := AppendEntriesRequest&#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    resp := AppendEntriesResponse&#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¡ å¯åŠ¨æ¶ˆè´¹è€…ç›‘å¬ </span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> rpc := &lt;-rpcCh:</span><br><span class="line">        <span class="comment">// è·å–æ¶ˆæ¯ç„¶åè¿”å›ï¼Œæ³¨æ„Respondå‡½æ•°åªæ˜¯ç»™RPCå¯¹è±¡çš„RespChanæ·»åŠ ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆè°æ¥æ¶ˆè´¹è¿™å’Œchanå‘¢</span></span><br><span class="line">        rpc.Respond(&amp;resp, <span class="literal">nil</span>)</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¢ åˆå§‹åŒ–ç”Ÿäº§è€… trans2</span></span><br><span class="line">    trans2, err := makeTransport(t, useAddrProvider, <span class="keyword">string</span>(trans1.LocalAddr()))</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// â‘£ å‘é€AppendEntriesæ¶ˆæ¯ç»™trans1ï¼Œè¿™é‡Œç›´æ¥å°±è·å–è¿”å›äº†ã€‚ä¸ºå•¥çœ‹ç€å°±æ˜¯åŒæ­¥è¿”å›çš„å‘¢</span></span><br><span class="line">    <span class="keyword">if</span> err := trans2.AppendEntries(<span class="string">&quot;id1&quot;</span>, trans1.LocalAddr(), &amp;args, &amp;out); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      t.Fatalf(<span class="string">&quot;err: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="makeTransportå®ç°åˆ†æ"><a href="#makeTransportå®ç°åˆ†æ" class="headerlink" title="makeTransportå®ç°åˆ†æ"></a>makeTransportå®ç°åˆ†æ</h5><ol>
<li><p>å…ˆçœ‹ä¸‹å‡½æ•°è°ƒç”¨å…³ç³»</p>
<p>newTCPTransportï¼šå°±æ˜¯tcpç«¯å£ç»‘å®šï¼Œç”ŸæˆTCPStreamLayer(ä¸Šé¢çš„ç±»å›¾ä¸­çŸ¥é“æ˜¯NetworkTransportç»“æ„éœ€è¦çš„æˆå‘˜)</p>
<p>NewNetworkTransportWithConfigï¼šåˆ›å»ºNetworkTransportå¯¹è±¡</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">   makeTransport</span><br><span class="line">   -&gt; NewTCPTransportWithConfig</span><br><span class="line">     -&gt; newTCPTransport <span class="comment">// è´Ÿè´£è¿›è¡Œtcpç«¯å£ç»‘å®šï¼Œç”ŸæˆTCPStreamLayerï¼ŒåŒ…è£…å™¨</span></span><br><span class="line">   		-&gt; NewNetworkTransportWithConfig <span class="comment">// çœŸæ­£åˆ›å»ºNetworkTransportå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> newTCPTransport</span><br><span class="line"></span><br><span class="line">   ä¸‹é¢æ˜¯newTCPTransportçš„å®ç°ï¼Œæœ€åtransportCreatorå°±æ˜¯ç½‘ç»œå±‚çš„åˆ›å»ºå™¨</span><br><span class="line"></span><br><span class="line">   <span class="string">``</span><span class="string">`go</span></span><br><span class="line"><span class="string">   // â‘  è°ƒç”¨netåº“ç»‘å®štcpç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="string">   list, err := net.Listen(&quot;tcp&quot;, bindAddr)</span></span><br><span class="line"><span class="string">   // â‘¡ å°†TCPListener -&gt; TCPStreamLayer(ä¸Šé¢çš„ç±»å›¾ä¸­NetworkTransportéœ€è¦å®ç°StreamLayeræ¥å£)</span></span><br><span class="line"><span class="string">   stream := &amp;TCPStreamLayer&#123;</span></span><br><span class="line"><span class="string">   		advertise: advertise,</span></span><br><span class="line"><span class="string">   		listener:  list.(*net.TCPListener),</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">   // â‘¢ å°†ä¸Šé¢çš„ TCPStreamLayer-&gt; NetworkTransportï¼Œè°ƒç”¨ NewNetworkTransportWithConfig</span></span><br><span class="line"><span class="string">   trans := transportCreator(stream)</span></span><br></pre></td></tr></table></figure></li>
<li><p>newNetworkTransport</p>
<p>ä¸‹é¢æ˜¯åˆ›å»ºç½‘ç»œå±‚çš„ä»£ç ï¼Œä¸€ä¸ªAcceptorä¸“é—¨ç”¨æ¥accetorè¿æ¥ï¼Œæ¯ä¸ªæ–°çš„è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªåç¨‹è¿›è¡Œå¤„ç†ã€‚</p>
<p><a href="https://imgtu.com/i/T9BOV1"><img src="https://s4.ax1x.com/2021/12/16/T9BOV1.png" alt="T9BOV1.png"></a></p>
<ul>
<li><p>Mainçº¿ç¨‹è°ƒç”¨trans.listen()å¯åŠ¨ç›‘å¬åç¨‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// â‘  å°†ä¸Šé¢çš„configæ³¨å…¥è¿›æ¥ï¼Œä¸»è¦æ˜¯Stream</span></span><br><span class="line">trans := &amp;NetworkTransport&#123;</span><br><span class="line">    connPool:              <span class="built_in">make</span>(<span class="keyword">map</span>[ServerAddress][]*netConn),</span><br><span class="line">    consumeCh:             <span class="built_in">make</span>(<span class="keyword">chan</span> RPC),</span><br><span class="line">    logger:                config.Logger,</span><br><span class="line">    maxPool:               config.MaxPool,</span><br><span class="line">    shutdownCh:            <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">    stream:                config.Stream,</span><br><span class="line">    timeout:               config.Timeout,</span><br><span class="line">    TimeoutScale:          DefaultTimeoutScale,</span><br><span class="line">    serverAddressProvider: config.ServerAddressProvider,</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// â‘¡ è®¾ç½®Streamä¸Šä¸‹æ–‡</span></span><br><span class="line">trans.setupStreamContext()</span><br><span class="line"><span class="comment">// â‘¢ å¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¸“é—¨æ¥å¤„ç†è¿æ¥</span></span><br><span class="line"><span class="keyword">go</span> trans.listen()</span><br></pre></td></tr></table></figure></li>
<li><p>Acceptorç›‘å¬æ–°è¿æ¥ï¼Œå¹¶å¯åŠ¨å¤„ç†åç¨‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">listen</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// â‘  æ¥æ”¶æ–°è¿æ¥ï¼Œè¿™ä¸ªåº•å±‚æ˜¯epollå®ç°ï¼Œ</span></span><br><span class="line">    conn, err := n.stream.Accept()</span><br><span class="line">    <span class="comment">// â‘¡ å¯åŠ¨å¤„ç†åç¨‹</span></span><br><span class="line">    <span class="keyword">go</span> n.handleConn(n.getStreamContext(), conn)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>å¯¹è¿æ¥è¿›è¡Œå¤„ç†</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">handleConn</span><span class="params">(connCtx context.Context, conn net.Conn)</span></span> &#123;</span><br><span class="line">  r := bufio.NewReaderSize(conn, connReceiveBufferSize)</span><br><span class="line">  w := bufio.NewWriter(conn)</span><br><span class="line">  dec := codec.NewDecoder(r, &amp;codec.MsgpackHandle&#123;&#125;)</span><br><span class="line">  enc := codec.NewEncoder(w, &amp;codec.MsgpackHandle&#123;&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// â‘  è¯»æ•°æ® -- è§£ç  -- å¤„ç† -- ç¼–ç </span></span><br><span class="line">    <span class="keyword">if</span> err := n.handleCommand(r, dec, enc); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// â‘¡ è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> err := w.Flush(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handleCommandæ˜¯æ ¸å¿ƒçš„å¤„ç†é€»è¾‘ï¼Œè¿™é‡Œé€šè¿‡chanè®©ç”¨æˆ·ä½¿ç”¨çš„æ—¶å€™æ„Ÿè§‰æ˜¯åŒæ­¥çš„ã€‚</p>
<ol>
<li><p>è·å–ç±»å‹ReadByteï¼Œçº¦å®šç¬¬ä¸€ä½è¡¨ç¤ºçš„RPCç±»å‹ï¼Œeg:AppendEntries RequestVote</p>
</li>
<li><p>å®šä¹‰respChã€‚</p>
</li>
<li><p>å¯¹ä¸åŒç±»å‹çš„Requestè¿›è¡Œè§£ç ã€‚</p>
</li>
<li><p>å°†è§£ç å‡ºæ¥çš„RPCæ¶ˆæ¯æ”¾åˆ°æ¶ˆè´¹channelä¸­</p>
</li>
<li><p>ç­‰respChè¿”å›å¤„ç†åçš„ç»“æ„</p>
</li>
<li><p>å°†ç»“æ„è¿›è¡Œç¼–ç ã€‚</p>
<p>ä¸‹é¢æ˜¯å’Œåˆ«çš„åç¨‹è¿›è¡Œäº¤äº’çš„æ–¹å¼ï¼Œå®é™…ä¸Šå¤„ç†é€»è¾‘æ˜¯å¤–åŒ…å‡ºå»è¿›è¡Œå¤„ç†çš„ã€‚</p>
</li>
</ol>
<p><a href="https://imgtu.com/i/T9R9Hg"><img src="https://s4.ax1x.com/2021/12/16/T9R9Hg.png" alt="T9R9Hg.png"></a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">handleCommand</span><span class="params">(r *bufio.Reader, dec *codec.Decoder, enc *codec.Encoder)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  getTypeStart := time.Now()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘  è·å–ç±»å‹ï¼Œçº¦å®šç¬¬ä¸€ä½è¡¨ç¤ºçš„RPCç±»å‹ï¼Œeg:AppendEntries RequestVote</span></span><br><span class="line">  rpcType, err := r.ReadByte()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ å®šä¹‰respCh</span></span><br><span class="line">  respCh := <span class="built_in">make</span>(<span class="keyword">chan</span> RPCResponse, <span class="number">1</span>)</span><br><span class="line">  rpc := RPC&#123;</span><br><span class="line">    RespChan: respCh,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¢ å¯¹ä¸åŒç±»å‹çš„Requestè¿›è¡Œè§£ç </span></span><br><span class="line">  <span class="keyword">switch</span> rpcType &#123;</span><br><span class="line">  <span class="keyword">case</span> rpcAppendEntries:</span><br><span class="line">    <span class="keyword">var</span> req AppendEntriesRequest</span><br><span class="line">    <span class="keyword">if</span> err := dec.Decode(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    rpc.Command = &amp;req</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> rpcRequestVote:</span><br><span class="line">    <span class="keyword">var</span> req RequestVoteRequest</span><br><span class="line">    <span class="keyword">if</span> err := dec.Decode(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    rpc.Command = &amp;req</span><br><span class="line">   ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘£ å°†è§£ç å‡ºæ¥çš„çŒåˆ°Raft.consumeCh</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> n.consumeCh &lt;- rpc:</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¤ ç­‰ç»“æœï¼Œä¸Šé¢çš„consumeChè¢«Raftçš„runLeaderä¹‹ç±»çš„å…¶ä»–åç¨‹è¿›è¡Œå¤„ç†åï¼Œå°†ç»“æœå¡ä¼šåˆ°respChã€‚</span></span><br><span class="line">RESP:</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> resp := &lt;-respCh:</span><br><span class="line">    <span class="comment">// â‘¥ å¯¹ç»“æœè¿›è¡Œç¼–ç </span></span><br><span class="line">    <span class="keyword">if</span> err := enc.Encode(resp.Response); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h5 id="AppendEntrieså®ç°åˆ†æ"><a href="#AppendEntrieså®ç°åˆ†æ" class="headerlink" title="AppendEntrieså®ç°åˆ†æ"></a>AppendEntrieså®ç°åˆ†æ</h5><p>ä¸Šé¢çš„ä¼ è¾“å±‚å·²ç»åˆ›å»ºå¥½äº†è¿æ¥çš„å¤„ç†å™¨(æ¶ˆè´¹è€…)ï¼Œç°åœ¨éœ€è¦æ¶ˆæ¯çš„ç”Ÿäº§è€…ï¼ŒAppendEntrieså°±èƒ½å……å½“è¿™ä¸€è§’è‰²ã€‚</p>
<p>éœ€è¦ç½‘ç»œäº¤äº’çš„RequestVoteã€AppendEntriesã€TimeoutNowéƒ½æ˜¯è°ƒç”¨çš„genericRPCå®ç°çš„ï¼ŒgenericRPCæ˜¯çœŸæ­£æ‰§è¡Œè¯·æ±‚çš„å‡½æ•°ã€‚</p>
<p><a href="https://imgtu.com/i/ovxupF"><img src="https://s4.ax1x.com/2021/12/14/ovxupF.png" alt="ovxupF.png"></a></p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªgenericRPCçš„æµç¨‹ï¼š</p>
<p>â‘  ä»è¿æ¥æ± è·å–è¿æ¥å¯¹è±¡ï¼Œç®€å•çš„ç»´æŠ¤äº†ä¸€ä¸ªè¿æ¥æ± ã€‚</p>
<p>â‘¡ åœ¨è¿æ¥ä¸Šå‘é€RPCè¯·æ±‚ã€‚</p>
<p>â‘¢ è§£ç Responseï¼Œå°†connè¿”è¿˜è¿æ¥æ± å¦‚æœå¯ä»¥çš„è¯ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šè¿™é‡Œå‘é€è¯·æ±‚ä¹‹åï¼ŒåŒæ­¥è·å–Responseã€‚å¦‚æœæ˜¯çŸ­é“¾æ¥ï¼Œä¸ºäº†é«˜æ•ˆå°±ä¸ä¼šç›´æ¥åœ¨è¿™é‡Œç­‰ç»“æœäº†ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">genericRPC</span><span class="params">(id ServerID, target ServerAddress, rpcType <span class="keyword">uint8</span>, args <span class="keyword">interface</span>&#123;&#125;, resp <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="comment">// â‘  ä»è¿æ¥æ± ä¸­è·å–è¿æ¥ï¼ŒNetworkTransportç»´æŠ¤äº†ä¸€ä¸ªè¿æ¥æ± </span></span><br><span class="line">  conn, err := n.getConnFromAddressProvider(id, target)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ å‘é€RPCè¯·æ±‚</span></span><br><span class="line">  <span class="keyword">if</span> err = sendRPC(conn, rpcType, args); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¢ è§£ç Responseï¼Œå¹¶ä¸”å½’è¿˜è¿æ¥ã€‚æ³¨æ„ï¼šè¿™é‡Œå‘é€äº†è¯·æ±‚ä¹‹åï¼Œé©¬ä¸Šå°±è§£ç Responseäº†ã€‚æƒ³æƒ³æˆ‘ä»¬çš„mysqlå®¢æˆ·ç«¯ï¼Œ(å‘æ¶ˆæ¯,ç­‰ç»“æœï¼‰ï¼Œä¸å¯ä»¥ä¸€ç›´å‘æ¶ˆæ¯è€Œä¸æ¥æ”¶ã€‚</span></span><br><span class="line">  canReturn, err := decodeResponse(conn, resp)</span><br><span class="line">  <span class="keyword">if</span> canReturn &#123;</span><br><span class="line">    n.returnConn(conn)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯¹æ¯”çœ‹çœ‹InmemTransport.makeRPCæ–¹æ³•æ¥ä½“ä¼šå…¶ä¸­çš„ä¸åŒï¼Œè¿™è¾¹è·å–ç»“æœéœ€è¦ä»respChè¯»å–ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªResponseæ˜¯è°å¡è¿›å»respChçš„å‘¢ï¼Œæ¯•ç«Ÿæˆ‘ä»¬åªæ˜¯è·å–äº†ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *InmemTransport)</span> <span class="title">makeRPC</span><span class="params">(target ServerAddress, args <span class="keyword">interface</span>&#123;&#125;, r io.Reader, timeout time.Duration)</span> <span class="params">(rpcResp RPCResponse, err error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// å®šä¹‰äº¤äº’ç”¨çš„RPCå¯¹è±¡</span></span><br><span class="line">  req := RPC&#123;</span><br><span class="line">    Command:  args,</span><br><span class="line">    Reader:   r,</span><br><span class="line">    RespChan: respCh,</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// å‘é€æ¶ˆæ¯ï¼Œç›´æ¥å°†æ„é€ å‡ºæ¥çš„reqçŒåˆ°peer.consumerChæ¶ˆè´¹channelï¼Œæœ¬æ¥å°±æ˜¯å†…å­˜ä¸­çš„å¯¹è±¡ã€‚</span></span><br><span class="line">   <span class="keyword">select</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> peer.consumerCh &lt;- req:</span><br><span class="line">     ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ç­‰respChç»“æœï¼Œæ¶ˆè´¹åç¨‹æŠŠRPCæ‹¿å‡ºæ¥-å¤„ç†-ç»“æœå¡å›åˆ°respChã€‚</span></span><br><span class="line">   <span class="keyword">select</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> rpcResp = &lt;-respCh:</span><br><span class="line">      <span class="keyword">if</span> rpcResp.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">         err = rpcResp.Error</span><br><span class="line">      &#125;</span><br><span class="line">     .... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€è€ƒï¼š</p>
<p>1ã€ä¸Šé¢çš„å®ç°æ˜¯ä¸€æ¡ä¸€æ¡çš„å‘ï¼Œå®é™…ä¸Šä¸ºäº†é«˜æ•ˆï¼Œæˆ‘ä»¬å¾€å¾€éƒ½æ˜¯æ‰¹å¤„ç†çš„ã€‚</p>
<p>2ã€æƒ³RequestVoteè¦ç»™å¤šä¸ªå¯¹è±¡å‘æŠ•ç¥¨æ¶ˆæ¯ï¼Œé‚£ä¹ˆè‚¯å®šä¸ä¼šå‘ä¸€ä¸ªæ¶ˆæ¯ç­‰ä¸€ä¸ªç»“æœï¼Œè€Œæ˜¯ç¾¤å‘ï¼Œç„¶åå¤„ç†ç»“æ„ã€‚</p>
<h5 id="AppendEntriesPipelineå®ç°"><a href="#AppendEntriesPipelineå®ç°" class="headerlink" title="AppendEntriesPipelineå®ç°"></a>AppendEntriesPipelineå®ç°</h5><p>åŒæ ·çš„æˆ‘ä»¬ä»æµ‹è¯•ç”¨ä¾‹å¼€å§‹ï¼Œçœ‹çœ‹æ‰¹å¤„ç†æ˜¯æ€ä¹ˆç©çš„ã€‚ä¸»è¦çœ‹çœ‹æ‰¹å¤„ç†å’Œå•æ¡å¤„ç†çš„åŒºåˆ«ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–AppendEntriesPipelineå¯¹è±¡ï¼Œå¯åŠ¨åç¨‹å¤„ç† inprogressCh -&gt; doneCh</span></span><br><span class="line">pipeline, err := trans2.AppendEntriesPipeline(<span class="string">&quot;id1&quot;</span>, trans1.LocalAddr())</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘10ä¸ªæ¶ˆæ¯ï¼Œå¹¶ä¸”å°†RPCåŠ å…¥åˆ°inprogressCh</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">  out := <span class="built_in">new</span>(AppendEntriesResponse)</span><br><span class="line">  <span class="keyword">if</span> _, err := pipeline.AppendEntries(&amp;args, out); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    t.Fatalf(<span class="string">&quot;err: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Consumer()ä¼šè¿”å›doneChï¼Œä»doneChè·å–æ•°æ®ï¼Œå‘äº†10ä¸ªæ¶ˆæ¯ï¼Œæ‰€ä»¥éœ€è¦è·å–10æ¬¡ç»“æœ</span></span><br><span class="line">respCh := pipeline.Consumer()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ready := &lt;-respCh:</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯å‘æ¶ˆæ¯çš„æ—¶å€™  épipeline VS pipelineçš„åŒºåˆ«</p>
<p><a href="https://imgtu.com/i/TCM7Us"><img src="https://s4.ax1x.com/2021/12/16/TCM7Us.md.png" alt="TCM7Us.md.png"></a></p>
<p>ä¸‹é¢æ˜¯è§£ç æ¶ˆæ¯çš„æ—¶å€™  épipeline VS pipelineçš„åŒºåˆ«ï¼Œpipelineçš„decodeResponsesæ–¹æ³•æ˜¯åˆå§‹åŒ–AppendEntriesPipelineå¯¹è±¡çš„æ—¶å€™å°±å¯åŠ¨çš„åç¨‹ã€‚</p>
<p><a href="https://imgtu.com/i/TClAFs"><img src="https://s4.ax1x.com/2021/12/16/TClAFs.md.png" alt="TClAFs.md.png"></a></p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªâ“ç–‘é—®å…³äºnet.Connçš„ A-&gt;B-&gt;Aï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨ç½‘ç»œä¸Šæ˜¯ä¸¤è¾¹å¯ä»¥åŒæ—¶å‘é€æ•°æ®å—ï¼Ÿä¸ºå•¥ä¸Šé¢çš„épipelineæ¨¡å¼ï¼Œsendä¹‹åé©¬ä¸Šå°±å¯ä»¥decodeæ¶ˆæ¯äº†ï¼Œconnè¿™é‡Œå¸®æˆ‘ä»¬åšäº†ä»€ä¹ˆã€‚</p>
<p>æ‰¹å¤„ç†çš„æ•´ä½“å®ç°å°±æ˜¯ï¼Œå¯åŠ¨ä¸€ä¸ªåç¨‹ç›‘æ§inprogressçš„ä»»åŠ¡ã€‚ç„¶åå¼€å‘æ‰¹é‡çš„å‘æ¶ˆæ¯ï¼Œæ¯”å¦‚ä¸€æ¬¡å‘10æ¡ï¼Œç„¶åinprogressåç¨‹è¢«æ¿€æ´»ï¼Œå¼€å§‹å¤„ç†ã€‚å°†å¤„ç†çš„ç»“æœæ”¾åˆ°doneChï¼Œæœ€åç”¨æˆ·ä»doneChè·å–æ¶ˆæ¯å³å¯ã€‚</p>
<h5 id="RequestVoteè¿‡ç¨‹"><a href="#RequestVoteè¿‡ç¨‹" class="headerlink" title="RequestVoteè¿‡ç¨‹"></a>RequestVoteè¿‡ç¨‹</h5><p>ä¸Šé¢æˆ‘ä»¬åˆ†æäº†ä¸€å¯¹ä¸€pipelineå‘æ¶ˆæ¯ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹1:Nï¼Œåœ¨é›†ç¾¤é‡Œé¢ç»™æ‰€æœ‰äººå‘æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ç»“æ„</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">electSelf</span><span class="params">()</span> &lt;-<span class="title">chan</span> *<span class="title">voteResult</span></span> &#123;</span><br><span class="line">  <span class="comment">// â‘  åˆ›å»ºä¸€ä¸ªåŒ…å«peersæ•°é‡çš„respCh</span></span><br><span class="line">  respCh := <span class="built_in">make</span>(<span class="keyword">chan</span> *voteResult, <span class="built_in">len</span>(r.configurations.latest.Servers))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ å¹¶å‘å‘æ¶ˆæ¯ï¼Œç„¶åå°†ç»“æœçŒå›åˆ°respChã€‚åé¢ä»respChè·å–æŠ•ç¥¨ç»“æœå³å¯è¿›è¡Œå¤„ç†ã€‚</span></span><br><span class="line">  askPeer := <span class="function"><span class="keyword">func</span><span class="params">(peer Server)</span></span> &#123;</span><br><span class="line">    r.goFunc(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      resp := &amp;voteResult&#123;voterID: peer.ID&#125;</span><br><span class="line">      err := r.trans.RequestVote(peer.ID, peer.Address, req, &amp;resp.RequestVoteResponse)</span><br><span class="line">      ... </span><br><span class="line">      respCh &lt;- resp</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> respCh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ€»ç»“ğŸ¤”"><a href="#æ€»ç»“ğŸ¤”" class="headerlink" title="æ€»ç»“ğŸ¤”"></a>æ€»ç»“ğŸ¤”</h4><p>ç½‘ç»œæ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„æ¨¡å—ï¼Œåç»­å¯ä»¥çœ‹çœ‹æ¯”è¾ƒç»å…¸çš„Redisã€Nginxè¿™äº›ä¼˜ç§€ç»„ä»¶çš„å®ç°ã€‚</p>
<p>ProxySQLï¼šæƒŠç¾¤æ•ˆåº”æ€è€ƒ</p>
]]></content>
      <tags>
        <tag>raft</tag>
      </tags>
  </entry>
  <entry>
    <title>hashicorp:raftæºç ç³»åˆ—(1)--å¯¼è¯»</title>
    <url>/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-1-%E5%AF%BC%E8%AF%BB/</url>
    <content><![CDATA[<h3 id="Raftæ˜¯å¹²å•¥çš„ï¼Ÿ"><a href="#Raftæ˜¯å¹²å•¥çš„ï¼Ÿ" class="headerlink" title="Raftæ˜¯å¹²å•¥çš„ï¼Ÿ"></a>Raftæ˜¯å¹²å•¥çš„ï¼Ÿ</h3><p><a href="http://thesecretlivesofdata.com/raft/">åŠ¨ç”»è¯´æ˜</a></p>
<p>ç®€è¿°å¦‚ä¸‹å›¾ï¼šç”¨æˆ·SET 5ï¼Œ3ä¸ªä¸åŒèŠ‚ç‚¹éƒ½èƒ½è·å–SET 5çš„æ“ä½œã€‚æ‰€è°“çš„æœ€ç®€å•çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ã€‚</p>
<p><a href="https://imgtu.com/i/oO3r0P"><img src="https://s4.ax1x.com/2021/12/13/oO3r0P.png" alt="oO3r0P.png"></a></p>
<h3 id="Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ"><a href="#Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ" class="headerlink" title="Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ"></a>Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ</h3><h4 id="é¡¹ç›®æœ‰å¤šå°‘è¡Œ"><a href="#é¡¹ç›®æœ‰å¤šå°‘è¡Œ" class="headerlink" title="é¡¹ç›®æœ‰å¤šå°‘è¡Œ?"></a>é¡¹ç›®æœ‰å¤šå°‘è¡Œ?</h4><p>åˆ†æä¸‹æ•´ä¸ªé¡¹ç›®å¤§æ¦‚æ˜¯1Wå¤šè¡Œï¼Œå¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œä»£ç æ³¨é‡Šéå¸¸é½å…¨ï¼Œç†è§£èµ·æ¥æ¯”è¾ƒè½»æ¾ã€‚ä»£ç æŠ½è±¡å¾—å¾ˆå¥½ï¼Œéå¸¸å€¼å¾—å­¦ä¹ ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">-&gt;</span><span class="bash"> % cloc ./</span></span><br><span class="line">      77 text files.</span><br><span class="line">      77 unique files.</span><br><span class="line">       8 files ignored.</span><br><span class="line"></span><br><span class="line">github.com/AlDanial/cloc v 1.90  T=0.09 s (814.1 files/s, 201614.7 lines/s)</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Language                     files          blank        comment           code</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Go                              57           2207           2786          11864</span><br><span class="line">Markdown                         4            106              0            255</span><br><span class="line">YAML                             4             26             29            141</span><br><span class="line">XML                              4              0              0            108</span><br><span class="line">make                             1             10              2             33</span><br><span class="line">Bourne Shell                     1              3              3             10</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">SUM:                            71           2352           2820          12411</span><br><span class="line">-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h4 id="ä»å“ªé‡Œå¼€å§‹ï¼Ÿ"><a href="#ä»å“ªé‡Œå¼€å§‹ï¼Ÿ" class="headerlink" title="ä»å“ªé‡Œå¼€å§‹ï¼Ÿ"></a>ä»å“ªé‡Œå¼€å§‹ï¼Ÿ</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹<code>api.go/Raft</code>ç»“æ„ï¼Œè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªRaftèŠ‚ç‚¹ï¼Œæœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ã€‚åˆ’åˆ†3å¤§å—</p>
<ol>
<li><p>NewRaftèŠ‚ç‚¹éœ€è¦çš„ä¿¡æ¯ï¼šä¸‹å›¾ä¸­æ ‡çº¢ç‚¹çš„ï¼Œå‡ å¤§æ ¸å¿ƒç»„æˆã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬ä»ç½‘ç»œå±‚å¼€å§‹è¯¦ç»†åˆ†æã€‚</p>
<blockquote>
<p>é™¤äº†raftStateï¼Œå…¶ä»–éƒ¨åˆ†å…¨æ˜¯interfaceï¼Œæ¨¡å—æŠ½è±¡çš„å¾ˆç»†è‡´ã€‚</p>
</blockquote>
</li>
<li><p>Leaderæ“ä½œç›¸å…³ï¼šæ•´ä¸ªRaftæœ€æ ¸å¿ƒçš„å°±æ˜¯Leaderçš„çŠ¶æ€è½¬æ¢è¿‡ç¨‹ã€‚æˆ‘ä»¬åç»­ä¹Ÿä¼šå¯¹è¿™ä¸€éƒ¨åˆ†çš„å®ç°åšè¯¦ç»†è¯´æ˜ã€‚</p>
</li>
<li><p>ä¸€äº›å¼‚æ­¥æ“ä½œï¼šè¿™ä¸€å—æ˜¯åµŒå…¥åœ¨å„ä¸ªæ¨¡å—çš„å®ç°ä¸­çš„ã€‚é¡¹ç›®é‡Œé¢ä¸€äº›chançš„ä½¿ç”¨ä¹Ÿæ˜¯å€¼å¾—å­¦ä¹ çš„ã€‚</p>
</li>
</ol>
<p><a href="https://imgtu.com/i/oO0Ein"><img src="https://s4.ax1x.com/2021/12/13/oO0Ein.png" alt="oO0Ein.png"></a></p>
<h4 id="æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ"><a href="#æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ" class="headerlink" title="æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ"></a>æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ</h4><ul>
<li><p>â‘  æ ¡éªŒé…ç½®</p>
</li>
<li><p>â‘¡ è·å–å½“å‰ä»»æœŸï¼Œä»StableStoreä¸­è·å–</p>
</li>
<li><p>â‘¢ è·å–æœ€è¿‘çš„æ—¥å¿—å·å’Œå…·ä½“Logï¼Œä»LogStoreä¸­è·å–</p>
</li>
<li><p>â‘£ åˆ›å»ºBuffer applyChï¼Œç”¨æ¥åº”ç”¨Logåˆ°FSMã€‚è¿™é‡ŒFutureçš„åº”ç”¨å¯ä»¥å­¦ä¹ ä¸‹ï¼Œåé¢å†™applyLogçš„æ—¶å€™å¯ä»¥è¯¦ç»†åˆ†æã€‚</p>
</li>
<li><p>â‘¤ åˆå§‹åŒ–Raftç»“æ„ã€‚</p>
</li>
<li><p>â‘¥ Setå„ç§å˜é‡ï¼Œè¿™é‡Œå¯ä»¥ç ”ç©¶ä¸‹configæ˜¯æ€ä¹ˆå®ç°çº¿ç¨‹å®‰å…¨çš„å˜æ›´ã€‚</p>
</li>
<li><p>â‘¦ å°è¯•ä»å¤‡ä»½ä¸­æ¢å¤ï¼Œå¤„ç†peerå˜æ›´æ—¥å¿—ï¼Œegï¼šæ·»åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹ã€‚è¿™é‡Œä¸ºå•¥åªå¤„ç†Peerå˜æ›´ä¿¡æ¯ï¼Œéƒ½å·²ç»å°†Logè§£æå‡ºæ¥äº†ï¼Œä¸ºå•¥ä¸ç›´æ¥åº”ç”¨å‘¢ï¼Ÿ</p>
</li>
<li><p>â‘§ ç»™ä¼ è¾“å±‚æ³¨å†Œå¿ƒè·³å¤„ç†å™¨ã€‚åœ¨è¿™é‡Œåˆå§‹åŒ–ï¼Œè€Œä¸æ˜¯åœ¨goroutineé‡Œé¢å¤„ç†ï¼Œæ˜¯ä¸ºäº†é¿å…é˜Ÿå¤´é˜»å¡ã€‚</p>
</li>
<li><p>â‘¨ å¯åŠ¨goroutineï¼Œå¦‚ä¸‹å¯åŠ¨äº†3ä¸ªåç¨‹ã€‚</p>
<p><a href="https://imgtu.com/i/oOhDud"><img src="https://s4.ax1x.com/2021/12/13/oOhDud.png" alt="oOhDud.png"></a></p>
</li>
</ul>
<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRaft</span><span class="params">(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans Transport)</span> <span class="params">(*Raft, error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// â‘  æ ¡éªŒé…ç½®</span></span><br><span class="line">  <span class="keyword">if</span> err := ValidateConfig(conf); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ è·å–å½“å‰ä»»åŠ¡ï¼Œè¿™é‡Œæ˜¯ä»StableStoreä¸­è·å–</span></span><br><span class="line">  currentTerm, err := stable.GetUint64(keyCurrentTerm)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¢ è·å–æœ€è¿‘çš„æ—¥å¿—å·å’Œå…·ä½“Logï¼Œä»LogStoreä¸­è·å–ï¼›</span></span><br><span class="line">  lastIndex, err := logs.LastIndex()</span><br><span class="line">  <span class="keyword">if</span> err = logs.GetLog(lastIndex, &amp;lastLog); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to get last log at index %d: %v&quot;</span>, lastIndex, err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘£ åˆ›å»ºBuffer applyChï¼Œç”¨æ¥åº”ç”¨Logåˆ°FSMã€‚è¿™é‡ŒFutureçš„åº”ç”¨å¯ä»¥å­¦ä¹ ä¸‹ã€‚</span></span><br><span class="line">  applyCh := <span class="built_in">make</span>(<span class="keyword">chan</span> *logFuture)</span><br><span class="line">  <span class="keyword">if</span> conf.BatchApplyCh &#123;</span><br><span class="line">    applyCh = <span class="built_in">make</span>(<span class="keyword">chan</span> *logFuture, conf.MaxAppendEntries)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¤ åˆå§‹åŒ–Raftç»“æ„ã€‚</span></span><br><span class="line">  r := &amp;Raft&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¥ Setå„ç§å˜é‡ï¼Œä¸‹é¢è¿™ä¸€è¡Œçš„å®ç°å¯ä»¥ç ”ç©¶ä¸‹ï¼Œä¸ºå•¥ä¸ç›´æ¥r.conf = conf</span></span><br><span class="line">  r.conf.Store(*conf)</span><br><span class="line">  r.setState(Follower)</span><br><span class="line">  r.setCurrentTerm(currentTerm)</span><br><span class="line">  r.setLastLog(lastLog.Index, lastLog.Term)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¦ å°è¯•ä»å¤‡ä»½ä¸­æ¢å¤ï¼Œå¤„ç†peerå˜æ›´æ—¥å¿—ï¼Œegï¼šæ·»åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹. </span></span><br><span class="line">  <span class="keyword">if</span> err := r.restoreSnapshot(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">  &#125;</span><br><span class="line">  snapshotIndex, _ := r.getLastSnapshot()</span><br><span class="line">  <span class="keyword">for</span> index := snapshotIndex + <span class="number">1</span>; index &lt;= lastLog.Index; index++ &#123;</span><br><span class="line">    <span class="keyword">var</span> entry Log</span><br><span class="line">    <span class="keyword">if</span> err := r.logs.GetLog(index, &amp;entry); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := r.processConfigurationLogEntry(&amp;entry); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// â‘§ ç»™ä¼ è¾“å±‚æ³¨å†Œå¿ƒè·³å¤„ç†å™¨</span></span><br><span class="line">  trans.SetHeartbeatHandler(r.processHeartbeat)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¨ å¯åŠ¨goroutine</span></span><br><span class="line">  r.goFunc(r.run)</span><br><span class="line">  r.goFunc(r.runFSM)</span><br><span class="line">  r.goFunc(r.runSnapshots)</span><br><span class="line">  <span class="keyword">return</span> r, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å°†RaftèŠ‚ç‚¹å¯åŠ¨èµ·æ¥äº†</p>
<h4 id="æŠ€æœ¯ç‚¹1ï¼šatomic-Value"><a href="#æŠ€æœ¯ç‚¹1ï¼šatomic-Value" class="headerlink" title="æŠ€æœ¯ç‚¹1ï¼šatomic.Value"></a>æŠ€æœ¯ç‚¹1ï¼šatomic.Value</h4><p><img src="https://blog.betacat.io/image/golang-atomic-value/atomic-value-store.drawio.png" alt="atomic.Value Store æµç¨‹"></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// confè¿™ä¸ªå˜é‡ä¼šæ¶‰åŠåˆ°å¤šä¸ªgoroutineçš„å¹¶å‘ä¿®æ”¹&amp;è¯»å–ã€‚</span></span><br><span class="line"><span class="comment">// ä¸ºäº†ä¿è¯è¯»å†™çš„åŸå­æ€§ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåŠ é”ã€‚ä½†æ˜¯åŠ é”åˆæœ‰ç‚¹è¿‡é‡äº†ï¼Œä¸ºäº†æ›´åŠ é«˜æ•ˆçš„å®ç°ï¼Œä½¿ç”¨äº†atomicã€‚</span></span><br><span class="line">conf atomic.Value</span><br><span class="line">r.conf.Store(*conf)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 8ä¸ªå†™routine + 1ä¸ªè¯»routine</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestAtomic</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">  <span class="keyword">var</span> gloMy = my&#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      wg.Add(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">for</span> &#123;</span><br><span class="line">        tmp := rand.Uint64() % <span class="number">100</span></span><br><span class="line">        gloMy.v1 = tmp</span><br><span class="line">        <span class="comment">// åœ¨è¿™ä¸¤æ¬¡æ“ä½œä¹‹é—´å°±ä¼šäº§ç”Ÿä¸­é—´çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€å°±å¾ˆå¥‡æ€ªæ²¡æœ‰æ„ä¹‰</span></span><br><span class="line">        gloMy.v2 = fmt.Sprintf(<span class="string">&quot;s%d&quot;</span>, tmp)</span><br><span class="line">      &#125;</span><br><span class="line">      wg.Done()</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  wg.Add(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">      t.Log(gloMy.v1, gloMy.v2)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Done()</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=== RUN   TestAtomic</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">75</span> s64 <span class="comment">// ä¸åˆç¬¦é¢„æœŸï¼Œè„è¯»äº†</span></span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">63</span> s63</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">48</span> s48</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">5</span> s5</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">1</span> s1</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.betacat.io/post/golang-atomic-value-exploration/">æ¨èä¸€ç¯‡æ–‡ç« </a> ï¼šæ–‡ä¸­å°†atomicçš„æ¥é¾™å»è„‰éƒ½è§£é‡Šäº†ä¸€éã€‚</p>
<h4 id="æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡"><a href="#æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡" class="headerlink" title="æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡"></a>æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿™è¡Œçš„ä½ç½®ï¼Œåœ¨goroutineå¯åŠ¨ä¹‹å‰æ³¨å†ŒHeartbeatHandlerå¤„ç†å™¨</span></span><br><span class="line">trans.SetHeartbeatHandler(r.processHeartbeat)</span><br></pre></td></tr></table></figure>



<h4 id="å°å°ç–‘é—®â“"><a href="#å°å°ç–‘é—®â“" class="headerlink" title="å°å°ç–‘é—®â“"></a>å°å°ç–‘é—®â“</h4><p>Q: ä¸ºå•¥è¦å«FSMï¼Œæˆ‘çš„ç†è§£FSMä¸å°±æ˜¯ç±»ä¼¼äºMySQLè¿™ç§å¯ä»¥åº”ç”¨Logçš„åœ°æ–¹å—ï¼Ÿæ€»æ„Ÿè§‰ç”¨çŠ¶æ€æœºå‘½åæ€ªæ€ªçš„ï¼Œå®¹æ˜“è¯¯ä¼šã€‚</p>
<p>Q: Config å’Œ Configurationçš„åŒºåˆ«? Configé‡Œé¢éƒ½æ˜¯å•ä¸ªRaftèŠ‚ç‚¹çš„é…ç½®ï¼Œæ¯”å¦‚è¶…æ—¶ä¹‹ç±»çš„ï¼›Configurationæ˜¯Raft Clusterç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æœ‰å‡ ä¸ªèŠ‚ç‚¹ä¹‹ç±»çš„ã€‚</p>
<p>â€‹           </p>
]]></content>
      <tags>
        <tag>raft</tag>
      </tags>
  </entry>
</search>
