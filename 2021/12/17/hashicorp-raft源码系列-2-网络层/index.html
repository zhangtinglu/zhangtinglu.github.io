<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhangtinglu.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="æ¦‚è¿°æ¥ç€ä¸Šé¢â€“å¯¼è¯»ï¼Œæœ¬ç¯‡è®²è§£Transportä¼ è¾“å±‚å®ç°ã€‚ å¦‚ä¸‹NewRaftå‡½æ•°çš„å‚æ•°ä¸­ï¼Œé™¤äº†Configç»“æ„ï¼Œå…¶ä»–éƒ½æ˜¯ä»¥interfaceå½¢å¼å®ç°ã€‚ æ¥ä¸‹æ¥å‡ ç¯‡æˆ‘ä»¬åˆ†åˆ«å¯¹è¿™5ç±»æ¥å£è¿›è¡Œè¯¦ç»†åˆ†æã€‚ 123func NewRaft(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans">
<meta property="og:type" content="article">
<meta property="og:title" content="hashicorp:raftæºç ç³»åˆ—(2)--ç½‘ç»œå±‚">
<meta property="og:url" content="https://zhangtinglu.github.io/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-2-%E7%BD%91%E7%BB%9C%E5%B1%82/index.html">
<meta property="og:site_name" content="Moonshine&#39;s Blog">
<meta property="og:description" content="æ¦‚è¿°æ¥ç€ä¸Šé¢â€“å¯¼è¯»ï¼Œæœ¬ç¯‡è®²è§£Transportä¼ è¾“å±‚å®ç°ã€‚ å¦‚ä¸‹NewRaftå‡½æ•°çš„å‚æ•°ä¸­ï¼Œé™¤äº†Configç»“æ„ï¼Œå…¶ä»–éƒ½æ˜¯ä»¥interfaceå½¢å¼å®ç°ã€‚ æ¥ä¸‹æ¥å‡ ç¯‡æˆ‘ä»¬åˆ†åˆ«å¯¹è¿™5ç±»æ¥å£è¿›è¡Œè¯¦ç»†åˆ†æã€‚ 123func NewRaft(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s4.ax1x.com/2021/12/14/ovlYo6.png">
<meta property="og:image" content="https://s4.ax1x.com/2021/12/14/ovW3X4.md.png">
<meta property="og:image" content="https://s4.ax1x.com/2021/12/16/T9BOV1.png">
<meta property="og:image" content="https://s4.ax1x.com/2021/12/16/T9R9Hg.png">
<meta property="og:image" content="https://s4.ax1x.com/2021/12/14/ovxupF.png">
<meta property="og:image" content="https://s4.ax1x.com/2021/12/16/TCM7Us.md.png">
<meta property="og:image" content="https://s4.ax1x.com/2021/12/16/TClAFs.md.png">
<meta property="article:published_time" content="2021-12-17T08:18:40.000Z">
<meta property="article:modified_time" content="2021-12-17T08:24:07.803Z">
<meta property="article:author" content="Moonshine">
<meta property="article:tag" content="raft">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s4.ax1x.com/2021/12/14/ovlYo6.png">

<link rel="canonical" href="https://zhangtinglu.github.io/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-2-%E7%BD%91%E7%BB%9C%E5%B1%82/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>hashicorp:raftæºç ç³»åˆ—(2)--ç½‘ç»œå±‚ | Moonshine's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Moonshine's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Moonshine's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">æ—¥æ‹±ä¸€å’æ— æœ‰å°½ï¼ŒåŠŸä¸å”æç»ˆå…¥æµ·</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/archives/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangtinglu.github.io/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-2-%E7%BD%91%E7%BB%9C%E5%B1%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Moonshine">
      <meta itemprop="description" content="é¢¨ãŒå¹ã„ã¦è‘‰ãŒè½ã¡ã€è½ã¡è‘‰ã¯åœŸå£Œã®è‚¥ã‚„ã—ã¨ãªã‚ŠåœŸå£Œã‚’è‚¥ãˆã•ã›ã€æœç‰©ãŒã‚†ã£ãã‚Šã¨ç€å®Ÿã«è‚²ã¤ã®ã§ã™">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moonshine's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          hashicorp:raftæºç ç³»åˆ—(2)--ç½‘ç»œå±‚
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-12-17 16:18:40 / ä¿®æ”¹æ—¶é—´ï¼š16:24:07" itemprop="dateCreated datePublished" datetime="2021-12-17T16:18:40+08:00">2021-12-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><p>æ¥ç€ä¸Šé¢â€“å¯¼è¯»ï¼Œæœ¬ç¯‡è®²è§£Transportä¼ è¾“å±‚å®ç°ã€‚</p>
<p>å¦‚ä¸‹NewRaftå‡½æ•°çš„å‚æ•°ä¸­ï¼Œé™¤äº†Configç»“æ„ï¼Œå…¶ä»–éƒ½æ˜¯ä»¥interfaceå½¢å¼å®ç°ã€‚</p>
<p>æ¥ä¸‹æ¥å‡ ç¯‡æˆ‘ä»¬åˆ†åˆ«å¯¹è¿™5ç±»æ¥å£è¿›è¡Œè¯¦ç»†åˆ†æã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRaft</span><span class="params">(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans Transport)</span> <span class="params">(*Raft, error)</span></span> &#123;</span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶"><a href="#ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶" class="headerlink" title="ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶"></a>ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶</h4><ul>
<li><p>transport.go: å®šä¹‰ä¼ è¾“å±‚æ¥å£ï¼Œä¸‹å›¾ä¸­çš„Transport Interfaceå¯¹è±¡ã€‚</p>
</li>
<li><p>inmem_transport.go: ä»¥å†…å­˜çš„æ–¹å¼å®ç°Transportæ¥å£ï¼Œç”¨äºæµ‹è¯•ã€‚</p>
</li>
<li><p>net_transport.go: ç½‘ç»œæ–¹å¼å®ç°Transportæ¥å£ã€‚</p>
</li>
<li><p>tcp_transport.go: ä»¥TCPçš„æ–¹å¼å®ç°äº†NetworkTransportéœ€è¦çš„SteamLayerã€‚</p>
</li>
<li><p>command.goï¼šè¿™ä¸ªæ–‡ä»¶é‡Œé¢å®šä¹‰äº†å„ç§RPC requestå’Œresponseçš„ç»“æ„ï¼Œeg: AppendEntriesRequestã€AppendEntriesResponse</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/ovlYo6"><img src="https://s4.ax1x.com/2021/12/14/ovlYo6.png" alt="ovlYo6.png"></a></p>
</li>
</ul>
<p>æ€»ç»“ï¼ŒNetworkTransportå’ŒInmemTransportæ˜¯å¯¹Transportå±‚çš„å…·ä½“å®ç°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯¹NetworkTransportè¿›è¡Œè¯¦ç»†åˆ†æã€‚</p>
<h4 id="ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ"><a href="#ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ" class="headerlink" title="ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ"></a>ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</h4><h5 id="ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport-AppendEntrieså¼€å§‹"><a href="#ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport-AppendEntrieså¼€å§‹" class="headerlink" title="ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport_AppendEntrieså¼€å§‹"></a>ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport_AppendEntrieså¼€å§‹</h5><p>æµ‹è¯•ç”¨ä¾‹ä¸€èˆ¬èƒ½å‘Šè¯‰æˆ‘ä»¬æ€ä¹ˆç©ï¼Œè€ŒAppendEntrieså‘é€æ—¥å¿—åˆæ˜¯æœ€å¸¸ç”¨çš„åŠŸèƒ½ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±ä»è¿™é‡Œå¼€å§‹ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/ovW3X4"><img src="https://s4.ax1x.com/2021/12/14/ovW3X4.md.png" alt="ovW3X4.md.png"></a></p>
<ol>
<li><p>åˆå§‹åŒ–æ¶ˆè´¹è€…(trans1)ï¼Œè¿™ä¸€æ­¥åé¢æ˜¯è¦è¯¦ç»†çœ‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ ‡æ˜Ÿã€‚</p>
</li>
<li><p>å¯åŠ¨æ¶ˆè´¹è€…ï¼Œç›‘å¬rpcChï¼Œä¹Ÿå°±æ˜¯Consumer()è¿”å›çš„åªè¯»channelã€‚ğŸ¤”ï¼šrpc.Respondå‡½æ•°åªæ˜¯ç»™respChæ·»åŠ äº†ä¸€ä¸ªå…ƒç´ ï¼Œé‚£è°æ¥æ¶ˆè´¹è¿™ä¸ªå…ƒç´ å‘¢ï¼Ÿ</p>
</li>
<li><p>åˆå§‹åŒ–ç”Ÿäº§è€…( trans2)ï¼ŒåŒæ ·ä½¿ç”¨newTCPTransportå®ç°ã€‚</p>
</li>
<li><p>è°ƒç”¨AppendEntriesæ¶ˆæ¯ç»™æ¶ˆè´¹è€…trans1ï¼Œè¿™é‡Œç›´æ¥å°±è·å–è¿”å›äº†ã€‚ä¸ºå•¥çœ‹ç€å°±æ˜¯åŒæ­¥è¿”å›çš„å‘¢? æŒ‰ç†è¯´ç½‘ç»œè°ƒç”¨ä¸€èˆ¬éƒ½æ˜¯å¼‚æ­¥è¿”å›å§ã€‚è¿™ä¸ªæ˜Ÿæ ‡æ­¥éª¤ï¼Œæˆ‘ä»¬åé¢æ¥è¯¦ç»†åˆ†æã€‚</p>
</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestNetworkTransport_AppendEntries</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, useAddrProvider := <span class="keyword">range</span> []<span class="keyword">bool</span>&#123;<span class="literal">true</span>, <span class="literal">false</span>&#125; &#123;</span><br><span class="line">		<span class="comment">// â‘ åˆå§‹åŒ–trans1 -- æ¶ˆè´¹è€…</span></span><br><span class="line">		trans1, err := makeTransport(t, useAddrProvider, <span class="string">&quot;localhost:0&quot;</span>)</span><br><span class="line">		</span><br><span class="line">		rpcCh := trans1.Consumer()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å®šä¹‰æµ‹è¯•ä½¿ç”¨çš„RPCè¯·æ±‚</span></span><br><span class="line">		args := AppendEntriesRequest&#123;</span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line">		resp := AppendEntriesResponse&#123;</span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// â‘¡ å¯åŠ¨æ¶ˆè´¹è€…ç›‘å¬ </span></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> rpc := &lt;-rpcCh:</span><br><span class="line">				<span class="comment">// è·å–æ¶ˆæ¯ç„¶åè¿”å›ï¼Œæ³¨æ„Respondå‡½æ•°åªæ˜¯ç»™RPCå¯¹è±¡çš„RespChanæ·»åŠ ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆè°æ¥æ¶ˆè´¹è¿™å’Œchanå‘¢</span></span><br><span class="line">				rpc.Respond(&amp;resp, <span class="literal">nil</span>)</span><br><span class="line">			...</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// â‘¢ åˆå§‹åŒ–ç”Ÿäº§è€… trans2</span></span><br><span class="line">		trans2, err := makeTransport(t, useAddrProvider, <span class="keyword">string</span>(trans1.LocalAddr()))</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// â‘£ å‘é€AppendEntriesæ¶ˆæ¯ç»™trans1ï¼Œè¿™é‡Œç›´æ¥å°±è·å–è¿”å›äº†ã€‚ä¸ºå•¥çœ‹ç€å°±æ˜¯åŒæ­¥è¿”å›çš„å‘¢</span></span><br><span class="line">		<span class="keyword">if</span> err := trans2.AppendEntries(<span class="string">&quot;id1&quot;</span>, trans1.LocalAddr(), &amp;args, &amp;out); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			t.Fatalf(<span class="string">&quot;err: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="makeTransportå®ç°åˆ†æ"><a href="#makeTransportå®ç°åˆ†æ" class="headerlink" title="makeTransportå®ç°åˆ†æ"></a>makeTransportå®ç°åˆ†æ</h5><ol>
<li><p>å…ˆçœ‹ä¸‹å‡½æ•°è°ƒç”¨å…³ç³»</p>
<p>newTCPTransportï¼šå°±æ˜¯tcpç«¯å£ç»‘å®šï¼Œç”ŸæˆTCPStreamLayer(ä¸Šé¢çš„ç±»å›¾ä¸­çŸ¥é“æ˜¯NetworkTransportç»“æ„éœ€è¦çš„æˆå‘˜)</p>
<p>NewNetworkTransportWithConfigï¼šåˆ›å»ºNetworkTransportå¯¹è±¡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   makeTransport</span><br><span class="line">   -&gt; NewTCPTransportWithConfig</span><br><span class="line">     -&gt; newTCPTransport <span class="comment">// è´Ÿè´£è¿›è¡Œtcpç«¯å£ç»‘å®šï¼Œç”ŸæˆTCPStreamLayer</span></span><br><span class="line">   		-&gt; NewNetworkTransportWithConfig <span class="comment">// çœŸæ­£åˆ›å»ºNetworkTransportå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> newTCPTransport</span><br><span class="line"></span><br><span class="line">   ä¸‹é¢æ˜¯newTCPTransportçš„å®ç°ï¼Œæœ€åtransportCreatorå°±æ˜¯ç½‘ç»œå±‚çš„åˆ›å»ºå™¨</span><br><span class="line"></span><br><span class="line">   <span class="string">``</span><span class="string">`go</span></span><br><span class="line"><span class="string">   // â‘  è°ƒç”¨netåº“ç»‘å®štcpç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="string">   list, err := net.Listen(&quot;tcp&quot;, bindAddr)</span></span><br><span class="line"><span class="string">   // â‘¡ å°†TCPListener -&gt; TCPStreamLayer(ä¸Šé¢çš„ç±»å›¾ä¸­NetworkTransportéœ€è¦å®ç°StreamLayeræ¥å£)</span></span><br><span class="line"><span class="string">   stream := &amp;TCPStreamLayer&#123;</span></span><br><span class="line"><span class="string">   		advertise: advertise,</span></span><br><span class="line"><span class="string">   		listener:  list.(*net.TCPListener),</span></span><br><span class="line"><span class="string">   	&#125;</span></span><br><span class="line"><span class="string">   // â‘¢ å°†ä¸Šé¢çš„ TCPStreamLayer-&gt; NetworkTransportï¼Œè°ƒç”¨ NewNetworkTransportWithConfig</span></span><br><span class="line"><span class="string">   trans := transportCreator(stream)</span></span><br></pre></td></tr></table></figure></li>
<li><p>newNetworkTransport</p>
<p>ä¸‹é¢æ˜¯åˆ›å»ºç½‘ç»œå±‚çš„ä»£ç ï¼Œä¸€ä¸ªAcceptorä¸“é—¨ç”¨æ¥accetorè¿æ¥ï¼Œæ¯ä¸ªæ–°çš„è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªåç¨‹è¿›è¡Œå¤„ç†ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/T9BOV1"><img src="https://s4.ax1x.com/2021/12/16/T9BOV1.png" alt="T9BOV1.png"></a></p>
<ul>
<li><p>Mainçº¿ç¨‹è°ƒç”¨trans.listen()å¯åŠ¨ç›‘å¬åç¨‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// â‘  å°†ä¸Šé¢çš„configæ³¨å…¥è¿›æ¥ï¼Œä¸»è¦æ˜¯Stream</span></span><br><span class="line">trans := &amp;NetworkTransport&#123;</span><br><span class="line">		connPool:              <span class="built_in">make</span>(<span class="keyword">map</span>[ServerAddress][]*netConn),</span><br><span class="line">		consumeCh:             <span class="built_in">make</span>(<span class="keyword">chan</span> RPC),</span><br><span class="line">		logger:                config.Logger,</span><br><span class="line">		maxPool:               config.MaxPool,</span><br><span class="line">		shutdownCh:            <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">		stream:                config.Stream,</span><br><span class="line">		timeout:               config.Timeout,</span><br><span class="line">		TimeoutScale:          DefaultTimeoutScale,</span><br><span class="line">		serverAddressProvider: config.ServerAddressProvider,</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">// â‘¡ è®¾ç½®Streamä¸Šä¸‹æ–‡</span></span><br><span class="line">trans.setupStreamContext()</span><br><span class="line"><span class="comment">// â‘¢ å¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¸“é—¨æ¥å¤„ç†è¿æ¥</span></span><br><span class="line"><span class="keyword">go</span> trans.listen()</span><br></pre></td></tr></table></figure></li>
<li><p>Acceptorç›‘å¬æ–°è¿æ¥ï¼Œå¹¶å¯åŠ¨å¤„ç†åç¨‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">listen</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">// â‘  æ¥æ”¶æ–°è¿æ¥ï¼Œè¿™ä¸ªåº•å±‚æ˜¯epollå®ç°ï¼Œ</span></span><br><span class="line">		conn, err := n.stream.Accept()</span><br><span class="line">		<span class="comment">// â‘¡ å¯åŠ¨å¤„ç†åç¨‹</span></span><br><span class="line">		<span class="keyword">go</span> n.handleConn(n.getStreamContext(), conn)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>å¯¹è¿æ¥è¿›è¡Œå¤„ç†</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">handleConn</span><span class="params">(connCtx context.Context, conn net.Conn)</span></span> &#123;</span><br><span class="line">	r := bufio.NewReaderSize(conn, connReceiveBufferSize)</span><br><span class="line">	w := bufio.NewWriter(conn)</span><br><span class="line">	dec := codec.NewDecoder(r, &amp;codec.MsgpackHandle&#123;&#125;)</span><br><span class="line">	enc := codec.NewEncoder(w, &amp;codec.MsgpackHandle&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// â‘  è¯»æ•°æ® -- è§£ç  -- å¤„ç† -- ç¼–ç </span></span><br><span class="line">		<span class="keyword">if</span> err := n.handleCommand(r, dec, enc); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// â‘¡ è¿”å›</span></span><br><span class="line">		<span class="keyword">if</span> err := w.Flush(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handleCommandæ˜¯æ ¸å¿ƒçš„å¤„ç†é€»è¾‘ï¼Œè¿™é‡Œé€šè¿‡chanè®©ç”¨æˆ·ä½¿ç”¨çš„æ—¶å€™æ„Ÿè§‰æ˜¯åŒæ­¥çš„ã€‚</p>
<ol>
<li><p>è·å–ç±»å‹ReadByteï¼Œçº¦å®šç¬¬ä¸€ä½è¡¨ç¤ºçš„RPCç±»å‹ï¼Œeg:AppendEntries RequestVote</p>
</li>
<li><p>å®šä¹‰respChã€‚</p>
</li>
<li><p>å¯¹ä¸åŒç±»å‹çš„Requestè¿›è¡Œè§£ç ã€‚</p>
</li>
<li><p>å°†è§£ç å‡ºæ¥çš„RPCæ¶ˆæ¯æ”¾åˆ°æ¶ˆè´¹channelä¸­</p>
</li>
<li><p>ç­‰respChè¿”å›å¤„ç†åçš„ç»“æ„</p>
</li>
<li><p>å°†ç»“æ„è¿›è¡Œç¼–ç ã€‚</p>
<p>ä¸‹é¢æ˜¯å’Œåˆ«çš„åç¨‹è¿›è¡Œäº¤äº’çš„æ–¹å¼ï¼Œå®é™…ä¸Šå¤„ç†é€»è¾‘æ˜¯å¤–åŒ…å‡ºå»è¿›è¡Œå¤„ç†çš„ã€‚</p>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/T9R9Hg"><img src="https://s4.ax1x.com/2021/12/16/T9R9Hg.png" alt="T9R9Hg.png"></a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">handleCommand</span><span class="params">(r *bufio.Reader, dec *codec.Decoder, enc *codec.Encoder)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	getTypeStart := time.Now()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘  è·å–ç±»å‹ï¼Œçº¦å®šç¬¬ä¸€ä½è¡¨ç¤ºçš„RPCç±»å‹ï¼Œeg:AppendEntries RequestVote</span></span><br><span class="line">	rpcType, err := r.ReadByte()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// â‘¡ å®šä¹‰respCh</span></span><br><span class="line">	respCh := <span class="built_in">make</span>(<span class="keyword">chan</span> RPCResponse, <span class="number">1</span>)</span><br><span class="line">	rpc := RPC&#123;</span><br><span class="line">		RespChan: respCh,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// â‘¢ å¯¹ä¸åŒç±»å‹çš„Requestè¿›è¡Œè§£ç </span></span><br><span class="line">	<span class="keyword">switch</span> rpcType &#123;</span><br><span class="line">	<span class="keyword">case</span> rpcAppendEntries:</span><br><span class="line">		<span class="keyword">var</span> req AppendEntriesRequest</span><br><span class="line">		<span class="keyword">if</span> err := dec.Decode(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		rpc.Command = &amp;req</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> rpcRequestVote:</span><br><span class="line">		<span class="keyword">var</span> req RequestVoteRequest</span><br><span class="line">		<span class="keyword">if</span> err := dec.Decode(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		rpc.Command = &amp;req</span><br><span class="line">   ...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// â‘£ å°†è§£ç å‡ºæ¥çš„çŒåˆ°Raft.consumeCh</span></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> n.consumeCh &lt;- rpc:</span><br><span class="line">	...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// â‘¤ ç­‰ç»“æœï¼Œä¸Šé¢çš„consumeChè¢«Raftçš„runLeaderä¹‹ç±»çš„å…¶ä»–åç¨‹è¿›è¡Œå¤„ç†åï¼Œå°†ç»“æœå¡ä¼šåˆ°respChã€‚</span></span><br><span class="line">RESP:</span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> resp := &lt;-respCh:</span><br><span class="line">		<span class="comment">// â‘¥ å¯¹ç»“æœè¿›è¡Œç¼–ç </span></span><br><span class="line">		<span class="keyword">if</span> err := enc.Encode(resp.Response); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h5 id="AppendEntrieså®ç°åˆ†æ"><a href="#AppendEntrieså®ç°åˆ†æ" class="headerlink" title="AppendEntrieså®ç°åˆ†æ"></a>AppendEntrieså®ç°åˆ†æ</h5><p>ä¸Šé¢çš„ä¼ è¾“å±‚å·²ç»åˆ›å»ºå¥½äº†è¿æ¥çš„å¤„ç†å™¨(æ¶ˆè´¹è€…)ï¼Œç°åœ¨éœ€è¦æ¶ˆæ¯çš„ç”Ÿäº§è€…ï¼ŒAppendEntrieså°±èƒ½å……å½“è¿™ä¸€è§’è‰²ã€‚</p>
<p>éœ€è¦ç½‘ç»œäº¤äº’çš„RequestVoteã€AppendEntriesã€TimeoutNowéƒ½æ˜¯è°ƒç”¨çš„genericRPCå®ç°çš„ï¼ŒgenericRPCæ˜¯çœŸæ­£æ‰§è¡Œè¯·æ±‚çš„å‡½æ•°ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/ovxupF"><img src="https://s4.ax1x.com/2021/12/14/ovxupF.png" alt="ovxupF.png"></a></p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªgenericRPCçš„æµç¨‹ï¼š</p>
<p>â‘  ä»è¿æ¥æ± è·å–è¿æ¥å¯¹è±¡ï¼Œç®€å•çš„ç»´æŠ¤äº†ä¸€ä¸ªè¿æ¥æ± ã€‚</p>
<p>â‘¡ åœ¨è¿æ¥ä¸Šå‘é€RPCè¯·æ±‚ã€‚</p>
<p>â‘¢ è§£ç Responseï¼Œå°†connè¿”è¿˜è¿æ¥æ± å¦‚æœå¯ä»¥çš„è¯ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šè¿™é‡Œå‘é€è¯·æ±‚ä¹‹åï¼ŒåŒæ­¥è·å–Responseã€‚å¦‚æœæ˜¯çŸ­é“¾æ¥ï¼Œä¸ºäº†é«˜æ•ˆå°±ä¸ä¼šç›´æ¥åœ¨è¿™é‡Œç­‰ç»“æœäº†ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">genericRPC</span><span class="params">(id ServerID, target ServerAddress, rpcType <span class="keyword">uint8</span>, args <span class="keyword">interface</span>&#123;&#125;, resp <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// â‘  ä»è¿æ¥æ± ä¸­è·å–è¿æ¥ï¼ŒNetworkTransportç»´æŠ¤äº†ä¸€ä¸ªè¿æ¥æ± </span></span><br><span class="line">	conn, err := n.getConnFromAddressProvider(id, target)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// â‘¡ å‘é€RPCè¯·æ±‚</span></span><br><span class="line">	<span class="keyword">if</span> err = sendRPC(conn, rpcType, args); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// â‘¢ è§£ç Responseï¼Œå¹¶ä¸”å½’è¿˜è¿æ¥ã€‚æ³¨æ„ï¼šè¿™é‡Œå‘é€äº†è¯·æ±‚ä¹‹åï¼Œé©¬ä¸Šå°±è§£ç Responseäº†ã€‚æƒ³æƒ³æˆ‘ä»¬çš„mysqlå®¢æˆ·ç«¯ï¼Œ(å‘æ¶ˆæ¯,ç­‰ç»“æœï¼‰ï¼Œä¸å¯ä»¥ä¸€ç›´å‘æ¶ˆæ¯è€Œä¸æ¥æ”¶ã€‚</span></span><br><span class="line">	canReturn, err := decodeResponse(conn, resp)</span><br><span class="line">	<span class="keyword">if</span> canReturn &#123;</span><br><span class="line">		n.returnConn(conn)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯¹æ¯”çœ‹çœ‹InmemTransport.makeRPCæ–¹æ³•æ¥ä½“ä¼šå…¶ä¸­çš„ä¸åŒï¼Œè¿™è¾¹è·å–ç»“æœéœ€è¦ä»respChè¯»å–ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªResponseæ˜¯è°å¡è¿›å»respChçš„å‘¢ï¼Œæ¯•ç«Ÿæˆ‘ä»¬åªæ˜¯è·å–äº†ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *InmemTransport)</span> <span class="title">makeRPC</span><span class="params">(target ServerAddress, args <span class="keyword">interface</span>&#123;&#125;, r io.Reader, timeout time.Duration)</span> <span class="params">(rpcResp RPCResponse, err error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// å®šä¹‰äº¤äº’ç”¨çš„RPCå¯¹è±¡</span></span><br><span class="line">  req := RPC&#123;</span><br><span class="line">		Command:  args,</span><br><span class="line">		Reader:   r,</span><br><span class="line">		RespChan: respCh,</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// å‘é€æ¶ˆæ¯ï¼Œç›´æ¥å°†æ„é€ å‡ºæ¥çš„reqçŒåˆ°peer.consumerChæ¶ˆè´¹channelï¼Œæœ¬æ¥å°±æ˜¯å†…å­˜ä¸­çš„å¯¹è±¡ã€‚</span></span><br><span class="line">   <span class="keyword">select</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> peer.consumerCh &lt;- req:</span><br><span class="line">     ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ç­‰respChç»“æœï¼Œæ¶ˆè´¹åç¨‹æŠŠRPCæ‹¿å‡ºæ¥-å¤„ç†-ç»“æœå¡å›åˆ°respChã€‚</span></span><br><span class="line">   <span class="keyword">select</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> rpcResp = &lt;-respCh:</span><br><span class="line">      <span class="keyword">if</span> rpcResp.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">         err = rpcResp.Error</span><br><span class="line">      &#125;</span><br><span class="line">     .... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€è€ƒï¼š</p>
<p>1ã€ä¸Šé¢çš„å®ç°æ˜¯ä¸€æ¡ä¸€æ¡çš„å‘ï¼Œå®é™…ä¸Šä¸ºäº†é«˜æ•ˆï¼Œæˆ‘ä»¬å¾€å¾€éƒ½æ˜¯æ‰¹å¤„ç†çš„ã€‚</p>
<p>2ã€æƒ³RequestVoteè¦ç»™å¤šä¸ªå¯¹è±¡å‘æŠ•ç¥¨æ¶ˆæ¯ï¼Œé‚£ä¹ˆè‚¯å®šä¸ä¼šå‘ä¸€ä¸ªæ¶ˆæ¯ç­‰ä¸€ä¸ªç»“æœï¼Œè€Œæ˜¯ç¾¤å‘ï¼Œç„¶åå¤„ç†ç»“æ„ã€‚</p>
<h5 id="AppendEntriesPipelineå®ç°"><a href="#AppendEntriesPipelineå®ç°" class="headerlink" title="AppendEntriesPipelineå®ç°"></a>AppendEntriesPipelineå®ç°</h5><p>åŒæ ·çš„æˆ‘ä»¬ä»æµ‹è¯•ç”¨ä¾‹å¼€å§‹ï¼Œçœ‹çœ‹æ‰¹å¤„ç†æ˜¯æ€ä¹ˆç©çš„ã€‚ä¸»è¦çœ‹çœ‹æ‰¹å¤„ç†å’Œå•æ¡å¤„ç†çš„åŒºåˆ«ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–AppendEntriesPipelineå¯¹è±¡ï¼Œå¯åŠ¨åç¨‹å¤„ç† inprogressCh -&gt; doneCh</span></span><br><span class="line">pipeline, err := trans2.AppendEntriesPipeline(<span class="string">&quot;id1&quot;</span>, trans1.LocalAddr())</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘10ä¸ªæ¶ˆæ¯ï¼Œå¹¶ä¸”å°†RPCåŠ å…¥åˆ°inprogressCh</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">  out := <span class="built_in">new</span>(AppendEntriesResponse)</span><br><span class="line">  <span class="keyword">if</span> _, err := pipeline.AppendEntries(&amp;args, out); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    t.Fatalf(<span class="string">&quot;err: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Consumer()ä¼šè¿”å›doneChï¼Œä»doneChè·å–æ•°æ®ï¼Œå‘äº†10ä¸ªæ¶ˆæ¯ï¼Œæ‰€ä»¥éœ€è¦è·å–10æ¬¡ç»“æœ</span></span><br><span class="line">respCh := pipeline.Consumer()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ready := &lt;-respCh:</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯å‘æ¶ˆæ¯çš„æ—¶å€™  épipeline VS pipelineçš„åŒºåˆ«</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/TCM7Us"><img src="https://s4.ax1x.com/2021/12/16/TCM7Us.md.png" alt="TCM7Us.md.png"></a></p>
<p>ä¸‹é¢æ˜¯è§£ç æ¶ˆæ¯çš„æ—¶å€™  épipeline VS pipelineçš„åŒºåˆ«ï¼Œpipelineçš„decodeResponsesæ–¹æ³•æ˜¯åˆå§‹åŒ–AppendEntriesPipelineå¯¹è±¡çš„æ—¶å€™å°±å¯åŠ¨çš„åç¨‹ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/TClAFs"><img src="https://s4.ax1x.com/2021/12/16/TClAFs.md.png" alt="TClAFs.md.png"></a></p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªâ“ç–‘é—®å…³äºnet.Connçš„ A-&gt;B-&gt;Aï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨ç½‘ç»œä¸Šæ˜¯ä¸¤è¾¹å¯ä»¥åŒæ—¶å‘é€æ•°æ®å—ï¼Ÿä¸ºå•¥ä¸Šé¢çš„épipelineæ¨¡å¼ï¼Œsendä¹‹åé©¬ä¸Šå°±å¯ä»¥decodeæ¶ˆæ¯äº†ï¼Œconnè¿™é‡Œå¸®æˆ‘ä»¬åšäº†ä»€ä¹ˆã€‚</p>
<p>æ‰¹å¤„ç†çš„æ•´ä½“å®ç°å°±æ˜¯ï¼Œå¯åŠ¨ä¸€ä¸ªåç¨‹ç›‘æ§inprogressçš„ä»»åŠ¡ã€‚ç„¶åå¼€å‘æ‰¹é‡çš„å‘æ¶ˆæ¯ï¼Œæ¯”å¦‚ä¸€æ¬¡å‘10æ¡ï¼Œç„¶åinprogressåç¨‹è¢«æ¿€æ´»ï¼Œå¼€å§‹å¤„ç†ã€‚å°†å¤„ç†çš„ç»“æœæ”¾åˆ°doneChï¼Œæœ€åç”¨æˆ·ä»doneChè·å–æ¶ˆæ¯å³å¯ã€‚</p>
<h5 id="RequestVoteè¿‡ç¨‹"><a href="#RequestVoteè¿‡ç¨‹" class="headerlink" title="RequestVoteè¿‡ç¨‹"></a>RequestVoteè¿‡ç¨‹</h5><p>ä¸Šé¢æˆ‘ä»¬åˆ†æäº†ä¸€å¯¹ä¸€pipelineå‘æ¶ˆæ¯ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹1:Nï¼Œåœ¨é›†ç¾¤é‡Œé¢ç»™æ‰€æœ‰äººå‘æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ç»“æ„</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">electSelf</span><span class="params">()</span> &lt;-<span class="title">chan</span> *<span class="title">voteResult</span></span> &#123;</span><br><span class="line">	<span class="comment">// â‘  åˆ›å»ºä¸€ä¸ªåŒ…å«peersæ•°é‡çš„respCh</span></span><br><span class="line">	respCh := <span class="built_in">make</span>(<span class="keyword">chan</span> *voteResult, <span class="built_in">len</span>(r.configurations.latest.Servers))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// â‘¡ å¹¶å‘å‘æ¶ˆæ¯ï¼Œç„¶åå°†ç»“æœçŒå›åˆ°respChã€‚åé¢ä»respChè·å–æŠ•ç¥¨ç»“æœå³å¯è¿›è¡Œå¤„ç†ã€‚</span></span><br><span class="line">	askPeer := <span class="function"><span class="keyword">func</span><span class="params">(peer Server)</span></span> &#123;</span><br><span class="line">		r.goFunc(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			resp := &amp;voteResult&#123;voterID: peer.ID&#125;</span><br><span class="line">			err := r.trans.RequestVote(peer.ID, peer.Address, req, &amp;resp.RequestVoteResponse)</span><br><span class="line">			... </span><br><span class="line">			respCh &lt;- resp</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> respCh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ€»ç»“ğŸ¤”"><a href="#æ€»ç»“ğŸ¤”" class="headerlink" title="æ€»ç»“ğŸ¤”"></a>æ€»ç»“ğŸ¤”</h4><p>ç½‘ç»œæ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„æ¨¡å—ï¼Œåç»­å¯ä»¥çœ‹çœ‹æ¯”è¾ƒç»å…¸çš„Redisã€Nginxè¿™äº›ä¼˜ç§€ç»„ä»¶çš„å®ç°ã€‚</p>
<p>ProxySQLï¼šæƒŠç¾¤æ•ˆåº”æ€è€ƒ</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/raft/" rel="tag"># raft</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-1-%E5%AF%BC%E8%AF%BB/" rel="prev" title="hashicorp:raftæºç ç³»åˆ—(1)--å¯¼è¯»">
      <i class="fa fa-chevron-left"></i> hashicorp:raftæºç ç³»åˆ—(1)--å¯¼è¯»
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-3-%E5%AD%98%E5%82%A8%E5%B1%82/" rel="next" title="hashicorp:raftæºç ç³»åˆ—(3)--å­˜å‚¨å±‚">
      hashicorp:raftæºç ç³»åˆ—(3)--å­˜å‚¨å±‚ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">æ¦‚è¿°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%A0%E8%BE%93%E5%B1%82%E6%B6%89%E5%8F%8A%E5%93%AA%E4%BA%9B%E6%96%87%E4%BB%B6"><span class="nav-number">2.</span> <span class="nav-text">ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%A0%E8%BE%93%E5%B1%82%E5%85%B7%E4%BD%93%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%91%A2%EF%BC%9F"><span class="nav-number">3.</span> <span class="nav-text">ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8E%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8BTestNetworkTransport-AppendEntries%E5%BC%80%E5%A7%8B"><span class="nav-number">3.1.</span> <span class="nav-text">ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport_AppendEntrieså¼€å§‹</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#makeTransport%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90"><span class="nav-number">3.2.</span> <span class="nav-text">makeTransportå®ç°åˆ†æ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AppendEntries%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90"><span class="nav-number">3.3.</span> <span class="nav-text">AppendEntrieså®ç°åˆ†æ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AppendEntriesPipeline%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.4.</span> <span class="nav-text">AppendEntriesPipelineå®ç°</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RequestVote%E8%BF%87%E7%A8%8B"><span class="nav-number">3.5.</span> <span class="nav-text">RequestVoteè¿‡ç¨‹</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%F0%9F%A4%94"><span class="nav-number">4.</span> <span class="nav-text">æ€»ç»“ğŸ¤”</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Moonshine</p>
  <div class="site-description" itemprop="description">é¢¨ãŒå¹ã„ã¦è‘‰ãŒè½ã¡ã€è½ã¡è‘‰ã¯åœŸå£Œã®è‚¥ã‚„ã—ã¨ãªã‚ŠåœŸå£Œã‚’è‚¥ãˆã•ã›ã€æœç‰©ãŒã‚†ã£ãã‚Šã¨ç€å®Ÿã«è‚²ã¤ã®ã§ã™</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Moonshine</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
