<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Moonshine&#39;s Blog</title>
  
  <subtitle>æ—¥æ‹±ä¸€å’æ— æœ‰å°½ï¼ŒåŠŸä¸å”æç»ˆå…¥æµ·</subtitle>
  <link href="https://zhangtinglu.github.io/atom.xml" rel="self"/>
  
  <link href="https://zhangtinglu.github.io/"/>
  <updated>2022-01-21T10:29:14.457Z</updated>
  <id>https://zhangtinglu.github.io/</id>
  
  <author>
    <name>Moonshine</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>go-åŒ…ç®¡ç†</title>
    <link href="https://zhangtinglu.github.io/2022/01/21/go-%E5%8C%85%E7%AE%A1%E7%90%86/"/>
    <id>https://zhangtinglu.github.io/2022/01/21/go-%E5%8C%85%E7%AE%A1%E7%90%86/</id>
    <published>2022-01-21T03:09:08.214Z</published>
    <updated>2022-01-21T10:29:14.457Z</updated>
    
    <content type="html"><![CDATA[<h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>æ¯æ¬¡æ‰“å¼€IDEï¼Œéƒ½å˜çº¢ã€‚å¦‚æœè¶…è¿‡3æ¬¡ï¼Œæˆ‘æƒ³ç€æ˜¯ä¸æ˜¯åº”è¯¥å°†äº‹å®å¼„æ˜ç™½å‘¢ã€‚</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220121111115117.png" alt="image-20220121111115117" style="zoom:100%;float:left" /><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><h5 id="1ã€ä¸ºå•¥ä¼šæŠ¥é”™ï¼Ÿ"><a href="#1ã€ä¸ºå•¥ä¼šæŠ¥é”™ï¼Ÿ" class="headerlink" title="1ã€ä¸ºå•¥ä¼šæŠ¥é”™ï¼Ÿ"></a>1ã€ä¸ºå•¥ä¼šæŠ¥é”™ï¼Ÿ</h5><blockquote><p>è‚¯å®šæ˜¯æ‰¾ä¸åˆ°å¯¹åº”çš„pkg</p></blockquote><h5 id="2ã€é‚£IDEåˆ°åº•æ˜¯å»å“ªé‡Œæ‰¾äº†å‘¢ï¼Ÿ"><a href="#2ã€é‚£IDEåˆ°åº•æ˜¯å»å“ªé‡Œæ‰¾äº†å‘¢ï¼Ÿ" class="headerlink" title="2ã€é‚£IDEåˆ°åº•æ˜¯å»å“ªé‡Œæ‰¾äº†å‘¢ï¼Ÿ"></a>2ã€é‚£IDEåˆ°åº•æ˜¯å»å“ªé‡Œæ‰¾äº†å‘¢ï¼Ÿ</h5><blockquote><p>ç†è®ºä¸Šæ˜¯gopathè·¯å¾„ä¸‹é¢ï¼ŒğŸ‘‡ğŸ»GOPATH=â€/root/gopathâ€ è¿™é‡Œï¼ŒIDEé‡Œé¢å¯ä»¥è®¾ç½®çš„é¡¹ç›®æ›´å¤š</p></blockquote><p>go envçš„è¾“å‡º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GO111MODULE=&quot;on&quot; </span><br><span class="line">GOPATH=&quot;/root/gopath&quot;</span><br><span class="line">GOPROXY=&quot;https://goproxy.cn,direct&quot;  # è®¾ç½®ä»£ç†ï¼Œgo getçš„æ—¶å€™å¿«ç‚¹</span><br><span class="line">GOROOT=&quot;/usr/local/go&quot;  # goäºŒè¿›åˆ¶åŒ…çš„å®‰è£…åœ°å€</span><br><span class="line">GOVERSION=&quot;go1.17&quot;  # goç‰ˆæœ¬</span><br></pre></td></tr></table></figure><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220121181545764.png" alt="image-20220121181545764" style="zoom:100%;float:left" /><h5 id="3ã€å®é™…ä¸ŠGOPATHä¸‹é¢æ˜¯æœ‰éœ€è¦çš„pkgçš„"><a href="#3ã€å®é™…ä¸ŠGOPATHä¸‹é¢æ˜¯æœ‰éœ€è¦çš„pkgçš„" class="headerlink" title="3ã€å®é™…ä¸ŠGOPATHä¸‹é¢æ˜¯æœ‰éœ€è¦çš„pkgçš„"></a>3ã€å®é™…ä¸ŠGOPATHä¸‹é¢æ˜¯æœ‰éœ€è¦çš„pkgçš„</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> éœ€è¦çš„åŒ…</span></span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> % ll /Users/linmi/go/pkg/mod/github.com/prometheus</span></span><br><span class="line">total 0</span><br><span class="line">dr-xr-xr-x   23 linmi  staff   736B  1 21 12:01 client_golang@v1.12.0</span><br><span class="line">dr-xr-xr-x   13 linmi  staff   416B  1 21 12:01 client_model@v0.2.0</span><br><span class="line">dr-xr-xr-x   24 linmi  staff   768B  1 21 12:01 common@v0.32.1</span><br><span class="line">dr-xr-xr-x  122 linmi  staff   3.8K  1 21 12:01 procfs@v0.7.3</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IDEæŠ¥é”™çš„è·¯å¾„</span></span><br><span class="line">/Users/linmi/go/pkg/mod/src/github.com/prometheus/client_golang/prometheus/promhttp (from $GOPATH)</span><br></pre></td></tr></table></figure><p>ğŸ“¢ï¼šIDEæŠ¥é”™çš„è·¯å¾„é‡Œé¢å¤šäº†ä¸€å±‚<code>src</code>ç›®å½•ï¼Œè¿™å°±æœ‰ç‚¹å‡ºä¹æ„æ–™äº†ã€‚</p><h5 id="4ã€æœ€ä½³å®è·µ"><a href="#4ã€æœ€ä½³å®è·µ" class="headerlink" title="4ã€æœ€ä½³å®è·µ"></a>4ã€æœ€ä½³å®è·µ</h5><p>gopathå’Œgo modæ˜¯äº’æ–¥çš„ï¼Œç°åœ¨çš„è¯è‚¯å®šæ˜¯go modäº†ã€‚æœ€ç®€å•&amp;æœ‰æ•ˆçš„æ–¹æ³•ï¼Œç±»ä¼¼pythoné‚£æ ·ï¼Œå„ä¸ªé¡¹ç›®è‡ªå·±ç®¡ç†è‡ªå·±çš„åŒ…ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go mod vendor # åˆ›å»ºvendorä¾èµ–</span><br><span class="line">go mod tidy </span><br></pre></td></tr></table></figure><p>IDEæ‰“å¼€go modulesçš„é€‰é¡¹ï¼Œé—®é¢˜è‡ªç„¶å°±è§£å†³äº†</p><h5 id="5ã€Macä¸Šgoå¤šç‰ˆæœ¬æ€ä¹ˆç®¡ç†"><a href="#5ã€Macä¸Šgoå¤šç‰ˆæœ¬æ€ä¹ˆç®¡ç†" class="headerlink" title="5ã€Macä¸Šgoå¤šç‰ˆæœ¬æ€ä¹ˆç®¡ç†"></a>5ã€Macä¸Šgoå¤šç‰ˆæœ¬æ€ä¹ˆç®¡ç†</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…ˆç¡®è®¤æ˜¯ä¸æ˜¯brewç®¡ç†</span></span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> % <span class="built_in">which</span> go</span></span><br><span class="line">/usr/local/bin/go</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> % ll -h /usr/<span class="built_in">local</span>/bin/go</span></span><br><span class="line">lrwxr-xr-x  1 linmi  admin    26B 10 12 23:34 /usr/local/bin/go -&gt; ../Cellar/go/1.17.2/bin/go # Cellarè¿™é‡Œå°±èƒ½è¯´æ˜æ˜¯çš„</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¥ç€çœ‹çœ‹æœ‰å“ªäº›ç‰ˆæœ¬ï¼Œæˆ‘çš„æœ¬æœºæœ‰3ä¸ªç‰ˆæœ¬</span></span><br><span class="line">ll /usr/local/opt | grep go  # opt=optionsæŸ¥çœ‹å¯é€‰æ‹©çš„ç‰ˆæœ¬</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    19B 10 12 23:34 go -&gt; ../Cellar/go/1.17.2</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    25B 10 13 10:54 go@1.15 -&gt; ../Cellar/go@1.15/1.15.15</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    24B  9 23 11:27 go@1.16 -&gt; ../Cellar/go@1.16/1.16.8</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    19B 10 12 23:34 go@1.17 -&gt; ../Cellar/go/1.17.2</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    19B 10 12 23:34 golang -&gt; ../Cellar/go/1.17.2</span><br><span class="line">lrwxr-xr-x  1 linmi  admin    19B 10 12 23:34 google-go -&gt; ../Cellar/go/1.17.2</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> é‚£è¦æ€ä¹ˆä½¿ç”¨brewå¿«æ·çš„è¿›è¡Œè®¾ç½®å‘¢</span></span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> % brew link go</span></span><br><span class="line">Warning: Already linked: /usr/local/Cellar/go/1.17.2</span><br><span class="line">To relink, run:</span><br><span class="line">  brew unlink go &amp;&amp; brew link go   # é‡æ–°å›åˆ°æœ€è¿‘çš„ç‰ˆæœ¬</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash">% brew link --overwrite go@1.16  <span class="comment"># çœ‹è¿™ä¸ªå°±çŸ¥é“æ˜¯é‡å†™äº†</span></span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h3&gt;&lt;p&gt;æ¯æ¬¡æ‰“å¼€IDEï¼Œéƒ½å˜çº¢ã€‚å¦‚æœè¶…è¿‡3æ¬¡ï¼Œæˆ‘æƒ³ç€æ˜¯ä¸æ˜¯åº”è¯¥å°†äº‹å®å¼„æ˜ç™½å‘¢ã€‚&lt;/p&gt;
&lt;img src=&quot;https://gitee.com/zh</summary>
      
    
    
    
    
    <category term="go" scheme="https://zhangtinglu.github.io/tags/go/"/>
    
    <category term="åŒ…ç®¡ç†" scheme="https://zhangtinglu.github.io/tags/%E5%8C%85%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>hexoæ–‡ç« è®¾ç½®è‰ç¨¿-æš‚ä¸å‘å¸ƒ-æ–‡ç« åˆ†ç±»</title>
    <link href="https://zhangtinglu.github.io/2022/01/12/hexo%E6%96%87%E7%AB%A0%E8%AE%BE%E7%BD%AE%E8%8D%89%E7%A8%BF-%E6%9A%82%E4%B8%8D%E5%8F%91%E5%B8%83-%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB/"/>
    <id>https://zhangtinglu.github.io/2022/01/12/hexo%E6%96%87%E7%AB%A0%E8%AE%BE%E7%BD%AE%E8%8D%89%E7%A8%BF-%E6%9A%82%E4%B8%8D%E5%8F%91%E5%B8%83-%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB/</id>
    <published>2022-01-12T02:19:57.000Z</published>
    <updated>2022-01-14T06:40:45.275Z</updated>
    
    <content type="html"><![CDATA[<h4 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h4><p>1ã€æ¯æ¬¡æ‰§è¡Œhexo d -géƒ½ä¼šå°†æ‰€æœ‰çš„æ‰€æœ‰æ–‡ç« pushä¸Šå»ï¼Œæœ‰çš„æ–‡ç« å…¶å®ä¸€ä¸ªæ˜¯æ²¡æœ‰å†™å®Œï¼Œä¸€ä¸ªæ˜¯æ•æ„Ÿä¿¡æ¯è¿˜éœ€è¦å¤„ç†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo new draft &lt;title&gt;  # source/_drafts</span><br><span class="line">hexo P &lt;filename&gt;       # source/_drafts  -&gt;  source/_post</span><br></pre></td></tr></table></figure><p>2ã€èƒ½ä¸èƒ½åˆ†ç±»ï¼Œå½“å‰æ‰€æœ‰çš„æ–‡ç« éƒ½åœ¨source/_postsä¸‹é¢(å¦‚ä¸‹å›¾)ï¼Œåé¢è¶Šæ¥è¶Šå¤šï¼ŒçœŸçš„ä¸å¥½ç®¡ç†ï¼Œä¹Ÿä¸å¥½æ‰¾</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220112102324526.png" alt="image-20220112102324526" style="zoom:50%;float:left" /><h4 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h4>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;éœ€æ±‚&quot;&gt;&lt;a href=&quot;#éœ€æ±‚&quot; class=&quot;headerlink&quot; title=&quot;éœ€æ±‚&quot;&gt;&lt;/a&gt;éœ€æ±‚&lt;/h4&gt;&lt;p&gt;1ã€æ¯æ¬¡æ‰§è¡Œhexo d -géƒ½ä¼šå°†æ‰€æœ‰çš„æ‰€æœ‰æ–‡ç« pushä¸Šå»ï¼Œæœ‰çš„æ–‡ç« å…¶å®ä¸€ä¸ªæ˜¯æ²¡æœ‰å†™å®Œï¼Œä¸€ä¸ªæ˜¯æ•æ„Ÿä¿¡æ¯è¿˜éœ€è¦å¤„ç†&lt;/p&gt;
&lt;figure</summary>
      
    
    
    
    
    <category term="hexo" scheme="https://zhangtinglu.github.io/tags/hexo/"/>
    
    <category term="blog" scheme="https://zhangtinglu.github.io/tags/blog/"/>
    
    <category term="è‰ç¨¿" scheme="https://zhangtinglu.github.io/tags/%E8%8D%89%E7%A8%BF/"/>
    
    <category term="æ–‡ç« åˆ†ç±»" scheme="https://zhangtinglu.github.io/tags/%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB/"/>
    
  </entry>
  
  <entry>
    <title>ä¹°ä¸€ä¸ª3å¹´è…¾è®¯äº‘æœåŠ¡-æ—¥å¸¸å¼€å‘ä½¿ç”¨</title>
    <link href="https://zhangtinglu.github.io/2022/01/11/%E4%B9%B0%E4%B8%80%E4%B8%AA3%E5%B9%B4%E8%85%BE%E8%AE%AF%E4%BA%91%E6%9C%8D%E5%8A%A1-%E6%97%A5%E5%B8%B8%E5%BC%80%E5%8F%91%E4%BD%BF%E7%94%A8/"/>
    <id>https://zhangtinglu.github.io/2022/01/11/%E4%B9%B0%E4%B8%80%E4%B8%AA3%E5%B9%B4%E8%85%BE%E8%AE%AF%E4%BA%91%E6%9C%8D%E5%8A%A1-%E6%97%A5%E5%B8%B8%E5%BC%80%E5%8F%91%E4%BD%BF%E7%94%A8/</id>
    <published>2022-01-11T06:37:33.000Z</published>
    <updated>2022-01-14T06:32:51.617Z</updated>
    
    <content type="html"><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>ä»Šå¤©åœ¨çœ‹å¤§ä½¬å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œå¤§ä½¬è¯´æˆ‘ä¸æƒ³åœ¨æœ¬åœ°å¼€å‘ï¼Œç¯å¢ƒé‡å¯éº»çƒ¦ï¼Œæˆ‘æƒ³ä¸‡åˆ†èµåŒã€‚æ¯æ¬¡æ¢ç”µè„‘éƒ½æ˜¯çƒ¦äººã€‚</p><p>ç„¶åæˆ‘å°±æ‰“å¼€äº†é˜¿é‡Œäº‘ï¼Œä¸€çœ‹å¥½è´µï¼Œæ¥ç€æ‰“å¼€äº†è…¾è®¯äº‘ï¼Œå—¯ï¼Œå¥½åƒä¾¿å®œç‚¹ã€‚æˆ‘æ‰¿è®¤æˆ‘å°±æ˜¯è¢«ä¸‹é¢çš„å¹¿å‘Šå¸å¼•çš„ã€‚ç„¶åæˆ‘å°±ç‚¹äº†ç«‹å³è´­ä¹°çš„æŒ‰é’®ğŸ˜‚</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111143908730.png" alt="image-20220111143908730" style="zoom:50%;float:left" /><p>æ¥ç€æˆ‘æƒ³1æ ¸2Gå®åœ¨æ˜¯æ°”è´¨ä¸ç¬¦ï¼Œå¤´è„‘ä¸€çƒ­2æ ¸4Gï¼Œä¸€çœ‹1å¹´è™½ç„¶ä¹Ÿå¾ˆé•¿ï¼Œ ä¸è¿‡3å¹´å¥½åƒæ›´ä¸ç”¨æ“å¿ƒï¼Œä¸»è¦æ˜¯æ€•è¢«å‚¬è´¦ã€‚</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111144433048.png" alt="image-20220111144433048" style="zoom:50%;float:left" /><p>å¥½ï¼Œæ¥ç€å°±æ˜¯æ‰“å¼€å¾®ä¿¡-ç»‘å®š+ä»˜é’±äº†,è®¢å•å°±å¥½äº†</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111144703537.png" alt="image-20220111144703537" style="zoom:50%;float:left" /><h4 id="sshç™»å½•è®¾ç½®"><a href="#sshç™»å½•è®¾ç½®" class="headerlink" title="sshç™»å½•è®¾ç½®"></a>sshç™»å½•è®¾ç½®</h4><p>è¯´å®è¯ï¼Œä¸è®ºæ˜¯é˜¿é‡Œäº‘è¿˜æ˜¯è…¾è®¯äº‘çš„webéƒ½å¼‚å¸¸çš„å¤æ‚ï¼Œå„ç§ç‚¹ç‚¹ç‚¹éƒ½æ˜¯äº§å“+äº§å“ï¼Œè´¦å•+è´¦å•ã€‚å°±æƒ³é—®åˆšä¹°çš„æœåŠ¡å™¨å»å“ªäº†ã€‚</p><p>ä¸æµªè´¹æ—¶é—´ï¼š<a href="https://console.cloud.tencent.com/lighthouse/instance/index">https://console.cloud.tencent.com/lighthouse/instance/index</a>  chromeä¿å­˜ğŸ”–å§ï¼Œæ‰¾èµ·æ¥è´¹åŠ²ã€‚</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111145804003.png" alt="image-20220111145804003" style="zoom:50%;float:left" /><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ç¼–è¾‘sshd_config,å¦‚ä¸‹</span></span></span><br><span class="line">sudo vi /etc/ssh/sshd_config</span><br><span class="line">[lighthouse@VM-24-14-centos ~]$ # vim /etc/ssh/sshd_config </span><br><span class="line">[lighthouse@VM-24-14-centos ~]$ # PermitRootLogin yes å»æ‰æ³¨é‡Š</span><br><span class="line">[lighthouse@VM-24-14-centos ~]$ # pubkeyAuthentication yes å»æ‰æ³¨é‡Š</span><br><span class="line">[lighthouse@VM-24-14-centos ~]$ # PasswordAuthentication yes å»æ‰æ³¨é‡Š</span><br><span class="line"><span class="meta">#</span><span class="bash"> é‡å¯sshdæœåŠ¡</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="æœ¬æœºé…ç½®sshå¹¶ç™»å½•"><a href="#æœ¬æœºé…ç½®sshå¹¶ç™»å½•" class="headerlink" title="æœ¬æœºé…ç½®sshå¹¶ç™»å½•"></a>æœ¬æœºé…ç½®sshå¹¶ç™»å½•</h4><p>æ‰¾åˆ°å…¬ç½‘ip</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111150006715.png" alt="image-20220111150006715" style="zoom:50%;float:left" /><p>å°†æœ¬æœºçš„å…¬é’¥é€šè¿‡ssh-copy-idæ‹·è´åˆ°remote host</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id root@ip</span><br><span class="line">ssh root@ip  # ç›´æ¥ç™»å½•</span><br></pre></td></tr></table></figure><h4 id="é€šè¿‡vscodeç™»å½•å¹¶ä¸”code"><a href="#é€šè¿‡vscodeç™»å½•å¹¶ä¸”code" class="headerlink" title="é€šè¿‡vscodeç™»å½•å¹¶ä¸”code"></a>é€šè¿‡vscodeç™»å½•å¹¶ä¸”code</h4><h5 id="å…ˆå®‰è£…remote-sshæ’ä»¶"><a href="#å…ˆå®‰è£…remote-sshæ’ä»¶" class="headerlink" title="å…ˆå®‰è£…remote sshæ’ä»¶"></a>å…ˆå®‰è£…remote sshæ’ä»¶</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111150257939.png" alt="image-20220111150257939" style="zoom:50%;float:left" /><h5 id="è¾“å…¥ssh-root-ipå¹¶é€‰æ‹©ssh-configï¼ŒåŸè°…è‰²å‡ºç°æå®Œï¼Œæ¥ç€å°±æ˜¯æ„‰å¿«çš„coding"><a href="#è¾“å…¥ssh-root-ipå¹¶é€‰æ‹©ssh-configï¼ŒåŸè°…è‰²å‡ºç°æå®Œï¼Œæ¥ç€å°±æ˜¯æ„‰å¿«çš„coding" class="headerlink" title="è¾“å…¥ssh root@ipå¹¶é€‰æ‹©ssh configï¼ŒåŸè°…è‰²å‡ºç°æå®Œï¼Œæ¥ç€å°±æ˜¯æ„‰å¿«çš„coding"></a>è¾“å…¥ssh root@ipå¹¶é€‰æ‹©ssh configï¼ŒåŸè°…è‰²å‡ºç°æå®Œï¼Œæ¥ç€å°±æ˜¯æ„‰å¿«çš„coding</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111150401476.png" alt="image-20220111150401476" style="zoom:50%;float:left" /><h5 id="æ‰“å¼€è¿œç«¯çš„æ–‡ä»¶"><a href="#æ‰“å¼€è¿œç«¯çš„æ–‡ä»¶" class="headerlink" title="æ‰“å¼€è¿œç«¯çš„æ–‡ä»¶"></a>æ‰“å¼€è¿œç«¯çš„æ–‡ä»¶</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111151140566.png" alt="image-20220111151140566" style="zoom:50%;float:left" /><h5 id="åˆ é™¤ä¸‹remote-hostï¼Œæ¯”å¦‚ipå†™é”™äº†ä¹‹ç±»ï¼Œç¼–è¾‘-ssh-configæ–‡ä»¶æ‰è¡Œ"><a href="#åˆ é™¤ä¸‹remote-hostï¼Œæ¯”å¦‚ipå†™é”™äº†ä¹‹ç±»ï¼Œç¼–è¾‘-ssh-configæ–‡ä»¶æ‰è¡Œ" class="headerlink" title="åˆ é™¤ä¸‹remote hostï¼Œæ¯”å¦‚ipå†™é”™äº†ä¹‹ç±»ï¼Œç¼–è¾‘~/.ssh/configæ–‡ä»¶æ‰è¡Œ"></a>åˆ é™¤ä¸‹remote hostï¼Œæ¯”å¦‚ipå†™é”™äº†ä¹‹ç±»ï¼Œç¼–è¾‘~/.ssh/configæ–‡ä»¶æ‰è¡Œ</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111151753449.png" alt="image-20220111151753449" style="zoom:50%;float:left" /><h5 id="è‡ªå·±å®‰è£…éœ€è¦çš„æ’ä»¶ï¼Œæ³¨æ„æœ¬åœ°å’Œè¿œç¨‹æ˜¯ä¸ä¸€æ ·çš„"><a href="#è‡ªå·±å®‰è£…éœ€è¦çš„æ’ä»¶ï¼Œæ³¨æ„æœ¬åœ°å’Œè¿œç¨‹æ˜¯ä¸ä¸€æ ·çš„" class="headerlink" title="è‡ªå·±å®‰è£…éœ€è¦çš„æ’ä»¶ï¼Œæ³¨æ„æœ¬åœ°å’Œè¿œç¨‹æ˜¯ä¸ä¸€æ ·çš„"></a>è‡ªå·±å®‰è£…éœ€è¦çš„æ’ä»¶ï¼Œæ³¨æ„æœ¬åœ°å’Œè¿œç¨‹æ˜¯ä¸ä¸€æ ·çš„</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111152351292.png" alt="image-20220111152351292" style="zoom:50%;float:left" /><h5 id="åœ¨centos7ä¸Šå®‰è£…goï¼Œè®¾ç½®go-env"><a href="#åœ¨centos7ä¸Šå®‰è£…goï¼Œè®¾ç½®go-env" class="headerlink" title="åœ¨centos7ä¸Šå®‰è£…goï¼Œè®¾ç½®go env"></a>åœ¨centos7ä¸Šå®‰è£…goï¼Œè®¾ç½®go env</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">yum update -y</span><br><span class="line">yum install -y go # å®‰è£…çš„æ˜¯1.15</span><br><span class="line">go env -w GOPROXY=https://goproxy.cn,direct</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="ä¸ºå•¥è¿™ä¸ªå¯¼å…¥ä¼šæŠ¥é”™å‘¢ï¼Ÿ-å—¯ï¼Œå¤§æ¦‚ç‡å°±æ˜¯ç¯å¢ƒçš„é—®é¢˜ï¼Œç”¨ä¸ªgo-mod-initè§£å†³å°±è¡Œ"><a href="#ä¸ºå•¥è¿™ä¸ªå¯¼å…¥ä¼šæŠ¥é”™å‘¢ï¼Ÿ-å—¯ï¼Œå¤§æ¦‚ç‡å°±æ˜¯ç¯å¢ƒçš„é—®é¢˜ï¼Œç”¨ä¸ªgo-mod-initè§£å†³å°±è¡Œ" class="headerlink" title="ä¸ºå•¥è¿™ä¸ªå¯¼å…¥ä¼šæŠ¥é”™å‘¢ï¼Ÿ å—¯ï¼Œå¤§æ¦‚ç‡å°±æ˜¯ç¯å¢ƒçš„é—®é¢˜ï¼Œç”¨ä¸ªgo mod initè§£å†³å°±è¡Œ"></a>ä¸ºå•¥è¿™ä¸ªå¯¼å…¥ä¼šæŠ¥é”™å‘¢ï¼Ÿ å—¯ï¼Œå¤§æ¦‚ç‡å°±æ˜¯ç¯å¢ƒçš„é—®é¢˜ï¼Œç”¨ä¸ªgo mod initè§£å†³å°±è¡Œ</h5><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220111161358986.png" alt="image-20220111161358986" style="zoom:50%;float:left" /><p>2021-01-11ä»Šå¤©å…ˆåˆ°è¿™ï¼Œç­‰ä¼šé¢æœ‰æ–°çš„æƒ³æ³•äº†åœ¨æ›´æ–°</p><p>2021-01-14å·ï¼Œæ¥ç€ä¸Šé¢ï¼Œè¢«æ”»å‡»äº†</p><h3 id="èƒŒæ™¯-1"><a href="#èƒŒæ™¯-1" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>æˆ‘çš„è…¾è®¯äº‘çš„è½»é‡æœåŠ¡å™¨ï¼Œçªç„¶ç»™æˆ‘å‘æ¶ˆæ¯è¯´æˆ‘æœ‰è¿è§„è¡Œä¸ºï¼Œæˆ‘å°±å¼€äº†22ç«¯å£åšäº†ä¸€ä¸ªè¿œç¨‹ç™»å½•ğŸ˜‚</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220114115516893.png" alt="image-20220114115516893" style="zoom:50%;float:left" /><h3 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h3><p>1ã€æˆ‘å…ˆç­‰äº†ä¸€å¤©ï¼Œé€šçŸ¥çš„24hæ¥è§¦å°ç¦</p><p>2ã€ç»“æœè¿˜æ˜¯ä¸èƒ½ç™»å½•</p><p>3ã€å®¢æœè¯´å¾—ç”¨VNCç™»å½•ï¼Œ<a href="https://cloud.tencent.com/document/product/1207/46824">https://cloud.tencent.com/document/product/1207/46824</a> ï¼Œ å°±æ˜¯ä¸‹é¢çš„è¿™ä¸ªæŒ‰é’®</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220114115847427.png" alt="image-20220114115847427" style="zoom:50%;float:left" /><p>4ã€æˆ‘å‘ç°å¾—è¦ä¸ªå¯†ç ä¸æ˜¯ï¼Œå¯æ˜¯æ²¡æœ‰åˆå§‹å¯†ç ï¼Œè®°ä½ç¬¬ä¸€æ¬¡å¿…é¡»æ˜¯é‡ç½®å¯†ç ï¼Œåœ¨é¡µé¢ä¸Šctrl+fæœç´¢å¯†ç ,å°±æ˜¯ä¸‹é¢çš„&lt;é‡ç½®å¯†ç &gt;æŒ‰é’®ã€‚å®é™…ä¸Šæ“ä½œå°±æ˜¯ä¹‹å‰æˆ‘ä»¬åšçš„sudo passwd root  â€“ æ³¨æ„è¿™é‡Œå‰å¾€ä¸è¦å¼„çš„å¤ªç®€å•äº†ï¼ŒçœŸçš„å¾ˆå®¹æ˜“è¢«ç ´è§£ã€‚</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220114120029547.png" alt="image-20220114120029547" style="zoom:50%;float:left" /><p>5ã€å¥½äº†ä¸€æ¬¡æ¬¡é‡å¯ä¹‹åä½ å°±å¯ä»¥åœ¨&lt;é¡µé¢ä¸Š&gt;æ­£å¸¸ç™»å½•äº†ï¼Œæ¥ç€è‚¯å®šæ˜¯æœ¬æœºç™»å½•ï¼Œå‘ç°å°±å‡ºç°äº†ä¸‹é¢çš„ä¸œè¥¿ğŸ˜‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span><span class="bash"> % ssh root@ip</span></span><br><span class="line">root@ip: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).</span><br></pre></td></tr></table></figure><p>6ã€ä¸ºå•¥ä¸è¡Œäº†å‘¢ï¼Œ çœ‹æ–‡æ¡£è¯´æ˜¯è¦ä¹ˆä½¿ç”¨å¯†ç ï¼Œè¦ä¹ˆä½¿ç”¨ç§˜é’¥ï¼Œå®é™…ä¸Šæ˜¯éƒ½å¯ä»¥ç”¨ï¼Œä¸è¿‡å°±æ˜¯æˆæƒçš„æ–¹å¼ä¸åŒ</p><ul><li>ç®¡ç†å¯†é’¥  <a href="https://cloud.tencent.com/document/product/1207/44573">https://cloud.tencent.com/document/product/1207/44573</a></li></ul><p>å› ä¸ºä¹‹å‰æˆ‘ä»¬ç™»å½•è¿‡ï¼Œåœ¨~/.ssh/known_hostsè¿™é‡Œå·²ç»æœ‰ipè®°å½•äº†ï¼ŒæŠŠå¯¹åº”ipçš„è®°å½•å»æ‰å†è¯•ã€‚</p><p>7ã€è°ƒæ•´å¥½äº†ä¹‹åæˆ‘ä»¬æ¥ç€ssh root@ip, è¿™äº›æ›´å¥½äº†ï¼Œç›´æ¥ç»™æˆ‘é—ªé€€äº†ã€‚åŒæ—¶ï¼Œæˆ‘è¿˜å‘ç°äº†ä¸€ä¸ªæ–°é—®é¢˜ï¼Œæˆ‘ä¸èƒ½su rootäº†</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220114141342311.png" alt="image-20220114141342311" style="zoom:50%;float:left" /><p>8ã€çªç„¶ï¼Œæˆ‘çš„æœåŠ¡å™¨å’‹äº†ï¼Œè¢«æ”»å‡»äº†~ ç›²çŒœåº”è¯¥æ˜¯å°†æˆ‘çš„sshæœåŠ¡ç»™ç¯¡æ”¹äº†ã€‚å¯¼è‡´äº†æˆ‘sshè¿æ¥äº†å°±é—ªé€€ï¼Œè¿˜æœ‰æˆ‘ä¸èƒ½åˆ‡æ¢rootè´¦å·ã€‚</p><p>9ã€å¥½åœ¨æˆ‘æ²¡å•¥ä¸œè¥¿ï¼Œå…¶å®æˆ‘è§‰å¾—é‡æ–°å®‰è£…sshdå³å¯ï¼Œä½†æ˜¯ä¸ºäº†ä¿é™©èµ·è§ï¼Œæˆ‘è¿˜æ˜¯é‡æ–°å®‰è£…OSå§ã€‚</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20220114142036461.png" alt="image-20220114142036461" style="zoom:50%;float:left" /><p>å¥½å®¶ä¼™ï¼Œè¿™ä¸ªæ“ä½œè´¼å¿«ï¼Œè¿™ä¸ªæ‰€è°“çš„è½»é‡æœåŠ¡å™¨å®¹å™¨æ²¡è·‘äº†</p><p>10ã€ä¸ºå•¥ssh-copy-idä¸éœ€è¦å¯†ç ï¼Ÿå¯¹æ¯”æ‰‹åŠ¨å’Œssh-copy-idï¼Œå¤§æ¦‚æ˜¯ssh-copy-idæœ‰å›ºå®šç¨‹åºå§ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æ‰‹åŠ¨</span></span><br><span class="line">ssh root@ip # è¾“å…¥rootå¯†ç </span><br><span class="line">vim ~/.ssh/authorized_keys  # æ·»åŠ å…¬é’¥</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ssh-copy-id</span></span><br><span class="line">ssh-copy-id root@ip # ä¸éœ€è¦è¾“å…¥å¯†ç  -- ä¸ºå•¥ï¼Ÿ</span><br></pre></td></tr></table></figure><p>11ã€å…¬é’¥å’Œç§é’¥æ˜¯æ€ä¹ˆä¸€èµ·èµ·ä½œç”¨çš„?</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…ˆè¯´é—®é¢˜çš„æ¥æº</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æœ¬æœº -&gt; remote</span></span><br><span class="line">ssh-copy-id å°†æœ¬åœ°çš„å…¬é’¥copyåˆ° ~/.ssh/authorized_keys    ---&gt;  æœ¬åœ°å¯ä»¥ç™»å½•è¿œç«¯</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è…¾è®¯äº‘ æˆæƒè¿‡ç¨‹  ç§˜é’¥ç®¡ç†</span></span><br><span class="line">ç”Ÿæˆç§˜é’¥ä¸€å¯¹ï¼Œæœ¬åœ°ä¿å­˜ç§é’¥</span><br><span class="line">ä¸‹å‘å…¬é’¥åˆ°å®ä¾‹</span><br><span class="line">ssh -i ç§é’¥ root@ip </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®é™…ä¸Šä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæœ¬åœ°è¿æ¥çš„æ—¶å€™ä½¿ç”¨ç§é’¥å»åŒ¹é…remote ~/.ssh/authorized_keys é‡Œé¢çš„å…¬é’¥ã€‚</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç»å†ä¸€äº›é—®é¢˜å¯ä»¥æ›´å¿«çš„å»ç†è§£å¾ˆå¤šä¸œè¥¿çš„åŸç†</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h4&gt;&lt;p&gt;ä»Šå¤©åœ¨çœ‹å¤§ä½¬å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œå¤§ä½¬è¯´æˆ‘ä¸æƒ³åœ¨æœ¬åœ°å¼€å‘ï¼Œç¯å¢ƒé‡å¯éº»çƒ¦ï¼Œæˆ‘æƒ³ä¸‡åˆ†èµåŒã€‚æ¯æ¬¡æ¢ç”µè„‘éƒ½æ˜¯çƒ¦äººã€‚&lt;/p&gt;
&lt;p&gt;ç„¶åæˆ‘å°±æ‰“å¼€äº†é˜¿é‡Œäº‘ï¼Œä¸€</summary>
      
    
    
    
    
    <category term="è…¾è®¯äº‘" scheme="https://zhangtinglu.github.io/tags/%E8%85%BE%E8%AE%AF%E4%BA%91/"/>
    
    <category term="ECS" scheme="https://zhangtinglu.github.io/tags/ECS/"/>
    
  </entry>
  
  <entry>
    <title>æœ¬åœ°è°ƒè¯•proxysql</title>
    <link href="https://zhangtinglu.github.io/2021/12/29/%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95proxysql/"/>
    <id>https://zhangtinglu.github.io/2021/12/29/%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95proxysql/</id>
    <published>2021-12-29T04:02:32.000Z</published>
    <updated>2021-12-29T07:34:30.750Z</updated>
    
    <content type="html"><![CDATA[<h4 id="1-æ„å»ºé•œåƒ"><a href="#1-æ„å»ºé•œåƒ" class="headerlink" title="1. æ„å»ºé•œåƒ"></a>1. æ„å»ºé•œåƒ</h4><p>Dockerfile + æ„å»ºé•œåƒ</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> description=<span class="string">&quot;Container for dev &amp; debug&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y automake bzip2 cmake make gcc-c++ gcc git openssl openssl-devel gnutls gnutls-devel libtool patch openssh-server perl-IPC-Cmd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y gdb-gdbserver <span class="built_in">which</span> </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®sshæœåŠ¡</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&#x27;PermitRootLogin yes&#x27;</span> &gt;&gt; /etc/ssh/sshd_config &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">&#x27;PermitEmptyPasswords yes&#x27;</span> &gt;&gt; /etc/ssh/sshd_config &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">&#x27;PasswordAuthentication yes&#x27;</span> &gt;&gt; /etc/ssh/sshd_config &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">&#x27;root:root&#x27;</span> | chpasswd &amp;&amp; \</span></span><br><span class="line"><span class="bash">    ssh-keygen -A</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">22</span> </span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;/usr/sbin/sshd&quot;</span>, <span class="string">&quot;-D&quot;</span>]</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t proxysqldebug:v1 .</span><br></pre></td></tr></table></figure><h4 id="2-è¿è¡Œå®¹å™¨"><a href="#2-è¿è¡Œå®¹å™¨" class="headerlink" title="2. è¿è¡Œå®¹å™¨"></a>2. è¿è¡Œå®¹å™¨</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 2222:22 --security-opt seccomp:unconfined -v $PWD:/home/luzhangting001/proxysql --name proxysqldev proxysqldebug:v1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åé¢å®¹å™¨stop + start ä¸è¦åœ¨é‡å¯ï¼Œå¦‚ä¸‹å›¾</span></span><br></pre></td></tr></table></figure><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211229121528631.png" alt="image-20211229121528631" style="zoom:100%; float:left" /><h4 id="3-å¯åŠ¨debug"><a href="#3-å¯åŠ¨debug" class="headerlink" title="3. å¯åŠ¨debug"></a>3. å¯åŠ¨debug</h4><p>é…ç½®launch.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;configurations&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;(gdb) Launch&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;cppdbg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;/home/luzhangting001/proxysql/src/proxysql&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;--foreground&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--debug&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--config&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/home/luzhangting001/proxysql/src/proxysql.cfg&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--initial&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;stopAtEntry&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;/home/luzhangting001/proxysql&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;pipeTransport&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;debuggerPath&quot;</span>: <span class="string">&quot;/usr/bin/gdb&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pipeProgram&quot;</span>: <span class="string">&quot;/usr/bin/ssh&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pipeArgs&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;root@localhost&quot;</span>,</span><br><span class="line">                <span class="string">&quot;-p&quot;</span>,</span><br><span class="line">                <span class="string">&quot;2222&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;pipeCwd&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;environment&quot;</span>: [],</span><br><span class="line">        <span class="attr">&quot;externalConsole&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;MIMode&quot;</span>: <span class="string">&quot;gdb&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;sourceFileMap&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;/home/luzhangting001/proxysql&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æŠ¥é”™ï¼šå› ä¸ºä¹‹å‰å¼„è¿‡ï¼ŒsshæŠ¥é”™äº†</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211229121827990.png" alt="image-20211229121827990" style="zoom:100%; float:left" /><p>å°†known_hostsé‡Œé¢çš„ç›¸å…³ä¿¡æ¯åˆ é™¤, å…¶å®æˆ‘ä¸çŸ¥é“æ˜¯ä¸æ˜¯å¿…é¡»è¿™ä¹ˆåšï¼Œå¯èƒ½ä¸æ˜¯å¿…é¡»çš„</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211229122615654.png" alt="image-20211229122615654" style="zoom:100%; float:left" /><p>å°†æœ¬æœºçš„å…¬é’¥ä¸Šä¼ </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id -p 2222 root@localhost</span><br></pre></td></tr></table></figure><p>vscodeé‡Œé¢å¯åŠ¨</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211229153334425.png" alt="image-20211229153334425" style="zoom:80%;float:left" />]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;1-æ„å»ºé•œåƒ&quot;&gt;&lt;a href=&quot;#1-æ„å»ºé•œåƒ&quot; class=&quot;headerlink&quot; title=&quot;1. æ„å»ºé•œåƒ&quot;&gt;&lt;/a&gt;1. æ„å»ºé•œåƒ&lt;/h4&gt;&lt;p&gt;Dockerfile + æ„å»ºé•œåƒ&lt;/p&gt;
&lt;figure class=&quot;highlight docke</summary>
      
    
    
    
    
    <category term="proxysql" scheme="https://zhangtinglu.github.io/tags/proxysql/"/>
    
    <category term="macæœ¬åœ°ç¯å¢ƒ" scheme="https://zhangtinglu.github.io/tags/mac%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83/"/>
    
  </entry>
  
  <entry>
    <title>Typoraå†™blogä¸­ç²˜è´´å›¾ç‰‡è‡ªåŠ¨ä¸Šä¼ å›¾åºŠ</title>
    <link href="https://zhangtinglu.github.io/2021/12/24/blog%E5%9B%BE%E5%BA%8A%E7%AF%87/"/>
    <id>https://zhangtinglu.github.io/2021/12/24/blog%E5%9B%BE%E5%BA%8A%E7%AF%87/</id>
    <published>2021-12-24T10:31:20.000Z</published>
    <updated>2021-12-25T01:04:46.710Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Goal"><a href="#Goal" class="headerlink" title="Goal"></a>Goal</h4><p>æˆ‘ç”µè„‘ä¸Š cmd + trl + a(å¾®ä¿¡æˆªå›¾) -&gt; æ¥åˆ°Typora(cmd + v) ç²˜è´´ã€‚</p><p>ç„¶åå°±è‡ªåŠ¨å¸®æˆ‘ä¸Šä¼ å›¾åºŠï¼Œå¹¶ä¸”æ›¿æ¢æˆå›¾åºŠç…§ç‰‡å§ï¼Œè¿™æ ·æˆ‘ä¹Ÿä¸éœ€è¦åˆ‡æ¢åˆ°å›¾åºŠä¸Šå»æ£é¼“äº†ï¼Œå°±ä¸“æ³¨åœ¨Typoraä¸Šå»æ‰“å­—ã€‚</p><h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><p>å›¾åºŠï¼š<a href="https://blog.svend.cc/upic/tutorials/github/">github</a>ã€<a href="https://blog.svend.cc/upic/tutorials/gitee/">gitee</a>ï¼Œæˆ‘è‡ªå·±æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯è·¯è¿‡å›¾åºŠï¼Œä½†æ˜¯uPicä¸ä¼šé…ç½®ï¼Œé‚£å°±ç®—å•¦ï¼Œä½›ç³»æ‰¾ä¸ªèƒ½æˆåŠŸçš„ã€‚</p><blockquote><p>é‡‡å‘ï¼šgithubå›¾ç‰‡å¯ä»¥æ­£å¸¸ä¸Šä¼ ï¼Œä½†æ˜¯å±•ç¤ºå‡ºæ¥</p></blockquote><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211225084632762.png" alt="image-20211225084632762" style="zoom:30%;float:left" /><p>å› æ­¤ï¼Œæˆ‘ä»¬è¿˜å¥½æŠ˜è…¾Giteeé…ç½®ã€‚</p><ol><li><p>åˆ›å»ºä»“åº“</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211225085435762.png" alt="image-20211225085435762" style="zoom:25%;float:left" /><ol start="2"><li>ç”Ÿæˆç§äººä»¤ç‰Œ</li></ol><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211225083650340.png" alt="image-20211225083650340" style="zoom:25%;float:left" /><ol start="3"><li><p>é…ç½®uPic</p><p>uPicç›´æ¥githubä¸Šä¸‹è½½äº†å®‰è£…å¥½ï¼Œç„¶åæŒ‰ç…§ä¸‹é¢çš„æ–¹æ³•é…ç½®</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211225090108133.png" alt="image-20211225090108133" style="zoom:25%;float:left" /></li><li><p>é…ç½®Typora</p><p>cmd+,æ‰“å¼€è½¯ä»¶åå¥½è®¾ç½®,æˆåŠŸäº†ä¹‹åå°±åœ¨å†™blogçš„æ—¶å€™ç›´æ¥æˆªå›¾+ç²˜è´´å§ï¼Œå·´æ–¯çš„å¾ˆ~</p><img src="https://gitee.com/zhangtinglu/blog_pic/raw/master/uPic/image-20211225090323825.png" alt="image-20211225090323825" style="zoom:25%;float:left" /></li></ol></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;Goal&quot;&gt;&lt;a href=&quot;#Goal&quot; class=&quot;headerlink&quot; title=&quot;Goal&quot;&gt;&lt;/a&gt;Goal&lt;/h4&gt;&lt;p&gt;æˆ‘ç”µè„‘ä¸Š cmd + trl + a(å¾®ä¿¡æˆªå›¾) -&amp;gt; æ¥åˆ°Typora(cmd + v) ç²˜è´´ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶å</summary>
      
    
    
    
    
    <category term="Typora" scheme="https://zhangtinglu.github.io/tags/Typora/"/>
    
    <category term="å›¾ç‰‡ç²˜è´´" scheme="https://zhangtinglu.github.io/tags/%E5%9B%BE%E7%89%87%E7%B2%98%E8%B4%B4/"/>
    
    <category term="ä¸Šä¼ å›¾åºŠ" scheme="https://zhangtinglu.github.io/tags/%E4%B8%8A%E4%BC%A0%E5%9B%BE%E5%BA%8A/"/>
    
  </entry>
  
  <entry>
    <title>hashicorp-raftæºç ç³»åˆ—-4-leaderé€»è¾‘</title>
    <link href="https://zhangtinglu.github.io/2021/12/20/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-4-leader%E9%80%BB%E8%BE%91/"/>
    <id>https://zhangtinglu.github.io/2021/12/20/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-4-leader%E9%80%BB%E8%BE%91/</id>
    <published>2021-12-20T07:09:54.000Z</published>
    <updated>2021-12-20T10:55:00.442Z</updated>
    
    <content type="html"><![CDATA[<p>å‰é¢ä¸‰ç¯‡æˆ‘ä»¬åˆ†åˆ«ä»‹ç»äº†Raftçš„APIã€ç½‘ç»œå±‚ã€å­˜å‚¨å±‚ï¼Œä»è¿™ä¸€ç¯‡å¼€å§‹æˆ‘ä»¬æ¥çœ‹Raftçš„<code>Leaderã€Candidateã€Follower</code>å®ç°ã€‚</p><h4 id="r-runLeaderé€»è¾‘"><a href="#r-runLeaderé€»è¾‘" class="headerlink" title="r.runLeaderé€»è¾‘"></a>r.runLeaderé€»è¾‘</h4><p>äº‹åŠ¡æäº¤çš„è¿‡ç¨‹ï¼šæ¥ç€æˆ‘ä»¬ä¸€ç‚¹ç‚¹åˆ†æï¼Œ</p><h5 id="å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•"><a href="#å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•" class="headerlink" title="å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•"></a>å‘é€è¯·æ±‚ï¼ŒApplyæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Apply</span></span><br><span class="line"><span class="comment">//  -&gt; ApplyLog</span></span><br><span class="line"><span class="comment">// å†™çš„æ—¶å€™ä¹Ÿä¸éœ€è¦è¿”å›ä»€ä¹ˆï¼Œä¸»è¦å°±æ˜¯Check Error</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">ApplyLog</span><span class="params">(log Log, timeout time.Duration)</span> <span class="title">ApplyFuture</span></span> &#123;</span><br><span class="line">  logFuture := &amp;logFuture&#123;</span><br><span class="line">    log: Log&#123;</span><br><span class="line">      Type:       LogCommand,</span><br><span class="line">      Data:       log.Data,</span><br><span class="line">      Extensions: log.Extensions,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  logFuture.init()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// è¿™ä¸ªå†™æ³•å¾ˆæœ‰æ„æ€ï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ”¾åˆ°applyChé©¬ä¸Šè¿”å›ï¼Œè¿™ä¸ªæ—¶å€™return logFutureä¸ä¸€å®šæœ‰æ•°æ®çš„å§ï¼Œclientæ€ä¹ˆåˆ¤æ–­æ“ä½œæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥å‘¢ã€‚</span></span><br><span class="line">  <span class="keyword">case</span> r.applyCh &lt;- logFuture:</span><br><span class="line">    <span class="keyword">return</span> logFuture</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="runLeader"><a href="#runLeader" class="headerlink" title="runLeader()"></a>runLeader()</h5><p>æ¥ç€æˆ‘ä»¬çœ‹ä¸‹leaderåˆå§‹åŒ–çš„æ—¶å€™ä¼šå¹²äº›å•¥ï¼Œé‡ç‚¹çœ‹ä¸‹åˆå§‹åŒ–çš„åå°å¤„ç†åç¨‹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">runLeader</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// ?? leaderChè¿™ä¸ªchanè¿˜çœŸçš„æ˜¯ä¸çŸ¥é“å¹²å•¥çš„ï¼Œåé¢æœ‰æ—¶é—´åœ¨é‡ç‚¹çœ‹ä¸‹</span></span><br><span class="line">  overrideNotifyBool(r.leaderCh, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setup leader stateï¼Œä¸»è¦æ˜¯èŠ‚ç‚¹çš„ä¿¡æ¯</span></span><br><span class="line">  r.setupLeaderState()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å®šä¹‰æ¸…ç†é€»è¾‘</span></span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">   ...</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡ç‚¹ï¼šä¸ºæ¯ä¸€ä¸ªpeerå¯åŠ¨ä¸€ä¸ªLogå¤åˆ¶åç¨‹ï¼Œ</span></span><br><span class="line">  r.startStopReplication()</span><br><span class="line">  <span class="comment">//  è°ƒç”¨-&gt; r.goFunc(func() &#123; r.replicate(s) &#125;)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å§‹leaderå¾ªç¯</span></span><br><span class="line">  r.leaderLoop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Leaderæ¶ˆè´¹r-applyCh"><a href="#Leaderæ¶ˆè´¹r-applyCh" class="headerlink" title="Leaderæ¶ˆè´¹r.applyCh"></a>Leaderæ¶ˆè´¹r.applyCh</h5><p>å°†å®¢æˆ·ç«¯çš„å†™å‡‘æˆä¸€æ‰¹ï¼Œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> newLog := &lt;-r.applyCh:</span><br><span class="line">  <span class="comment">// Group commit, ç»„æäº¤</span></span><br><span class="line">  ready := []*logFuture&#123;newLog&#125;</span><br><span class="line">GROUP_COMMIT_LOOP:</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; r.config().MaxAppendEntries; i++ &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> newLog := &lt;-r.applyCh:</span><br><span class="line">      ready = <span class="built_in">append</span>(ready, newLog)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span> GROUP_COMMIT_LOOP</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Dispatch the logs</span></span><br><span class="line">  <span class="keyword">if</span> stepDown &#123;</span><br><span class="line">     ....</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    r.dispatchLogs(ready)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€çœ‹çœ‹dispatchLogsé€»è¾‘</p><p>åŠ r.leaderState.inflight list, è¡¨ç¤ºéœ€è¦å¤„ç†çš„applyLogs</p><p>æ—¥å¿—æŒä¹…åŒ– r.logs.StoreLogs(logs)ï¼Œç±»æ¯”mysql æŒä¹…åŒ–redo log</p><p>å°†è‡ªå·±çš„log indexå¾€å‰ï¼Œå¹¶ä¸”é€šçŸ¥<code>commitCh</code></p><p>æŒä¹…åŒ–lastIndexï¼Œr.setLastLog(lastIndex, term)</p><p>é€šçŸ¥æ¯ä¸ªreplicationæ–°Log â€“  asyncNotifyCh(f.triggerCh)  </p><p>æ¥ç€å°±æ˜¯ä¸Šé¢çš„åˆå§‹åŒ–çš„æ—¶å€™å¹²çš„äº‹æƒ…äº†ï¼Œç»™æ¯ä¸ªchannelå‘æ¶ˆæ¯</p><p>æƒ³æƒ³å“ªäº›æ˜¯å¼‚æ­¥çš„ï¼Ÿä¸ºå•¥è¦å¼‚æ­¥å¤„ç†å‘¢ï¼Ÿ</p><p>ææ¸…æ¥šé‡ç‚¹</p><p>ä¸‹é¢çš„<code>observe</code>æ˜¯å¹²å•¥çš„ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r.observe(LeaderObservation&#123;Leader: leader&#125;)</span><br></pre></td></tr></table></figure><p>client å†™è¯·æ±‚ :api.go   Applyæ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªApplyFutureå¯¹è±¡ï¼ŒåŒ…å«reqã€responseã€error</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>â€“&gt;  å‘æ¶ˆæ¯ append entity â€“&gt; å¤šæ•°æ´¾çš„å›å¤  â€“ &gt; å®¢æˆ·ç«¯è¿”å›  â€“&gt; åº”ç”¨FSM(å¦ä¸€ä¸ªæµç¨‹)â€“&gt; é€šçŸ¥å…¶ä»–èŠ‚ç‚¹å¯ä»¥åº”ç”¨ â€“</p><p>clientè¿”å›çš„æ ‡å‡†æ˜¯å•¥ï¼Ÿæ—¥å¿—å¤šæ•°æ´¾ or  Master applyæˆåŠŸ(ä¸å¯èƒ½)   </p><p>è®¤çœŸç¢ç£¨å…¶ä¸­çš„ä¼˜åŒ–</p><h4 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h4><p>1ã€chané‡Œé¢åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”ä¸èƒ½å¹¶å‘è°ƒç”¨ã€‚ä¸‹é¢ä»£ç çš„ç†è§£ï¼Œåˆ°åº•æ˜¯æ€ä¹ˆé¿å…å¹¶å‘è°ƒç”¨çš„ï¼Ÿè¿˜æœ‰åˆ«çš„å®ç°å—ï¼Ÿè¿™ä¸ªå®ç°æ˜¯ä¸æ˜¯æœ‰ç‚¹trickï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">overrideNotifyBool</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">bool</span>, v <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> ch &lt;- v:</span><br><span class="line">    <span class="comment">// value sent, all done</span></span><br><span class="line">  <span class="keyword">case</span> &lt;-ch:</span><br><span class="line">    <span class="comment">// channel had an old value</span></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ch &lt;- v:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">panic</span>(<span class="string">&quot;race: channel was sent concurrently&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2ã€<code>leaderLoop</code>è¿™ä¸ªé‡Œé¢å…¨æ˜¯å¼‚æ­¥çš„chanï¼Œä»£ç è§„åˆ’çš„éå¸¸å¥½ï¼Œå¾ˆå€¼å¾—å­¦ä¹ </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å‰é¢ä¸‰ç¯‡æˆ‘ä»¬åˆ†åˆ«ä»‹ç»äº†Raftçš„APIã€ç½‘ç»œå±‚ã€å­˜å‚¨å±‚ï¼Œä»è¿™ä¸€ç¯‡å¼€å§‹æˆ‘ä»¬æ¥çœ‹Raftçš„&lt;code&gt;Leaderã€Candidateã€Follower&lt;/code&gt;å®ç°ã€‚&lt;/p&gt;
&lt;h4 id=&quot;r-runLeaderé€»è¾‘&quot;&gt;&lt;a href=&quot;#r-runLeaderé€»è¾‘&quot; </summary>
      
    
    
    
    
    <category term="raft" scheme="https://zhangtinglu.github.io/tags/raft/"/>
    
  </entry>
  
  <entry>
    <title>hashicorp:raftæºç ç³»åˆ—(3)--å­˜å‚¨å±‚</title>
    <link href="https://zhangtinglu.github.io/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-3-%E5%AD%98%E5%82%A8%E5%B1%82/"/>
    <id>https://zhangtinglu.github.io/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-3-%E5%AD%98%E5%82%A8%E5%B1%82/</id>
    <published>2021-12-17T08:18:49.000Z</published>
    <updated>2021-12-20T07:08:45.167Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>æ¥ç€ä¸Šä¸€ç¯‡æˆ‘ä»¬è®²äº†ç½‘ç»œå±‚ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥è®²<code>LogStoreã€StableStoreã€FSMã€SnapshotStore</code>ï¼Œä¸ºå•¥è¿™äº›ä¸€èµ·è®²å‘¢ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯å­˜å‚¨ç›¸å…³ï¼Œå¹¶ä¸”åŠŸèƒ½ç›¸å¯¹ç®€å•ï¼Œå¹¶æ²¡æœ‰åƒ<code>Transport</code>é‚£æ ·æœ‰<code>NetworkTransport</code>å®ç°å¯ä»¥ç”¨æ¥è¿›è¡Œåˆ†æã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Â <span class="function"><span class="keyword">func</span> <span class="title">NewRaft</span><span class="params">(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans Transport)</span> <span class="params">(*Raft, error)</span></span> &#123; Â    ......&#125;</span><br></pre></td></tr></table></figure><h4 id="StableStore"><a href="#StableStore" class="headerlink" title="StableStore"></a>StableStore</h4><p>è¿™ä¸ªç»„ä»¶ä¸»è¦å°±æ˜¯ä¸ºäº†å®‰å…¨è€ƒè™‘è€Œå­˜åœ¨çš„ï¼Œæä¾›ä¸€ä¸ªå¯ä»¥æŒä¹…åŒ–k-vçš„å­˜å‚¨çš„å³å¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StableStore <span class="keyword">interface</span> &#123;</span><br><span class="line">  Set(key []<span class="keyword">byte</span>, val []<span class="keyword">byte</span>) error</span><br><span class="line">  Get(key []<span class="keyword">byte</span>) ([]<span class="keyword">byte</span>, error)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// uint64æ˜¯æ—¥å¿—å·å’Œä»»æœŸå®šä¹‰çš„ç±»å‹ï¼Œæ–¹ä¾¿å­˜</span></span><br><span class="line">  SetUint64(key []<span class="keyword">byte</span>, val <span class="keyword">uint64</span>) error</span><br><span class="line">  GetUint64(key []<span class="keyword">byte</span>) (<span class="keyword">uint64</span>, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="LogStore"><a href="#LogStore" class="headerlink" title="LogStore"></a>LogStore</h4><p>è¿™ä¸ªç»„ä»¶å°±æ˜¯ä¸ºäº†å­˜æ—¥å¿—çš„ï¼Œæ¯”å¦‚ç”¨æˆ·å‘è¿‡æ¥<code>set a=1</code>, å°†è¿™ä¸ªå­˜èµ·æ¥å³å¯ã€‚å’Œä¸Šé¢çš„<code>StableStore</code>èƒ½åŠ›æ˜¯åŒä¸€ç§ï¼Œä¸è¿‡æ—¥å¿—å¯èƒ½æ¯”è¾ƒå¤šï¼Œéœ€è¦æ ¹æ®å®ç°æƒ…å†µè¿›è¡Œé€‰æ‹©ã€‚é¡¹ç›®åœ¨æµ‹è¯•çš„æ—¶å€™å®ç°äº†ä¸€ä¸ª<code>inmem</code>çš„æ—¥å¿—å­˜å‚¨ï¼Œç”¨äº†ä¸€ä¸ª<code>map</code>æ¥è¿›è¡Œå­˜å‚¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// inmemæ¨¡æ‹Ÿï¼Œç›´æ¥mapå­˜ï¼ŒåŸºæœ¬èƒ½åŠ›-è¯»å†™ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewInmemStore</span><span class="params">()</span> *<span class="title">InmemStore</span></span> &#123;</span><br><span class="line">  i := &amp;InmemStore&#123;</span><br><span class="line">    logs:  <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">uint64</span>]*Log),</span><br><span class="line">    kv:    <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">byte</span>),</span><br><span class="line">    kvInt: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">uint64</span>),</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="FSM"><a href="#FSM" class="headerlink" title="FSM"></a>FSM</h4><p>FMSçš„åŠŸèƒ½ï¼Œâ‘¡+â‘¢ä¸æ˜¯Raftçš„æ ¸å¿ƒé€»è¾‘ã€‚Raftå¯åŠ¨æ—¶å€™ä¼šæœ‰ä¸€ä¸ªåå°åç¨‹<code>runFSM</code>è´Ÿè´£æ¥åšä¸‹é¢çš„ä¸‰ä»¶äº‹ï¼ŒMainçº¿ç¨‹å°†åº”ç”¨æ—¥å¿—è¯·æ±‚æ”¾åˆ°<code>fsmMutateCh</code>é‡Œé¢ï¼Œå°†æ‰“å¿«ç…§çš„è¯·æ±‚æ”¾åˆ°<code>fsmSnapshotCh</code>é‡Œé¢ï¼Œä¸é˜»å¡Main</p><p>â‘  åº”ç”¨æ—¥å¿—ï¼Œraft logå¤šæ•°æ´¾å·²ç»ç¡®è®¤ï¼Œå°±å¯ä»¥åº”ç”¨åˆ°åº•å±‚å­˜å‚¨äº†ã€‚</p><p>â‘¡ å¿«ç…§</p><p>â‘¢ èŠ‚ç‚¹æ¢å¤</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FSM <span class="keyword">interface</span> &#123;</span><br><span class="line">  Apply(*Log) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">  Snapshot() (FSMSnapshot, error)</span><br><span class="line">  Restore(io.ReadCloser) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">runFSM</span><span class="params">()</span></span> &#123;</span><br><span class="line">  commitSingle := <span class="function"><span class="keyword">func</span><span class="params">(req *commitTuple)</span></span>&#123;...&#125;</span><br><span class="line">  commitBatch := <span class="function"><span class="keyword">func</span><span class="params">(reqs []*commitTuple)</span></span>&#123;...&#125;</span><br><span class="line">  restore := <span class="function"><span class="keyword">func</span><span class="params">(req *restoreFuture)</span></span>&#123;...&#125;</span><br><span class="line">  snapshot := <span class="function"><span class="keyword">func</span><span class="params">(req *reqSnapshotFuture)</span></span>&#123;...&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ptr := &lt;-r.fsmMutateCh:</span><br><span class="line">      <span class="keyword">switch</span> req := ptr.(<span class="keyword">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> []*commitTuple:</span><br><span class="line">        commitBatch(req)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> *restoreFuture:</span><br><span class="line">        restore(req)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">panic</span>(fmt.Errorf(<span class="string">&quot;bad type passed to fsmMutateCh: %#v&quot;</span>, ptr))</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> req := &lt;-r.fsmSnapshotCh:</span><br><span class="line">      snapshot(req)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> &lt;-r.shutdownCh:</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>snapshotä¸æ˜¯é‡ç‚¹ï¼Œæ‰€ä»¥å…ˆç®€å•ä»‹ç»ä¸‹ï¼Œåç»­é‡è¯»çš„æ—¶å€™è¡¥ä¸Šè¿™ä¸€æ¨¡å—ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥çœ‹æœ€é‡è¦çš„Raftçš„é€»è¾‘ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h3&gt;&lt;p&gt;æ¥ç€ä¸Šä¸€ç¯‡æˆ‘ä»¬è®²äº†ç½‘ç»œå±‚ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥è®²&lt;code&gt;LogStoreã€StableStoreã€FSMã€SnapshotStore&lt;/code</summary>
      
    
    
    
    
    <category term="raft" scheme="https://zhangtinglu.github.io/tags/raft/"/>
    
  </entry>
  
  <entry>
    <title>blogæŠ˜è…¾è®°å½•</title>
    <link href="https://zhangtinglu.github.io/2021/12/17/blog%E9%83%A8%E7%BD%B2%E7%AF%87/"/>
    <id>https://zhangtinglu.github.io/2021/12/17/blog%E9%83%A8%E7%BD%B2%E7%AF%87/</id>
    <published>2021-12-17T08:18:49.000Z</published>
    <updated>2022-01-06T08:32:07.748Z</updated>
    
    <content type="html"><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>æœ€è¿‘å¼€å§‹é‡æ‹¾å†™blogçš„ä¹ æƒ¯ï¼Œæƒ³ç€åšæŒç‚¹å•¥å§ã€‚</p><p>ç»“æœå°†githubä¸Šçš„ç½‘ç«™æ‰“å¼€ï¼Œ2020-03æœ€è¿‘ä¸€ç¯‡ï¼Œç°åœ¨å¯æ˜¯2021-12æœˆäº†ï¼Œæç½®äº†1å¹´9ä¸ªæœˆï¼ŒçœŸè¡Œã€‚</p><p>ç„¶åæ‰“ç®—ä¸Šä¼ ä¸€ç¯‡blogï¼Œå‘ç°æ–°ç”µè„‘ä¸Šç¯å¢ƒä¹Ÿæ²¡æœ‰äº†ã€‚å¤§è„‘å¼€å§‹é«˜é€Ÿè¿è½¬ï¼Œå¥½å§~ å®Œå…¨æ²¡æœ‰ä¸€ç‚¹æ˜ åƒã€‚</p><p>å› æ­¤ï¼Œæ‰“ç®—ä¹–ä¹–çš„å†™æ–‡ç« è®°å½•ï¼Œå¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œå…ˆäººä»¬ä¸æ›¾æ¬ºæˆ‘å•Š~</p><h4 id="æ“ä½œè®°å½•"><a href="#æ“ä½œè®°å½•" class="headerlink" title="æ“ä½œè®°å½•"></a>æ“ä½œè®°å½•</h4><p>ä¹‹å‰è¿˜æŠ˜è…¾ä»€ä¹ˆmwebï¼Œä¸€é”®éƒ¨ç½²å¤šä¸ªå¹³å°å•¥çš„ã€‚ç°åœ¨å¯èƒ½æ˜¯æ€æƒ³è§‚å¿µå˜äº†ï¼Œå†…å®¹å¹³å°è¿˜æ˜¯ä»¥å†…å®¹ä¸ºä¸»ã€‚æ—¢ç„¶éƒ½èŠ±äº†é‚£ä¹ˆå¤šå¿ƒæ€å†™äº†ï¼Œéš¾é“è¿˜ä¸èƒ½å»å„ä¸ªå¹³å°æºœè¾¾ä¸€åœˆå¯¼å…¥ä¸‹å—ã€‚</p><h5 id="ç”¨ä»€ä¹ˆå†™ï¼Ÿ"><a href="#ç”¨ä»€ä¹ˆå†™ï¼Ÿ" class="headerlink" title="ç”¨ä»€ä¹ˆå†™ï¼Ÿ"></a>ç”¨ä»€ä¹ˆå†™ï¼Ÿ</h5><blockquote><p>Typero</p></blockquote><h5 id="ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ"><a href="#ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ" class="headerlink" title="ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ"></a>ç”¨ä»€ä¹ˆå›¾åºŠï¼Ÿ</h5><blockquote><p> è·¯è¿‡å›¾åºŠã€‚å°±æ˜¯è§‰å¾—å‰ªè´´æ¿ç›´æ¥ctrl+vå¾ˆæ–¹ä¾¿ï¼Œæ‡’å¾—æ¢ã€‚</p></blockquote><h5 id="å‘å¸ƒåˆ°å“ª"><a href="#å‘å¸ƒåˆ°å“ª" class="headerlink" title="å‘å¸ƒåˆ°å“ª"></a>å‘å¸ƒåˆ°å“ª</h5><p>åŸåˆ™å°±æ˜¯æ”¯æŒMDå¯¼å…¥</p><ul><li>githubï¼Œå¯ä»¥å»ç™¾åº¦æ™ºèƒ½äº‘ä¸Šå»ç”³è¯·ä¸€ä¸ªåŸŸåï¼Œä¾¿å®œçš„ä¸€å¹´å°±13å…ƒï¼Œä¸è¿‡ç»­è´¹æ¯”è¾ƒè´µâ˜ºï¸ã€‚ â€“  ç®—äº†ï¼Œå®åè®¤è¯å•¥çš„éº»çƒ¦ã€‚</li><li>csdn</li><li>cnblog(ä¸æ”¯æŒMDå¯¼å…¥ï¼Œæœ‰ç‚¹æ„äºº)</li><li>ç®€ä¹¦(ä¸æ”¯æŒMDå¯¼å…¥ï¼Œæ”¾å¼ƒ)</li></ul><h5 id="hexoä¸githubé…ç½®"><a href="#hexoä¸githubé…ç½®" class="headerlink" title="hexoä¸githubé…ç½®"></a>hexoä¸githubé…ç½®</h5><p>è¯´èµ·æ¥æˆ‘ä¹‹å‰å¼„è¿‡ä¸€ç‰ˆï¼Œä½†æ˜¯å®Œæˆå¿˜è®°äº†ã€‚æ›´æƒ¨çš„æ˜¯gitä»“åº“çš„ä¸œè¥¿éƒ½ä¸çŸ¥é“æ€ä¹ˆå¤ç”¨ï¼Œåªèƒ½å®Œå…¨é‡æ¥ï¼Œå°±å½“æ˜¯ä¸€ä¸ªæ–°çš„å¼€å§‹å¥½äº†ã€‚</p><p>å…ˆå°†ä¸€æ¬¡æ€§çš„æ“ä½œåšäº†ï¼Œå®‰è£…&amp;é…ç½®ã€‚é…ç½®æ–‡ä»¶åªæœ‰2ä¸ªï¼Œä¸€å®šè¦åšå¥½å¤‡ä»½</p><p>_config.yml: ç½‘ç«™é…ç½®</p><p>themes/next/_config.ymlï¼šä¸»é¢˜é…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> macä¸Šå®‰è£…hexo</span></span><br><span class="line">brew install hexo</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆå§‹åŒ–é¡¹ç›®</span></span><br><span class="line">hexo init myblog</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> git <span class="built_in">clone</span> nextä¸»é¢˜</span></span><br><span class="line">git clone https://github.com/theme-next/hexo-theme-next themes/next</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®šåˆ¶åŒ–é…ç½® _config.yml</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># siteï¼š è¿™åŠ›çš„languageè¦å’Œä¸»é¢˜é‡Œé¢çš„themes/next/languagesä¸‹é¢çš„æ–‡ä»¶èƒ½å¯¹åº”æ‰è¡Œ</span></span></span><br><span class="line">title: Moonshine&#x27;s Blog</span><br><span class="line">subtitle: &#x27;æ—¥æ‹±ä¸€å’æ— æœ‰å°½ï¼ŒåŠŸä¸å”æç»ˆå…¥æµ·&#x27;</span><br><span class="line">description: &#x27;é¢¨ãŒå¹ã„ã¦è‘‰ãŒè½ã¡ã€è½ã¡è‘‰ã¯åœŸå£Œã®è‚¥ã‚„ã—ã¨ãªã‚ŠåœŸå£Œã‚’è‚¥ãˆã•ã›ã€æœç‰©ãŒã‚†ã£ãã‚Šã¨ç€å®Ÿã«è‚²ã¤ã®ã§ã™&#x27;</span><br><span class="line">keywords: &#x27;æ•°æ®åº“&#x27;</span><br><span class="line">author: Moonshine</span><br><span class="line">language: zh-CN</span><br><span class="line">timezone: &#x27;&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># url</span></span></span><br><span class="line">url: https://zhangtinglu.github.io/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ä¸»é¢˜</span></span></span><br><span class="line">theme: next</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># éƒ¨ç½²git</span></span></span><br><span class="line">deploy:</span><br><span class="line">  type: &#x27;git&#x27;</span><br><span class="line">  repo: &#x27;https://github.com/zhangtinglu/zhangtinglu.github.io&#x27;</span><br><span class="line">  branch: &#x27;master&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ä»£ç è¯­æ³•é«˜äº®ï¼Œå°†prismjsæ”¹æˆtrueå°±è¡Œäº†</span></span></span><br><span class="line">prismjs:</span><br><span class="line">  enable: true </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®šåˆ¶themeé…ç½® themes/next/_config.yml -- æœ‰ç‚¹å¤šï¼Œç›´æ¥å¤‡ä»½å§</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŠŠè‡ªå·±éœ€è¦çš„éœ€è¦çš„pageå®‰è£…ä¸‹</span></span><br><span class="line">hexo new page about</span><br><span class="line">hexo new page tags</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> é¦–é¡µæ‘˜è¦ -- å¤ªè´¹åŠ²äº†ï¼Œç›´æ¥ç”¨å½’æ¡£é¡µé¢å½“æˆä¸»é¡µ</span></span><br><span class="line">~/myblog/themes/next/layout </span><br><span class="line">mv index.swig index_bak.swig</span><br><span class="line">cp archive.swig index.swig</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä»£ç å¯æŠ˜å  - æ”¶ç¼©</span></span><br><span class="line">codeblock:</span><br><span class="line">  highlight_theme: night</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ˜¾å¾—å¤ªå¤§äº† -- ä¸ç®¡èƒ½çœ‹å°±è¡Œ</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ–‡ç« ç›®å½•</span></span><br><span class="line">toc:</span><br><span class="line">  expand_all: true</span><br></pre></td></tr></table></figure><p>æ¥ç€å°±æ˜¯å¹³å¸¸ä½¿ç”¨äº†ï¼Œåˆ›å»ºblog-deploy</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…ˆå°†hello worldè¿™ä¸ªpageåˆ é™¤</span></span><br><span class="line">rm -rf /source/_posts/hello-world.md</span><br><span class="line">hexo new &#x27;blog&#x27;</span><br><span class="line">hexo s</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> éƒ¨ç½²</span></span><br><span class="line">hexo d -g</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>çœŸçš„å‰ç«¯åšåˆ°æœ€åä¼šç–¯ï¼Œå¤ªå®¹æ˜“äº§ç”Ÿå¼ºè¿«ç—‡äº†ã€‚</p><p>å•¥ä¹Ÿä¸è¯´äº†ï¼Œé‡å¤æ€§åŠ³åŠ¨ï¼Œå¦‚æœæ¢ä¸ªç”µè„‘ï¼Œç›´æ¥å°†æ•´ä¸ªé¡¹ç›®å¤‡ä»½ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h4&gt;&lt;p&gt;æœ€è¿‘å¼€å§‹é‡æ‹¾å†™blogçš„ä¹ æƒ¯ï¼Œæƒ³ç€åšæŒç‚¹å•¥å§ã€‚&lt;/p&gt;
&lt;p&gt;ç»“æœå°†githubä¸Šçš„ç½‘ç«™æ‰“å¼€ï¼Œ2020-03æœ€è¿‘ä¸€ç¯‡ï¼Œç°åœ¨å¯æ˜¯2021-12</summary>
      
    
    
    
    
    <category term="hexoé…ç½®" scheme="https://zhangtinglu.github.io/tags/hexo%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>hashicorp:raftæºç ç³»åˆ—(2)--ç½‘ç»œå±‚</title>
    <link href="https://zhangtinglu.github.io/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-2-%E7%BD%91%E7%BB%9C%E5%B1%82/"/>
    <id>https://zhangtinglu.github.io/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-2-%E7%BD%91%E7%BB%9C%E5%B1%82/</id>
    <published>2021-12-17T08:18:40.000Z</published>
    <updated>2021-12-26T03:40:58.259Z</updated>
    
    <content type="html"><![CDATA[<h4 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><p>æ¥ç€ä¸Šé¢â€“å¯¼è¯»ï¼Œæœ¬ç¯‡è®²è§£Transportä¼ è¾“å±‚å®ç°ã€‚</p><p>å¦‚ä¸‹NewRaftå‡½æ•°çš„å‚æ•°ä¸­ï¼Œé™¤äº†Configç»“æ„ï¼Œå…¶ä»–éƒ½æ˜¯ä»¥interfaceå½¢å¼å®ç°ã€‚</p><p>æ¥ä¸‹æ¥å‡ ç¯‡æˆ‘ä»¬åˆ†åˆ«å¯¹è¿™5ç±»æ¥å£è¿›è¡Œè¯¦ç»†åˆ†æã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRaft</span><span class="params">(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans Transport)</span> <span class="params">(*Raft, error)</span></span> &#123;</span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶"><a href="#ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶" class="headerlink" title="ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶"></a>ä¼ è¾“å±‚æ¶‰åŠå“ªäº›æ–‡ä»¶</h4><ul><li><p>transport.go: å®šä¹‰ä¼ è¾“å±‚æ¥å£ï¼Œä¸‹å›¾ä¸­çš„Transport Interfaceå¯¹è±¡ã€‚</p></li><li><p>inmem_transport.go: ä»¥å†…å­˜çš„æ–¹å¼å®ç°Transportæ¥å£ï¼Œç”¨äºæµ‹è¯•ã€‚</p></li><li><p>net_transport.go: ç½‘ç»œæ–¹å¼å®ç°Transportæ¥å£ã€‚</p></li><li><p>tcp_transport.go: ä»¥TCPçš„æ–¹å¼å®ç°äº†NetworkTransportéœ€è¦çš„SteamLayerã€‚</p></li><li><p>command.goï¼šè¿™ä¸ªæ–‡ä»¶é‡Œé¢å®šä¹‰äº†å„ç§RPC requestå’Œresponseçš„ç»“æ„ï¼Œeg: AppendEntriesRequestã€AppendEntriesResponse</p><p><a href="https://imgtu.com/i/ovlYo6"><img src="https://s4.ax1x.com/2021/12/14/ovlYo6.png" alt="ovlYo6.png"></a></p></li></ul><p>æ€»ç»“ï¼ŒNetworkTransportå’ŒInmemTransportæ˜¯å¯¹Transportå±‚çš„å…·ä½“å®ç°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯¹NetworkTransportè¿›è¡Œè¯¦ç»†åˆ†æã€‚</p><h4 id="ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ"><a href="#ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ" class="headerlink" title="ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ"></a>ä¼ è¾“å±‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</h4><h5 id="ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport-AppendEntrieså¼€å§‹"><a href="#ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport-AppendEntrieså¼€å§‹" class="headerlink" title="ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport_AppendEntrieså¼€å§‹"></a>ä»æµ‹è¯•ç”¨ä¾‹TestNetworkTransport_AppendEntrieså¼€å§‹</h5><p>æµ‹è¯•ç”¨ä¾‹ä¸€èˆ¬èƒ½å‘Šè¯‰æˆ‘ä»¬æ€ä¹ˆç©ï¼Œè€ŒAppendEntrieså‘é€æ—¥å¿—åˆæ˜¯æœ€å¸¸ç”¨çš„åŠŸèƒ½ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±ä»è¿™é‡Œå¼€å§‹ã€‚</p><p><a href="https://imgtu.com/i/ovW3X4"><img src="https://s4.ax1x.com/2021/12/14/ovW3X4.md.png" alt="ovW3X4.md.png"></a></p><ol><li><p>åˆå§‹åŒ–æ¶ˆè´¹è€…(trans1)ï¼Œè¿™ä¸€æ­¥åé¢æ˜¯è¦è¯¦ç»†çœ‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ ‡æ˜Ÿã€‚</p></li><li><p>å¯åŠ¨æ¶ˆè´¹è€…ï¼Œç›‘å¬rpcChï¼Œä¹Ÿå°±æ˜¯Consumer()è¿”å›çš„åªè¯»channelã€‚ğŸ¤”ï¼šrpc.Respondå‡½æ•°åªæ˜¯ç»™respChæ·»åŠ äº†ä¸€ä¸ªå…ƒç´ ï¼Œé‚£è°æ¥æ¶ˆè´¹è¿™ä¸ªå…ƒç´ å‘¢ï¼Ÿ</p></li><li><p>åˆå§‹åŒ–ç”Ÿäº§è€…( trans2)ï¼ŒåŒæ ·ä½¿ç”¨newTCPTransportå®ç°ã€‚</p></li><li><p>è°ƒç”¨AppendEntriesæ¶ˆæ¯ç»™æ¶ˆè´¹è€…trans1ï¼Œè¿™é‡Œç›´æ¥å°±è·å–è¿”å›äº†ã€‚ä¸ºå•¥çœ‹ç€å°±æ˜¯åŒæ­¥è¿”å›çš„å‘¢? æŒ‰ç†è¯´ç½‘ç»œè°ƒç”¨ä¸€èˆ¬éƒ½æ˜¯å¼‚æ­¥è¿”å›å§ã€‚è¿™ä¸ªæ˜Ÿæ ‡æ­¥éª¤ï¼Œæˆ‘ä»¬åé¢æ¥è¯¦ç»†åˆ†æã€‚</p></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestNetworkTransport_AppendEntries</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> _, useAddrProvider := <span class="keyword">range</span> []<span class="keyword">bool</span>&#123;<span class="literal">true</span>, <span class="literal">false</span>&#125; &#123;</span><br><span class="line">    <span class="comment">// â‘ åˆå§‹åŒ–trans1 -- æ¶ˆè´¹è€…</span></span><br><span class="line">    trans1, err := makeTransport(t, useAddrProvider, <span class="string">&quot;localhost:0&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    rpcCh := trans1.Consumer()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰æµ‹è¯•ä½¿ç”¨çš„RPCè¯·æ±‚</span></span><br><span class="line">    args := AppendEntriesRequest&#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    resp := AppendEntriesResponse&#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¡ å¯åŠ¨æ¶ˆè´¹è€…ç›‘å¬ </span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> rpc := &lt;-rpcCh:</span><br><span class="line">        <span class="comment">// è·å–æ¶ˆæ¯ç„¶åè¿”å›ï¼Œæ³¨æ„Respondå‡½æ•°åªæ˜¯ç»™RPCå¯¹è±¡çš„RespChanæ·»åŠ ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆè°æ¥æ¶ˆè´¹è¿™å’Œchanå‘¢</span></span><br><span class="line">        rpc.Respond(&amp;resp, <span class="literal">nil</span>)</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¢ åˆå§‹åŒ–ç”Ÿäº§è€… trans2</span></span><br><span class="line">    trans2, err := makeTransport(t, useAddrProvider, <span class="keyword">string</span>(trans1.LocalAddr()))</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// â‘£ å‘é€AppendEntriesæ¶ˆæ¯ç»™trans1ï¼Œè¿™é‡Œç›´æ¥å°±è·å–è¿”å›äº†ã€‚ä¸ºå•¥çœ‹ç€å°±æ˜¯åŒæ­¥è¿”å›çš„å‘¢</span></span><br><span class="line">    <span class="keyword">if</span> err := trans2.AppendEntries(<span class="string">&quot;id1&quot;</span>, trans1.LocalAddr(), &amp;args, &amp;out); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      t.Fatalf(<span class="string">&quot;err: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="makeTransportå®ç°åˆ†æ"><a href="#makeTransportå®ç°åˆ†æ" class="headerlink" title="makeTransportå®ç°åˆ†æ"></a>makeTransportå®ç°åˆ†æ</h5><ol><li><p>å…ˆçœ‹ä¸‹å‡½æ•°è°ƒç”¨å…³ç³»</p><p>newTCPTransportï¼šå°±æ˜¯tcpç«¯å£ç»‘å®šï¼Œç”ŸæˆTCPStreamLayer(ä¸Šé¢çš„ç±»å›¾ä¸­çŸ¥é“æ˜¯NetworkTransportç»“æ„éœ€è¦çš„æˆå‘˜)</p><p>NewNetworkTransportWithConfigï¼šåˆ›å»ºNetworkTransportå¯¹è±¡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   makeTransport</span><br><span class="line">   -&gt; NewTCPTransportWithConfig</span><br><span class="line">     -&gt; newTCPTransport <span class="comment">// è´Ÿè´£è¿›è¡Œtcpç«¯å£ç»‘å®šï¼Œç”ŸæˆTCPStreamLayerï¼ŒåŒ…è£…å™¨</span></span><br><span class="line">   -&gt; NewNetworkTransportWithConfig <span class="comment">// çœŸæ­£åˆ›å»ºNetworkTransportå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> newTCPTransport</span><br><span class="line"></span><br><span class="line">   ä¸‹é¢æ˜¯newTCPTransportçš„å®ç°ï¼Œæœ€åtransportCreatorå°±æ˜¯ç½‘ç»œå±‚çš„åˆ›å»ºå™¨</span><br><span class="line"></span><br><span class="line">   <span class="string">``</span><span class="string">`go</span></span><br><span class="line"><span class="string">   // â‘  è°ƒç”¨netåº“ç»‘å®štcpç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="string">   list, err := net.Listen(&quot;tcp&quot;, bindAddr)</span></span><br><span class="line"><span class="string">   // â‘¡ å°†TCPListener -&gt; TCPStreamLayer(ä¸Šé¢çš„ç±»å›¾ä¸­NetworkTransportéœ€è¦å®ç°StreamLayeræ¥å£)</span></span><br><span class="line"><span class="string">   stream := &amp;TCPStreamLayer&#123;</span></span><br><span class="line"><span class="string">   advertise: advertise,</span></span><br><span class="line"><span class="string">   listener:  list.(*net.TCPListener),</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">   // â‘¢ å°†ä¸Šé¢çš„ TCPStreamLayer-&gt; NetworkTransportï¼Œè°ƒç”¨ NewNetworkTransportWithConfig</span></span><br><span class="line"><span class="string">   trans := transportCreator(stream)</span></span><br></pre></td></tr></table></figure></li><li><p>newNetworkTransport</p><p>ä¸‹é¢æ˜¯åˆ›å»ºç½‘ç»œå±‚çš„ä»£ç ï¼Œä¸€ä¸ªAcceptorä¸“é—¨ç”¨æ¥accetorè¿æ¥ï¼Œæ¯ä¸ªæ–°çš„è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªåç¨‹è¿›è¡Œå¤„ç†ã€‚</p><p><a href="https://imgtu.com/i/T9BOV1"><img src="https://s4.ax1x.com/2021/12/16/T9BOV1.png" alt="T9BOV1.png"></a></p><ul><li><p>Mainçº¿ç¨‹è°ƒç”¨trans.listen()å¯åŠ¨ç›‘å¬åç¨‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// â‘  å°†ä¸Šé¢çš„configæ³¨å…¥è¿›æ¥ï¼Œä¸»è¦æ˜¯Stream</span></span><br><span class="line">trans := &amp;NetworkTransport&#123;</span><br><span class="line">    connPool:              <span class="built_in">make</span>(<span class="keyword">map</span>[ServerAddress][]*netConn),</span><br><span class="line">    consumeCh:             <span class="built_in">make</span>(<span class="keyword">chan</span> RPC),</span><br><span class="line">    logger:                config.Logger,</span><br><span class="line">    maxPool:               config.MaxPool,</span><br><span class="line">    shutdownCh:            <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">    stream:                config.Stream,</span><br><span class="line">    timeout:               config.Timeout,</span><br><span class="line">    TimeoutScale:          DefaultTimeoutScale,</span><br><span class="line">    serverAddressProvider: config.ServerAddressProvider,</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// â‘¡ è®¾ç½®Streamä¸Šä¸‹æ–‡</span></span><br><span class="line">trans.setupStreamContext()</span><br><span class="line"><span class="comment">// â‘¢ å¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¸“é—¨æ¥å¤„ç†è¿æ¥</span></span><br><span class="line"><span class="keyword">go</span> trans.listen()</span><br></pre></td></tr></table></figure></li><li><p>Acceptorç›‘å¬æ–°è¿æ¥ï¼Œå¹¶å¯åŠ¨å¤„ç†åç¨‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">listen</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// â‘  æ¥æ”¶æ–°è¿æ¥ï¼Œè¿™ä¸ªåº•å±‚æ˜¯epollå®ç°ï¼Œ</span></span><br><span class="line">    conn, err := n.stream.Accept()</span><br><span class="line">    <span class="comment">// â‘¡ å¯åŠ¨å¤„ç†åç¨‹</span></span><br><span class="line">    <span class="keyword">go</span> n.handleConn(n.getStreamContext(), conn)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯¹è¿æ¥è¿›è¡Œå¤„ç†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">handleConn</span><span class="params">(connCtx context.Context, conn net.Conn)</span></span> &#123;</span><br><span class="line">  r := bufio.NewReaderSize(conn, connReceiveBufferSize)</span><br><span class="line">  w := bufio.NewWriter(conn)</span><br><span class="line">  dec := codec.NewDecoder(r, &amp;codec.MsgpackHandle&#123;&#125;)</span><br><span class="line">  enc := codec.NewEncoder(w, &amp;codec.MsgpackHandle&#123;&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// â‘  è¯»æ•°æ® -- è§£ç  -- å¤„ç† -- ç¼–ç </span></span><br><span class="line">    <span class="keyword">if</span> err := n.handleCommand(r, dec, enc); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// â‘¡ è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> err := w.Flush(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handleCommandæ˜¯æ ¸å¿ƒçš„å¤„ç†é€»è¾‘ï¼Œè¿™é‡Œé€šè¿‡chanè®©ç”¨æˆ·ä½¿ç”¨çš„æ—¶å€™æ„Ÿè§‰æ˜¯åŒæ­¥çš„ã€‚</p><ol><li><p>è·å–ç±»å‹ReadByteï¼Œçº¦å®šç¬¬ä¸€ä½è¡¨ç¤ºçš„RPCç±»å‹ï¼Œeg:AppendEntries RequestVote</p></li><li><p>å®šä¹‰respChã€‚</p></li><li><p>å¯¹ä¸åŒç±»å‹çš„Requestè¿›è¡Œè§£ç ã€‚</p></li><li><p>å°†è§£ç å‡ºæ¥çš„RPCæ¶ˆæ¯æ”¾åˆ°æ¶ˆè´¹channelä¸­</p></li><li><p>ç­‰respChè¿”å›å¤„ç†åçš„ç»“æ„</p></li><li><p>å°†ç»“æ„è¿›è¡Œç¼–ç ã€‚</p><p>ä¸‹é¢æ˜¯å’Œåˆ«çš„åç¨‹è¿›è¡Œäº¤äº’çš„æ–¹å¼ï¼Œå®é™…ä¸Šå¤„ç†é€»è¾‘æ˜¯å¤–åŒ…å‡ºå»è¿›è¡Œå¤„ç†çš„ã€‚</p></li></ol><p><a href="https://imgtu.com/i/T9R9Hg"><img src="https://s4.ax1x.com/2021/12/16/T9R9Hg.png" alt="T9R9Hg.png"></a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">handleCommand</span><span class="params">(r *bufio.Reader, dec *codec.Decoder, enc *codec.Encoder)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  getTypeStart := time.Now()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘  è·å–ç±»å‹ï¼Œçº¦å®šç¬¬ä¸€ä½è¡¨ç¤ºçš„RPCç±»å‹ï¼Œeg:AppendEntries RequestVote</span></span><br><span class="line">  rpcType, err := r.ReadByte()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ å®šä¹‰respCh</span></span><br><span class="line">  respCh := <span class="built_in">make</span>(<span class="keyword">chan</span> RPCResponse, <span class="number">1</span>)</span><br><span class="line">  rpc := RPC&#123;</span><br><span class="line">    RespChan: respCh,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¢ å¯¹ä¸åŒç±»å‹çš„Requestè¿›è¡Œè§£ç </span></span><br><span class="line">  <span class="keyword">switch</span> rpcType &#123;</span><br><span class="line">  <span class="keyword">case</span> rpcAppendEntries:</span><br><span class="line">    <span class="keyword">var</span> req AppendEntriesRequest</span><br><span class="line">    <span class="keyword">if</span> err := dec.Decode(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    rpc.Command = &amp;req</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> rpcRequestVote:</span><br><span class="line">    <span class="keyword">var</span> req RequestVoteRequest</span><br><span class="line">    <span class="keyword">if</span> err := dec.Decode(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    rpc.Command = &amp;req</span><br><span class="line">   ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘£ å°†è§£ç å‡ºæ¥çš„çŒåˆ°Raft.consumeCh</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> n.consumeCh &lt;- rpc:</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¤ ç­‰ç»“æœï¼Œä¸Šé¢çš„consumeChè¢«Raftçš„runLeaderä¹‹ç±»çš„å…¶ä»–åç¨‹è¿›è¡Œå¤„ç†åï¼Œå°†ç»“æœå¡ä¼šåˆ°respChã€‚</span></span><br><span class="line">RESP:</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> resp := &lt;-respCh:</span><br><span class="line">    <span class="comment">// â‘¥ å¯¹ç»“æœè¿›è¡Œç¼–ç </span></span><br><span class="line">    <span class="keyword">if</span> err := enc.Encode(resp.Response); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul></li></ol><h5 id="AppendEntrieså®ç°åˆ†æ"><a href="#AppendEntrieså®ç°åˆ†æ" class="headerlink" title="AppendEntrieså®ç°åˆ†æ"></a>AppendEntrieså®ç°åˆ†æ</h5><p>ä¸Šé¢çš„ä¼ è¾“å±‚å·²ç»åˆ›å»ºå¥½äº†è¿æ¥çš„å¤„ç†å™¨(æ¶ˆè´¹è€…)ï¼Œç°åœ¨éœ€è¦æ¶ˆæ¯çš„ç”Ÿäº§è€…ï¼ŒAppendEntrieså°±èƒ½å……å½“è¿™ä¸€è§’è‰²ã€‚</p><p>éœ€è¦ç½‘ç»œäº¤äº’çš„RequestVoteã€AppendEntriesã€TimeoutNowéƒ½æ˜¯è°ƒç”¨çš„genericRPCå®ç°çš„ï¼ŒgenericRPCæ˜¯çœŸæ­£æ‰§è¡Œè¯·æ±‚çš„å‡½æ•°ã€‚</p><p><a href="https://imgtu.com/i/ovxupF"><img src="https://s4.ax1x.com/2021/12/14/ovxupF.png" alt="ovxupF.png"></a></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªgenericRPCçš„æµç¨‹ï¼š</p><p>â‘  ä»è¿æ¥æ± è·å–è¿æ¥å¯¹è±¡ï¼Œç®€å•çš„ç»´æŠ¤äº†ä¸€ä¸ªè¿æ¥æ± ã€‚</p><p>â‘¡ åœ¨è¿æ¥ä¸Šå‘é€RPCè¯·æ±‚ã€‚</p><p>â‘¢ è§£ç Responseï¼Œå°†connè¿”è¿˜è¿æ¥æ± å¦‚æœå¯ä»¥çš„è¯ã€‚</p><blockquote><p>æ³¨æ„ï¼šè¿™é‡Œå‘é€è¯·æ±‚ä¹‹åï¼ŒåŒæ­¥è·å–Responseã€‚å¦‚æœæ˜¯çŸ­é“¾æ¥ï¼Œä¸ºäº†é«˜æ•ˆå°±ä¸ä¼šç›´æ¥åœ¨è¿™é‡Œç­‰ç»“æœäº†ã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NetworkTransport)</span> <span class="title">genericRPC</span><span class="params">(id ServerID, target ServerAddress, rpcType <span class="keyword">uint8</span>, args <span class="keyword">interface</span>&#123;&#125;, resp <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="comment">// â‘  ä»è¿æ¥æ± ä¸­è·å–è¿æ¥ï¼ŒNetworkTransportç»´æŠ¤äº†ä¸€ä¸ªè¿æ¥æ± </span></span><br><span class="line">  conn, err := n.getConnFromAddressProvider(id, target)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ å‘é€RPCè¯·æ±‚</span></span><br><span class="line">  <span class="keyword">if</span> err = sendRPC(conn, rpcType, args); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¢ è§£ç Responseï¼Œå¹¶ä¸”å½’è¿˜è¿æ¥ã€‚æ³¨æ„ï¼šè¿™é‡Œå‘é€äº†è¯·æ±‚ä¹‹åï¼Œé©¬ä¸Šå°±è§£ç Responseäº†ã€‚æƒ³æƒ³æˆ‘ä»¬çš„mysqlå®¢æˆ·ç«¯ï¼Œ(å‘æ¶ˆæ¯,ç­‰ç»“æœï¼‰ï¼Œä¸å¯ä»¥ä¸€ç›´å‘æ¶ˆæ¯è€Œä¸æ¥æ”¶ã€‚</span></span><br><span class="line">  canReturn, err := decodeResponse(conn, resp)</span><br><span class="line">  <span class="keyword">if</span> canReturn &#123;</span><br><span class="line">    n.returnConn(conn)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯¹æ¯”çœ‹çœ‹InmemTransport.makeRPCæ–¹æ³•æ¥ä½“ä¼šå…¶ä¸­çš„ä¸åŒï¼Œè¿™è¾¹è·å–ç»“æœéœ€è¦ä»respChè¯»å–ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªResponseæ˜¯è°å¡è¿›å»respChçš„å‘¢ï¼Œæ¯•ç«Ÿæˆ‘ä»¬åªæ˜¯è·å–äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i *InmemTransport)</span> <span class="title">makeRPC</span><span class="params">(target ServerAddress, args <span class="keyword">interface</span>&#123;&#125;, r io.Reader, timeout time.Duration)</span> <span class="params">(rpcResp RPCResponse, err error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// å®šä¹‰äº¤äº’ç”¨çš„RPCå¯¹è±¡</span></span><br><span class="line">  req := RPC&#123;</span><br><span class="line">    Command:  args,</span><br><span class="line">    Reader:   r,</span><br><span class="line">    RespChan: respCh,</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// å‘é€æ¶ˆæ¯ï¼Œç›´æ¥å°†æ„é€ å‡ºæ¥çš„reqçŒåˆ°peer.consumerChæ¶ˆè´¹channelï¼Œæœ¬æ¥å°±æ˜¯å†…å­˜ä¸­çš„å¯¹è±¡ã€‚</span></span><br><span class="line">   <span class="keyword">select</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> peer.consumerCh &lt;- req:</span><br><span class="line">     ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ç­‰respChç»“æœï¼Œæ¶ˆè´¹åç¨‹æŠŠRPCæ‹¿å‡ºæ¥-å¤„ç†-ç»“æœå¡å›åˆ°respChã€‚</span></span><br><span class="line">   <span class="keyword">select</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> rpcResp = &lt;-respCh:</span><br><span class="line">      <span class="keyword">if</span> rpcResp.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">         err = rpcResp.Error</span><br><span class="line">      &#125;</span><br><span class="line">     .... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€è€ƒï¼š</p><p>1ã€ä¸Šé¢çš„å®ç°æ˜¯ä¸€æ¡ä¸€æ¡çš„å‘ï¼Œå®é™…ä¸Šä¸ºäº†é«˜æ•ˆï¼Œæˆ‘ä»¬å¾€å¾€éƒ½æ˜¯æ‰¹å¤„ç†çš„ã€‚</p><p>2ã€æƒ³RequestVoteè¦ç»™å¤šä¸ªå¯¹è±¡å‘æŠ•ç¥¨æ¶ˆæ¯ï¼Œé‚£ä¹ˆè‚¯å®šä¸ä¼šå‘ä¸€ä¸ªæ¶ˆæ¯ç­‰ä¸€ä¸ªç»“æœï¼Œè€Œæ˜¯ç¾¤å‘ï¼Œç„¶åå¤„ç†ç»“æ„ã€‚</p><h5 id="AppendEntriesPipelineå®ç°"><a href="#AppendEntriesPipelineå®ç°" class="headerlink" title="AppendEntriesPipelineå®ç°"></a>AppendEntriesPipelineå®ç°</h5><p>åŒæ ·çš„æˆ‘ä»¬ä»æµ‹è¯•ç”¨ä¾‹å¼€å§‹ï¼Œçœ‹çœ‹æ‰¹å¤„ç†æ˜¯æ€ä¹ˆç©çš„ã€‚ä¸»è¦çœ‹çœ‹æ‰¹å¤„ç†å’Œå•æ¡å¤„ç†çš„åŒºåˆ«ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–AppendEntriesPipelineå¯¹è±¡ï¼Œå¯åŠ¨åç¨‹å¤„ç† inprogressCh -&gt; doneCh</span></span><br><span class="line">pipeline, err := trans2.AppendEntriesPipeline(<span class="string">&quot;id1&quot;</span>, trans1.LocalAddr())</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘10ä¸ªæ¶ˆæ¯ï¼Œå¹¶ä¸”å°†RPCåŠ å…¥åˆ°inprogressCh</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">  out := <span class="built_in">new</span>(AppendEntriesResponse)</span><br><span class="line">  <span class="keyword">if</span> _, err := pipeline.AppendEntries(&amp;args, out); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    t.Fatalf(<span class="string">&quot;err: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Consumer()ä¼šè¿”å›doneChï¼Œä»doneChè·å–æ•°æ®ï¼Œå‘äº†10ä¸ªæ¶ˆæ¯ï¼Œæ‰€ä»¥éœ€è¦è·å–10æ¬¡ç»“æœ</span></span><br><span class="line">respCh := pipeline.Consumer()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ready := &lt;-respCh:</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯å‘æ¶ˆæ¯çš„æ—¶å€™  épipeline VS pipelineçš„åŒºåˆ«</p><p><a href="https://imgtu.com/i/TCM7Us"><img src="https://s4.ax1x.com/2021/12/16/TCM7Us.md.png" alt="TCM7Us.md.png"></a></p><p>ä¸‹é¢æ˜¯è§£ç æ¶ˆæ¯çš„æ—¶å€™  épipeline VS pipelineçš„åŒºåˆ«ï¼Œpipelineçš„decodeResponsesæ–¹æ³•æ˜¯åˆå§‹åŒ–AppendEntriesPipelineå¯¹è±¡çš„æ—¶å€™å°±å¯åŠ¨çš„åç¨‹ã€‚</p><p><a href="https://imgtu.com/i/TClAFs"><img src="https://s4.ax1x.com/2021/12/16/TClAFs.md.png" alt="TClAFs.md.png"></a></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªâ“ç–‘é—®å…³äºnet.Connçš„ A-&gt;B-&gt;Aï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨ç½‘ç»œä¸Šæ˜¯ä¸¤è¾¹å¯ä»¥åŒæ—¶å‘é€æ•°æ®å—ï¼Ÿä¸ºå•¥ä¸Šé¢çš„épipelineæ¨¡å¼ï¼Œsendä¹‹åé©¬ä¸Šå°±å¯ä»¥decodeæ¶ˆæ¯äº†ï¼Œconnè¿™é‡Œå¸®æˆ‘ä»¬åšäº†ä»€ä¹ˆã€‚</p><p>æ‰¹å¤„ç†çš„æ•´ä½“å®ç°å°±æ˜¯ï¼Œå¯åŠ¨ä¸€ä¸ªåç¨‹ç›‘æ§inprogressçš„ä»»åŠ¡ã€‚ç„¶åå¼€å‘æ‰¹é‡çš„å‘æ¶ˆæ¯ï¼Œæ¯”å¦‚ä¸€æ¬¡å‘10æ¡ï¼Œç„¶åinprogressåç¨‹è¢«æ¿€æ´»ï¼Œå¼€å§‹å¤„ç†ã€‚å°†å¤„ç†çš„ç»“æœæ”¾åˆ°doneChï¼Œæœ€åç”¨æˆ·ä»doneChè·å–æ¶ˆæ¯å³å¯ã€‚</p><h5 id="RequestVoteè¿‡ç¨‹"><a href="#RequestVoteè¿‡ç¨‹" class="headerlink" title="RequestVoteè¿‡ç¨‹"></a>RequestVoteè¿‡ç¨‹</h5><p>ä¸Šé¢æˆ‘ä»¬åˆ†æäº†ä¸€å¯¹ä¸€pipelineå‘æ¶ˆæ¯ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹1:Nï¼Œåœ¨é›†ç¾¤é‡Œé¢ç»™æ‰€æœ‰äººå‘æ¶ˆæ¯ï¼Œå¹¶ä¸”å¤„ç†ç»“æ„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Raft)</span> <span class="title">electSelf</span><span class="params">()</span> &lt;-<span class="title">chan</span> *<span class="title">voteResult</span></span> &#123;</span><br><span class="line">  <span class="comment">// â‘  åˆ›å»ºä¸€ä¸ªåŒ…å«peersæ•°é‡çš„respCh</span></span><br><span class="line">  respCh := <span class="built_in">make</span>(<span class="keyword">chan</span> *voteResult, <span class="built_in">len</span>(r.configurations.latest.Servers))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ å¹¶å‘å‘æ¶ˆæ¯ï¼Œç„¶åå°†ç»“æœçŒå›åˆ°respChã€‚åé¢ä»respChè·å–æŠ•ç¥¨ç»“æœå³å¯è¿›è¡Œå¤„ç†ã€‚</span></span><br><span class="line">  askPeer := <span class="function"><span class="keyword">func</span><span class="params">(peer Server)</span></span> &#123;</span><br><span class="line">    r.goFunc(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      resp := &amp;voteResult&#123;voterID: peer.ID&#125;</span><br><span class="line">      err := r.trans.RequestVote(peer.ID, peer.Address, req, &amp;resp.RequestVoteResponse)</span><br><span class="line">      ... </span><br><span class="line">      respCh &lt;- resp</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> respCh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“ğŸ¤”"><a href="#æ€»ç»“ğŸ¤”" class="headerlink" title="æ€»ç»“ğŸ¤”"></a>æ€»ç»“ğŸ¤”</h4><p>ç½‘ç»œæ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„æ¨¡å—ï¼Œåç»­å¯ä»¥çœ‹çœ‹æ¯”è¾ƒç»å…¸çš„Redisã€Nginxè¿™äº›ä¼˜ç§€ç»„ä»¶çš„å®ç°ã€‚</p><p>ProxySQLï¼šæƒŠç¾¤æ•ˆåº”æ€è€ƒ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h4&gt;&lt;p&gt;æ¥ç€ä¸Šé¢â€“å¯¼è¯»ï¼Œæœ¬ç¯‡è®²è§£Transportä¼ è¾“å±‚å®ç°ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚ä¸‹NewRaftå‡½æ•°çš„å‚æ•°ä¸­ï¼Œé™¤äº†Configç»“æ„ï¼Œå…¶ä»–éƒ½æ˜¯ä»¥int</summary>
      
    
    
    
    
    <category term="raft" scheme="https://zhangtinglu.github.io/tags/raft/"/>
    
  </entry>
  
  <entry>
    <title>hashicorp:raftæºç ç³»åˆ—(1)--å¯¼è¯»</title>
    <link href="https://zhangtinglu.github.io/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-1-%E5%AF%BC%E8%AF%BB/"/>
    <id>https://zhangtinglu.github.io/2021/12/17/hashicorp-raft%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97-1-%E5%AF%BC%E8%AF%BB/</id>
    <published>2021-12-17T07:16:53.000Z</published>
    <updated>2022-01-06T08:38:29.641Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Raftæ˜¯å¹²å•¥çš„ï¼Ÿ"><a href="#Raftæ˜¯å¹²å•¥çš„ï¼Ÿ" class="headerlink" title="Raftæ˜¯å¹²å•¥çš„ï¼Ÿ"></a>Raftæ˜¯å¹²å•¥çš„ï¼Ÿ</h3><p><a href="http://thesecretlivesofdata.com/raft/">åŠ¨ç”»è¯´æ˜</a></p><p>ç®€è¿°å¦‚ä¸‹å›¾ï¼šç”¨æˆ·SET 5ï¼Œ3ä¸ªä¸åŒèŠ‚ç‚¹éƒ½èƒ½è·å–SET 5çš„æ“ä½œã€‚æ‰€è°“çš„æœ€ç®€å•çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ã€‚</p><p><a href="https://imgtu.com/i/oO3r0P"><img src="https://s4.ax1x.com/2021/12/13/oO3r0P.png" alt="oO3r0P.png"></a></p><h3 id="Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ"><a href="#Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ" class="headerlink" title="Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ"></a>Rafté¡¹ç›®åŒ…å«å“ªäº›æ¨¡å—ï¼Ÿ</h3><h4 id="é¡¹ç›®æœ‰å¤šå°‘è¡Œ"><a href="#é¡¹ç›®æœ‰å¤šå°‘è¡Œ" class="headerlink" title="é¡¹ç›®æœ‰å¤šå°‘è¡Œ?"></a>é¡¹ç›®æœ‰å¤šå°‘è¡Œ?</h4><p>åˆ†æä¸‹æ•´ä¸ªé¡¹ç›®å¤§æ¦‚æ˜¯1Wå¤šè¡Œï¼Œå¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œä»£ç æ³¨é‡Šéå¸¸é½å…¨ï¼Œç†è§£èµ·æ¥æ¯”è¾ƒè½»æ¾ã€‚ä»£ç æŠ½è±¡å¾—å¾ˆå¥½ï¼Œéå¸¸å€¼å¾—å­¦ä¹ ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span><span class="bash"> % cloc ./</span></span><br><span class="line">      77 text files.</span><br><span class="line">      77 unique files.</span><br><span class="line">       8 files ignored.</span><br><span class="line"></span><br><span class="line">github.com/AlDanial/cloc v 1.90  T=0.09 s (814.1 files/s, 201614.7 lines/s)</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Language                     files          blank        comment           code</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Go                              57           2207           2786          11864</span><br><span class="line">Markdown                         4            106              0            255</span><br><span class="line">YAML                             4             26             29            141</span><br><span class="line">XML                              4              0              0            108</span><br><span class="line">make                             1             10              2             33</span><br><span class="line">Bourne Shell                     1              3              3             10</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">SUM:                            71           2352           2820          12411</span><br><span class="line">-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure><h4 id="ä»å“ªé‡Œå¼€å§‹ï¼Ÿ"><a href="#ä»å“ªé‡Œå¼€å§‹ï¼Ÿ" class="headerlink" title="ä»å“ªé‡Œå¼€å§‹ï¼Ÿ"></a>ä»å“ªé‡Œå¼€å§‹ï¼Ÿ</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹<code>api.go/Raft</code>ç»“æ„ï¼Œè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªRaftèŠ‚ç‚¹ï¼Œæœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ã€‚åˆ’åˆ†3å¤§å—</p><ol><li><p>NewRaftèŠ‚ç‚¹éœ€è¦çš„ä¿¡æ¯ï¼šä¸‹å›¾ä¸­æ ‡çº¢ç‚¹çš„ï¼Œå‡ å¤§æ ¸å¿ƒç»„æˆã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬ä»ç½‘ç»œå±‚å¼€å§‹è¯¦ç»†åˆ†æã€‚</p><blockquote><p>é™¤äº†raftStateï¼Œå…¶ä»–éƒ¨åˆ†å…¨æ˜¯interfaceï¼Œæ¨¡å—æŠ½è±¡çš„å¾ˆç»†è‡´ã€‚</p></blockquote></li><li><p>Leaderæ“ä½œç›¸å…³ï¼šæ•´ä¸ªRaftæœ€æ ¸å¿ƒçš„å°±æ˜¯Leaderçš„çŠ¶æ€è½¬æ¢è¿‡ç¨‹ã€‚æˆ‘ä»¬åç»­ä¹Ÿä¼šå¯¹è¿™ä¸€éƒ¨åˆ†çš„å®ç°åšè¯¦ç»†è¯´æ˜ã€‚</p></li><li><p>ä¸€äº›å¼‚æ­¥æ“ä½œï¼šè¿™ä¸€å—æ˜¯åµŒå…¥åœ¨å„ä¸ªæ¨¡å—çš„å®ç°ä¸­çš„ã€‚é¡¹ç›®é‡Œé¢ä¸€äº›chançš„ä½¿ç”¨ä¹Ÿæ˜¯å€¼å¾—å­¦ä¹ çš„ã€‚</p></li></ol><p><a href="https://imgtu.com/i/oO0Ein"><img src="https://s4.ax1x.com/2021/12/13/oO0Ein.png" alt="oO0Ein.png"></a></p><h4 id="æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ"><a href="#æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ" class="headerlink" title="æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ"></a>æ–°å»ºRaftèŠ‚ç‚¹é€»è¾‘ï¼Ÿ</h4><ul><li><p>â‘  æ ¡éªŒé…ç½®</p></li><li><p>â‘¡ è·å–å½“å‰ä»»æœŸï¼Œä»StableStoreä¸­è·å–</p></li><li><p>â‘¢ è·å–æœ€è¿‘çš„æ—¥å¿—å·å’Œå…·ä½“Logï¼Œä»LogStoreä¸­è·å–</p></li><li><p>â‘£ åˆ›å»ºBuffer applyChï¼Œç”¨æ¥åº”ç”¨Logåˆ°FSMã€‚è¿™é‡ŒFutureçš„åº”ç”¨å¯ä»¥å­¦ä¹ ä¸‹ï¼Œåé¢å†™applyLogçš„æ—¶å€™å¯ä»¥è¯¦ç»†åˆ†æã€‚</p></li><li><p>â‘¤ åˆå§‹åŒ–Raftç»“æ„ã€‚</p></li><li><p>â‘¥ Setå„ç§å˜é‡ï¼Œè¿™é‡Œå¯ä»¥ç ”ç©¶ä¸‹configæ˜¯æ€ä¹ˆå®ç°çº¿ç¨‹å®‰å…¨çš„å˜æ›´ã€‚</p></li><li><p>â‘¦ å°è¯•ä»å¤‡ä»½ä¸­æ¢å¤ï¼Œå¤„ç†peerå˜æ›´æ—¥å¿—ï¼Œegï¼šæ·»åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹ã€‚è¿™é‡Œä¸ºå•¥åªå¤„ç†Peerå˜æ›´ä¿¡æ¯ï¼Œéƒ½å·²ç»å°†Logè§£æå‡ºæ¥äº†ï¼Œä¸ºå•¥ä¸ç›´æ¥åº”ç”¨å‘¢ï¼Ÿ</p></li><li><p>â‘§ ç»™ä¼ è¾“å±‚æ³¨å†Œå¿ƒè·³å¤„ç†å™¨ã€‚åœ¨è¿™é‡Œåˆå§‹åŒ–ï¼Œè€Œä¸æ˜¯åœ¨goroutineé‡Œé¢å¤„ç†ï¼Œæ˜¯ä¸ºäº†é¿å…é˜Ÿå¤´é˜»å¡ã€‚</p></li><li><p>â‘¨ å¯åŠ¨goroutineï¼Œå¦‚ä¸‹å¯åŠ¨äº†3ä¸ªåç¨‹ã€‚</p><p><a href="https://imgtu.com/i/oOhDud"><img src="https://s4.ax1x.com/2021/12/13/oOhDud.png" alt="oOhDud.png"></a></p></li></ul><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRaft</span><span class="params">(conf *Config, fsm FSM, logs LogStore, stable StableStore, snaps SnapshotStore, trans Transport)</span> <span class="params">(*Raft, error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// â‘  æ ¡éªŒé…ç½®</span></span><br><span class="line">  <span class="keyword">if</span> err := ValidateConfig(conf); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¡ è·å–å½“å‰ä»»åŠ¡ï¼Œè¿™é‡Œæ˜¯ä»StableStoreä¸­è·å–</span></span><br><span class="line">  currentTerm, err := stable.GetUint64(keyCurrentTerm)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¢ è·å–æœ€è¿‘çš„æ—¥å¿—å·å’Œå…·ä½“Logï¼Œä»LogStoreä¸­è·å–ï¼›</span></span><br><span class="line">  lastIndex, err := logs.LastIndex()</span><br><span class="line">  <span class="keyword">if</span> err = logs.GetLog(lastIndex, &amp;lastLog); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to get last log at index %d: %v&quot;</span>, lastIndex, err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘£ åˆ›å»ºBuffer applyChï¼Œç”¨æ¥åº”ç”¨Logåˆ°FSMã€‚è¿™é‡ŒFutureçš„åº”ç”¨å¯ä»¥å­¦ä¹ ä¸‹ã€‚</span></span><br><span class="line">  applyCh := <span class="built_in">make</span>(<span class="keyword">chan</span> *logFuture)</span><br><span class="line">  <span class="keyword">if</span> conf.BatchApplyCh &#123;</span><br><span class="line">    applyCh = <span class="built_in">make</span>(<span class="keyword">chan</span> *logFuture, conf.MaxAppendEntries)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¤ åˆå§‹åŒ–Raftç»“æ„ã€‚</span></span><br><span class="line">  r := &amp;Raft&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¥ Setå„ç§å˜é‡ï¼Œä¸‹é¢è¿™ä¸€è¡Œçš„å®ç°å¯ä»¥ç ”ç©¶ä¸‹ï¼Œä¸ºå•¥ä¸ç›´æ¥r.conf = conf</span></span><br><span class="line">  r.conf.Store(*conf)</span><br><span class="line">  r.setState(Follower)</span><br><span class="line">  r.setCurrentTerm(currentTerm)</span><br><span class="line">  r.setLastLog(lastLog.Index, lastLog.Term)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¦ å°è¯•ä»å¤‡ä»½ä¸­æ¢å¤ï¼Œå¤„ç†peerå˜æ›´æ—¥å¿—ï¼Œegï¼šæ·»åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹. </span></span><br><span class="line">  <span class="keyword">if</span> err := r.restoreSnapshot(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">  &#125;</span><br><span class="line">  snapshotIndex, _ := r.getLastSnapshot()</span><br><span class="line">  <span class="keyword">for</span> index := snapshotIndex + <span class="number">1</span>; index &lt;= lastLog.Index; index++ &#123;</span><br><span class="line">    <span class="keyword">var</span> entry Log</span><br><span class="line">    <span class="keyword">if</span> err := r.logs.GetLog(index, &amp;entry); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := r.processConfigurationLogEntry(&amp;entry); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// â‘§ ç»™ä¼ è¾“å±‚æ³¨å†Œå¿ƒè·³å¤„ç†å™¨</span></span><br><span class="line">  trans.SetHeartbeatHandler(r.processHeartbeat)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// â‘¨ å¯åŠ¨goroutine</span></span><br><span class="line">  r.goFunc(r.run)</span><br><span class="line">  r.goFunc(r.runFSM)</span><br><span class="line">  r.goFunc(r.runSnapshots)</span><br><span class="line">  <span class="keyword">return</span> r, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å°†RaftèŠ‚ç‚¹å¯åŠ¨èµ·æ¥äº†</p><h4 id="æŠ€æœ¯ç‚¹1ï¼šatomic-Value"><a href="#æŠ€æœ¯ç‚¹1ï¼šatomic-Value" class="headerlink" title="æŠ€æœ¯ç‚¹1ï¼šatomic.Value"></a>æŠ€æœ¯ç‚¹1ï¼šatomic.Value</h4><p><img src="https://blog.betacat.io/image/golang-atomic-value/atomic-value-store.drawio.png" alt="atomic.Value Store æµç¨‹"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// confè¿™ä¸ªå˜é‡ä¼šæ¶‰åŠåˆ°å¤šä¸ªgoroutineçš„å¹¶å‘ä¿®æ”¹&amp;è¯»å–ã€‚</span></span><br><span class="line"><span class="comment">// ä¸ºäº†ä¿è¯è¯»å†™çš„åŸå­æ€§ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåŠ é”ã€‚ä½†æ˜¯åŠ é”åˆæœ‰ç‚¹è¿‡é‡äº†ï¼Œä¸ºäº†æ›´åŠ é«˜æ•ˆçš„å®ç°ï¼Œä½¿ç”¨äº†atomicã€‚</span></span><br><span class="line">conf atomic.Value</span><br><span class="line">r.conf.Store(*conf)</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 8ä¸ªå†™routine + 1ä¸ªè¯»routine</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestAtomic</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">  <span class="keyword">var</span> gloMy = my&#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      wg.Add(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">for</span> &#123;</span><br><span class="line">        tmp := rand.Uint64() % <span class="number">100</span></span><br><span class="line">        gloMy.v1 = tmp</span><br><span class="line">        <span class="comment">// åœ¨è¿™ä¸¤æ¬¡æ“ä½œä¹‹é—´å°±ä¼šäº§ç”Ÿä¸­é—´çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€å°±å¾ˆå¥‡æ€ªæ²¡æœ‰æ„ä¹‰</span></span><br><span class="line">        gloMy.v2 = fmt.Sprintf(<span class="string">&quot;s%d&quot;</span>, tmp)</span><br><span class="line">      &#125;</span><br><span class="line">      wg.Done()</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  wg.Add(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">      t.Log(gloMy.v1, gloMy.v2)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Done()</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=== RUN   TestAtomic</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">75</span> s64 <span class="comment">// ä¸åˆç¬¦é¢„æœŸï¼Œè„è¯»äº†</span></span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">63</span> s63</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">48</span> s48</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">5</span> s5</span><br><span class="line">    tmp_test.<span class="keyword">go</span>:<span class="number">33</span>: <span class="number">1</span> s1</span><br></pre></td></tr></table></figure><p><a href="https://blog.betacat.io/post/golang-atomic-value-exploration/">æ¨èä¸€ç¯‡æ–‡ç« </a> ï¼šæ–‡ä¸­å°†atomicçš„æ¥é¾™å»è„‰éƒ½è§£é‡Šäº†ä¸€éã€‚</p><h4 id="æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡"><a href="#æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡" class="headerlink" title="æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡"></a>æŠ€æœ¯ç‚¹2ï¼šé˜Ÿå¤´é˜»å¡</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™è¡Œçš„ä½ç½®ï¼Œåœ¨goroutineå¯åŠ¨ä¹‹å‰æ³¨å†ŒHeartbeatHandlerå¤„ç†å™¨</span></span><br><span class="line">trans.SetHeartbeatHandler(r.processHeartbeat)</span><br></pre></td></tr></table></figure><h4 id="å°å°ç–‘é—®â“"><a href="#å°å°ç–‘é—®â“" class="headerlink" title="å°å°ç–‘é—®â“"></a>å°å°ç–‘é—®â“</h4><p>Q: ä¸ºå•¥è¦å«FSMï¼Œæˆ‘çš„ç†è§£FSMä¸å°±æ˜¯ç±»ä¼¼äºMySQLè¿™ç§å¯ä»¥åº”ç”¨Logçš„åœ°æ–¹å—ï¼Ÿæ€»æ„Ÿè§‰ç”¨çŠ¶æ€æœºå‘½åæ€ªæ€ªçš„ï¼Œå®¹æ˜“è¯¯ä¼šã€‚</p><p>Q: Config å’Œ Configurationçš„åŒºåˆ«? Configé‡Œé¢éƒ½æ˜¯å•ä¸ªRaftèŠ‚ç‚¹çš„é…ç½®ï¼Œæ¯”å¦‚è¶…æ—¶ä¹‹ç±»çš„ï¼›Configurationæ˜¯Raft Clusterç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æœ‰å‡ ä¸ªèŠ‚ç‚¹ä¹‹ç±»çš„ã€‚</p><p>â€‹           </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;Raftæ˜¯å¹²å•¥çš„ï¼Ÿ&quot;&gt;&lt;a href=&quot;#Raftæ˜¯å¹²å•¥çš„ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;Raftæ˜¯å¹²å•¥çš„ï¼Ÿ&quot;&gt;&lt;/a&gt;Raftæ˜¯å¹²å•¥çš„ï¼Ÿ&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;http://thesecretlivesofdata.com/r</summary>
      
    
    
    
    
    <category term="raft" scheme="https://zhangtinglu.github.io/tags/raft/"/>
    
  </entry>
  
</feed>
